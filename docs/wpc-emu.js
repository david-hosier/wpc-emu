var WpcEmu=function(t){function e(i){if(s[i])return s[i].exports;var h=s[i]={i:i,l:!1,exports:{}};return t[i].call(h.exports,h,h.exports,e),h.l=!0,h.exports}var s={};return e.m=t,e.c=s,e.d=function(t,s,i){e.o(t,s)||Object.defineProperty(t,s,{enumerable:!0,get:i})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,s){if(1&s&&(t=e(t)),8&s)return t;if(4&s&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(e.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&s&&"string"!=typeof t)for(var h in t)e.d(i,h,function(e){return t[e]}.bind(null,h));return i},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=3)}([function(t){"use strict";t.exports={CALL_IRQ_AFTER_TICKS:2049,CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS:512,CALL_ZEROCLEAR_AFTER_TICKS:16667,CALL_UPDATELAMP_AFTER_TICKS:33334,CALL_UPDATESOLENOID_AFTER_TICKS:266672}},function(t){"use strict";t.exports={findMsbBit:function(t){const e=[1,2,4,8,16,32,64,128].indexOf(t);return-1<e?e+1:0},setMsbBit:function(t=0){return[1,2,4,8,16,32,64,128][t]}}},function(t){"use strict";const e=1,s=2,i=4,h=8,r=16,a=32,o=64,n=128,c=[6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,0,0,2,4,0,0,5,9,0,2,3,0,3,2,8,6,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,5,5,5,5,0,5,3,6,9,11,0,19,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,7,0,0,7,7,0,7,7,7,7,7,0,7,7,4,7,2,2,2,4,2,2,2,0,2,2,2,2,4,7,3,0,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,5,5,5,7,5,5,5,5,5,5,5,5,7,8,6,6,2,2,2,4,2,2,2,0,2,2,2,2,3,0,3,0,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,7,5,5,5,5,5,5,5,5,6,6,6,6],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,5,0,4,0,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,8,0,0,0,0,0,0,0,0,8,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],g=[4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];t.exports={getInstance:function(t,e,s){return new C(t,e,s)}};class C{constructor(t,e,s){this.name=s,this.memoryWriteFunction=t,this.memoryReadFunction=e,this.tickCount=0,this.missedIRQ=0,this.missedFIRQ=0,this.irqPendingNMI=!1,this.irqPendingFIRQ=!1,this.irqPendingIRQ=!1,this.irqCount=0,this.firqCount=0,this.nmiCount=0,this.regA=0,this.regB=0,this.regX=0,this.regY=0,this.regU=0,this.regS=0,this.regCC=0,this.regPC=0,this.regDP=0}setV8(t,e,s){this.regCC|=(128&(t^e^s^s>>1))>>6}setV16(t,e,s){this.regCC|=(32768&(t^e^s^s>>1))>>14}getD(){return(this.regA<<8)+this.regB}setD(t){this.regA=255&t>>8,this.regB=255&t}PUSHB(t){this.memoryWriteFunction(--this.regS,255&t)}PUSHW(t){this.memoryWriteFunction(--this.regS,255&t),this.memoryWriteFunction(--this.regS,255&t>>8)}PUSHBU(t){this.memoryWriteFunction(--this.regU,255&t)}PUSHWU(t){this.memoryWriteFunction(--this.regU,255&t),this.memoryWriteFunction(--this.regU,255&t>>8)}PULLB(){return this.memoryReadFunction(this.regS++)}PULLW(){return(this.memoryReadFunction(this.regS++)<<8)+this.memoryReadFunction(this.regS++)}PULLBU(){return this.memoryReadFunction(this.regU++)}PULLWU(){return(this.memoryReadFunction(this.regU++)<<8)+this.memoryReadFunction(this.regU++)}PSHS(t){var e=0;128&t&&(this.PUSHW(this.regPC),e+=2),64&t&&(this.PUSHW(this.regU),e+=2),32&t&&(this.PUSHW(this.regY),e+=2),16&t&&(this.PUSHW(this.regX),e+=2),8&t&&(this.PUSHB(this.regDP),e++),4&t&&(this.PUSHB(this.regB),e++),2&t&&(this.PUSHB(this.regA),e++),1&t&&(this.PUSHB(this.regCC),e++),this.tickCount+=e}PSHU(t){var e=0;128&t&&(this.PUSHWU(this.regPC),e+=2),64&t&&(this.PUSHWU(this.regS),e+=2),32&t&&(this.PUSHWU(this.regY),e+=2),16&t&&(this.PUSHWU(this.regX),e+=2),8&t&&(this.PUSHBU(this.regDP),e++),4&t&&(this.PUSHBU(this.regB),e++),2&t&&(this.PUSHBU(this.regA),e++),1&t&&(this.PUSHBU(this.regCC),e++),this.tickCount+=e}PULS(t){var e=0;1&t&&(this.regCC=this.PULLB(),e++),2&t&&(this.regA=this.PULLB(),e++),4&t&&(this.regB=this.PULLB(),e++),8&t&&(this.regDP=this.PULLB(),e++),16&t&&(this.regX=this.PULLW(),e+=2),32&t&&(this.regY=this.PULLW(),e+=2),64&t&&(this.regU=this.PULLW(),e+=2),128&t&&(this.regPC=this.PULLW(),e+=2),this.tickCount+=e}PULU(t){var e=0;1&t&&(this.regCC=this.PULLBU(),e++),2&t&&(this.regA=this.PULLBU(),e++),4&t&&(this.regB=this.PULLBU(),e++),8&t&&(this.regDP=this.PULLBU(),e++),16&t&&(this.regX=this.PULLWU(),e+=2),32&t&&(this.regY=this.PULLWU(),e+=2),64&t&&(this.regS=this.PULLWU(),e+=2),128&t&&(this.regPC=this.PULLWU(),e+=2),this.tickCount+=e}getPBR(t){switch(15&t){case 0:return this.getD();case 1:return this.regX;case 2:return this.regY;case 3:return this.regU;case 4:return this.regS;case 5:return this.regPC;case 8:return this.regA;case 9:return this.regB;case 10:return this.regCC;case 11:return this.regDP;default:throw new Error("getPBR_INVALID"+t)}}setPBR(t,e){switch(15&t){case 0:return void this.setD(e);case 1:return void(this.regX=e);case 2:return void(this.regY=e);case 3:return void(this.regU=e);case 4:return void(this.regS=e);case 5:return void(this.regPC=e);case 8:return void(this.regA=e);case 9:return void(this.regB=e);case 10:return void(this.regCC=e);case 11:return void(this.regDP=e);default:throw new Error("setPBR_INVALID"+t)}}TFREXG(t,e){var s=136&t;(128===s||8===s)&&(console.log("**** TFREXG problem!"),s=0),s=this.getPBR(t>>4),e&&this.setPBR(t>>4,this.getPBR(t)),this.setPBR(t,s)}signed(t){return 127<t?t-256:t}signed16(t){return 32767<t?t-65536:t}fetch(){const t=this.memoryReadFunction(this.regPC++);return this.regPC&=65535,t}fetch16(){const t=this.memoryReadFunction(this.regPC++);this.regPC&=65535;const e=this.memoryReadFunction(this.regPC++);return this.regPC&=65535,(t<<8)+e}ReadWord(t){const e=this.memoryReadFunction(t++);t&=65535;const s=this.memoryReadFunction(t++);return t&=65535,(e<<8)+s}WriteWord(t,e){this.memoryWriteFunction(t++,255&e>>8),t&=65535,this.memoryWriteFunction(t,255&e)}PostByte(){const t=this.fetch();var e;switch(96&t){case 0:e=this.regX;break;case 32:e=this.regY;break;case 64:e=this.regU;break;case 96:e=this.regS;break;default:throw new Error("INVALID_ADDRESS_PB")}var s,i=null,h=null;if(128&t){switch(15&t){case 0:h=e,i=e+1,this.tickCount+=2;break;case 1:h=e,i=e+2,this.tickCount+=3;break;case 2:h=i=e-1,this.tickCount+=2;break;case 3:h=i=e-2,this.tickCount+=3;break;case 4:h=e;break;case 5:h=e+this.signed(this.regB),this.tickCount+=1;break;case 6:h=e+this.signed(this.regA),this.tickCount+=1;break;case 7:throw new Error("INVALID_ADDRESS_MODE_0x07");case 8:h=e+this.signed(this.fetch()),this.tickCount+=1;break;case 9:h=e+this.signed16(this.fetch16()),this.tickCount+=4;break;case 10:throw new Error("INVALID_ADDRESS_MODE_0x0A");case 11:this.tickCount+=4,h=e+this.getD();break;case 12:s=this.signed(this.fetch()),h=this.regPC+s,this.tickCount+=1;break;case 13:s=this.signed16(this.fetch16()),h=this.regPC+s,this.tickCount+=5;break;case 14:throw new Error("INVALID_ADDRESS_MODE_0x0E");case 15:this.tickCount+=5,h=this.fetch16()}h&=65535,16&t&&(h=this.ReadWord(h),this.tickCount+=3)}else{var r=31&t;15<r&&(r-=32),h=e+r,this.tickCount+=1}if(null!==i)switch(96&t){case 0:this.regX=i;break;case 32:this.regY=i;break;case 64:this.regU=i;break;case 96:this.regS=i;break;default:throw new Error("PB_INVALID_XCHG_VALUE_"+t)}return 65535&h}flagsNZ16(t){this.regCC&=~(i|h),0===t&&(this.regCC|=i),32768&t&&(this.regCC|=h)}oINC(t){return t++,t&=255,this.regCC&=~(i|s|h),this.regCC|=g[t],(0===t||128===t)&&(this.regCC|=s),t}oDEC(t){return t--,t&=255,this.regCC&=~(i|s|h),this.regCC|=g[t],(127===t||255===t)&&(this.regCC|=s),t}oSUB(t,r){var a=t-r;return this.regCC&=~(e|i|s|h),this.regCC|=g[255&a],256&a&&(this.regCC|=e),this.setV8(t,r,a),255&a}oSUB16(t,r){var a=t-r;return this.regCC&=~(e|i|s|h),0==(65535&a)&&(this.regCC|=i),32768&a&&(this.regCC|=h),65536&a&&(this.regCC|=e),this.setV16(t,r,a),65535&a}oADD(t,r){var o=t+r;return this.regCC&=~(a|e|i|s|h),this.regCC|=g[255&o],256&o&&(this.regCC|=e),this.setV8(t,r,o),16&(o^t^r)&&(this.regCC|=a),255&o}oADD16(t,r){var a=t+r;return this.regCC&=~(e|i|s|h),0==(65535&a)&&(this.regCC|=i),32768&a&&(this.regCC|=h),65536&a&&(this.regCC|=e),this.setV16(t,r,a),65535&a}oADC(t,r){var o=t+r+(this.regCC&e);return this.regCC&=~(a|e|i|s|h),this.regCC|=g[255&o],256&o&&(this.regCC|=e),this.setV8(t,r,o),16&(o^t^r)&&(this.regCC|=a),255&o}oSBC(t,r){var a=t-r-(this.regCC&e);return this.regCC&=~(e|i|s|h),this.regCC|=g[255&a],256&a&&(this.regCC|=e),this.setV8(t,r,a),255&a}oCMP(t,r){var a=t-r;this.regCC&=~(e|i|s|h),this.regCC|=g[255&a],256&a&&(this.regCC|=e),this.setV8(t,r,a)}oCMP16(t,r){var a=t-r;this.regCC&=~(e|i|s|h),0==(65535&a)&&(this.regCC|=i),32768&a&&(this.regCC|=h),65536&a&&(this.regCC|=e),this.setV16(t,r,a)}oNEG(t){return this.regCC&=~(e|i|s|h),128===t&&(this.regCC|=s),t*=-1,0===(t&=255)&&(this.regCC|=i),128&t&&(this.regCC|=h|e),t}oLSR(t){return this.regCC&=~(i|e|h),1&t&&(this.regCC|=e),0===(t>>=1)&&(this.regCC|=i),255&t}oASR(t){return this.regCC&=~(i|e|h),1&t&&(this.regCC|=e),t=128&t|t>>1,this.regCC|=g[t],t}oASL(t){var r=t;return this.regCC&=~(i|e|h|s),128&t&&(this.regCC|=e),t<<=1,t&=255,this.regCC|=g[t],128&(t^r)&&(this.regCC|=s),t}oROL(t){var r=t,a=this.regCC&e;return this.regCC&=~(i|e|h|s),128&t&&(this.regCC|=e),t=t<<1|a,t&=255,this.regCC|=g[t],128&(t^r)&&(this.regCC|=s),t}oROR(t){var s=this.regCC&e;return this.regCC&=~(i|e|h),1&t&&(this.regCC|=e),t=t>>1|s<<7,t&=255,this.regCC|=g[t],t}oEOR(t,e){return this.regCC&=~(i|h|s),t^=e,this.regCC|=g[t],t}oOR(t,e){return this.regCC&=~(i|h|s),t|=e,this.regCC|=g[t],t}oAND(t,e){return this.regCC&=~(i|h|s),t&=e,this.regCC|=g[t],t}oCOM(t){return this.regCC&=~(i|h|s),t^=255,this.regCC|=g[t],this.regCC|=e,t}dpadd(){return(this.regDP<<8)+this.fetch()}step(){const t=this.tickCount;this.irqPendingNMI?(this.irqPendingNMI=!1,this.nmiCount++,this._executeNmi()):this.irqPendingFIRQ&&0==(this.regCC&o)?(this.irqPendingFIRQ=!1,this.firqCount++,this._executeFirq()):this.irqPendingIRQ&&0==(this.regCC&r)&&(this.irqPendingIRQ=!1,this.irqCount++,this._executeIrq());var a=null,C=null,_=this.fetch();switch(this.tickCount+=c[_],_){case 0:a=this.dpadd(),this.memoryWriteFunction(a,this.oNEG(this.memoryReadFunction(a)));break;case 3:a=this.dpadd(),this.memoryWriteFunction(a,this.oCOM(this.memoryReadFunction(a)));break;case 4:a=this.dpadd(),this.memoryWriteFunction(a,this.oLSR(this.memoryReadFunction(a)));break;case 6:a=this.dpadd(),this.memoryWriteFunction(a,this.oROR(this.memoryReadFunction(a)));break;case 7:a=this.dpadd(),this.memoryWriteFunction(a,this.oASR(this.memoryReadFunction(a)));break;case 8:a=this.dpadd(),this.memoryWriteFunction(a,this.oASL(this.memoryReadFunction(a)));break;case 9:a=this.dpadd(),this.memoryWriteFunction(a,this.oROL(this.memoryReadFunction(a)));break;case 10:a=this.dpadd(),this.memoryWriteFunction(a,this.oDEC(this.memoryReadFunction(a)));break;case 12:a=this.dpadd(),this.memoryWriteFunction(a,this.oINC(this.memoryReadFunction(a)));break;case 13:a=this.dpadd(),C=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[C];break;case 14:a=this.dpadd(),this.regPC=a;break;case 15:a=this.dpadd(),this.memoryWriteFunction(a,0),this.regCC&=~(e|h|s),this.regCC|=i;break;case 18:break;case 19:console.log("SYNC");break;case 22:a=this.signed16(this.fetch16()),this.regPC+=a;break;case 23:a=this.signed16(this.fetch16()),this.PUSHW(this.regPC),this.regPC+=a;break;case 25:var d=0,l=240&this.regA,m=15&this.regA;(9<m||32&this.regCC)&&(d|=6),128<l&&9<m&&(d|=96),(144<l||1&this.regCC)&&(d|=96),a=d+this.regA,this.regCC&=~(e|h|i|s),256&a&&(this.regCC|=e),this.regA=255&a,this.regCC|=g[this.regA];break;case 26:this.regCC|=this.fetch();break;case 28:this.regCC&=this.fetch();break;case 29:this.regA=128&this.regB?255:0,this.flagsNZ16(this.getD()),this.regCC&=~s;break;case 30:C=this.fetch(),this.TFREXG(C,!0);break;case 31:C=this.fetch(),this.TFREXG(C,!1);break;case 32:a=this.signed(this.fetch()),this.regPC+=a;break;case 33:a=this.signed(this.fetch());break;case 34:a=this.signed(this.fetch()),this.regCC&(e|i)||(this.regPC+=a);break;case 35:a=this.signed(this.fetch()),this.regCC&(e|i)&&(this.regPC+=a);break;case 36:a=this.signed(this.fetch()),this.regCC&e||(this.regPC+=a);break;case 37:a=this.signed(this.fetch()),this.regCC&e&&(this.regPC+=a);break;case 38:a=this.signed(this.fetch()),this.regCC&i||(this.regPC+=a);break;case 39:a=this.signed(this.fetch()),this.regCC&i&&(this.regPC+=a);break;case 40:a=this.signed(this.fetch()),this.regCC&s||(this.regPC+=a);break;case 41:a=this.signed(this.fetch()),this.regCC&s&&(this.regPC+=a);break;case 42:a=this.signed(this.fetch()),this.regCC&h||(this.regPC+=a);break;case 43:a=this.signed(this.fetch()),this.regCC&h&&(this.regPC+=a);break;case 44:a=this.signed(this.fetch()),this.regCC&h^(this.regCC&s)<<2||(this.regPC+=a);break;case 45:a=this.signed(this.fetch()),this.regCC&h^(this.regCC&s)<<2&&(this.regPC+=a);break;case 46:a=this.signed(this.fetch()),this.regCC&h^(this.regCC&s)<<2||this.regCC&i||(this.regPC+=a);break;case 47:a=this.signed(this.fetch()),(this.regCC&h^(this.regCC&s)<<2||this.regCC&i)&&(this.regPC+=a);break;case 48:this.regX=this.PostByte(),0===this.regX?this.regCC|=i:this.regCC&=~i;break;case 49:this.regY=this.PostByte(),0===this.regY?this.regCC|=i:this.regCC&=~i;break;case 50:this.regS=this.PostByte();break;case 51:this.regU=this.PostByte();break;case 52:this.PSHS(this.fetch());break;case 53:this.PULS(this.fetch());break;case 54:this.PSHU(this.fetch());break;case 55:this.PULU(this.fetch());break;case 57:this.regPC=this.PULLW();break;case 58:this.regX+=this.regB;break;case 59:this.regCC=this.PULLB(),this.regCC&n&&(this.tickCount+=9,this.regA=this.PULLB(),this.regB=this.PULLB(),this.regDP=this.PULLB(),this.regX=this.PULLW(),this.regY=this.PULLW(),this.regU=this.PULLW()),this.regPC=this.PULLW();break;case 60:console.log("CWAI might be broken!"),this.regCC&=this.fetch();break;case 61:0===(a=this.regA*this.regB)?this.regCC|=i:this.regCC&=~i,128&a?this.regCC|=e:this.regCC&=~e,this.setD(a);break;case 63:console.log("swi"),this.regCC|=n,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=r|o,this.regPC=this.ReadWord(65530);break;case 64:this.regA=this.oNEG(this.regA);break;case 67:this.regA=this.oCOM(this.regA);break;case 68:this.regA=this.oLSR(this.regA);break;case 70:this.regA=this.oROR(this.regA);break;case 71:this.regA=this.oASR(this.regA);break;case 72:this.regA=this.oASL(this.regA);break;case 73:this.regA=this.oROL(this.regA);break;case 74:this.regA=this.oDEC(this.regA);break;case 76:this.regA=this.oINC(this.regA);break;case 77:this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 79:this.regA=0,this.regCC&=~(h|s|e),this.regCC|=i;break;case 80:this.regB=this.oNEG(this.regB);break;case 83:this.regB=this.oCOM(this.regB);break;case 84:this.regB=this.oLSR(this.regB);break;case 86:this.regB=this.oROR(this.regB);break;case 87:this.regB=this.oASR(this.regB);break;case 88:this.regB=this.oASL(this.regB);break;case 89:this.regB=this.oROL(this.regB);break;case 90:this.regB=this.oDEC(this.regB);break;case 92:this.regB=this.oINC(this.regB);break;case 93:this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 95:this.regB=0,this.regCC&=~(h|s|e),this.regCC|=i;break;case 96:a=this.PostByte(),this.memoryWriteFunction(a,this.oNEG(this.memoryReadFunction(a)));break;case 99:a=this.PostByte(),this.memoryWriteFunction(a,this.oCOM(this.memoryReadFunction(a)));break;case 100:a=this.PostByte(),this.memoryWriteFunction(a,this.oLSR(this.memoryReadFunction(a)));break;case 102:a=this.PostByte(),this.memoryWriteFunction(a,this.oROR(this.memoryReadFunction(a)));break;case 103:a=this.PostByte(),this.memoryWriteFunction(a,this.oASR(this.memoryReadFunction(a)));break;case 104:a=this.PostByte(),this.memoryWriteFunction(a,this.oASL(this.memoryReadFunction(a)));break;case 105:a=this.PostByte(),this.memoryWriteFunction(a,this.oROL(this.memoryReadFunction(a)));break;case 106:a=this.PostByte(),this.memoryWriteFunction(a,this.oDEC(this.memoryReadFunction(a)));break;case 108:a=this.PostByte(),this.memoryWriteFunction(a,this.oINC(this.memoryReadFunction(a)));break;case 109:a=this.PostByte(),C=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[C];break;case 110:a=this.PostByte(),this.regPC=a;break;case 111:a=this.PostByte(),this.memoryWriteFunction(a,0),this.regCC&=~(e|h|s),this.regCC|=i;break;case 112:a=this.fetch16(),this.memoryWriteFunction(a,this.oNEG(this.memoryReadFunction(a)));break;case 115:a=this.fetch16(),this.memoryWriteFunction(a,this.oCOM(this.memoryReadFunction(a)));break;case 116:a=this.fetch16(),this.memoryWriteFunction(a,this.oLSR(this.memoryReadFunction(a)));break;case 118:a=this.fetch16(),this.memoryWriteFunction(a,this.oROR(this.memoryReadFunction(a)));break;case 119:a=this.fetch16(),this.memoryWriteFunction(a,this.oASR(this.memoryReadFunction(a)));break;case 120:a=this.fetch16(),this.memoryWriteFunction(a,this.oASL(this.memoryReadFunction(a)));break;case 121:a=this.fetch16(),this.memoryWriteFunction(a,this.oROL(this.memoryReadFunction(a)));break;case 122:a=this.fetch16(),this.memoryWriteFunction(a,this.oDEC(this.memoryReadFunction(a)));break;case 124:a=this.fetch16(),this.memoryWriteFunction(a,this.oINC(this.memoryReadFunction(a)));break;case 125:a=this.fetch16(),C=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[C];break;case 126:a=this.fetch16(),this.regPC=a;break;case 127:a=this.fetch16(),this.memoryWriteFunction(a,0),this.regCC&=~(e|h|s),this.regCC|=i;break;case 128:this.regA=this.oSUB(this.regA,this.fetch());break;case 129:this.oCMP(this.regA,this.fetch());break;case 130:this.regA=this.oSBC(this.regA,this.fetch());break;case 131:this.setD(this.oSUB16(this.getD(),this.fetch16()));break;case 132:this.regA=this.oAND(this.regA,this.fetch());break;case 133:this.oAND(this.regA,this.fetch());break;case 134:this.regA=this.fetch(),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 136:this.regA=this.oEOR(this.regA,this.fetch());break;case 137:this.regA=this.oADC(this.regA,this.fetch());break;case 138:this.regA=this.oOR(this.regA,this.fetch());break;case 139:this.regA=this.oADD(this.regA,this.fetch());break;case 140:this.oCMP16(this.regX,this.fetch16());break;case 141:a=this.signed(this.fetch()),this.PUSHW(this.regPC),this.regPC+=a;break;case 142:this.regX=this.fetch16(),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 144:a=this.dpadd(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(a));break;case 145:a=this.dpadd(),this.oCMP(this.regA,this.memoryReadFunction(a));break;case 146:a=this.dpadd(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(a));break;case 147:a=this.dpadd(),this.setD(this.oSUB16(this.getD(),this.ReadWord(a)));break;case 148:a=this.dpadd(),this.regA=this.oAND(this.regA,this.memoryReadFunction(a));break;case 149:a=this.dpadd(),this.oAND(this.regA,this.memoryReadFunction(a));break;case 150:a=this.dpadd(),this.regA=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 151:a=this.dpadd(),this.memoryWriteFunction(a,this.regA),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 152:a=this.dpadd(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(a));break;case 153:a=this.dpadd(),this.regA=this.oADC(this.regA,this.memoryReadFunction(a));break;case 154:a=this.dpadd(),this.regA=this.oOR(this.regA,this.memoryReadFunction(a));break;case 155:a=this.dpadd(),this.regA=this.oADD(this.regA,this.memoryReadFunction(a));break;case 156:a=this.dpadd(),this.oCMP16(this.regX,this.ReadWord(a));break;case 157:a=this.dpadd(),this.PUSHW(this.regPC),this.regPC=a;break;case 158:a=this.dpadd(),this.regX=this.ReadWord(a),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 159:a=this.dpadd(),this.WriteWord(a,this.regX),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 160:a=this.PostByte(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(a));break;case 161:a=this.PostByte(),this.oCMP(this.regA,this.memoryReadFunction(a));break;case 162:a=this.PostByte(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(a));break;case 163:a=this.PostByte(),this.setD(this.oSUB16(this.getD(),this.ReadWord(a)));break;case 164:a=this.PostByte(),this.regA=this.oAND(this.regA,this.memoryReadFunction(a));break;case 165:a=this.PostByte(),this.oAND(this.regA,this.memoryReadFunction(a));break;case 166:a=this.PostByte(),this.regA=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 167:a=this.PostByte(),this.memoryWriteFunction(a,this.regA),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 168:a=this.PostByte(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(a));break;case 169:a=this.PostByte(),this.regA=this.oADC(this.regA,this.memoryReadFunction(a));break;case 170:a=this.PostByte(),this.regA=this.oOR(this.regA,this.memoryReadFunction(a));break;case 171:a=this.PostByte(),this.regA=this.oADD(this.regA,this.memoryReadFunction(a));break;case 172:a=this.PostByte(),this.oCMP16(this.regX,this.ReadWord(a));break;case 173:a=this.PostByte(),this.PUSHW(this.regPC),this.regPC=a;break;case 174:a=this.PostByte(),this.regX=this.ReadWord(a),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 175:a=this.PostByte(),this.WriteWord(a,this.regX),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 176:a=this.fetch16(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(a));break;case 177:a=this.fetch16(),this.oCMP(this.regA,this.memoryReadFunction(a));break;case 178:a=this.fetch16(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(a));break;case 179:a=this.fetch16(),this.setD(this.oSUB16(this.getD(),this.ReadWord(a)));break;case 180:a=this.fetch16(),this.regA=this.oAND(this.regA,this.memoryReadFunction(a));break;case 181:a=this.fetch16(),this.oAND(this.regA,this.memoryReadFunction(a));break;case 182:a=this.fetch16(),this.regA=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 183:a=this.fetch16(),this.memoryWriteFunction(a,this.regA),this.regCC&=~(i|h|s),this.regCC|=g[this.regA];break;case 184:a=this.fetch16(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(a));break;case 185:a=this.fetch16(),this.regA=this.oADC(this.regA,this.memoryReadFunction(a));break;case 186:a=this.fetch16(),this.regA=this.oOR(this.regA,this.memoryReadFunction(a));break;case 187:a=this.fetch16(),this.regA=this.oADD(this.regA,this.memoryReadFunction(a));break;case 188:a=this.fetch16(),this.oCMP16(this.regX,this.ReadWord(a));break;case 189:a=this.fetch16(),this.PUSHW(this.regPC),this.regPC=a;break;case 190:a=this.fetch16(),this.regX=this.ReadWord(a),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 191:a=this.fetch16(),this.WriteWord(a,this.regX),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 192:this.regB=this.oSUB(this.regB,this.fetch());break;case 193:this.oCMP(this.regB,this.fetch());break;case 194:this.regB=this.oSBC(this.regB,this.fetch());break;case 195:this.setD(this.oADD16(this.getD(),this.fetch16()));break;case 196:this.regB=this.oAND(this.regB,this.fetch());break;case 197:this.oAND(this.regB,this.fetch());break;case 198:this.regB=this.fetch(),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 200:this.regB=this.oEOR(this.regB,this.fetch());break;case 201:this.regB=this.oADC(this.regB,this.fetch());break;case 202:this.regB=this.oOR(this.regB,this.fetch());break;case 203:this.regB=this.oADD(this.regB,this.fetch());break;case 204:a=this.fetch16(),this.setD(a),this.flagsNZ16(a),this.regCC&=~s;break;case 206:this.regU=this.fetch16(),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 208:a=this.dpadd(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(a));break;case 209:a=this.dpadd(),this.oCMP(this.regB,this.memoryReadFunction(a));break;case 210:a=this.dpadd(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(a));break;case 211:a=this.dpadd(),this.setD(this.oADD16(this.getD(),this.ReadWord(a)));break;case 212:a=this.dpadd(),this.regB=this.oAND(this.regB,this.memoryReadFunction(a));break;case 213:a=this.dpadd(),this.oAND(this.regB,this.memoryReadFunction(a));break;case 214:a=this.dpadd(),this.regB=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 215:a=this.dpadd(),this.memoryWriteFunction(a,this.regB),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 216:a=this.dpadd(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(a));break;case 217:a=this.dpadd(),this.regB=this.oADC(this.regB,this.memoryReadFunction(a));break;case 218:a=this.dpadd(),this.regB=this.oOR(this.regB,this.memoryReadFunction(a));break;case 219:a=this.dpadd(),this.regB=this.oADD(this.regB,this.memoryReadFunction(a));break;case 220:a=this.dpadd(),C=this.ReadWord(a),this.setD(C),this.flagsNZ16(C),this.regCC&=~s;break;case 221:a=this.dpadd(),this.WriteWord(a,this.getD()),this.regCC&=~s;break;case 222:a=this.dpadd(),this.regU=this.ReadWord(a),this.flagsNZ16(this.regX),this.regCC&=~s;break;case 223:a=this.dpadd(),this.WriteWord(a,this.regU),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 224:a=this.PostByte(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(a));break;case 225:a=this.PostByte(),this.oCMP(this.regB,this.memoryReadFunction(a));break;case 226:a=this.PostByte(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(a));break;case 227:a=this.PostByte(),this.setD(this.oADD16(this.getD(),this.ReadWord(a)));break;case 228:a=this.PostByte(),this.regB=this.oAND(this.regB,this.memoryReadFunction(a));break;case 229:a=this.PostByte(),this.oAND(this.regB,this.memoryReadFunction(a));break;case 230:a=this.PostByte(),this.regB=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 231:a=this.PostByte(),this.memoryWriteFunction(a,this.regB),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 232:a=this.PostByte(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(a));break;case 233:a=this.PostByte(),this.regB=this.oADC(this.regB,this.memoryReadFunction(a));break;case 234:a=this.PostByte(),this.regB=this.oOR(this.regB,this.memoryReadFunction(a));break;case 235:a=this.PostByte(),this.regB=this.oADD(this.regB,this.memoryReadFunction(a));break;case 236:a=this.PostByte(),C=this.ReadWord(a),this.setD(C),this.flagsNZ16(C),this.regCC&=~s;break;case 237:a=this.PostByte(),this.WriteWord(a,this.getD()),this.regCC&=~s;break;case 238:a=this.PostByte(),this.regU=this.ReadWord(a),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 239:a=this.PostByte(),this.WriteWord(a,this.regU),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 240:a=this.fetch16(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(a));break;case 241:a=this.fetch16(),this.oCMP(this.regB,this.memoryReadFunction(a));break;case 242:a=this.fetch16(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(a));break;case 243:a=this.fetch16(),this.setD(this.oADD16(this.getD(),this.ReadWord(a)));break;case 244:a=this.fetch16(),this.regB=this.oAND(this.regB,this.memoryReadFunction(a));break;case 245:a=this.fetch16(),this.oAND(this.regB,this.memoryReadFunction(a));break;case 246:a=this.fetch16(),this.regB=this.memoryReadFunction(a),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 247:a=this.fetch16(),this.memoryWriteFunction(a,this.regB),this.regCC&=~(i|h|s),this.regCC|=g[this.regB];break;case 248:a=this.fetch16(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(a));break;case 249:a=this.fetch16(),this.regB=this.oADC(this.regB,this.memoryReadFunction(a));break;case 250:a=this.fetch16(),this.regB=this.oOR(this.regB,this.memoryReadFunction(a));break;case 251:a=this.fetch16(),this.regB=this.oADD(this.regB,this.memoryReadFunction(a));break;case 252:a=this.fetch16(),C=this.ReadWord(a),this.setD(C),this.flagsNZ16(C),this.regCC&=~s;break;case 253:a=this.fetch16(),this.WriteWord(a,this.getD()),this.regCC&=~s;break;case 254:a=this.fetch16(),this.regU=this.ReadWord(a),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 255:a=this.fetch16(),this.WriteWord(a,this.regU),this.flagsNZ16(this.regU),this.regCC&=~s;break;case 16:switch(_=this.fetch(),this.tickCount+=u[_],_){case 33:a=this.signed16(this.fetch16());break;case 34:a=this.signed16(this.fetch16()),this.regCC&(e|i)||(this.regPC+=a);break;case 35:a=this.signed16(this.fetch16()),this.regCC&(e|i)&&(this.regPC+=a);break;case 36:a=this.signed16(this.fetch16()),this.regCC&e||(this.regPC+=a);break;case 37:a=this.signed16(this.fetch16()),this.regCC&e&&(this.regPC+=a);break;case 38:a=this.signed16(this.fetch16()),this.regCC&i||(this.regPC+=a);break;case 39:a=this.signed16(this.fetch16()),this.regCC&i&&(this.regPC+=a);break;case 40:a=this.signed16(this.fetch16()),this.regCC&s||(this.regPC+=a);break;case 41:a=this.signed16(this.fetch16()),this.regCC&s&&(this.regPC+=a);break;case 42:a=this.signed16(this.fetch16()),this.regCC&h||(this.regPC+=a);break;case 43:a=this.signed16(this.fetch16()),this.regCC&h&&(this.regPC+=a);break;case 44:a=this.signed16(this.fetch16()),this.regCC&h^(this.regCC&s)<<2||(this.regPC+=a);break;case 45:a=this.signed16(this.fetch16()),this.regCC&h^(this.regCC&s)<<2&&(this.regPC+=a);break;case 46:a=this.signed16(this.fetch16()),this.regCC&h^(this.regCC&s)<<2||this.regCC&i||(this.regPC+=a);break;case 47:a=this.signed16(this.fetch16()),(this.regCC&h^(this.regCC&s)<<2||this.regCC&i)&&(this.regPC+=a);break;case 63:this.regCC|=n,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=r|o,this.regPC=this.ReadWord(65524);break;case 131:this.oCMP16(this.getD(),this.fetch16());break;case 140:this.oCMP16(this.regY,this.fetch16());break;case 142:this.regY=this.fetch16(),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 147:a=this.dpadd(),this.oCMP16(this.getD(),this.ReadWord(a));break;case 156:a=this.dpadd(),this.oCMP16(this.regY,this.ReadWord(a));break;case 158:a=this.dpadd(),this.regY=this.ReadWord(a),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 159:a=this.dpadd(),this.WriteWord(a,this.regY),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 163:a=this.PostByte(),this.oCMP16(this.getD(),this.ReadWord(a));break;case 172:a=this.PostByte(),this.oCMP16(this.regY,this.ReadWord(a));break;case 174:a=this.PostByte(),this.regY=this.ReadWord(a),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 175:a=this.PostByte(),this.WriteWord(a,this.regY),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 179:a=this.fetch16(),this.oCMP16(this.getD(),this.ReadWord(a));break;case 188:a=this.fetch16(),this.oCMP16(this.regY,this.ReadWord(a));break;case 190:a=this.fetch16(),this.regY=this.ReadWord(a),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 191:a=this.fetch16(),this.WriteWord(a,this.regY),this.flagsNZ16(this.regY),this.regCC&=~s;break;case 206:this.regS=this.fetch16(),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 222:a=this.dpadd(),this.regS=this.ReadWord(a),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 223:a=this.dpadd(),this.WriteWord(a,this.regS),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 238:a=this.PostByte(),this.regS=this.ReadWord(a),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 239:a=this.PostByte(),this.WriteWord(a,this.regS),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 254:a=this.fetch16(),this.regS=this.ReadWord(a),this.flagsNZ16(this.regS),this.regCC&=~s;break;case 255:a=this.fetch16(),this.WriteWord(a,this.regS),this.flagsNZ16(this.regS),this.regCC&=~s;break;default:throw new Error("CPU_OPCODE_INVALID_PAGE1_"+_)}break;case 17:switch(_=this.fetch(),this.tickCount+=u[_],_){case 63:this.regCC|=n,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=r|o,this.regPC=this.ReadWord(65522);break;case 131:this.oCMP16(this.regU,this.fetch16());break;case 140:this.oCMP16(this.regS,this.fetch16());break;case 147:a=this.dpadd(),this.oCMP16(this.regU,this.ReadWord(a));break;case 156:a=this.dpadd(),this.oCMP16(this.regS,this.ReadWord(a));break;case 163:a=this.PostByte(),this.oCMP16(this.regU,this.ReadWord(a));break;case 172:a=this.PostByte(),this.oCMP16(this.regS,this.ReadWord(a));break;case 179:a=this.fetch16(),this.oCMP16(this.regU,this.ReadWord(a));break;case 188:a=this.fetch16(),this.oCMP16(this.regS,this.ReadWord(a));break;default:throw new Error("CPU_OPCODE_INVALID_PAGE2_"+_)}}return this.regA&=255,this.regB&=255,this.regCC&=255,this.regDP&=255,this.regX&=65535,this.regY&=65535,this.regU&=65535,this.regS&=65535,this.regPC&=65535,this.tickCount-t}reset(){this.regDP=0,this.irqPendingIRQ=!1,this.irqPendingFIRQ=!1,this.irqPendingNMI=!1,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.regCC=r|o,this.regPC=this.ReadWord(65534),this.tickCount=0}_executeNmi(){this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=n,this.PUSHB(this.regCC),this.regCC|=r|o,this.regPC=this.ReadWord(65532),this.tickCount+=19}_executeFirq(){this.PUSHW(this.regPC),this.regCC&=~n,this.PUSHB(this.regCC),this.regCC|=r|o,this.regPC=this.ReadWord(65526),this.tickCount+=10}_executeIrq(){this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=n,this.PUSHB(this.regCC),this.regCC|=r,this.regPC=this.ReadWord(65528),this.tickCount+=19}steps(t=1){const e=this.tickCount;for(;0<t;)t-=this.step();return this.tickCount-e}status(){return{pc:this.regPC,sp:this.regS,u:this.regU,a:this.regA,b:this.regB,x:this.regX,y:this.regY,dp:this.regDP,flags:this.regCC,irqPendingNMI:this.irqPendingNMI,irqPendingFIRQ:this.irqPendingFIRQ,irqPendingIRQ:this.irqPendingIRQ,missedIRQ:this.missedIRQ,missedFIRQ:this.missedFIRQ,irqCount:this.irqCount,firqCount:this.firqCount,nmiCount:this.nmiCount}}irq(){this.irqPendingIRQ&&this.missedIRQ++,this.irqPendingIRQ=!0}clearIrqMasking(){this.regCC&=~r}firq(){this.irqPendingFIRQ&&this.missedFIRQ++,this.irqPendingFIRQ=!0}clearFirqMasking(){this.regCC&=~o}nmi(){this.irqPendingNMI=!0}set(t,e){switch(t.toUpperCase()){case"PC":this.reg=e;break;case"A":this.regA=e;break;case"B":this.regB=e;break;case"X":this.regX=e;break;case"Y":this.regY=e;break;case"SP":this.regS=e;break;case"U":this.regU=e;break;case"FLAGS":this.regCC=e}}flagsToString(){const t="EFHINZVC";for(var e="",s=0;8>s;s++)e+=0===(this.regCC&128>>s)?t[s].toLowerCase():t[s];return e}}},function(t,e,s){"use strict";(function(e){const i=s(5),h=s(7);t.exports={initVMwithRom:function(t,e){return i.parse(t,e).then(t=>new class{constructor(t){this.cpuBoard=h.getInstance(t)}start(){this.startTime=Date.now(),this.cpuBoard.start()}getUiState(){const t=this.cpuBoard.getUiState(),e=Date.now()-this.startTime;return t.opsMs=parseInt(t.ticks/e,10),t.runtime=e,t}registerAudioConsumer(t){this.cpuBoard.registerDacCallback(t)}mixStereo(t,e,s){}executeCycle(t=500,e=4){return this.cpuBoard.executeCycle(t,e)}setCabinetInput(t){this.cpuBoard.setCabinetInput(t)}setInput(t){this.cpuBoard.setInput(t)}setFliptronicsInput(t){this.cpuBoard.setFliptronicsInput(t)}reset(){this.startTime=Date.now(),this.cpuBoard.reset()}}(t))}};e.on("uncaughtException",t=>{console.error("UNCAUGHT_EXCEPTION",{error:t.message})}),e.on("unhandledRejection",t=>{console.error("UNHANDLED_REJECTION",{msg:t.message,stack:t.stack})})}).call(this,s(4))},function(t){function e(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function i(t){if(n===setTimeout)return setTimeout(t,0);if((n===e||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}function h(){_&&g&&(_=!1,g.length?C=g.concat(C):d=-1,C.length&&r())}function r(){if(!_){var t=i(h);_=!0;for(var e=C.length;e;){for(g=C,C=[];++d<e;)g&&g[d].run();d=-1,e=C.length}g=null,_=!1,function(t){if(c===clearTimeout)return clearTimeout(t);if((c===s||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(t);try{c(t)}catch(e){try{return c.call(null,t)}catch(e){return c.call(this,t)}}}(t)}}function a(t,e){this.fun=t,this.array=e}function o(){}var n,c,u=t.exports={};!function(){try{n="function"==typeof setTimeout?setTimeout:e}catch(t){n=e}try{c="function"==typeof clearTimeout?clearTimeout:s}catch(t){c=s}}();var g,C=[],_=!1,d=-1;u.nextTick=function(t){var e=Array(arguments.length-1);if(1<arguments.length)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];C.push(new a(t,e)),1!==C.length||_||i(r)},a.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=o,u.addListener=o,u.once=o,u.off=o,u.removeListener=o,u.removeAllListeners=o,u.emit=o,u.prependListener=o,u.prependOnceListener=o,u.listeners=function(){return[]},u.binding=function(){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},function(t,e,s){"use strict";function i(t){const e=t.u18;return e?e.subarray(e.length-u,e.length):void 0}function h(t){if(!t.u18||!t.u15||!t.u14)return void console.log("missing sound roms");const e=524288,s=new Uint8Array(g);if(console.log("u18 rom size: %s bytes",t.u18.length),t.u18.length>e)throw new Error("U18_ROM_SIZE_EXCEEDED");if(s.set(t.u18,0),t.u15){if(console.log("u15 rom size: %s bytes",t.u15.length),t.u15.length>e)throw new Error("U15_ROM_SIZE_EXCEEDED");s.set(t.u15,e)}if(t.u14){if(console.log("u14 rom size: %s bytes",t.u14.length),t.u14.length>e)throw new Error("U14_ROM_SIZE_EXCEEDED");s.set(t.u14,2*e)}const h=i(t);return s.set(h,507904),s}function r(t){return t.subarray(t.length-c,t.length)}function a(t){return t.subarray(0,t.length-c)}const o=s(6),n=[1,2,4,8],c=32768,u=16384,g=1572864;t.exports={parse:function(t,e={}){return new Promise((s,c)=>{if("object"!=typeof t)return c(new Error("INVALID_ROM_DATA"));const u=t.u06,g=u.length/131072,C=!Number.isInteger(g),_=!n.includes(g);if(C||_)return c(new Error("INVALID_ROM_SIZE"));const d=h(t),l=i(t),m=r(u),p=a(u),S=o.search(p,m),f=Array.isArray(e.features);s({romSizeMBit:g,systemRom:m,gameRom:p,soundSystemRom:l,concatinatedSoundRom:d,gameIdMemoryLocation:S,fileName:e.fileName||"Unknown",skipWmcRomCheck:!0===e.skipWmcRomCheck,switchesEnabled:e.switchesEnabled||[],hasSecurityPic:f&&e.features.includes("securityPic")})})}}},function(t){"use strict";t.exports={search:function(t,e){let s=0;for(let i=0;i<t.length-7;i++){if(236===t[i]&&159===t[i+1]){if(131===t[i+4]&&18===t[i+5]&&52===t[i+6]&&2==++s){let s=(t[i+2]<<8)+t[i+3];const h=(e[s-=32768]<<8)+e[s+1];return console.log("GAMEID_FOUND",h),h}}}}}},function(t,e,s){"use strict";const i=s(8),h=s(9),r=s(0),a=s(10),o=s(17),n=s(21),c=s(22),u=s(23),g=s(24),C=s(26),_=s(2);t.exports={getInstance:function(t){return new class{constructor(t){this.ram=new Uint8Array(i.MEMORY_ADDR_HARDWARE),this.romSizeMBit=t.romSizeMBit,this.systemRom=t.systemRom,this.romFileName=t.fileName,this.gameRom=t.gameRom,this.memoryPatch=c.getInstance(),t.gameIdMemoryLocation&&u.run(this.memoryPatch,t.gameIdMemoryLocation);const e=this._read8.bind(this),s=this._write8.bind(this);this.cpu=_.getInstance(s,e,"cpuboard"),this.uiFacade=C.getInstance();const h={irq:this.cpu.irq,firq:()=>{this.asic.firqSourceDmd(!1),this.cpu.firq()},firqFromDmd:()=>{this.asic.firqSourceDmd(!0),this.cpu.firq()},clearIrqFlag:()=>{this.cpu.clearIrqMasking()},clearFirqFlag:()=>{this.cpu.clearFirqMasking()},reset:this.cpu.reset},r={interruptCallback:h,romSizeMBit:this.romSizeMBit,romObject:t,ram:this.ram};this.asic=a.getInstance(r),this.soundBoard=o.getInstance(r),this.dmdBoard=g.getInstance(r),this.externalIo=n.getInstance(),this.startTime=0,this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0,!0===t.skipWmcRomCheck&&this._disableWpcRomCheck()}reset(){console.log("RESET_CPU_BOARD"),this.startTime=0,this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0,this.cpu.reset(),this.asic.reset(),this.dmdBoard.reset(),this.soundBoard.reset()}getUiState(){const t=this.uiFacade.getChangedState({ram:this.ram.slice(0,i.MEMORY_ADDR_RAM),wpc:this.asic.getUiState(),dmd:this.dmdBoard.getUiState()});t.sound=this.soundBoard.getUiState();const e=this.cpu.tickCount,s=this.cpu.status();return{asic:t,romFileName:this.romFileName,ticks:e,missedIrqCall:s.missedIRQ,missedFirqCall:s.missedFIRQ,irqCount:s.irqCount,firqCount:s.firqCount,nmiCount:s.nmiCount,protectedMemoryWriteAttempts:this.protectedMemoryWriteAttempts}}setCabinetInput(t){this.asic.setCabinetInput(t)}setInput(t){this.asic.setInput(t)}setFliptronicsInput(t){this.asic.setFliptronicsInput(t)}registerDacCallback(t){this.soundBoard.registerDacCallback(t)}start(){console.log("RESET_SYSTEM"),this.reset()}mixStereo(t,e,s){this.soundBoard.mixStereo(t,e,s)}executeCycle(t,e){let s=0;for(;s<t;){const t=this.cpu.steps(e);s+=t,this.ticksIrq+=t,this.ticksIrq>=r.CALL_IRQ_AFTER_TICKS&&(this.ticksIrq-=r.CALL_IRQ_AFTER_TICKS,this.cpu.irq()),this.ticksUpdateDmd+=t,this.ticksUpdateDmd>=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS&&(this.ticksUpdateDmd-=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS,this.dmdBoard.copyScanline()),this.asic.executeCycle(t)}return this.soundBoard.executeCycle(t,e),s}_disableWpcRomCheck(){this.systemRom[32748]=0,this.systemRom[32749]=255}_read8(t){if(isNaN(t))throw new TypeError("ASIC_MEMORY_READ_BUG_DETECTED!");const e=this.memoryPatch.hasPatch(t);if(e)return e.value;const s=i.getAddress(t);switch(s.subsystem){case i.SUBSYSTEM_RAM:return this.ram[s.offset];case i.SUBSYSTEM_HARDWARE:return this._hardwareRead(s.offset);case i.SUBSYSTEM_BANKSWITCHED:return this._bankswitchedRead(s.offset);case i.SUBSYSTEM_SYSTEMROM:return this.systemRom[s.offset];default:throw new Error("INVALID_READ_SUBSYSTEM")}}_write8(t,e){if(isNaN(t))throw new TypeError("ASIC_MEMORY_WRITE_BUG_DETECTED!");if(void 0!==e){e&=255;const s=i.getAddress(t);switch(s.subsystem){case i.SUBSYSTEM_RAM:this.asic.isMemoryProtectionEnabled()||(t&this.asic.memoryProtectionMask)!==this.asic.memoryProtectionMask?this.ram[s.offset]=e:this.protectedMemoryWriteAttempts++;break;case i.SUBSYSTEM_HARDWARE:this._hardwareWrite(t,e);break;default:console.log("CPU_WRITE8_FAIL",JSON.stringify(s),t,e)}}}_bankswitchedRead(t){const e=this.asic.romBank;return e===a.SYSTEM_ROM_BANK_NUMBER1||e===a.SYSTEM_ROM_BANK_NUMBER2?this.systemRom[t]:this.gameRom[t+16384*e]}_hardwareWrite(t,e){const s=h.getAddress(t);switch(s.subsystem){case h.SUBSYSTEM_DMD:this.dmdBoard.write(t,e);break;case h.SUBSYSTEM_EXTERNAL_IO:this.externalIo.write(t,e);break;case h.SUBSYSTEM_SOUND:this.soundBoard.writeInterface(t,e);break;case h.SUBSYSTEM_WPCIO:this.asic.write(t,e);break;case h.SUBSYSTEM_EXPANSION:console.log("EXPANSION_WRITE_NOT_IMPL",{offset:t,value:e});break;default:throw console.log(JSON.stringify(s)),new Error("CPUBOARD_INVALID_HW_WRITE")}}_hardwareRead(t){const e=h.getAddress(t);switch(e.subsystem){case h.SUBSYSTEM_DMD:return this.dmdBoard.read(t);case h.SUBSYSTEM_EXTERNAL_IO:return this.externalIo.read(t);case h.SUBSYSTEM_SOUND:return this.soundBoard.readInterface(t);case h.SUBSYSTEM_WPCIO:return this.asic.read(t);case h.SUBSYSTEM_EXPANSION:return 0;default:throw console.log(JSON.stringify(e)),new Error("INVALID_HW_READ")}}}(t)}}},function(t){"use strict";function e(t,e){return{offset:t,subsystem:e}}const s="hardware",i="bank",h="system";t.exports={getAddress:function(t){if(void 0===t)throw new Error("MEMORY_GET_ADDRESS_UNDEFINED");if((t&=65535)>=15360&&t<=16303||t<8192)return e(t,"ram");if(t<16384)return e(t,s);if(t<32768)return e(t-16384,i);if(t<65536)return e(t-32768,h);throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},MEMORY_ADDR_RAM:8192,MEMORY_ADDR_HARDWARE:16384,SUBSYSTEM_RAM:"ram",SUBSYSTEM_HARDWARE:s,SUBSYSTEM_BANKSWITCHED:i,SUBSYSTEM_SYSTEMROM:h}},function(t){"use strict";function e(t,e){return{offset:t,subsystem:e}}const s="wpcio",i="sound",h="externalIo",r="expansion";t.exports={getAddress:function(t){if(void 0===t)throw new Error("HW_GET_ADDRESS_UNDEFINED");if((t&=65535)<8192)throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16));if(t<14336)return e(t,r);if(t<16320)return e(t,"dmd");if(16340===t)return e(t,s);if(t<16348)return e(t,h);if(t<16352)return e(t,i);if(t<16384)return e(t,s);throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},SUBSYSTEM_WPCIO:s,SUBSYSTEM_SOUND:i,SUBSYSTEM_EXTERNAL_IO:h,SUBSYSTEM_DMD:"dmd",SUBSYSTEM_EXPANSION:r}},function(t,e,s){"use strict";const i=s(0),h=s(11),r=s(12),a=s(13),o=s(14),n=s(15),c=s(16),u={WPC_FLIPTRONICS_FLIPPER_PORT_A:16340,WPC_SOLENOID_GEN_OUTPUT:16352,WPC_SOLENOID_HIGHPOWER_OUTPUT:16353,WPC_SOLENOID_FLASH1_OUTPUT:16354,WPC_SOLENOID_LOWPOWER_OUTPUT:16355,WPC_LAMP_ROW_OUTPUT:16356,WPC_LAMP_COL_STROBE:16357,WPC_GI_TRIAC:16358,WPC_SW_JUMPER_INPUT:16359,WPC_SWITCH_CABINET_INPUT:16360,WPC_SWITCH_ROW_SELECT:16361,WPC_SWITCH_COL_SELECT:16362,WPC_PICREAD:16361,WPC_PICWRITE:16362,WPC_EXTBOARD1:16363,WPC_EXTBOARD2:16364,WPC_EXTBOARD3:16365,WPC_EXTBOARD4:16366,WPC_EXTBOARD5:16367,WPC_LEDS:16370,WPC_RAM_BANK:16371,WPC_SHIFTADDRH:16372,WPC_SHIFTADDRL:16373,WPC_SHIFTBIT:16374,WPC_SHIFTBIT2:16375,WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:16376,WPC_ROM_LOCK:16377,WPC_CLK_HOURS_DAYS:16378,WPC_CLK_MINS:16379,WPC_ROM_BANK:16380,WPC_RAM_LOCK:16381,WPC_RAM_LOCKSIZE:16382,WPC_ZEROCROSS_IRQ_CLEAR:16383},g=[];Object.keys(u).forEach(t=>{g[u[t]]=t});const C=[0,7,15,0,31,0,0,0,63],_=62,d=63;t.exports={getInstance:function(t){return new class{constructor(t){this.interruptCallback=t.interruptCallback,this.pageMask=C[t.romSizeMBit],this.ram=t.ram,this.hardwareHasPic=t.romObject&&t.romObject.hasSecurityPic,this.inputSwitchMatrix=h.getInstance(),this.outputLampMatrix=r.getInstance(i.CALL_UPDATELAMP_AFTER_TICKS),this.outputSolenoidMatrix=a.getInstance(i.CALL_UPDATESOLENOID_AFTER_TICKS),this.outputGeneralIllumination=o.getInstance(),this.securityPic=c.getInstance()}reset(){console.log("RESET_ASIC"),this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._firqSourceDmd=!1,this.ticksZeroCross=0,this.hardwareHasPic&&this.securityPic.reset()}getUiState(){const t=this.ram[u.WPC_LEDS];return{diagnosticLed:t,lampState:this.outputLampMatrix.lampState,solenoidState:this.outputSolenoidMatrix.solenoidState,generalIlluminationState:this.outputGeneralIllumination.generalIlluminationState,inputState:this.inputSwitchMatrix.switchState,diagnosticLedToggleCount:this.diagnosticLedToggleCount,irqEnabled:this.periodicIRQTimerEnabled,activeRomBank:this.romBank}}setZeroCrossFlag(){this.zeroCrossFlag=1}setCabinetInput(t){this.inputSwitchMatrix.setCabinetKey(255&t)}setInput(t){this.inputSwitchMatrix.setInputKey(255&t)}setFliptronicsInput(t){this.inputSwitchMatrix.setFliptronicsInput(t)}firqSourceDmd(t){this._firqSourceDmd=!0===t}executeCycle(t){this.ticksZeroCross+=t,this.ticksZeroCross>=i.CALL_ZEROCLEAR_AFTER_TICKS&&(this.ticksZeroCross-=i.CALL_ZEROCLEAR_AFTER_TICKS,this.setZeroCrossFlag()),this.outputLampMatrix.executeCycle(t),this.outputSolenoidMatrix.executeCycle(t)}isMemoryProtectionEnabled(){return 180===this.ram[u.WPC_RAM_LOCK]}write(t,e){switch(this.ram[t]=e,t){case u.WPC_RAM_LOCK:case u.WPC_RAM_BANK:case u.WPC_CLK_HOURS_DAYS:case u.WPC_CLK_MINS:case u.WPC_SHIFTADDRH:case u.WPC_SHIFTADDRL:case u.WPC_SHIFTBIT:case u.WPC_SHIFTBIT2:case u.WPC_ROM_LOCK:case u.WPC_EXTBOARD1:case u.WPC_EXTBOARD2:case u.WPC_EXTBOARD3:case u.WPC_EXTBOARD4:case u.WPC_EXTBOARD5:case u.WPC_FLIPTRONICS_FLIPPER_PORT_A:break;case u.WPC_RAM_LOCKSIZE:this.isMemoryProtectionEnabled()&&(this.memoryProtectionMask=n.getMemoryProtectionMask(e));break;case u.WPC_SWITCH_COL_SELECT:if(this.hardwareHasPic)return this.securityPic.write(e);this.inputSwitchMatrix.setActiveColumn(e);break;case u.WPC_GI_TRIAC:this.outputGeneralIllumination.update(e);break;case u.WPC_LAMP_ROW_OUTPUT:this.outputLampMatrix.setActiveRow(e);break;case u.WPC_LAMP_COL_STROBE:this.outputLampMatrix.setActiveColumn(e);break;case u.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:break;case u.WPC_SOLENOID_GEN_OUTPUT:case u.WPC_SOLENOID_HIGHPOWER_OUTPUT:case u.WPC_SOLENOID_FLASH1_OUTPUT:case u.WPC_SOLENOID_LOWPOWER_OUTPUT:this.outputSolenoidMatrix.setActive(t,e);break;case u.WPC_LEDS:e!==this.oldDiagnostigLedState&&(this.diagnosticLedToggleCount++,this.oldDiagnostigLedState=e);break;case u.WPC_ROM_BANK:if(e===_||e===d)return void(this.romBank=e);this.romBank=e&this.pageMask;break;case u.WPC_ZEROCROSS_IRQ_CLEAR:{128&e&&this.interruptCallback.clearIrqFlag();const t=0<(16&e);t!==this.periodicIRQTimerEnabled&&(this.periodicIRQTimerEnabled=t);break}default:console.log("W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){let e;return t===u.WPC_LEDS||t===u.WPC_ROM_LOCK||t===u.WPC_EXTBOARD1||t===u.WPC_EXTBOARD2||t===u.WPC_EXTBOARD3||t===u.WPC_EXTBOARD4||t===u.WPC_EXTBOARD5?this.ram[t]:t===u.WPC_FLIPTRONICS_FLIPPER_PORT_A?this.inputSwitchMatrix.getFliptronicsKeys():t===u.WPC_RAM_LOCK||t===u.WPC_RAM_LOCKSIZE?this.ram[t]:t===u.WPC_SWITCH_CABINET_INPUT?this.inputSwitchMatrix.getCabinetKey():t===u.WPC_ROM_BANK?this.ram[t]&this.pageMask:t===u.WPC_SWITCH_ROW_SELECT?this.hardwareHasPic?this.securityPic.read(t=>this.inputSwitchMatrix.getRow(t)):this.inputSwitchMatrix.getActiveRow():t===u.WPC_SHIFTADDRH?e=255&this.ram[u.WPC_SHIFTADDRH]+(this.ram[u.WPC_SHIFTADDRL]+(this.ram[u.WPC_SHIFTBIT]>>>3)>>>8):t===u.WPC_SHIFTADDRL?e=255&this.ram[u.WPC_SHIFTADDRL]+(this.ram[u.WPC_SHIFTBIT]>>>3):t===u.WPC_SHIFTBIT||t===u.WPC_SHIFTBIT2?1<<(7&this.ram[t]):t===u.WPC_CLK_HOURS_DAYS?(e=new Date).getHours():t===u.WPC_CLK_MINS?(e=new Date).getMinutes():t===u.WPC_SW_JUMPER_INPUT?252:t===u.WPC_ZEROCROSS_IRQ_CLEAR?(e=this.zeroCrossFlag<<7|127&this.ram[t],this.zeroCrossFlag=0,e):t===u.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR?!0===this._firqSourceDmd?0:128:(console.log("R_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t])}}(t)},SYSTEM_ROM_BANK_NUMBER1:_,SYSTEM_ROM_BANK_NUMBER2:d,OP:u}},function(t,e,s){"use strict";const i=s(1);t.exports={getInstance:function(){return new class{constructor(){this.cabinetKeyState=h,this.cabinetKeyAutoreleaseTs=0,this.switchState=new Uint8Array(10).fill(h),this.setInputKey(24),this.activeColumn=0}setActiveColumn(t){this.activeColumn=i.findMsbBit(t)}setCabinetKey(t){console.log("SET CABINET_KEY",t),this.switchState[r]=t,this.cabinetKeyAutoreleaseTs=Date.now()}getCabinetKey(){const t=Date.now()-this.cabinetKeyAutoreleaseTs>100;return t&&(this.switchState[r]=h),this.switchState[r]}setFliptronicsInput(t){const e="string"==typeof t&&2===t.length;if(!e||"F"!==t[0])return void console.log("INVALID_FLIPTRONICS_INPUT_VALUE_"+t);const s=t[1]-1;console.log("setFliptronicsInput",t),this.switchState[a]^=i.setMsbBit(s)}setInputKey(t=0){if(!Number.isInteger(t)||11>t||95<t)return void console.log("INVALID INPUT_KEY",t);const e=t-1,s=parseInt(e/10,10),h=parseInt(e%10,10);this.switchState[s]^=i.setMsbBit(h),this.switchState[2]|=8}getActiveRow(){return this.switchState[this.activeColumn]}getRow(t){return this.switchState[t]}getFliptronicsKeys(){return this.switchState[a]}clearInputKeys(){this.cabinetKeyState=h,this.switchState.fill(h)}}}};const h=0,r=0,a=9},function(t){"use strict";t.exports={getInstance:function(t){return new class{constructor(t){this.updateAfterTicks=t,this.lampState=new Uint8Array(64).fill(0),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateLampState(){if(0!==this.activeColumn)for(let t=0;8>t;t++)if(this.activeRow&1<<t)for(let e=0;8>e;e++)this.activeColumn&1<<e&&(this.lampState[e<<3|t]|=128)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.lampState=this.lampState.map(t=>t>>>1))}setActiveRow(t){this.activeRow=t,this._updateLampState()}setActiveColumn(t){this.activeColumn=t,this._updateLampState()}}(t)}}},function(t){"use strict";t.exports={getInstance:function(t){return new class{constructor(t){this.updateAfterTicks=t,this.solenoidState=new Uint8Array(64).fill(0),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateSolenoidsPacked(t,e){for(var s=0;8>s;s++)e&1<<s&&(this.solenoidState[t+s]=255)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.solenoidState=this.solenoidState.map(t=>t>>>1))}setActive(t,e){if(0>e||255<e)throw new Error("SOLENOID_MATRIX_INVALID_VALUE_"+e);switch(t){case 16352:return this._updateSolenoidsPacked(24,e);case 16353:return this._updateSolenoidsPacked(0,e);case 16354:return this._updateSolenoidsPacked(16,e);case 16355:return this._updateSolenoidsPacked(8,e);default:throw new Error("SOLENOID_MATRIX_INVALID_OFFSET_"+t.toString(16))}}}(t)}}},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.generalIlluminationState=new Uint8Array(8).fill(0),this.lastValue=-1}update(t){if(t!==this.lastValue){this.lastValue=t;for(var e=0;8>e;e++)this.generalIlluminationState[e]=t&1<<e?255:0}}}}}},function(t){"use strict";const e=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15];t.exports={getMemoryProtectionMask:function(t){return 65535&e[15&t]+(240&t)+16<<8}}},function(t){"use strict";const e=[0,0,0,1,2,3,4,5,6,1,2,3,4,5,1,2,3],s=0,i=32,h=255;t.exports={getInstance:function(t){return new class{constructor(t=559){this.machineNumber=t,this.gameSerialNumber=new Uint8Array(e),this.picSerialNumber=new Uint8Array(16);const s=""+t;this.gameSerialNumber[0]=parseInt(s[0],10),this.gameSerialNumber[1]=parseInt(s[1],10),this.gameSerialNumber[2]=parseInt(s[2],10),this.picSerialNumber[10]=0,this.picSerialNumber[2]=0;let i=100*this.gameSerialNumber[1]+10*this.gameSerialNumber[7]+this.gameSerialNumber[4]+5*this.picSerialNumber[10];i=7117*i+127984,this.picSerialNumber[1]=255&i>>16,this.picSerialNumber[11]=255&i>>8,this.picSerialNumber[9]=255&i,i=4223*(i=1e4*this.gameSerialNumber[2]+1e3*this.gameSerialNumber[15]+100*this.gameSerialNumber[0]+10*this.gameSerialNumber[8]+this.gameSerialNumber[6]+2*this.picSerialNumber[10]+this.picSerialNumber[2])+7463513,this.picSerialNumber[7]=255&i>>24,this.picSerialNumber[12]=255&i>>16,this.picSerialNumber[0]=255&i>>8,this.picSerialNumber[8]=255&i,i=581*(i=1e3*this.gameSerialNumber[16]+100*this.gameSerialNumber[3]+10*this.gameSerialNumber[5]+this.gameSerialNumber[14]+this.picSerialNumber[2])+15732,this.picSerialNumber[3]=255&i>>16,this.picSerialNumber[14]=255&i>>8,this.picSerialNumber[6]=255&i,i=99999-(i=1e4*this.gameSerialNumber[13]+1e3*this.gameSerialNumber[12]+100*this.gameSerialNumber[11]+10*this.gameSerialNumber[10]+this.gameSerialNumber[9]),this.picSerialNumber[15]=255&i>>8,this.picSerialNumber[4]=255&i}reset(){this.lastByteWrite=h,this.unlockMode=0,this.unlockCode=0,this.writesUntilUnlockNeeded=32,console.log("RESET SECURITY PIC")}read(t){switch(this.lastByteWrite){case s:case i:return 0;case 13:return this.writesUntilUnlockNeeded=31&this.writesUntilUnlockNeeded-1,this.writesUntilUnlockNeeded;case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:if(0<this.unlockMode)return console.log("Column read in unlock mode"),0;const e=this.lastByteWrite-22;return 0>e||8<=e?(console.log("Invalid column %d",e),0):t(e+1);case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:const h=this.lastByteWrite-112;return 0>h||h>this.gameSerialNumber.length?(console.log("invalid OFFSET!!!",h),0):this.picSerialNumber[h];default:return console.log("Invalid PIC address read"),0}}write(t){if(this.lastByteWrite!==h||t===s)return this.lastByteWrite=t,0<this.unlockMode?(this.unlockCode=this.unlockCode<<8|t,void(3<++this.unlockMode&&(this.unlockMode=0))):void(t===i&&(this.unlockMode=1,this.unlockCode=0))}}(t)}}},function(t,e,s){"use strict";const i=s(2),h=s(18),r=s(19),a=(s(20),{WPC_ROMBANK_W:8192,WPC_DAC_WRITE:10240,HC55516_CLOCK_SET_WRITE:11264,WPC_LATCH_READ:12288,HC55516_DIGIT_CLOCK_CLEAR_WRITE:13312,WPC_VOLUME_WRITE:14336,WPC_LATCH_WRITE:15360,WPC_SOUND_CONTROL_STATUS:16349,WPC_SOUND_DATA:16348}),o=[];Object.keys(a).forEach(t=>{o[a[t]]=t}),t.exports={getInstance:function(t){return new class{constructor(t){this.interruptCallback=t.interruptCallback,this.ram=new Uint8Array(8192).fill(0);const e=this._cpuRead8.bind(this),s=this._cpuWrite8.bind(this);this.cpu=i.getInstance(s,e,"soundboard"),this.ym2151=h.create(3579545,44100),this.ym2151.TimerA=(()=>{}),this.ym2151.Intr=(t=>{!0===t?this.cpu.firq():this.cpu.clearFirqMasking()}),this.dacCallback=(()=>{}),this.systemROM=t.romObject.soundSystemRom,this.concatinatedSoundRom=t.romObject.concatinatedSoundRom,this.systemROM&&this.concatinatedSoundRom||(this.noRomAvailable=!0)}reset(){console.log("RESET_SOUNDBOARD"),this.volume=0,this.ym2151Register0=0,this.soundData=255,this.firqHackTicks=0,this.romBankOffset=0,this.ym2151.Reset(),this.cpu.reset()}getUiState(){const t=this.cpu.status(),e={ram:this.ram,volume:this.volume,ticks:this.cpu.tickCount,missedIrqCall:t.missedIRQ,missedFirqCall:t.missedFIRQ,irqCount:t.irqCount,firqCount:t.firqCount,nmiCount:t.nmiCount};return e}executeCycle(t=500,e=4){if(this.noRomAvailable)return;let s=0;for(;s<t;){const t=this.cpu.steps(e);s+=t}return s}_getBankRomOffset(t){let e=15&t;switch(224&~t){case 128:e|=0;break;case 64:e|=16;break;case 32:e|=32;break;default:console.log("UNKNOWN_SOUND_ROM_BANK_"+t+" -> "+e)}return e<<15}_cpuRead8(t){if(this.noRomAvailable)return 0;if(isNaN(t))throw new TypeError("SOUND_MEMORY_READ_BUG_DETECTED!");const e=r.getAddress(t);switch(e.subsystem){case r.SUBSYSTEM_RAM:return this.ram[e.offset];case r.SUBSYSTEM_HARDWARE:return this._hardwareRead(e.offset);case r.SUBSYSTEM_BANKSWITCHED:const s=e.offset+this.romBankOffset;return this.concatinatedSoundRom[s];case r.SUBSYSTEM_ROM:return this.systemROM[e.offset];default:throw console.log("wpcemu:boards:sound-board: CPU_READ8_FAIL",JSON.stringify(e),t),new Error("SND_INVALID_READ_SUBSYSTEM")}}_cpuWrite8(t,e){if(!this.noRomAvailable){if(isNaN(t))throw new TypeError("SOUND_MEMORY_WRITE_BUG_DETECTED!");if(void 0===e)throw new TypeError("MEMORY WRITE VALUE BUG DETECTED!");e&=255;const s=r.getAddress(t);switch(s.subsystem){case r.SUBSYSTEM_RAM:this.ram[s.offset]=e;break;case r.SUBSYSTEM_HARDWARE:this._hardwareWrite(s.offset,e)}}}mixStereo(t,e,s){this.ym2151.mixStereo(t,e,s)}registerDacCallback(t){this.dacCallback=t}writeInterface(t,e){switch(this.ram[t]=e,t){case a.WPC_SOUND_CONTROL_STATUS:console.log("RESET_SOUND_CPU"),this.reset();break;case a.WPC_SOUND_DATA:console.log("write sound data",e),this._hardwareWrite(a.WPC_LATCH_WRITE,e);break;default:console.log("SND_W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}readInterface(t){return t===a.WPC_SOUND_CONTROL_STATUS?this._hardwareRead(r.ADDRESS_YM2151_REGISTER):t===a.WPC_SOUND_DATA?this._hardwareRead(a.WPC_LATCH_READ):(console.log("wpcemu:boards:sound-board R_NOT_IMPLEMENTED","0x"+t.toString(16)),0)}_hardwareWrite(t,e){switch(t){case a.WPC_ROMBANK_W:[111,127].includes(e)&&console.log("SYSTEM ROM BANK REQUESTED!!!!");const s=this._getBankRomOffset(e);s!==this.romBankOffset&&(this.romBankOffset=s);break;case r.ADDRESS_YM2151_REGISTER:this.ym2151Register0=e;break;case r.ADDRESS_YM2151_DATA:this.ym2151.SetReg(this.ym2151Register0,e);break;case a.WPC_DAC_WRITE:this.dacCallback(e);break;case a.HC55516_CLOCK_SET_WRITE:case a.HC55516_DIGIT_CLOCK_CLEAR_WRITE:break;case a.WPC_VOLUME_WRITE:1&e&&(0<this.volume&&2&e?this.volume-=1:255>this.volume&&0==(2&e)&&(this.volume+=1));break;case a.WPC_LATCH_WRITE:this.soundData=e,this.cpu.irq(),this.interruptCallback.firq();break;default:console.log("SND_INVALID_HW_WRITE","0x"+t.toString(16),e)}}_hardwareRead(t){switch(t){case r.ADDRESS_YM2151_DATA:return this.ym2151.status;case r.ADDRESS_YM2151_REGISTER:return this.ym2151Register0;case a.WPC_LATCH_READ:return this.cpu.clearIrqMasking(),this.soundData;default:throw console.log("SND_INVALID_HW_READ","0x"+t.toString(16)),new Error("SND_INVALID_READ_SUBSYSTEM_0x"+t.toString(16))}}}(t)}}},function(t){"use strict";var e=this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);s.prototype=e.prototype,t.prototype=new s};!function(){var s,i=Math.min,h=Math.pow;(function(t){t.FM_PGBITS=9,t.FM_RATIOBITS=7,t.FM_LFOBITS=8,t.FM_TLBITS=7,t.FM_TLENTS=1<<t.FM_TLBITS,t.FM_LFOENTS=1<<t.FM_LFOBITS,t.FM_CLENTS=8192,t.FM_OPSINBITS=10,t.FM_OPSINENTS=1<<t.FM_OPSINBITS,t.FM_EG_BOTTOM=955,t.IS2EC_SHIFT=20+t.FM_PGBITS-13})(s||(s={})),function(t){var e=Math.sin,s=Math.PI;!function(t){t[t.typeN=0]="typeN",t[t.typeM=1]="typeM"}(t.OpType||(t.OpType={})),t.OpType,t.pmtable,t.amtable,t.tablemade=!1;var r=function(){function r(){this.chip_=null,this.out_=0,this.out2_=0,this.in2_=0,this.dp_=0,this.detune_=0,this.detune2_=0,this.multiple_=0,this.pg_count_=0,this.pg_diff_=0,this.pg_diff_lfo_=0,this.bn_=0,this.eg_level_=0,this.eg_level_on_next_phase_=0,this.eg_count_=0,this.eg_count_diff_=0,this.eg_out_=0,this.tl_out_=0,this.eg_rate_=0,this.eg_curve_count_=0,this.key_scale_rate_=0,this.eg_phase_=r.EGPhase.next,this.ms_=0,this.tl_=0,this.tl_latch_=0,this.ar_=0,this.dr_=0,this.sr_=0,this.sl_=0,this.rr_=0,this.ks_=0,this.keyon_=!1,this.amon_=!1,this.param_changed_=!1,this.mute_=!1,this.dbgopout_=0,this.dbgpgout_=0,r.tablehasmade||this.MakeTable(),this.ar_=this.dr_=this.sr_=this.rr_=this.key_scale_rate_=0,this.ams_=t.amtable[0][0],this.mute_=!1,this.keyon_=!1,this.tl_out_=0,this.multiple_=0,this.detune_=0,this.detune2_=0,this.ms_=0}return r.prototype.SetChip=function(t){this.chip_=t},r.prototype.Reset=function(){this.tl_=this.tl_latch_=127,this.ShiftPhase(r.EGPhase.off),this.eg_count_=0,this.eg_curve_count_=0,this.pg_count_=0,this.out_=this.out2_=0,this.param_changed_=!0},r.prototype.MakeTable=function(){var i,a=Math.floor,o=0;for(i=0;256>i;i++){var n=a(h(2,13-i/256));n=-4&n+2,r.cltable[o++]=n,r.cltable[o++]=-n}for(;o<t.FM_CLENTS;)r.cltable[o]=0|r.cltable[o-512]/2,o++;for(i=0;i<t.FM_OPSINENTS/2;i++){var c=(2*i+1)*s/t.FM_OPSINENTS,u=a(-256*Math.log(e(c))/Math.LN2+.5)+1;r.sinetable[i]=2*u,r.sinetable[t.FM_OPSINENTS/2+i]=2*u+1}t.MakeLFOTable(),r.tablehasmade=!0},r.prototype.SetDPBN=function(t,e){this.dp_=t,this.bn_=e,this.param_changed_=!0},r.prototype.Prepare=function(){if(this.param_changed_){switch(this.param_changed_=!1,this.pg_diff_=(this.dp_+r.dttable[this.detune_+this.bn_])*this.chip_.GetMulValue(this.detune2_,this.multiple_),this.pg_diff_lfo_=this.pg_diff_>>11,this.key_scale_rate_=this.bn_>>3-this.ks_,this.tl_out_=this.mute_?1023:8*this.tl_,this.eg_phase_){case r.EGPhase.attack:this.SetEGRate(this.ar_?i(63,this.ar_+this.key_scale_rate_):0);break;case r.EGPhase.decay:this.SetEGRate(this.dr_?i(63,this.dr_+this.key_scale_rate_):0),this.eg_level_on_next_phase_=8*this.sl_;break;case r.EGPhase.sustain:this.SetEGRate(this.sr_?i(63,this.sr_+this.key_scale_rate_):0);break;case r.EGPhase.release:this.SetEGRate(i(63,this.rr_+this.key_scale_rate_))}this.ams_=t.amtable[this.type_][this.amon_?3&this.ms_>>4:0],this.EGUpdate(),this.dbgopout_=0}},r.prototype.ShiftPhase=function(e){switch(e){case r.EGPhase.attack:if(62>this.ar_+this.key_scale_rate_){this.SetEGRate(this.ar_?i(63,this.ar_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.attack;break}case r.EGPhase.decay:if(this.sl_){this.eg_level_=0,this.eg_level_on_next_phase_=8*this.sl_,this.SetEGRate(this.dr_?i(63,this.dr_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.decay;break}case r.EGPhase.sustain:this.eg_level_=8*this.sl_,this.eg_level_on_next_phase_=1024,this.SetEGRate(this.sr_?i(63,this.sr_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.sustain;break;case r.EGPhase.release:if(this.eg_phase_===r.EGPhase.attack||this.eg_level_<t.FM_EG_BOTTOM){this.eg_level_on_next_phase_=1024,this.SetEGRate(i(63,this.rr_+this.key_scale_rate_)),this.eg_phase_=r.EGPhase.release;break}case r.EGPhase.off:default:this.eg_level_=t.FM_EG_BOTTOM,this.eg_level_on_next_phase_=t.FM_EG_BOTTOM,this.EGUpdate(),this.SetEGRate(0),this.eg_phase_=r.EGPhase.off}},r.prototype.SetFNum=function(t){this.dp_=(2047&t)<<(7&t>>11),this.bn_=r.notetable[127&t>>7],this.param_changed_=!0},r.prototype.LogToLin=function(e){return e<t.FM_CLENTS?r.cltable[e]:0},r.prototype.EGUpdate=function(){this.eg_out_=i(this.tl_out_+this.eg_level_,1023)<<3},r.prototype.SetEGRate=function(t){this.eg_rate_=t,this.eg_count_diff_=r.decaytable2[t>>2]*this.chip_.GetRatio()},r.prototype.EGCalc=function(){if(this.eg_count_=6141<<t.FM_RATIOBITS,this.eg_phase_===r.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),0>=this.eg_level_&&this.ShiftPhase(r.EGPhase.decay)),this.EGUpdate()}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1),this.EGUpdate();this.eg_curve_count_++},r.prototype.EGStep=function(){this.eg_count_-=this.eg_count_diff_,0>=this.eg_count_&&this.EGCalc()},r.prototype.PGCalc=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_,this.dbgpgout_=t,t},r.prototype.PGCalcL=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.GetPMV()>>5),this.dbgpgout_=t,t},r.prototype.Calc=function(e){this.EGStep(),this.out2_=this.out_;var s=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=e>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+r.sinetable[s&t.FM_OPSINENTS-1]),this.dbgopout_=this.out_,this.out_},r.prototype.CalcL=function(e){this.EGStep();var s=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=e>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+r.sinetable[s&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},r.prototype.CalcN=function(t){this.EGStep();var e=Math.max(0,1023-(this.tl_out_+this.eg_level_))<<1;return t=(1&t)-1,this.out_=e+t^t,this.dbgopout_=this.out_,this.out_},r.prototype.CalcFB=function(e){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var i=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return 31>e&&(i+=s<<1+t.IS2EC_SHIFT>>e>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+r.sinetable[i&t.FM_OPSINENTS-1]),this.dbgopout_=this.out2_,this.out2_},r.prototype.CalcFBL=function(e){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var i=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return 31>e&&(i+=s<<1+t.IS2EC_SHIFT>>e>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+r.sinetable[i&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},r.prototype.ResetFB=function(){this.out_=this.out2_=0},r.prototype.KeyOn=function(){this.keyon_||(this.keyon_=!0,(this.eg_phase_===r.EGPhase.off||this.eg_phase_===r.EGPhase.release)&&(this.ShiftPhase(r.EGPhase.attack),this.EGUpdate(),this.in2_=this.out_=this.out2_=0,this.pg_count_=0))},r.prototype.KeyOff=function(){this.keyon_&&(this.keyon_=!1,this.ShiftPhase(r.EGPhase.release))},r.prototype.IsOn=function(){return this.eg_phase_-r.EGPhase.off},r.prototype.SetDT=function(t){this.detune_=32*t,this.param_changed_=!0},r.prototype.SetDT2=function(t){this.detune2_=3&t,this.param_changed_=!0},r.prototype.SetMULTI=function(t){this.multiple_=t,this.param_changed_=!0},r.prototype.SetTL=function(t){this.tl_=t,this.param_changed_=!0},r.prototype.SetAR=function(t){this.ar_=t,this.param_changed_=!0},r.prototype.SetDR=function(t){this.dr_=t,this.param_changed_=!0},r.prototype.SetSR=function(t){this.sr_=t,this.param_changed_=!0},r.prototype.SetSL=function(t){this.sl_=t,this.param_changed_=!0},r.prototype.SetRR=function(t){this.rr_=t,this.param_changed_=!0},r.prototype.SetKS=function(t){this.ks_=t,this.param_changed_=!0},r.prototype.SetAMON=function(t){this.amon_=t,this.param_changed_=!0},r.prototype.Mute=function(t){this.mute_=t,this.param_changed_=!0},r.prototype.SetMS=function(t){this.ms_=t,this.param_changed_=!0},r.prototype.Out=function(){return this.out_},r.notetable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,30,31,31,31,31,31,31,31],r.dttable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,16,16,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,32,32,32,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,34,38,40,44,44,44,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,-2,-2,-2,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-16,-16,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-32,-32,-32,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-34,-38,-40,-44,-44,-44,-44],r.decaytable1=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0],[1,1,1,0,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1],[2,1,1,1,2,1,1,1],[2,1,2,1,2,1,2,1],[2,2,2,1,2,2,2,1],[2,2,2,2,2,2,2,2],[4,2,2,2,4,2,2,2],[4,2,4,2,4,2,4,2],[4,4,4,2,4,4,4,2],[4,4,4,4,4,4,4,4],[8,4,4,4,8,4,4,4],[8,4,8,4,8,4,8,4],[8,8,8,4,8,8,8,4],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16]],r.decaytable2=[1,2,4,8,16,32,64,128,256,512,1024,2047,2047,2047,2047,2047],r.attacktable=[[-1,-1,-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1,-1,-1],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,-1,4,4,4,-1],[4,4,4,-1,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,4,4,4,4,4,4,4],[3,4,4,4,3,4,4,4],[3,4,3,4,3,4,3,4],[3,3,3,4,3,3,3,4],[3,3,3,3,3,3,3,3],[2,3,3,3,2,3,3,3],[2,3,2,3,2,3,2,3],[2,2,2,3,2,2,2,3],[2,2,2,2,2,2,2,2],[1,2,2,2,1,2,2,2],[1,2,1,2,1,2,1,2],[1,1,1,2,1,1,1,2],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],r.tablehasmade=!1,r.sinetable=Array(1024),r.cltable=Array(t.FM_CLENTS),r.EGPhase={next:0,attack:1,decay:2,sustain:3,release:4,off:5},r}();t.Operator=r;var a=function(){function e(){this.op=[new r,new r,new r,new r],this.tablehasmade=!1,this.fb=0,this.buf=[,,,,],this.inop=[,,,],this.outop=[,,,],this.algo_=0,this.chip_=null,this.tablehasmade||this.MakeTable(),this.SetAlgorithm(0),this.pms=t.pmtable[0][0]}return e.prototype.MakeTable=function(){for(var t=0;64>t;t++)e.kftable[t]=0|65536*h(2,t/768)},e.prototype.SetChip=function(t){this.chip_=t;for(var e=0;4>e;e++)this.op[e].SetChip(t)},e.prototype.Reset=function(){for(var t=0;4>t;t++)this.op[t].Reset()},e.prototype.Prepare=function(){for(var e=0;4>e;e++)this.op[e].Prepare();return this.pms=t.pmtable[this.op[0].type_][7&this.op[0].ms_],(this.op[0].IsOn()|this.op[1].IsOn()|this.op[2].IsOn()|this.op[3].IsOn()?1:0)|(this.op[0].ms_&(this.op[0].amon_||this.op[1].amon_||this.op[2].amon_||this.op[3].amon_?55:7)?2:0)},e.prototype.SetFNum=function(t){for(var e=0;4>e;e++)this.op[e].SetFNum(t)},e.prototype.SetKCKF=function(t,s){var i=[5197,5506,5833,6180,6180,6547,6937,7349,7349,7786,8249,8740,8740,9259,9810,10394][15&t],h=(i=(i+2)/4*4)*e.kftable[63&s];h>>=19,h<<=19,h>>=19-(7&t>>4);var r=31&t>>2;this.op[0].SetDPBN(h,r),this.op[1].SetDPBN(h,r),this.op[2].SetDPBN(h,r),this.op[3].SetDPBN(h,r)},e.prototype.KeyControl=function(t){1&t?this.op[0].KeyOn():this.op[0].KeyOff(),2&t?this.op[1].KeyOn():this.op[1].KeyOff(),4&t?this.op[2].KeyOn():this.op[2].KeyOff(),8&t?this.op[3].KeyOn():this.op[3].KeyOff()},e.prototype.SetAlgorithm=function(t){var e=[[0,1,1,2,2,3],[1,0,0,1,1,2],[1,1,1,0,0,2],[0,1,2,1,1,2],[0,1,2,2,2,1],[0,1,0,1,0,1],[0,1,2,1,2,1],[1,0,1,0,1,0]];this.inop[0]=e[t][0],this.outop[0]=e[t][1],this.inop[1]=e[t][2],this.outop[1]=e[t][3],this.inop[2]=e[t][4],this.outop[2]=e[t][5],this.op[0].ResetFB(),this.algo_=t},e.prototype.Calc=function(){var t;switch(this.algo_){case 0:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 1:this.op[2].Calc(this.op[0].Out()+this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 2:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 3:this.op[2].Calc(0),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 4:this.op[2].Calc(0),t=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 5:t=this.op[2].Calc(this.op[0].Out()),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[0].Out()),this.op[0].CalcFB(this.fb);break;case 6:t=this.op[2].Calc(0),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(0),this.op[0].CalcFB(this.fb);break;case 7:t=this.op[2].Calc(0),t+=this.op[1].Calc(0),t+=this.op[3].Calc(0),t+=this.op[0].CalcFB(this.fb)}return t},e.prototype.CalcL=function(){var t;switch(this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.algo_){case 0:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 1:this.op[2].CalcL(this.op[0].Out()+this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 2:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 3:this.op[2].CalcL(0),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 4:this.op[2].CalcL(0),t=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 5:t=this.op[2].CalcL(this.op[0].Out()),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[0].Out()),this.op[0].CalcFBL(this.fb);break;case 6:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(0),this.op[0].CalcFBL(this.fb);break;case 7:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(0),t+=this.op[3].CalcL(0),t+=this.op[0].CalcFBL(this.fb)}return t},e.prototype.CalcN=function(t){this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFB(this.fb),this.buf[this.outop[0]]+=this.op[1].Calc(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].Calc(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.CalcLN=function(t){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFBL(this.fb),this.buf[this.outop[0]]+=this.op[1].CalcL(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].CalcL(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.SetType=function(t){for(var e=0;4>e;e++)this.op[e].type_=t},e.prototype.SetFB=function(t){this.fb=e.fbtable[t]},e.prototype.SetMS=function(t){for(var e=0;4>e;e++)this.op[e].SetMS(t)},e.prototype.Mute=function(t){for(var e=0;4>e;e++)this.op[e].Mute(t)},e.fbtable=[31,7,6,5,4,3,2,1],e.kftable=Array(64),e.muted=0,e}();t.Channel4=a;var o=function(){function e(){this.ratio_=0,this.aml_=0,this.pml_=0,this.pmv_=0}return e.prototype.SetRatio=function(t){t=Math.round(t),this.ratio_!==t&&(this.ratio_=t,this.MakeTable())},e.prototype.SetAML=function(e){this.aml_=e&t.FM_LFOENTS-1},e.prototype.SetPML=function(e){this.pml_=e&t.FM_LFOENTS-1},e.prototype.SetPMV=function(t){this.pmv_=t},e.prototype.GetMulValue=function(t,e){return this.multable_[t][e]},e.prototype.GetAML=function(){return this.aml_},e.prototype.GetPML=function(){return this.pml_},e.prototype.GetPMV=function(){return this.pmv_},e.prototype.GetRatio=function(){return this.ratio_},e.prototype.MakeTable=function(){var e,s,i=[1,1.414,1.581,1.732];for(this.multable_=[,,,,],e=0;4>e;e++){var h=i[e]*this.ratio_/(1<<2+t.FM_RATIOBITS-t.FM_PGBITS);for(this.multable_[e]=Array(16),s=0;16>s;s++){var r=s?2*s:1;this.multable_[e][s]=0|r*h}}},e}();t.Chip=o,t.MakeLFOTable=function(){if(!t.tablemade){t.tablemade=!0;var i,r=[[0,1/360,2/360,3/360,4/360,6/360,12/360,24/360],[0,1/480,2/480,4/480,10/480,20/480,80/480,140/480]],a=[[31,6,4,3],[31,2,1,0]];t.pmtable=[,,],t.amtable=[,,];for(var o=0;2>o;o++){for(t.pmtable[o]=Array(8),i=0;8>i;i++){var n=r[o][i];t.pmtable[o][i]=Array(t.FM_LFOENTS);for(var c=0;c<t.FM_LFOENTS;c++){h(2,n*(2*c-t.FM_LFOENTS+1)/(t.FM_LFOENTS-1));var u=.6*n*e(2*c*s/t.FM_LFOENTS)+1;t.pmtable[o][i][c]=0|65536*(u-1)}}for(t.amtable[o]=[,,,,],i=0;4>i;i++)for(t.amtable[o][i]=Array(t.FM_LFOENTS),c=0;c<t.FM_LFOENTS;c++)t.amtable[o][i][c]=2*(4*c>>a[o][i])<<2}}}}(s||(s={})),function(t){var e=function(){function t(){this.OPM_LFOENTS=512,this.regtc=0,this.regta=[,,],this.timera=0,this.timera_count=0,this.timerb=0,this.timerb_count=0,this.timer_step=0}return t.prototype.Reset=function(){this.timera_count=0,this.timerb_count=0},t.prototype.SetTimerControl=function(t){var e=this.regtc^t;this.regtc=t,16&t&&this.ResetStatus(1),32&t&&this.ResetStatus(2),1&e&&(this.timera_count=1&t?this.timera:0),2&e&&(this.timerb_count=2&t?this.timerb:0)},t.prototype.SetTimerA=function(t,e){var s;this.regta[1&t]=e,s=(this.regta[0]<<2)+(3&this.regta[1]),this.timera=(1024-s)*this.timer_step},t.prototype.SetTimerB=function(t){this.timerb=(256-t)*this.timer_step},t.prototype.Count=function(t){var e=!1;if(this.timera_count&&(this.timera_count-=t<<16,0>=this.timera_count)){for(e=!0,this.TimerA();0>=this.timera_count;)this.timera_count+=this.timera;4&this.regtc&&this.SetStatus(1)}if(this.timerb_count&&(this.timerb_count-=t<<12,0>=this.timerb_count)){for(e=!0;0>=this.timerb_count;)this.timerb_count+=this.timerb;8&this.regtc&&this.SetStatus(2)}return e},t.prototype.GetNextEvent=function(){var t=(this.timera_count+65535>>16)-1,e=(this.timerb_count+4095>>12)-1;return(t<e?t:e)+1},t.prototype.SetTimerBase=function(t){this.timer_step=0|65536e6/t,console.log("YM2151: SetTimerBase",{param:t,stepsize:this.timer_step})},t.prototype.SetStatus=function(t){console.log("t.prototype.SetStatus not impl",t)},t.prototype.ResetStatus=function(t){console.log("t.prototype.ResetStatus not impl",t)},t.prototype.TimerA=function(){console.log("t.prototype.TimerA not impl",t)},t}();t.Timer=e}(s||(s={})),function(t){var s=function(s){function r(){s.call(this),this.fmvolume=0,this.clock=0,this.rate=0,this.pcmrate=0,this.pmd=0,this.amd=0,this.lfocount=0,this.lfodcount=0,this.lfo_count_=0,this.lfo_count_diff_=0,this.lfo_step_=0,this.lfo_count_prev_=0,this.lfowaveform=0,this.rateratio=0,this.noise=0,this.noisecount=0,this.noisedelta=0,this.interpolation=!1,this.lfofreq=0,this.status=0,this.reg01=0,this.kc=Array(8),this.kf=Array(8),this.pan=Array(8),this.ch=[new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4],this.chip=new t.Chip,this.lfo_count_=0,this.lfo_count_prev_=-1,this.BuildLFOTable();for(var e=0;8>e;e++)this.ch[e].SetChip(this.chip),this.ch[e].SetType(1)}return e(r,s),r.prototype.Init=function(t,e){return this.SetRate(t,e)?(this.Reset(),this.SetVolume(0),this.SetChannelMask(0),!0):(console.log("init:setRate failed!"),!1)},r.prototype.SetRate=function(t,e){return this.clock=t,this.pcmrate=e,this.rate=e,this.RebuildTimeTable(),!0},r.prototype.SetChannelMask=function(t){for(var e=0;8>e;e++)this.ch[e].Mute(!!(t&1<<e))},r.prototype.Reset=function(){var t;for(console.log("YM2151: Reset",{clock:this.clock}),t=0;256>t;t++)this.SetReg(t,0);for(this.SetReg(25,128),s.prototype.Reset.call(this),this.status=0,this.noise=12345,this.noisecount=0,t=0;8>t;t++)this.ch[t].Reset()},r.prototype.RebuildTimeTable=function(){var e=this.clock/64;this.rateratio=((e<<t.FM_RATIOBITS)+this.rate/2)/this.rate,this.SetTimerBase(e),console.log("YM2151: RebuildTimeTable",{clock:this.clock,rateratio:this.rateratio}),this.chip.SetRatio(this.rateratio)},r.prototype.SetVolume=function(t){t=i(t,20),this.fmvolume=-192<t?0|16384*h(10,t/40):0},r.prototype.SetStatus=function(t){this.status&t||(this.status|=t,this.Intr(!0))},r.prototype.ResetStatus=function(t){this.status&t&&(this.status&=~t,!this.status&&this.Intr(!1))},r.prototype.SetReg=function(e,s){if(!(256<=e)){var i=7&e;switch(255&e){case 1:2&s&&(this.lfo_count_=0,this.lfo_count_prev_=-1),this.reg01=s;break;case 8:128&this.regtc?(i=7&s,!(8&s)&&this.ch[i].op[0].KeyOff(),!(16&s)&&this.ch[i].op[1].KeyOff(),!(32&s)&&this.ch[i].op[2].KeyOff(),!(64&s)&&this.ch[i].op[3].KeyOff()):this.ch[7&s].KeyControl(s>>3);break;case 15:this.noisedelta=s,this.noisecount=0;break;case 16:case 17:this.SetTimerA(e,s);break;case 18:this.SetTimerB(s);break;case 20:this.SetTimerControl(s);break;case 24:this.lfofreq=s,this.lfo_count_diff_=this.rateratio*(16+(15&this.lfofreq)<<12-t.FM_RATIOBITS)/(1<<15-(this.lfofreq>>4));break;case 25:0==(128&s)?this.amd=127&s:this.pmd=127&s;break;case 27:this.lfowaveform=3&s;break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:this.ch[i].SetFB(7&s>>3),this.ch[i].SetAlgorithm(7&s),this.pan[i]=3&s>>6;break;case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this.kc[i]=s,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:this.kf[i]=s>>2,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.ch[i].SetMS(s<<4|s>>4);break;default:64<=e&&this.SetParameter(e,s)}}},r.prototype.SetParameter=function(t,e){var s=[0,2,1,3][3&t>>3],i=this.ch[7&t].op[s];switch(7&t>>5){case 2:i.SetDT(7&e>>4),i.SetMULTI(15&e);break;case 3:i.SetTL(127&e);break;case 4:i.SetKS(3&e>>6),i.SetAR(2*(31&e));break;case 5:i.SetDR(2*(31&e)),i.SetAMON(0!=(128&e));break;case 6:i.SetSR(2*(31&e)),i.SetDT2(3&e>>6);break;case 7:i.SetSL([0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,124][15&e>>4]),i.SetRR(4*(15&e)+2)}},r.prototype.BuildLFOTable=function(){this.amtable=[,,,,],this.pmtable=[,,,,];for(var t,e=0;4>e;e++){t=0,this.amtable[e]=Array(this.OPM_LFOENTS),this.pmtable[e]=Array(this.OPM_LFOENTS);for(var s=0;s<this.OPM_LFOENTS;s++){var i,h;0===e?(h=(511&s+256)/2-128,i=255-s/2):1===e?(i=256>s?255:0,h=256>s?127:-128):2===e?(h=256>(h=511&s+128)?h-128:383-h,i=256>s?255-s:s-256):3===e&&(3&s||(t=255&(0|32768*Math.random())/17),i=t,h=t-128),this.amtable[e][s]=0|i,this.pmtable[e][s]=0|-h-1}}},r.prototype.LFO=function(){var t;3===this.lfowaveform?-131072&(this.lfo_count_^this.lfo_count_prev_)&&(t=255&(0|32768*Math.random())/17,this.chip.SetPML((t-128)*this.pmd/128+128),this.chip.SetAML(t*this.amd/128)):(t=510&this.lfo_count_>>15,this.chip.SetPML(this.pmtable[this.lfowaveform][t]*this.pmd/128+128),this.chip.SetAML(this.amtable[this.lfowaveform][t]*this.amd/128)),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_)},r.prototype.Noise=function(){if(this.noisecount+=2*this.rateratio,this.noisecount>=32<<t.FM_RATIOBITS){var e=32-(31&this.noisedelta);1==e&&(e=2),this.noisecount-=e<<t.FM_RATIOBITS,31==(31&this.noisedelta)&&(this.noisecount-=t.FM_RATIOBITS),this.noise=this.noise>>1^(1&this.noise?33800:0)}return this.noise},r.prototype.MixSub=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].Calc()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].Calc()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].Calc()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].Calc()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].Calc()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].Calc()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].Calc()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcN(this.Noise()):e[this.pan[7]]+=this.ch[7].Calc())},r.prototype.MixSubL=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].CalcL()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].CalcL()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].CalcL()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].CalcL()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].CalcL()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].CalcL()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].CalcL()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcLN(this.Noise()):e[this.pan[7]]+=this.ch[7].CalcL())},r.prototype.Mix=function(t,e,s){for(var i=0,h=1/this.attenuation,r=this.volume/100,a=0;8>a;a++)i=i<<2|this.ch[a].Prepare();2&this.reg01&&(i&=21845);var o=[,,,,];for(a=0;a<s;a++)o[1]=o[2]=o[3]=0,this.LFO(),43690&i?this.MixSubL(i,o):this.MixSub(i,o),t[a]=(o[1]+o[3])*h*r,e[a]=(o[2]+o[3])*h*r},r.prototype.label="YM2151",r.prototype.version=258,r.prototype.attenuation=49152,r.prototype.volume=100,r.prototype.mixStereo=function(t,e,s){for(var i=0,h=1/this.attenuation,r=this.volume/100,a=0;8>a;a++)i=i<<2|this.ch[a].Prepare();2&this.reg01&&(i&=21845);var o=[,,,,],n=0|s;for(a=0;a<e;a++)o[1]=o[2]=o[3]=0,this.LFO(),43690&i?this.MixSubL(i,o):this.MixSub(i,o),t[n++]+=(o[1]+o[3])*h*r,t[n++]+=(o[2]+o[3])*h*r},r.prototype.Intr=function(){console.log("i.prototype.Intr not implemented")},r.prototype.toggle=function(t,e){this.ch[t].muted=!e},r}(t.Timer);t.OPM=s}(s||(s={})),t.exports={get label(){return"YM2151"},get channels(){return["Ch 1","Ch 2","Ch 3","Ch 4","Ch 5","Ch 6","Ch 7","Ch 8"]},create:function(t,e){const i=new s.OPM;i.Init(t,e),i.SetReg(20,42);for(var h=0;8>h;++h)i.SetReg(56+h,0);return i.SetReg(15,0),i}}}()},function(t){"use strict";function e(t,e){return{offset:t,subsystem:e}}const s="hardware",i="bank",h=9216;t.exports={getAddress:function(t){if(void 0===t)throw new Error("SND_GET_ADDRESS_UNDEFINED");if((t&=65535)<8192)return e(t,"ram");if(t<16384){if(t<h||t>10239)return e(t,s);return e(function(t){return 1==t%2}(t)?9217:h,s)}if(t<49152)return e(t-16384,i);if(t<65536)return e(t-49152,"rom");throw new Error("SND_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},SUBSYSTEM_RAM:"ram",SUBSYSTEM_HARDWARE:s,SUBSYSTEM_BANKSWITCHED:i,SUBSYSTEM_ROM:"rom",ADDRESS_YM2151_REGISTER:h,ADDRESS_YM2151_DATA:9217}},function(t){"use strict";function e(t,e,s){return t>=e&&t<=s}t.exports={getRegisterName:function(t){if(s.includes(t))return"NOT_USED";const h=i[t];return h||(e(t,40,47)?"KEY CODE":e(t,48,55)?"KEY FRACTION":e(t,56,63)?"PHASE & AMPLITUDE MODULATION SENSITIVITY":e(t,64,95)?"DETUNE & PHASE MULTIPLY":e(t,96,127)?"TOTAL LEVEL":e(t,128,159)?"EG ATTACK":e(t,160,191)?"EG DECAY 1":e(t,192,223)?"EG DECAY 2":e(t,224,255)?"EG DECAY LEVEL, RELEASE RATE":"WTF?")}};const s=[0,2,3,4,5,6,7,9,10,11,12,13,14,16,26,28,29,30,31,33,34,35,36,37,38,39],i=[];i[1]="TEST & LFO RESET",i[8]="KEY ON",i[15]="NOISE ENABLE, NOISE FREQUENCY",i[17]="CLOCK A1",i[18]="CLOCK A2",i[19]="CLOCK B",i[20]="CLOCK FUNCTIONS",i[24]="LOW FREQUENCY",i[25]="PHASE AND AMPLITUDE MODULATION",i[27]="CONTROL OUTPUT & WAVE FORM SELECT",i[32]="CHANNEL CONTROL"},function(t){"use strict";const e={WPC_PARALLEL_STATUS_PORT:16320,WPC_PARALLEL_DATA_PORT:16321,WPC_PARALLEL_STROBE_PORT:16322,WPC_SERIAL_DATA_OUTPUT:16323,WPC_SERIAL_CONTROL_OUTPUT:16324,WPC_SERIAL_BAUD_SELECT:16325,WPC_TICKET_DISPENSE:16326,WPC_FLIPTRONICS_FLIPPER_PORT_B:16341},s=[];Object.keys(e).forEach(t=>{s[e[t]]=t}),t.exports={getInstance:function(){return new class{constructor(){this.ram=new Uint8Array(32).fill(0)}write(t,s){switch(this.ram[t-16320]=s,t){case e.WPC_PARALLEL_STATUS_PORT:case e.WPC_PARALLEL_DATA_PORT:case e.WPC_PARALLEL_STROBE_PORT:case e.WPC_SERIAL_DATA_OUTPUT:case e.WPC_SERIAL_CONTROL_OUTPUT:case e.WPC_SERIAL_BAUD_SELECT:case e.WPC_TICKET_DISPENSE:case e.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO W_NOT_IMPLEMENTED","0x"+t.toString(16),s)}}read(t){switch(t){case e.WPC_TICKET_DISPENSE:return 255;case e.WPC_PARALLEL_STATUS_PORT:case e.WPC_PARALLEL_DATA_PORT:case e.WPC_PARALLEL_STROBE_PORT:case e.WPC_SERIAL_DATA_OUTPUT:case e.WPC_SERIAL_CONTROL_OUTPUT:case e.WPC_SERIAL_BAUD_SELECT:case e.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO R_NOT_IMPLEMENTED","0x"+t.toString(16))}return this.ram[t-16320]}}}}},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.patch=[]}addPatch(t,e){this.patch.push({memoryOffset:t,value:e})}hasPatch(t){return this.patch.find(e=>e.memoryOffset===t)}}}}},function(t){"use strict";t.exports={run:function(t,i){return t.addPatch(i,e),t.addPatch(i+1,s),t}};const e=20,s=99},function(t,e,s){"use strict";const i=s(25),h={FREEWPC_DEBUG_CONTROL_PORT:15713,WPC_SERIAL_CONTROL_PORT:15974,WPC_DMD_HIGH_PAGE:16316,WPC_DMD_SCANLINE:16317,WPC_DMD_LOW_PAGE:16318,WPC_DMD_ACTIVE_PAGE:16319},r=14848,a=15360,o=512,n=16,c=3,u=[];Object.keys(h).forEach(t=>{u[h[t]]=t}),t.exports={getInstance:function(t){return new class{constructor(t){this.interruptCallback=t.interruptCallback,this.ram=t.ram,this.videoOutputBuffer=new Uint8Array(c*o).fill(0),this.outputDmdDisplay=i.getInstance(o,this.videoOutputBuffer),this.videoRam=new Uint8Array(16*o).fill(0)}reset(){console.log("RESET_DMD_BOARD"),this.videoRam.fill(0),this.videoOutputBuffer.fill(0),this.lowPage=0,this.highPage=1,this.scanline=0,this.activePage=0,this.nextActivePage=void 0,this.videoOutputPointer=0,this.requestFIRQ=!1}getUiState(){return{scanline:this.scanline,lowpage:this.lowPage,highpage:this.highPage,activepage:this.activePage,videoRam:this.videoRam,dmdShadedBuffer:this.outputDmdDisplay.getShadedOutputVideoFrame()}}copyScanline(){const t=this.activePage*o+this.scanline*n,e=this.videoOutputPointer*o+this.scanline*n;for(let s=0;s<n;s++)this.videoOutputBuffer[e+s]=this.videoRam[t+s];this.scanline=31&this.scanline+1,0===this.scanline&&(this.videoOutputPointer=(this.videoOutputPointer+1)%c,this.outputDmdDisplay.updateVideoBuffer(this.videoOutputBuffer),Number.isInteger(this.nextActivePage)&&(this.activePage=this.nextActivePage,this.nextActivePage=void 0)),!0===this.requestFIRQ&&31&this.scanline===this.ram[h.WPC_DMD_SCANLINE]&&(this.interruptCallback.firqFromDmd(),this.requestFIRQ=!1)}_getLowPageOffset(t){return this.lowPage*o+(t-14336)}_getHighPageOffset(t){return this.highPage*o+(t-r)}write(t,e){var s;if(t<r)return s=this._getLowPageOffset(t),void(this.videoRam[s]=e);if(t<a)return s=this._getHighPageOffset(t),void(this.videoRam[s]=e);switch(this.ram[t]=e,t){case h.WPC_DMD_SCANLINE:this.requestFIRQ=!0;break;case h.WPC_DMD_ACTIVE_PAGE:this.nextActivePage=15&e;break;case h.WPC_DMD_LOW_PAGE:this.lowPage=15&e;break;case h.WPC_DMD_HIGH_PAGE:this.highPage=15&e;break;default:console.log("DMD W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){var e;return t<r?(e=this._getLowPageOffset(t),this.videoRam[e]):t<a?(e=this._getHighPageOffset(t),this.videoRam[e]):t===h.WPC_DMD_SCANLINE?this.scanline:t===h.FREEWPC_DEBUG_CONTROL_PORT||t===h.WPC_SERIAL_CONTROL_PORT?0:(console.log("DMD R_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t])}}(t)}}},function(t,e,s){"use strict";const i=s(1);t.exports={getInstance:function(t,e){return new class{constructor(t,e){this.dmdPageSize=t,this.videoBuffer=e}updateVideoBuffer(t){this.videoBuffer=Uint8Array.from(t)}getShadedOutputVideoFrame(){const t=this.dmdPageSize,e=2*this.dmdPageSize,s=new Uint8Array(8*this.dmdPageSize).fill(0);for(var h=0,r=0,a=0;a<32;a++)for(var o=0;o<16;o++){for(var n=0;8>n;n++){const a=i.setMsbBit(n),o=(0<(this.videoBuffer[0+r]&a)?1:0)+(0<(this.videoBuffer[t+r]&a)?1:0)+(0<(this.videoBuffer[e+r]&a)?1:0);s[h++]=o}r++}return s}}(t,e)}}},function(t){"use strict";t.exports={getInstance:function(){return new s}};const e=512;class s{constructor(){this.count=0,this.oldState={videoRam:[],dmdShadedBuffer:[],lampState:[],solenoidState:[],inputState:[]},this.videoRam=[]}getVideoRamDiff(t){let i=!1;for(let h=0;16>h;h++){const r=t.slice(h*e,(h+1)*e);(!this.oldState.videoRam[h]||!s.arraysEqual(r,this.oldState.videoRam[h]))&&(i=!0,this.videoRam[h]=r,this.oldState.videoRam[h]=Uint8Array.from(r))}return i}static arraysEqual(t,e){if(t===e)return!0;if(null===t||null===e||t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}getChangedState(t){this.count++;const e=!s.arraysEqual(t.dmd.dmdShadedBuffer,this.oldState.dmdShadedBuffer),i=!s.arraysEqual(t.wpc.lampState,this.oldState.lampState),h=!s.arraysEqual(t.wpc.solenoidState,this.oldState.solenoidState),r=!s.arraysEqual(t.wpc.inputState,this.oldState.inputState);e&&(this.oldState.dmdShadedBuffer=Uint8Array.from(t.dmd.dmdShadedBuffer)),i&&(this.oldState.lampState=Uint8Array.from(t.wpc.lampState)),h&&(this.oldState.solenoidState=Uint8Array.from(t.wpc.solenoidState)),r&&(this.oldState.inputState=Uint8Array.from(t.wpc.inputState));const a=this.getVideoRamDiff(t.dmd.videoRam);return{ram:0==this.count%4?t.ram:void 0,wpc:{diagnosticLed:t.wpc.diagnosticLed,lampState:i?t.wpc.lampState:void 0,solenoidState:h?t.wpc.solenoidState:void 0,generalIlluminationState:t.wpc.generalIlluminationState,inputState:r?t.wpc.inputState:void 0,diagnosticLedToggleCount:t.wpc.diagnosticLedToggleCount,irqEnabled:t.wpc.irqEnabled,activeRomBank:t.wpc.activeRomBank},dmd:{scanline:t.dmd.scanline,lowpage:t.dmd.lowpage,highpage:t.dmd.highpage,activepage:t.dmd.activepage,videoRam:a?this.videoRam:void 0,dmdShadedBuffer:e?t.dmd.dmdShadedBuffer:void 0}}}}}]);