var WpcEmu=function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=2)}([function(t,e,s){"use strict";t.exports={CALL_IRQ_AFTER_TICKS:2049,CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS:512,CALL_ZEROCLEAR_AFTER_TICKS:16667,CALL_UPDATELAMP_AFTER_TICKS:33333,CALL_UPDATESOLENOID_AFTER_TICKS:266664}},function(t,e,s){"use strict";t.exports={findMsbBit:function(t){const e=[1,2,4,8,16,32,64,128].indexOf(t);return e>-1?e+1:0},setMsbBit:function(t=0){return[1,2,4,8,16,32,64,128][t]}}},function(t,e,s){"use strict";(function(e){const i=s(4),r=s(5),h=s(7),a=s(29);t.exports={initVMwithRom:function(t,e){return r.parse(t,e).then(t=>new o(t))}};class o{constructor(t){this.cpuBoard=h.getInstance(t),this.uiFacade=a.getInstance()}start(){this.startTime=Date.now(),this.cpuBoard.start()}getUiState(){const t=this.cpuBoard.getState(),e=this.uiFacade.getChangedState(t.asic);t.asic=e;const s=Date.now()-this.startTime;return t.opsMs=parseInt(t.cpuState.tickCount/s,10),t.runtime=s,t}registerAudioConsumer(t){this.cpuBoard.registerSoundBoardCallback(t)}executeCycle(t=500,e=4){return this.cpuBoard.executeCycle(t,e)}setCabinetInput(t){this.cpuBoard.setCabinetInput(t)}setInput(t){this.cpuBoard.setInput(t)}setFliptronicsInput(t){this.cpuBoard.setFliptronicsInput(t)}toggleMidnightMadnessMode(){this.cpuBoard.toggleMidnightMadnessMode()}reset(){this.startTime=Date.now(),this.cpuBoard.reset()}version(){return i.version}}e.on("uncaughtException",t=>{console.error("UNCAUGHT_EXCEPTION",{error:t.message})}),e.on("unhandledRejection",t=>{console.error("UNHANDLED_REJECTION",{msg:t.message,stack:t.stack})})}).call(this,s(3))},function(t,e){var s,i,r=t.exports={};function h(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function o(t){if(s===setTimeout)return setTimeout(t,0);if((s===h||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(e){try{return s.call(null,t,0)}catch(e){return s.call(this,t,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:h}catch(t){s=h}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(t){i=a}}();var n,c=[],g=!1,u=-1;function d(){g&&n&&(g=!1,n.length?c=n.concat(c):u=-1,c.length&&C())}function C(){if(!g){var t=o(d);g=!0;for(var e=c.length;e;){for(n=c,c=[];++u<e;)n&&n[u].run();u=-1,e=c.length}n=null,g=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function m(t,e){this.fun=t,this.array=e}function l(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];c.push(new m(t,e)),1!==c.length||g||o(C)},m.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=l,r.addListener=l,r.once=l,r.off=l,r.removeListener=l,r.removeAllListeners=l,r.emit=l,r.prependListener=l,r.prependOnceListener=l,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t){t.exports={name:"wpc-emu",version:"0.22.0",description:"WPC pinball machine emu",main:"index.js",engines:{node:">=10.0.0"},author:"Michael Vogt",license:"ISC",devDependencies:{ava:"^1.3.1","copy-webpack-plugin":"^5.0.0","http-server":"^0.11.1",nyc:"^13.3.0","remove-debug-loader":"^0.2.6",sinon:"^7.2.7","terser-webpack-plugin":"^1.2.3",webpack:"^4.30.0","webpack-cli":"^3.3.0",xo:"^0.24.0"},dependencies:{debug:"^4.1.1"},xo:{envs:["node","browser"],space:!0,rules:{"comma-dangle":0,"arrow-parens":0,"no-var":0,"comma-spacing":0,"capitalized-comments":0,"promise/prefer-await-to-then":0,"ava/prefer-async-await":0,"no-use-before-define":0,"spaced-comment":0,"object-curly-spacing":0,"array-bracket-spacing":0,"padded-blocks":0,"no-mixed-operators":0,"unicorn/import-index":0,"new-cap":0,"prefer-destructuring":0,"no-use-extend-native/no-use-extend-native":0,"padding-line-between-statements":0,"array-element-newline":0},ignores:["client","docs","test/tracer/disasm.js","lib/boards/up/ym2151.js","lib/boards/up/mc6809.js"]},scripts:{build:"webpack --mode development",watch:"webpack --mode development --watch","build:production":"webpack --mode production",start:"DEBUG=* node index.js","start:fileserv":"cp -fr ./rom ./dist && npm run start:webserver","start:webserver":"http-server ./dist -S -C assets/localhost-cert/server.crt -K assets/localhost-cert/server.key --cors -p 8080 || echo '\n\nERROR. Did you created and install the local dev certificates? Heres the content:' && cat assets/localhost-cert/README.md",debug:"node --inspect index.js",xo:"xo",test:"nyc ava --verbose test/lib/**","test:coverage":"nyc report --reporter=html","test:debug":"DEBUG='wpc*' ava --fail-fast --verbose test/lib/**","test:integration":"ava --verbose test/integration/*.test.js","test:runner":"node test/headless-runner.js","tracer:dump":"cd ./test/tracer && ./_runbig.sh","tracer:stats":"cd ./test/tracer && ./_runbig.sh stats","tracer:status":"cd ./test/tracer/wpc-emu-dumps && git status","tracer:diff":"cd ./test/tracer/wpc-emu-dumps && git diff",benchmark:"node test/integration/benchmark.js > /dev/null","benchmark:t2":"CYCLES=20000000 ROMFILE=./rom/t2_l8.rom node test/integration/benchmark.js > /dev/null",release:"rm -rf ./docs/* && rm -rf ./dist/* && npm run build:production && cd client && npm run build:production && cd .. && cp -rf dist/* docs"}}},function(t,e,s){"use strict";const i=s(6),r=131072,h=[1,2,4,8],a=32768,o=["wpcDmd","wpcFliptronics"];t.exports={parse:function(t,e={}){return new Promise((s,n)=>{if("object"!=typeof t)return n(new Error("INVALID_ROM_DATA"));const c=t.u06,g=c.length/r,u=!Number.isInteger(g),d=!h.includes(g);if(u||d)return n(new Error("INVALID_ROM_SIZE"));const C=function(t){return t.subarray(t.length-a,t.length)}(c),m=function(t){return t.subarray(0,t.length-a)}(c),l=i.search(m,C),P=Array.isArray(e.features),S={romSizeMBit:g,systemRom:C,gameRom:m,gameIdMemoryLocation:l,fileName:e.fileName||"Unknown",skipWpcRomCheck:!0===e.skipWpcRomCheck,hasSecurityPic:P&&e.features.includes("securityPic"),preDcsSoundboard:P&&(e.features.includes(o[0])||e.features.includes(o[1]))};s(S)})}}},function(t,e,s){"use strict";const i=7,r=236,h=159,a=131,o=18,n=52;t.exports={search:function(t,e){let s=0;for(let c=0;c<t.length-i;c++){const i=t[c]===r&&t[c+1]===h;if(i){const i=t[c+4]===a&&t[c+5]===o&&t[c+6]===n;if(i&&2==++s){let s=(t[c+2]<<8)+t[c+3];const i=(e[s-=32768]<<8)+e[s+1];return console.log("GAMEID_FOUND",i),i}}}}}},function(t,e,s){"use strict";const i=s(8),r=s(9),h=s(0),a=s(10),o=s(18),n=s(21),c=s(22),g=s(23),u=s(24),d=s(25),C=s(28),m=16384;t.exports={getInstance:function(t){return new l(t)}};class l{constructor(t){this.ram=new Uint8Array(i.MEMORY_ADDR_HARDWARE).fill(0),this.romSizeMBit=t.romSizeMBit,this.systemRom=t.systemRom,this.romFileName=t.fileName,this.gameRom=t.gameRom,this.memoryPatch=c.getInstance(),t.gameIdMemoryLocation&&g.run(this.memoryPatch,t.gameIdMemoryLocation),!0===t.skipWpcRomCheck&&u.run(this.memoryPatch);const e=this._read8.bind(this),s=this._write8.bind(this);this.cpu=C.getInstance(s,e,"cpuboard");const r={interruptCallback:{irq:this.cpu.irq,firq:()=>{this.asic.firqSourceDmd(!1),this.cpu.firq()},firqFromDmd:()=>{this.asic.firqSourceDmd(!0),this.cpu.firq()},clearIrqFlag:()=>{this.cpu.clearIrqMasking()},clearFirqFlag:()=>{this.cpu.clearFirqMasking()},reset:this.cpu.reset},romSizeMBit:this.romSizeMBit,romObject:t,ram:this.ram};this.asic=a.getInstance(r),this.soundBoard=o.getInstance(r),this.dmdBoard=d.getInstance(r),this.externalIo=n.getInstance(),this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0}reset(){console.log("RESET_CPU_BOARD"),this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0,this.cpu.reset(),this.asic.reset(),this.dmdBoard.reset(),this.soundBoard.reset()}getState(){const t={ram:this.ram,wpc:this.asic.getState(),dmd:this.dmdBoard.getState(),sound:this.soundBoard.getState()},e=this.cpu.getState();return{asic:t,romFileName:this.romFileName,cpuState:e,protectedMemoryWriteAttempts:this.protectedMemoryWriteAttempts,ticksIrq:this.ticksIrq,ticksUpdateDmd:this.ticksUpdateDmd}}setState(t){this.ram.set(Uint8Array.from(t.asic.ram),0),this.cpu.setState(t.cpuState),this.protectedMemoryWriteAttempts=t.protectedMemoryWriteAttempts,this.ticksIrq=t.ticksIrq,this.ticksUpdateDmd=t.ticksUpdateDmd,this.asic.setState(t.asic.wpc),this.dmdBoard.setState(t.asic.dmd),this.soundBoard.setState(t.asic.sound)}setCabinetInput(t){this.asic.setCabinetInput(t)}setInput(t){this.asic.setInput(t)}setFliptronicsInput(t){this.asic.setFliptronicsInput(t)}toggleMidnightMadnessMode(){this.asic.toggleMidnightMadnessMode()}registerSoundBoardCallback(t){this.soundBoard.registerSoundBoardCallback(t)}start(){console.log("RESET_SYSTEM"),this.reset()}executeCycle(t,e){let s=0;for(;s<t;){const t=this.cpu.steps(e);s+=t,this.ticksIrq+=t,this.ticksIrq>=h.CALL_IRQ_AFTER_TICKS&&(this.ticksIrq-=h.CALL_IRQ_AFTER_TICKS,this.cpu.irq()),this.ticksUpdateDmd+=t,this.ticksUpdateDmd>=h.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS&&(this.ticksUpdateDmd-=h.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS,this.dmdBoard.copyScanline()),this.asic.executeCycle(t)}return s}_read8(t){if(!t&&0!==t)throw new TypeError("CPU_MEMORY_READ_BUG_DETECTED!");const e=this.memoryPatch.hasPatch(t);if(e)return e.value;const s=i.getAddress(t);switch(s.subsystem){case i.SUBSYSTEM_RAM:return this.ram[s.offset];case i.SUBSYSTEM_HARDWARE:return this._hardwareRead(s.offset);case i.SUBSYSTEM_BANKSWITCHED:return this._bankswitchedRead(s.offset);case i.SUBSYSTEM_SYSTEMROM:return this.systemRom[s.offset];default:throw new Error("INVALID_READ_SUBSYSTEM")}}_write8(t,e){if(!t&&0!==t)throw console.log("CPU_MEMORY_WRITE_BUG_DETECTED",{offset:t,value:e}),new TypeError("CPU_MEMORY_WRITE_BUG_DETECTED!");e&=255;const s=i.getAddress(t);switch(s.subsystem){case i.SUBSYSTEM_RAM:this.asic.isMemoryProtectionEnabled()||(t&this.asic.memoryProtectionMask)!==this.asic.memoryProtectionMask?this.ram[s.offset]=e:this.protectedMemoryWriteAttempts++;break;case i.SUBSYSTEM_HARDWARE:this._hardwareWrite(t,e);break;default:console.log("CPU_WRITE8_FAIL",JSON.stringify(s),t,e)}}_bankswitchedRead(t){const e=this.asic.romBank;if(a.SYSTEM_ROM_BANK_NUMBERS.includes(e)){const s=a.SYSTEM_ROM_BANK_NUMBERS.indexOf(e)*m;return this.systemRom[t+s]}const s=t+e*m;return this.gameRom[s]}_hardwareWrite(t,e){const s=r.getAddress(t);switch(s.subsystem){case r.SUBSYSTEM_DMD:this.dmdBoard.write(t,e);break;case r.SUBSYSTEM_EXTERNAL_IO:this.externalIo.write(t,e);break;case r.SUBSYSTEM_SOUND:this.soundBoard.writeInterface(t,e);break;case r.SUBSYSTEM_WPCIO:this.asic.write(t,e);break;default:throw console.log(JSON.stringify(s)),new Error("CPUBOARD_INVALID_HW_WRITE")}}_hardwareRead(t){const e=r.getAddress(t);switch(e.subsystem){case r.SUBSYSTEM_DMD:return this.dmdBoard.read(t);case r.SUBSYSTEM_EXTERNAL_IO:return this.externalIo.read(t);case r.SUBSYSTEM_SOUND:return this.soundBoard.readInterface(t);case r.SUBSYSTEM_WPCIO:return this.asic.read(t);default:throw console.log(JSON.stringify(e)),new Error("INVALID_HW_READ")}}}},function(t,e,s){"use strict";const i=12288,r=15360,h=16303,a=16384,o=32768,n=65536,c="ram",g="hardware",u="bank",d="system";function C(t,e){return{offset:t,subsystem:e}}t.exports={getAddress:function(t){if(void 0===t)throw new Error("MEMORY_GET_ADDRESS_UNDEFINED");const e=(t&=65535)>=r&&t<=h;if(t<i||e)return C(t,c);if(t<a)return C(t,g);if(t<o)return C(t-16384,u);if(t<n)return C(t-32768,d);throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},MEMORY_ADDR_RAM:i,MEMORY_ADDR_HARDWARE:a,SUBSYSTEM_RAM:c,SUBSYSTEM_HARDWARE:g,SUBSYSTEM_BANKSWITCHED:u,SUBSYSTEM_SYSTEMROM:d}},function(t,e,s){"use strict";const i=12288,r=16320,h=16348,a=16352,o=16340,n=16384,c="wpcio",g="sound",u="externalIo",d="dmd";function C(t,e){return{offset:t,subsystem:e}}t.exports={getAddress:function(t){if(void 0===t)throw new Error("HW_GET_ADDRESS_UNDEFINED");if((t&=65535)<i)throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16));if(t<r)return C(t,d);if(t===o)return C(t,c);if(t<h)return C(t,u);if(t<a)return C(t,g);if(t<n)return C(t,c);throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},SUBSYSTEM_WPCIO:c,SUBSYSTEM_SOUND:g,SUBSYSTEM_EXTERNAL_IO:u,SUBSYSTEM_DMD:d}},function(t,e,s){"use strict";const i=s(0),r=s(11),h=s(12),a=s(13),o=s(14),n=s(15),c=s(16),g=s(17),u={WPC_FLIPTRONICS_FLIPPER_PORT_A:16340,WPC_SOLENOID_GEN_OUTPUT:16352,WPC_SOLENOID_HIGHPOWER_OUTPUT:16353,WPC_SOLENOID_FLASH1_OUTPUT:16354,WPC_SOLENOID_LOWPOWER_OUTPUT:16355,WPC_LAMP_ROW_OUTPUT:16356,WPC_LAMP_COL_STROBE:16357,WPC_GI_TRIAC:16358,WPC_SW_JUMPER_INPUT:16359,WPC_SWITCH_CABINET_INPUT:16360,WPC_SWITCH_ROW_SELECT:16361,WPC_SWITCH_COL_SELECT:16362,WPC_PICREAD:16361,WPC_PICWRITE:16362,WPC_EXTBOARD1:16363,WPC_EXTBOARD2:16364,WPC_EXTBOARD3:16365,WPC95_FLIPPER_COIL_OUTPUT:16366,WPC95_FLIPPER_SWITCH_INPUT:16367,WPC_LEDS:16370,WPC_RAM_BANK:16371,WPC_SHIFTADDRH:16372,WPC_SHIFTADDRL:16373,WPC_SHIFTBIT:16374,WPC_SHIFTBIT2:16375,WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:16376,WPC_ROM_LOCK:16377,WPC_CLK_HOURS_DAYS:16378,WPC_CLK_MINS:16379,WPC_ROM_BANK:16380,WPC_RAM_LOCK:16381,WPC_RAM_LOCKSIZE:16382,WPC_ZEROCROSS_IRQ_CLEAR:16383},d=[];Object.keys(u).forEach(t=>{d[u[t]]=t});const C=[0,7,15,0,31,0,0,0,63],m=r.USA,l=180,P=[62,63],S=63,_=6144,R=6145,f=6146,A=6147,b=6148,k=6149,p=6150,E=6151,D=6152,B=new Date("December 17, 1995 23:59:45").getTime(),I=2;t.exports={getInstance:function(t){return new W(t)},SYSTEM_ROM_BANK_NUMBERS:P,OP:u};class W{constructor(t){if(this.interruptCallback=t.interruptCallback,this.pageMask=C[t.romSizeMBit],0===this.pageMask)throw new Error("PAGEMASK_EMPTY");this.ram=t.ram,this.hardwareHasSecurityPic=t.romObject&&t.romObject.hasSecurityPic,this.inputSwitchMatrix=h.getInstance(),this.outputLampMatrix=a.getInstance(i.CALL_UPDATELAMP_AFTER_TICKS),this.outputSolenoidMatrix=o.getInstance(i.CALL_UPDATESOLENOID_AFTER_TICKS),this.outputGeneralIllumination=n.getInstance(),this.securityPic=g.getInstance(),this.zeroCrossFlag=0,this.memoryProtectionMask=null,this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!1,this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0}reset(){console.log("RESET_ASIC"),this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._firqSourceDmd=!1,this.zeroCrossFlag=0,this.ticksZeroCross=0,this.memoryProtectionMask=null,this.hardwareHasSecurityPic&&this.securityPic.reset(),this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!1}getState(){let t=this.getTime().toTimeString().split(" ")[0];return this.midnightModeEnabled&&(t+=" MM!"),{version:I,diagnosticLed:this.ram[u.WPC_LEDS],lampState:this.outputLampMatrix.lampState,solenoidState:this.outputSolenoidMatrix.solenoidState,generalIlluminationState:this.outputGeneralIllumination.generalIlluminationState,inputState:this.inputSwitchMatrix.switchState,inputSwitchMatrixActiveColumn:this.inputSwitchMatrix.activeColumn,diagnosticLedToggleCount:this.diagnosticLedToggleCount,irqEnabled:this.periodicIRQTimerEnabled,activeRomBank:this.romBank,zeroCrossFlag:this.zeroCrossFlag,ticksZeroCross:this.ticksZeroCross,memoryProtectionMask:this.memoryProtectionMask,firqSourceDmd:this._firqSourceDmd,midnightModeEnabled:this.midnightModeEnabled,time:t}}setState(t={}){if(t.version!==I)return console.log("INVALID_STATE_VERSION"),!1;this.outputLampMatrix.lampState=Uint8Array.from(t.lampState),this.outputSolenoidMatrix.solenoidState=Uint8Array.from(t.solenoidState),this.outputGeneralIllumination.generalIlluminationState=Uint8Array.from(t.generalIlluminationState),this.inputSwitchMatrix.switchState=Uint8Array.from(t.inputState),this.inputSwitchMatrix.activeColumn=t.inputSwitchMatrixActiveColumn,this.diagnosticLedToggleCount=t.diagnosticLedToggleCount,this.periodicIRQTimerEnabled=t.irqEnabled,this.romBank=t.activeRomBank,this.zeroCrossFlag=t.zeroCrossFlag,this.ticksZeroCross=t.ticksZeroCross,this.memoryProtectionMask=t.memoryProtectionMask,this._firqSourceDmd=t.firqSourceDmd,this.midnightModeEnabled=t.midnightModeEnabled}setZeroCrossFlag(){this.zeroCrossFlag=1}setCabinetInput(t){this.inputSwitchMatrix.setCabinetKey(255&t)}setInput(t){this.inputSwitchMatrix.setInputKey(255&t)}setFliptronicsInput(t){this.inputSwitchMatrix.setFliptronicsInput(t)}firqSourceDmd(t){this._firqSourceDmd=!0===t}toggleMidnightMadnessMode(){this.midnightMadnessMode=Date.now(),this.midnightModeEnabled=!this.midnightModeEnabled}executeCycle(t){this.ticksZeroCross+=t,this.ticksZeroCross>=i.CALL_ZEROCLEAR_AFTER_TICKS&&(this.ticksZeroCross-=i.CALL_ZEROCLEAR_AFTER_TICKS,this.setZeroCrossFlag()),this.outputLampMatrix.executeCycle(t),this.outputSolenoidMatrix.executeCycle(t)}isMemoryProtectionEnabled(){return this.ram[u.WPC_RAM_LOCK]===l}getTime(){return this.midnightModeEnabled?new Date(B+Date.now()-this.midnightMadnessMode):new Date}write(t,e){switch(this.ram[t]=e,t){case u.WPC_RAM_LOCK:case u.WPC_RAM_BANK:case u.WPC_CLK_HOURS_DAYS:case u.WPC_CLK_MINS:case u.WPC_SHIFTADDRH:case u.WPC_SHIFTADDRL:case u.WPC_SHIFTBIT:case u.WPC_SHIFTBIT2:case u.WPC_ROM_LOCK:case u.WPC_EXTBOARD1:case u.WPC_EXTBOARD2:case u.WPC_EXTBOARD3:case u.WPC95_FLIPPER_SWITCH_INPUT:break;case u.WPC_FLIPTRONICS_FLIPPER_PORT_A:this.outputSolenoidMatrix.writeFliptronic(255&~e);break;case u.WPC95_FLIPPER_COIL_OUTPUT:this.outputSolenoidMatrix.writeFliptronic(e);break;case u.WPC_RAM_LOCKSIZE:this.isMemoryProtectionEnabled()&&(this.memoryProtectionMask=c.getMemoryProtectionMask(e));break;case u.WPC_SWITCH_COL_SELECT:if(this.hardwareHasSecurityPic)return this.securityPic.write(e);this.inputSwitchMatrix.setActiveColumn(e);break;case u.WPC_GI_TRIAC:this.outputGeneralIllumination.update(e);break;case u.WPC_LAMP_ROW_OUTPUT:this.outputLampMatrix.setActiveRow(e);break;case u.WPC_LAMP_COL_STROBE:this.outputLampMatrix.setActiveColumn(e);break;case u.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:break;case u.WPC_SOLENOID_GEN_OUTPUT:case u.WPC_SOLENOID_HIGHPOWER_OUTPUT:case u.WPC_SOLENOID_FLASH1_OUTPUT:case u.WPC_SOLENOID_LOWPOWER_OUTPUT:this.outputSolenoidMatrix.write(t,e);break;case u.WPC_LEDS:e!==this.oldDiagnostigLedState&&(this.diagnosticLedToggleCount++,this.oldDiagnostigLedState=e);break;case u.WPC_ROM_BANK:{const t=e&this.pageMask,s=t+(S^this.pageMask);if(P.includes(s))return void(this.romBank=s);this.romBank=t;break}case u.WPC_ZEROCROSS_IRQ_CLEAR:{128&e&&this.interruptCallback.clearIrqFlag();const t=(16&e)>0;t!==this.periodicIRQTimerEnabled&&(this.periodicIRQTimerEnabled=t);break}default:console.log("ASIC_WRITE_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){let e;switch(t){case u.WPC_LEDS:case u.WPC_RAM_BANK:case u.WPC_ROM_LOCK:case u.WPC_EXTBOARD1:case u.WPC_EXTBOARD2:case u.WPC_EXTBOARD3:case u.WPC95_FLIPPER_COIL_OUTPUT:return this.ram[t];case u.WPC95_FLIPPER_SWITCH_INPUT:case u.WPC_FLIPTRONICS_FLIPPER_PORT_A:return this.inputSwitchMatrix.getFliptronicsKeys();case u.WPC_RAM_LOCK:case u.WPC_RAM_LOCKSIZE:return this.ram[t];case u.WPC_SWITCH_CABINET_INPUT:return this.inputSwitchMatrix.getCabinetKey();case u.WPC_ROM_BANK:return this.ram[t]&this.pageMask;case u.WPC_SWITCH_ROW_SELECT:return this.hardwareHasSecurityPic?this.securityPic.read(t=>this.inputSwitchMatrix.getRow(t)):this.inputSwitchMatrix.getActiveRow();case u.WPC_SHIFTADDRH:return e=this.ram[u.WPC_SHIFTADDRH]+(this.ram[u.WPC_SHIFTADDRL]+(this.ram[u.WPC_SHIFTBIT]>>>3)>>>8)&255;case u.WPC_SHIFTADDRL:return e=this.ram[u.WPC_SHIFTADDRL]+(this.ram[u.WPC_SHIFTBIT]>>>3)&255;case u.WPC_SHIFTBIT:case u.WPC_SHIFTBIT2:return 1<<(7&this.ram[t]);case u.WPC_CLK_HOURS_DAYS:{e=this.getTime();let t=0;return t+=this.ram[_]=e.getFullYear()>>8,t+=this.ram[R]=255&e.getFullYear(),t+=this.ram[f]=e.getMonth()+1,t+=this.ram[A]=e.getDate(),t+=this.ram[b]=e.getDay()+1,t+=this.ram[k]=0,t=65535-(t+=this.ram[p]=1),this.ram[E]=t>>8,this.ram[D]=255&t,e.getHours()}case u.WPC_CLK_MINS:return(e=this.getTime()).getMinutes();case u.WPC_SW_JUMPER_INPUT:return m;case u.WPC_ZEROCROSS_IRQ_CLEAR:return e=this.zeroCrossFlag<<7|127&this.ram[t],this.zeroCrossFlag=0,e;case u.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:return!0===this._firqSourceDmd?0:128;default:return console.log("ASIC_READ_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t]}}}},function(t,e,s){"use strict";t.exports={FRENCH:48,GERMAN:112,EUROPE:208,USA:0,USA2:240}},function(t,e,s){"use strict";const i=s(1);t.exports={getInstance:function(){return new g}};const r=24,h=100,a=10,o=0,n=0,c=9;class g{constructor(){this.cabinetKeyState=o,this.cabinetKeyAutoreleaseTs=0,this.switchState=new Uint8Array(a).fill(o),this.setInputKey(r),this.activeColumn=0}setActiveColumn(t){this.activeColumn=i.findMsbBit(t)}setCabinetKey(t){console.log("SET CABINET_KEY",t),this.switchState[n]=t,this.cabinetKeyAutoreleaseTs=Date.now()}getCabinetKey(){return Date.now()-this.cabinetKeyAutoreleaseTs>h&&(this.switchState[n]=o),this.switchState[n]}setFliptronicsInput(t){if(!("string"==typeof t&&2===t.length)||"F"!==t[0])return void console.log("INVALID_FLIPTRONICS_INPUT_VALUE_"+t);const e=t[1]-1;console.log("setFliptronicsInput",t),this.switchState[c]^=i.setMsbBit(e)}setInputKey(t=0){if(!Number.isInteger(t)||t<11||t>95)return void console.log("INVALID INPUT_KEY",t);const e=t-1,s=parseInt(e/10,10),r=parseInt(e%10,10);this.switchState[s]^=i.setMsbBit(r),this.switchState[2]|=8}getActiveRow(){return this.switchState[this.activeColumn]}getRow(t){return this.switchState[t]}getFliptronicsKeys(){return 255&~this.switchState[c]}clearInputKeys(){this.cabinetKeyState=o,this.switchState.fill(o)}}},function(t,e,s){"use strict";t.exports={getInstance:function(t){return new h(t)}};const i=64,r=0;class h{constructor(t){this.updateAfterTicks=t,this.lampState=new Uint8Array(i).fill(r),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateLampState(){if(0!==this.activeColumn)for(let t=0;t<8;t++)if(this.activeRow&1<<t)for(let e=0;e<8;e++)this.activeColumn&1<<e&&(this.lampState[e<<3|t]|=128)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.lampState=this.lampState.map(t=>t>>>1))}setActiveRow(t){this.activeRow=t,this._updateLampState()}setActiveColumn(t){this.activeColumn=t,this._updateLampState()}}},function(t,e,s){"use strict";t.exports={getInstance:function(t){return new m(t)}};const i=48,r=0,h=16352,a=16353,o=16354,n=16355,c=0,g=8,u=16,d=24,C=32;class m{constructor(t){if(!t)throw new Error("MISSING_UPDATE_AFTER_TICKS");this.updateAfterTicks=t,this.solenoidState=new Uint8Array(i).fill(r),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateSolenoidsPacked(t,e){for(var s=0;s<8;s++)e&1<<s&&(this.solenoidState[t+s]=255)}executeCycle(t){this.ticks+=t,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.solenoidState=this.solenoidState.map(t=>t>>>1))}writeFliptronic(t){return this._updateSolenoidsPacked(C,t)}write(t,e){if(e<0||e>255)throw new Error("SOLENOID_MATRIX_INVALID_VALUE_"+e);switch(t){case a:return this._updateSolenoidsPacked(c,e);case n:return this._updateSolenoidsPacked(g,e);case o:return this._updateSolenoidsPacked(u,e);case h:return this._updateSolenoidsPacked(d,e);default:throw new Error("SOLENOID_MATRIX_INVALID_OFFSET_"+t.toString(16))}}}},function(t,e,s){"use strict";t.exports={getInstance:function(){return new h}};const i=8,r=0;class h{constructor(){this.generalIlluminationState=new Uint8Array(i).fill(r),this.lastValue=-1}update(t){if(t!==this.lastValue){this.lastValue=t;for(var e=0;e<8;e++)this.generalIlluminationState[e]=t&1<<e?255:0}}}},function(t,e,s){"use strict";const i=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15];t.exports={getMemoryProtectionMask:function(t){return 65535&i[15&t]+(240&t)+16<<8}}},function(t,e,s){"use strict";const i=[0,0,0,1,2,3,4,5,6,1,2,3,4,5,1,2,3],r=16,h=0,a=13,o=32,n=255;t.exports={getInstance:function(t){return new c(t)}};class c{constructor(t=559){this.machineNumber=t,this.gameSerialNumber=new Uint8Array(i),this.picSerialNumber=new Uint8Array(r);const e=String(t);this.gameSerialNumber[0]=parseInt(e[0],10),this.gameSerialNumber[1]=parseInt(e[1],10),this.gameSerialNumber[2]=parseInt(e[2],10),this.picSerialNumber[10]=0,this.picSerialNumber[2]=0;let s=100*this.gameSerialNumber[1]+10*this.gameSerialNumber[7]+this.gameSerialNumber[4]+5*this.picSerialNumber[10];s=7117*s+127984,this.picSerialNumber[1]=s>>16&255,this.picSerialNumber[11]=s>>8&255,this.picSerialNumber[9]=255&s,s=4223*(s=1e4*this.gameSerialNumber[2]+1e3*this.gameSerialNumber[15]+100*this.gameSerialNumber[0]+10*this.gameSerialNumber[8]+this.gameSerialNumber[6]+2*this.picSerialNumber[10]+this.picSerialNumber[2])+7463513,this.picSerialNumber[7]=s>>24&255,this.picSerialNumber[12]=s>>16&255,this.picSerialNumber[0]=s>>8&255,this.picSerialNumber[8]=255&s,s=581*(s=1e3*this.gameSerialNumber[16]+100*this.gameSerialNumber[3]+10*this.gameSerialNumber[5]+this.gameSerialNumber[14]+this.picSerialNumber[2])+15732,this.picSerialNumber[3]=s>>16&255,this.picSerialNumber[14]=s>>8&255,this.picSerialNumber[6]=255&s,s=99999-(s=1e4*this.gameSerialNumber[13]+1e3*this.gameSerialNumber[12]+100*this.gameSerialNumber[11]+10*this.gameSerialNumber[10]+this.gameSerialNumber[9]),this.picSerialNumber[15]=s>>8&255,this.picSerialNumber[4]=255&s}reset(){this.lastByteWrite=n,this.unlockMode=0,this.unlockCode=0,this.writesUntilUnlockNeeded=32,console.log("RESET SECURITY PIC")}read(t){switch(this.lastByteWrite){case h:case o:case n:return 0;case a:return this.writesUntilUnlockNeeded=this.writesUntilUnlockNeeded-1&31,this.writesUntilUnlockNeeded;case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:if(this.unlockMode>0)return console.log("Column read in unlock mode"),0;return t(this.lastByteWrite-22+1);case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:const e=this.lastByteWrite-112;return e<0||e>this.gameSerialNumber.length?(console.log("invalid OFFSET read:",e),0):this.picSerialNumber[e];default:return console.log("Invalid PIC address read",this.lastByteWrite),0}}write(t){if(this.lastByteWrite!==n||t===h){if(this.lastByteWrite=t,this.unlockMode>0)return this.unlockCode=this.unlockCode<<8|t,void(++this.unlockMode>3&&(this.unlockMode=0));t===o&&(this.unlockMode=1,this.unlockCode=0)}}}},function(t,e,s){"use strict";const i=s(19),r={WPC_LATCH_READ:12288,WPC_LATCH_WRITE:15360,WPC_SOUND_CONTROL_STATUS:16349,WPC_SOUND_DATA:16348};t.exports={getInstance:function(t){return new h(t)},OP:r};class h{constructor(t){this.interruptCallback=t.interruptCallback;const e=!0===t.romObject.preDcsSoundboard;this.soundSerialInterface=i.getInstance(e),this.readDataBytes=0,this.writeDataBytes=0,this.readControlBytes=0,this.writeControlBytes=0,this.resetCount=0}reset(){console.log("RESET_SOUNDBOARD"),this.soundSerialInterface.reset(),this.readDataBytes=0,this.writeDataBytes=0,this.readControlBytes=0,this.writeControlBytes=0,this.resetCount++}getState(){return{volume:this.soundSerialInterface.volume,readDataBytes:this.readDataBytes,writeDataBytes:this.writeDataBytes,readControlBytes:this.readControlBytes,writeControlBytes:this.writeControlBytes}}setState(t){this.soundSerialInterface.volume=t.volume,this.readDataBytes=t.readDataBytes,this.writeDataBytes=t.writeDataBytes,this.readControlBytes=t.readControlBytes,this.writeControlBytes=t.writeControlBytes}registerSoundBoardCallback(t){if("function"!=typeof t)return console.log("ERROR: INVALID CALLBACK FUNCTION"),!1;this.soundSerialInterface.registerCallBack(t)}writeInterface(t,e){switch(t){case r.WPC_SOUND_CONTROL_STATUS:this.writeControlBytes++,this.soundSerialInterface.writeControl(e)&&this.reset();break;case r.WPC_SOUND_DATA:if(this.resetCount>20&&0===e)return this.resetCount=0,void console.log("ignore first 0 after multiple soundboard reset!");this.writeDataBytes++,this.soundSerialInterface.writeData(e);break;default:console.log("SND_W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}readInterface(t){switch(t){case r.WPC_SOUND_CONTROL_STATUS:return this.readControlBytes++,this.soundSerialInterface.readControl();case r.WPC_SOUND_DATA:return this.readDataBytes++,this.soundSerialInterface.readData();default:return console.log("wpcemu:boards:sound-board R_NOT_IMPLEMENTED","0x"+t.toString(16)),0}}}},function(t,e,s){"use strict";const i=s(20);t.exports={getInstance:function(t){return new I(t)}};const r=0,h=85,a=170,o=992,n=993,c=994,g=995,u=996,d=997,C=998,m=999,l=1e3,P=978,S=979,_=121,R=122,f="PLAYSAMPLE",A="STOPSOUND",b="MAINVOLUME",k="CHANNELOFF",p=0,E=255,D=128,B=8;class I{constructor(t){this.isPreDcsSoundBoard=t,this.soundBoardCallback=(()=>{}),this.writeQueue=new W,this.readQueue=new W,this.volume=B,this.lastUnknownControlWrite=-1}reset(){this.writeQueue.clear(),this.readQueue.clear(),this.volume=B,this._callbackStopAllSamples(),this.lastUnknownControlWrite=-1}registerCallBack(t){this.soundBoardCallback=t}readData(){return this.readQueue.isEmpty()?p:this.readQueue.remove()}writeData(t){this.writeQueue.insert(t),this.isPreDcsSoundBoard?this._processPreDcsSoundCommand(t):this._processDcsSoundCommand(t)}readControl(){return this.readQueue.isEmpty()?E:D}writeControl(t){if(0===t)return!0;1!==t&&t!==this.lastUnknownControlWrite&&(console.log("UNKNOWN CONTROL WRITE:",t),this.lastUnknownControlWrite=t)}_processPreDcsSoundCommand(t){if(this.writeQueue.queue[0]===_){if(3!==this.writeQueue.size())return;const t=i.getRelativeVolumePreDcs(this.writeQueue.queue[1],this.writeQueue.queue[2]);return Number.isInteger(t)&&(this.volume=t,this._callbackMainVolume(this.volume)),void this.writeQueue.clear()}if(this.writeQueue.queue[0]===R){if(this.writeQueue.size()>1){const t=(R<<8)+this.writeQueue.queue[1];this._callbackPlaySample(t),this.writeQueue.clear()}}else this._callbackPlaySample(this.writeQueue.queue[0]),this.writeQueue.clear()}_processDcsSoundCommand(){if(this.writeQueue.size()<2)return;if(this.writeQueue.queue[0]===h){if(console.log("-> pendingVolumeCommand",this.writeQueue.size()),4!==this.writeQueue.size())return;if(this.writeQueue.queue[1]===a){const t=i.getRelativeVolumeDcs(this.writeQueue.queue[2],this.writeQueue.queue[3]);Number.isInteger(t)&&(this.volume=t,this._callbackMainVolume(this.volume))}else console.log("ONLY GLOBAL VOLUME SUPPORTED NOW! ;(");return void this.writeQueue.clear()}const t=this.writeQueue.queue[0]<<8|this.writeQueue.queue[1];switch(t){case r:console.log("-> STOP ALL SAMPLES"),this._callbackStopAllSamples();break;case o:case n:case c:case g:case u:case d:case C:{const e=t-o;this._callbackChannelOff(e);break}case P:case S:this.readQueue.insert(1);break;case m:console.log("DCS_GET_MAIN_VERSION"),this.readQueue.insert(16);break;case l:console.log("DCS_GET_MINOR_VERSION"),this.readQueue.insert(1);break;default:this._callbackPlaySample(t)}this.writeQueue.clear()}_callbackStopAllSamples(){this.soundBoardCallback({command:A})}_callbackPlaySample(t){t!==r?this.soundBoardCallback({command:f,id:t}):this._callbackStopAllSamples()}_callbackChannelOff(t){this.soundBoardCallback({command:k,channel:t})}_callbackMainVolume(t){this.soundBoardCallback({command:b,value:t})}}class W{constructor(){this.queue=[]}insert(t){this.queue.push(t)}remove(){return this.queue.shift()}isEmpty(){return 0===this.queue.length}clear(){this.queue=[]}size(){return this.queue.length}}},function(t,e,s){"use strict";t.exports={getRelativeVolumeDcs:function(t,e){if(t!==(255&~e))return void console.log("WARNING, INVALID VOLUME VALUE:",t,e);return parseInt(t/8,10)},getRelativeVolumePreDcs:function(t,e){if(t!==(255&~e))return void console.log("WARNING, INVALID VOLUME VALUE:",t,e);return parseInt(t,10)}}},function(t,e,s){"use strict";const i=32,r={WPC_PARALLEL_STATUS_PORT:16320,WPC_PARALLEL_DATA_PORT:16321,WPC_PARALLEL_STROBE_PORT:16322,WPC_SERIAL_DATA_OUTPUT:16323,WPC_SERIAL_CONTROL_OUTPUT:16324,WPC_SERIAL_BAUD_SELECT:16325,WPC_TICKET_DISPENSE:16326,WPC_FLIPTRONICS_FLIPPER_PORT_B:16341},h=255;t.exports={getInstance:function(){return new a}};class a{constructor(){this.ram=new Uint8Array(i).fill(0)}write(t,e){const s=t-r.WPC_PARALLEL_STATUS_PORT;switch(this.ram[s]=e,t){case r.WPC_PARALLEL_STATUS_PORT:case r.WPC_PARALLEL_DATA_PORT:case r.WPC_PARALLEL_STROBE_PORT:case r.WPC_SERIAL_DATA_OUTPUT:case r.WPC_SERIAL_CONTROL_OUTPUT:case r.WPC_SERIAL_BAUD_SELECT:case r.WPC_TICKET_DISPENSE:case r.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){const e=t-r.WPC_PARALLEL_STATUS_PORT;switch(t){case r.WPC_TICKET_DISPENSE:return h;case r.WPC_PARALLEL_STATUS_PORT:case r.WPC_PARALLEL_DATA_PORT:case r.WPC_PARALLEL_STROBE_PORT:case r.WPC_SERIAL_DATA_OUTPUT:case r.WPC_SERIAL_CONTROL_OUTPUT:case r.WPC_SERIAL_BAUD_SELECT:case r.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO R_NOT_IMPLEMENTED","0x"+t.toString(16))}return this.ram[e]}}},function(t,e,s){"use strict";t.exports={getInstance:function(){return new i}};class i{constructor(){this.patch=new Map}addPatch(t,e){this.patch.set(t,{memoryOffset:t,value:e})}hasPatch(t){return this.patch.get(t)}}},function(t,e,s){"use strict";t.exports={run:function(t,e){return t.addPatch(e,i),t.addPatch(e+1,r),t}};const i=20,r=99},function(t,e,s){"use strict";t.exports={run:function(t){return t.addPatch(65516,0),t.addPatch(65517,255),t}}},function(t,e,s){"use strict";const i=s(26),r=s(27),h={FREEWPC_DEBUG_CONTROL_PORT:15713,WPC_SERIAL_CONTROL_PORT:15974,WPC95_PRINTER_DATA:16304,WPC95_PRINTER_BAUD:16305,WPC95_PRINTER_ADDR:16307,WPC95_PRINTER_STATUS:16309,WPC95_PRINTER_PRESENCE:16311,WPC95_DMD_PAGE3000:16313,WPC95_DMD_PAGE3200:16312,WPC95_DMD_PAGE3400:16315,WPC95_DMD_PAGE3600:16314,WPC_DMD_HIGH_PAGE:16316,WPC_DMD_SCANLINE:16317,WPC_DMD_LOW_PAGE:16318,WPC_DMD_ACTIVE_PAGE:16319},a=512,o=16,n=16,c=3,g=[];Object.keys(h).forEach(t=>{g[h[t]]=t}),t.exports={getInstance:function(t){return new u(t)},OP:h};class u{constructor(t){this.interruptCallback=t.interruptCallback,this.ram=t.ram,this.videoOutputBuffer=new Uint8Array(c*a).fill(0),this.outputDmdDisplay=r.getInstance(a,this.videoOutputBuffer),this.videoRam=new Uint8Array(a*n).fill(0),this.dmdPageMapping=[0,0,0,0,0,0],this.scanline=0,this.activePage=0}reset(){console.log("RESET_DMD_BOARD"),this.videoRam.fill(0),this.videoOutputBuffer.fill(0),this.dmdPageMapping=[0,0,0,0,0,0],this.scanline=0,this.activePage=0,this.nextActivePage=void 0,this.videoOutputPointer=0,this.requestFIRQ=!1}getState(){return{scanline:this.scanline,dmdPageMapping:this.dmdPageMapping,activepage:this.activePage,videoRam:this.videoRam,dmdShadedBuffer:this.outputDmdDisplay.getShadedOutputVideoFrame(),videoOutputPointer:this.videoOutputPointer,requestFIRQ:this.requestFIRQ,videoOutputBuffer:this.outputDmdDisplay.videoBuffer}}setState(t){this.scanline=t.scanline,this.dmdPageMapping=t.dmdPageMapping,this.activepage=t.activepage,this.videoRam=Uint8Array.from(t.videoRam),this.videoOutputPointer=t.videoOutputPointer,this.requestFIRQ=t.requestFIRQ}copyScanline(){const t=this.activePage*a+this.scanline*o,e=this.videoOutputPointer*a+this.scanline*o;for(let i=0;i<o;i++)this.videoOutputBuffer[e+i]=this.videoRam[t+i];this.scanline=this.scanline+1&31,0===this.scanline&&(this.videoOutputPointer=(this.videoOutputPointer+1)%c,this.outputDmdDisplay.updateVideoBuffer(this.videoOutputBuffer),Number.isInteger(this.nextActivePage)&&(this.activePage=this.nextActivePage,this.nextActivePage=void 0));const s=parseInt(this.ram[h.WPC_DMD_SCANLINE]/8,10);this.scanline%4===s&&this.scanline>0&&this.scanline<31&&this.interruptCallback.firqFromDmd()}_getPageOffset(t,e){return this.dmdPageMapping[t]*a+e}_selectDmdPage(t,e){const s=15&e;this.dmdPageMapping[t]=s}write(t,e){const s=i.getAddress(t);if(s.subsystem!==i.SUBSYSTEM_DMD_VIDEORAM)switch(this.ram[t]=e,t){case h.WPC95_PRINTER_DATA:case h.WPC95_PRINTER_BAUD:case h.WPC95_PRINTER_ADDR:case h.WPC95_PRINTER_STATUS:case h.WPC95_PRINTER_PRESENCE:break;case h.WPC_DMD_SCANLINE:this.requestFIRQ=!0;break;case h.WPC_DMD_ACTIVE_PAGE:this.nextActivePage=15&e;break;case h.WPC_DMD_LOW_PAGE:this._selectDmdPage(0,e);break;case h.WPC_DMD_HIGH_PAGE:this._selectDmdPage(1,e);break;case h.WPC95_DMD_PAGE3000:this._selectDmdPage(2,e);break;case h.WPC95_DMD_PAGE3200:this._selectDmdPage(3,e);break;case h.WPC95_DMD_PAGE3400:this._selectDmdPage(4,e);break;case h.WPC95_DMD_PAGE3600:this._selectDmdPage(5,e);break;default:console.log("DMD W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}else{const t=this._getPageOffset(s.bank,s.offset);this.videoRam[t]=e}}read(t){const e=i.getAddress(t);if(e.subsystem===i.SUBSYSTEM_DMD_VIDEORAM){const t=this._getPageOffset(e.bank,e.offset);return this.videoRam[t]}switch(t){case h.WPC95_PRINTER_DATA:case h.WPC95_PRINTER_BAUD:case h.WPC95_PRINTER_ADDR:case h.WPC95_PRINTER_STATUS:case h.WPC95_PRINTER_PRESENCE:case h.FREEWPC_DEBUG_CONTROL_PORT:case h.WPC_SERIAL_CONTROL_PORT:return 0;case h.WPC_DMD_SCANLINE:return this.ram[t];default:return console.log("DMD R_NOT_IMPLEMENTED","0x"+t.toString(16)),0}}}},function(t,e,s){"use strict";const i=12288,r=12800,h=13312,a=13824,o=14336,n=14848,c="videoram",g="command";function u(t,e,s){return{offset:t,subsystem:e,bank:s}}t.exports={getAddress:function(t){if(void 0===t)throw new Error("DMD_GET_ADDRESS_UNDEFINED");if(t<i)throw new Error("INVALID_DMD_ADRESSRANGE_"+t);if((t&=65535)<r)return u(t-i,c,2);if(t<h)return u(t-r,c,3);if(t<a)return u(t-h,c,4);if(t<o)return u(t-a,c,5);if(t<n)return u(t-o,c,0);if(t<n+512)return u(t-n,c,1);return u(t,g)},SUBSYSTEM_DMD_VIDEORAM:c,SUBSYSTEM_CMD:g,MEMORY_ADDR_DMD_PAGE3000:i,MEMORY_ADDR_DMD_PAGE3200:r,MEMORY_ADDR_DMD_PAGE3400:h,MEMORY_ADDR_DMD_PAGE3600:a,MEMORY_ADDR_DMD_PAGE_LOW:o,MEMORY_ADDR_DMD_PAGE_HIGH:n}},function(t,e,s){"use strict";const i=s(1),r=32,h=16;t.exports={getInstance:function(t,e){return new a(t,e)}};class a{constructor(t,e){this.dmdPageSize=t,this.videoBuffer=e}updateVideoBuffer(t){this.videoBuffer=new Uint8Array(t)}getShadedOutputVideoFrame(){const t=this.dmdPageSize,e=2*this.dmdPageSize,s=new Uint8Array(8*this.dmdPageSize).fill(0);for(var a=0,o=0,n=0;n<r;n++)for(var c=0;c<h;c++){for(var g=0;g<8;g++){const r=i.setMsbBit(g),h=((this.videoBuffer[0+o]&r)>0?1:0)+((this.videoBuffer[t+o]&r)>0?1:0)+((this.videoBuffer[e+o]&r)>0?1:0);s[a++]=h}o++}return s}}},function(t,e,s){"use strict";const i=1,r=2,h=4,a=8,o=16,n=32,c=64,g=128,u=65534,d=65526,C=65528,m=65532,l=65530,P=65524,S=65522,_=[6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,1,1,2,2,0,0,5,9,0,2,3,0,3,2,8,7,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,5,5,5,5,0,5,3,6,21,11,0,19,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,7,0,0,7,7,0,7,7,7,7,7,0,7,7,4,7,2,2,2,4,2,2,2,0,2,2,2,2,4,7,3,0,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,5,5,5,7,5,5,5,5,5,5,5,5,7,8,6,6,2,2,2,4,2,2,2,0,2,2,2,2,3,0,3,0,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,7,5,5,5,5,5,5,5,5,6,6,6,6],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,5,0,4,0,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,8,0,0,0,0,0,0,0,0,8,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],f=[4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];t.exports={getInstance:function(t,e,s){return new A(t,e,s)}};class A{constructor(t,e,s){this.name=s,this.memoryWriteFunction=t,this.memoryReadFunction=e,this.tickCount=0,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.nmiCount=0,this.regA=0,this.regB=0,this.regX=0,this.regY=0,this.regU=0,this.regS=0,this.regCC=0,this.regPC=0,this.regDP=0}setV8(t,e,s){this.regCC|=(128&(t^e^s^s>>1))>>6}setV16(t,e,s){this.regCC|=(32768&(t^e^s^s>>1))>>14}getD(){return(this.regA<<8)+this.regB}setD(t){this.regA=t>>8&255,this.regB=255&t}PUSHB(t){this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,255&t)}PUSHW(t){this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,255&t),this.regS=this.regS-1&65535,this.memoryWriteFunction(this.regS,t>>8&255)}PUSHBU(t){this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,255&t)}PUSHWU(t){this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,255&t),this.regU=this.regU-1&65535,this.memoryWriteFunction(this.regU,t>>8&255)}PULLB(){return this.memoryReadFunction(this.regS++)}PULLW(){return(this.memoryReadFunction(this.regS++)<<8)+this.memoryReadFunction(this.regS++)}PULLBU(){return this.memoryReadFunction(this.regU++)}PULLWU(){return(this.memoryReadFunction(this.regU++)<<8)+this.memoryReadFunction(this.regU++)}PSHS(t){var e=0;128&t&&(this.PUSHW(this.regPC),e+=2),64&t&&(this.PUSHW(this.regU),e+=2),32&t&&(this.PUSHW(this.regY),e+=2),16&t&&(this.PUSHW(this.regX),e+=2),8&t&&(this.PUSHB(this.regDP),e++),4&t&&(this.PUSHB(this.regB),e++),2&t&&(this.PUSHB(this.regA),e++),1&t&&(this.PUSHB(this.regCC),e++),this.tickCount+=e}PSHU(t){var e=0;128&t&&(this.PUSHWU(this.regPC),e+=2),64&t&&(this.PUSHWU(this.regS),e+=2),32&t&&(this.PUSHWU(this.regY),e+=2),16&t&&(this.PUSHWU(this.regX),e+=2),8&t&&(this.PUSHBU(this.regDP),e++),4&t&&(this.PUSHBU(this.regB),e++),2&t&&(this.PUSHBU(this.regA),e++),1&t&&(this.PUSHBU(this.regCC),e++),this.tickCount+=e}PULS(t){var e=0;1&t&&(this.regCC=this.PULLB(),e++),2&t&&(this.regA=this.PULLB(),e++),4&t&&(this.regB=this.PULLB(),e++),8&t&&(this.regDP=this.PULLB(),e++),16&t&&(this.regX=this.PULLW(),e+=2),32&t&&(this.regY=this.PULLW(),e+=2),64&t&&(this.regU=this.PULLW(),e+=2),128&t&&(this.regPC=this.PULLW(),e+=2),this.tickCount+=e}PULU(t){var e=0;1&t&&(this.regCC=this.PULLBU(),e++),2&t&&(this.regA=this.PULLBU(),e++),4&t&&(this.regB=this.PULLBU(),e++),8&t&&(this.regDP=this.PULLBU(),e++),16&t&&(this.regX=this.PULLWU(),e+=2),32&t&&(this.regY=this.PULLWU(),e+=2),64&t&&(this.regS=this.PULLWU(),e+=2),128&t&&(this.regPC=this.PULLWU(),e+=2),this.tickCount+=e}getPostByteRegister(t){switch(15&t){case 0:return this.getD();case 1:return this.regX;case 2:return this.regY;case 3:return this.regU;case 4:return this.regS;case 5:return this.regPC;case 8:return this.regA;case 9:return this.regB;case 10:return this.regCC;case 11:return this.regDP;default:throw new Error("getPBR_INVALID_"+t)}}setPostByteRegister(t,e){switch(15&t){case 0:return void this.setD(e);case 1:return void(this.regX=e);case 2:return void(this.regY=e);case 3:return void(this.regU=e);case 4:return void(this.regS=e);case 5:return void(this.regPC=e);case 8:return void(this.regA=255&e);case 9:return void(this.regB=255&e);case 10:return void(this.regCC=255&e);case 11:return void(this.regDP=255&e);default:throw new Error("setPBR_INVALID_"+t)}}TFREXG(t,e){var s=136&t;if(128===s||8===s)throw new Error("TFREXG_ERROR_MIXING_8_AND_16BIT_REGISTER!");s=this.getPostByteRegister(t>>4),e&&this.setPostByteRegister(t>>4,this.getPostByteRegister(t)),this.setPostByteRegister(t,s)}signed5bit(t){return t>15?t-32:t}signed(t){return t>127?t-256:t}signed16(t){return t>32767?t-65536:t}fetch(){return this.memoryReadFunction(this.regPC++)}fetch16(){return(this.memoryReadFunction(this.regPC++)<<8)+this.memoryReadFunction(this.regPC++)}ReadWord(t){return(this.memoryReadFunction(t)<<8)+this.memoryReadFunction(t+1&65535)}WriteWord(t,e){this.memoryWriteFunction(t,e>>8&255),this.memoryWriteFunction(t+1&65535,255&e)}PostByte(){const t=this.fetch();var e;switch(96&t){case 0:e=this.regX;break;case 32:e=this.regY;break;case 64:e=this.regU;break;case 96:e=this.regS;break;default:throw new Error("INVALID_ADDRESS_PB")}var s=null,i=null;if(128&t){switch(15&t){case 0:i=e,s=e+1,this.tickCount+=2;break;case 1:i=e,s=e+2,this.tickCount+=3;break;case 2:i=s=e-1,this.tickCount+=2;break;case 3:i=s=e-2,this.tickCount+=3;break;case 4:i=e;break;case 5:i=e+this.signed(this.regB),this.tickCount+=1;break;case 6:i=e+this.signed(this.regA),this.tickCount+=1;break;case 8:i=e+this.signed(this.fetch()),this.tickCount+=1;break;case 9:i=e+this.signed16(this.fetch16()),this.tickCount+=4;break;case 11:i=e+this.getD(),this.tickCount+=4;break;case 12:{const t=this.signed(this.fetch());i=this.regPC+t,this.tickCount+=1;break}case 13:{const t=this.signed16(this.fetch16());i=this.regPC+t,this.tickCount+=5;break}case 15:i=this.fetch16(),this.tickCount+=5;break;default:throw new Error("INVALID_ADDRESS_MODE_"+(15&t))}i&=65535,16&t&&(i=this.ReadWord(i),this.tickCount+=3)}else{i=e+this.signed5bit(31&t),this.tickCount+=1}if(null!==s)switch(s&=65535,96&t){case 0:this.regX=s;break;case 32:this.regY=s;break;case 64:this.regU=s;break;case 96:this.regS=s;break;default:throw new Error("PB_INVALID_XCHG_VALUE_"+t)}return 65535&i}flagsNZ16(t){this.regCC&=~(h|a),0===t&&(this.regCC|=h),32768&t&&(this.regCC|=a)}oINC(t){return t=t+1&255,this.regCC&=~(h|r|a),this.regCC|=f[t],128===t&&(this.regCC|=r),t}oDEC(t){return t=t-1&255,this.regCC&=~(h|r|a),this.regCC|=f[t],127===t&&(this.regCC|=r),t}oSUB(t,e){var s=t-e;return this.regCC&=~(i|h|r|a),256&s&&(this.regCC|=i),this.setV8(t,e,s),s&=255,this.regCC|=f[s],s}oSUB16(t,e){var s=t-e;return this.regCC&=~(i|h|r|a),32768&s&&(this.regCC|=a),65536&s&&(this.regCC|=i),this.setV16(t,e,s),0===(s&=65535)&&(this.regCC|=h),s}oADD(t,e){var s=t+e;return this.regCC&=~(n|i|h|r|a),256&s&&(this.regCC|=i),this.setV8(t,e,s),16&(s^t^e)&&(this.regCC|=n),s&=255,this.regCC|=f[s],s}oADD16(t,e){var s=t+e;return this.regCC&=~(i|h|r|a),32768&s&&(this.regCC|=a),65536&s&&(this.regCC|=i),this.setV16(t,e,s),0===(s&=65535)&&(this.regCC|=h),s}oADC(t,e){var s=t+e+(this.regCC&i);return this.regCC&=~(n|i|h|r|a),256&s&&(this.regCC|=i),this.setV8(t,e,s),16&(s^t^e)&&(this.regCC|=n),s&=255,this.regCC|=f[s],s}oSBC(t,e){var s=t-e-(this.regCC&i);return this.regCC&=~(i|h|r|a),256&s&&(this.regCC|=i),this.setV8(t,e,s),s&=255,this.regCC|=f[s],s}oCMP(t,e){var s=t-e;this.regCC&=~(i|h|r|a),256&s&&(this.regCC|=i),this.setV8(t,e,s),s&=255,this.regCC|=f[s]}oCMP16(t,e){var s=t-e;this.regCC&=~(i|h|r|a),0==(65535&s)&&(this.regCC|=h),32768&s&&(this.regCC|=a),65536&s&&(this.regCC|=i),this.setV16(t,e,s)}oNEG(t){return this.regCC&=~(i|h|r|a),128===(t=0-t&255)&&(this.regCC|=r),0===t&&(this.regCC|=h),128&t&&(this.regCC|=a|i),t}oLSR(t){return this.regCC&=~(h|i|a),t&i&&(this.regCC|=i),0===(t>>=1)&&(this.regCC|=h),t}oASR(t){return this.regCC&=~(h|i|a),1&t&&(this.regCC|=i),t=128&t|t>>1,t&=255,this.regCC|=f[t],t}oASL(t){var e=t;return this.regCC&=~(h|i|a|r),128&t&&(this.regCC|=i),128&((t<<=1)^e)&&(this.regCC|=r),t&=255,this.regCC|=f[t],t}oROL(t){var e=t,s=this.regCC&i;return this.regCC&=~(h|i|a|r),128&t&&(this.regCC|=i),128&((t=t<<1|s)^e)&&(this.regCC|=r),t&=255,this.regCC|=f[t],t}oROR(t){var e=this.regCC&i;return this.regCC&=~(h|i|a),1&t&&(this.regCC|=i),t=t>>1|e<<7,t&=255,this.regCC|=f[t],t}oEOR(t,e){return this.regCC&=~(h|a|r),t^=e,t&=255,this.regCC|=f[t],t}oOR(t,e){return this.regCC&=~(h|a|r),t|=e,t&=255,this.regCC|=f[t],t}oAND(t,e){return this.regCC&=~(h|a|r),t&=e,t&=255,this.regCC|=f[t],t}oCOM(t){return this.regCC&=~(h|a|r),t^=255,t&=255,this.regCC|=f[t],this.regCC|=i,t}dpadd(){return(this.regDP<<8)+this.fetch()}step(){const t=this.tickCount;var e=null,s=null,u=this.fetch();switch(this.tickCount+=_[u],u){case 0:e=this.dpadd(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 3:e=this.dpadd(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 4:e=this.dpadd(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 6:e=this.dpadd(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 7:e=this.dpadd(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 8:e=this.dpadd(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 9:e=this.dpadd(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 10:e=this.dpadd(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 12:e=this.dpadd(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 13:e=this.dpadd(),s=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[s];break;case 14:e=this.dpadd(),this.regPC=e;break;case 15:e=this.dpadd(),this.memoryWriteFunction(e,0),this.regCC&=~(i|a|r),this.regCC|=h;break;case 18:break;case 19:console.log("SYNC is broken!");break;case 22:e=this.fetch16(),this.regPC+=e;break;case 23:e=this.fetch16(),this.PUSHW(this.regPC),this.regPC+=e;break;case 25:var d=0,C=240&this.regA,m=15&this.regA;(m>9||this.regCC&n)&&(d|=6),C>128&&m>9&&(d|=96),(C>144||this.regCC&i)&&(d|=96),e=d+this.regA,this.regCC&=~(i|a|h|r),256&e&&(this.regCC|=i),this.regA=255&e,this.regCC|=f[this.regA];break;case 26:this.regCC|=this.fetch();break;case 28:this.regCC&=this.fetch();break;case 29:this.regA=128&this.regB?255:0,this.flagsNZ16(this.getD());break;case 30:s=this.fetch(),this.TFREXG(s,!0);break;case 31:s=this.fetch(),this.TFREXG(s,!1);break;case 32:e=this.signed(this.fetch()),this.regPC+=e;break;case 33:e=this.signed(this.fetch());break;case 34:e=this.signed(this.fetch()),this.regCC&(i|h)||(this.regPC+=e);break;case 35:e=this.signed(this.fetch()),this.regCC&(i|h)&&(this.regPC+=e);break;case 36:e=this.signed(this.fetch()),this.regCC&i||(this.regPC+=e);break;case 37:e=this.signed(this.fetch()),this.regCC&i&&(this.regPC+=e);break;case 38:e=this.signed(this.fetch()),this.regCC&h||(this.regPC+=e);break;case 39:e=this.signed(this.fetch()),this.regCC&h&&(this.regPC+=e);break;case 40:e=this.signed(this.fetch()),this.regCC&r||(this.regPC+=e);break;case 41:e=this.signed(this.fetch()),this.regCC&r&&(this.regPC+=e);break;case 42:e=this.signed(this.fetch()),this.regCC&a||(this.regPC+=e);break;case 43:e=this.signed(this.fetch()),this.regCC&a&&(this.regPC+=e);break;case 44:e=this.signed(this.fetch()),this.regCC&a^(this.regCC&r)<<2||(this.regPC+=e);break;case 45:e=this.signed(this.fetch()),this.regCC&a^(this.regCC&r)<<2&&(this.regPC+=e);break;case 46:e=this.signed(this.fetch()),this.regCC&a^(this.regCC&r)<<2||this.regCC&h||(this.regPC+=e);break;case 47:e=this.signed(this.fetch()),(this.regCC&a^(this.regCC&r)<<2||this.regCC&h)&&(this.regPC+=e);break;case 48:this.regX=this.PostByte(),this.regCC&=~h,0===this.regX&&(this.regCC|=h);break;case 49:this.regY=this.PostByte(),this.regCC&=~h,0===this.regY&&(this.regCC|=h);break;case 50:this.regS=this.PostByte();break;case 51:this.regU=this.PostByte();break;case 52:this.PSHS(this.fetch());break;case 53:this.PULS(this.fetch());break;case 54:this.PSHU(this.fetch());break;case 55:this.PULU(this.fetch());break;case 57:this.regPC=this.PULLW();break;case 58:this.regX+=this.regB;break;case 59:this.regCC=this.PULLB(),this.regCC&g&&(this.tickCount+=9,this.regA=this.PULLB(),this.regB=this.PULLB(),this.regDP=this.PULLB(),this.regX=this.PULLW(),this.regY=this.PULLW(),this.regU=this.PULLW()),this.regPC=this.PULLW();break;case 60:console.log("CWAI is broken!"),this.regCC&=this.fetch();break;case 61:0===(e=this.regA*this.regB)?this.regCC|=h:this.regCC&=~h,128&e?this.regCC|=i:this.regCC&=~i,this.setD(e);break;case 63:console.log("swi"),this.regCC|=g,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=o|c,this.regPC=this.ReadWord(l);break;case 64:this.regA=this.oNEG(this.regA);break;case 67:this.regA=this.oCOM(this.regA);break;case 68:this.regA=this.oLSR(this.regA);break;case 70:this.regA=this.oROR(this.regA);break;case 71:this.regA=this.oASR(this.regA);break;case 72:this.regA=this.oASL(this.regA);break;case 73:this.regA=this.oROL(this.regA);break;case 74:this.regA=this.oDEC(this.regA);break;case 76:this.regA=this.oINC(this.regA);break;case 77:this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 79:this.regA=0,this.regCC&=~(a|r|i),this.regCC|=h;break;case 80:this.regB=this.oNEG(this.regB);break;case 83:this.regB=this.oCOM(this.regB);break;case 84:this.regB=this.oLSR(this.regB);break;case 86:this.regB=this.oROR(this.regB);break;case 87:this.regB=this.oASR(this.regB);break;case 88:this.regB=this.oASL(this.regB);break;case 89:this.regB=this.oROL(this.regB);break;case 90:this.regB=this.oDEC(this.regB);break;case 92:this.regB=this.oINC(this.regB);break;case 93:this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 95:this.regB=0,this.regCC&=~(a|r|i),this.regCC|=h;break;case 96:e=this.PostByte(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 99:e=this.PostByte(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 100:e=this.PostByte(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 102:e=this.PostByte(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 103:e=this.PostByte(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 104:e=this.PostByte(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 105:e=this.PostByte(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 106:e=this.PostByte(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 108:e=this.PostByte(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 109:e=this.PostByte(),s=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[s];break;case 110:e=this.PostByte(),this.regPC=e;break;case 111:e=this.PostByte(),this.memoryWriteFunction(e,0),this.regCC&=~(i|a|r),this.regCC|=h;break;case 112:e=this.fetch16(),this.memoryWriteFunction(e,this.oNEG(this.memoryReadFunction(e)));break;case 115:e=this.fetch16(),this.memoryWriteFunction(e,this.oCOM(this.memoryReadFunction(e)));break;case 116:e=this.fetch16(),this.memoryWriteFunction(e,this.oLSR(this.memoryReadFunction(e)));break;case 118:e=this.fetch16(),this.memoryWriteFunction(e,this.oROR(this.memoryReadFunction(e)));break;case 119:e=this.fetch16(),this.memoryWriteFunction(e,this.oASR(this.memoryReadFunction(e)));break;case 120:e=this.fetch16(),this.memoryWriteFunction(e,this.oASL(this.memoryReadFunction(e)));break;case 121:e=this.fetch16(),this.memoryWriteFunction(e,this.oROL(this.memoryReadFunction(e)));break;case 122:e=this.fetch16(),this.memoryWriteFunction(e,this.oDEC(this.memoryReadFunction(e)));break;case 124:e=this.fetch16(),this.memoryWriteFunction(e,this.oINC(this.memoryReadFunction(e)));break;case 125:e=this.fetch16(),s=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[s];break;case 126:e=this.fetch16(),this.regPC=e;break;case 127:e=this.fetch16(),this.memoryWriteFunction(e,0),this.regCC&=~(i|a|r),this.regCC|=h;break;case 128:this.regA=this.oSUB(this.regA,this.fetch());break;case 129:this.oCMP(this.regA,this.fetch());break;case 130:this.regA=this.oSBC(this.regA,this.fetch());break;case 131:this.setD(this.oSUB16(this.getD(),this.fetch16()));break;case 132:this.regA=this.oAND(this.regA,this.fetch());break;case 133:this.oAND(this.regA,this.fetch());break;case 134:this.regA=this.fetch(),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 136:this.regA=this.oEOR(this.regA,this.fetch());break;case 137:this.regA=this.oADC(this.regA,this.fetch());break;case 138:this.regA=this.oOR(this.regA,this.fetch());break;case 139:this.regA=this.oADD(this.regA,this.fetch());break;case 140:this.oCMP16(this.regX,this.fetch16());break;case 141:e=this.signed(this.fetch()),this.PUSHW(this.regPC),this.regPC+=e;break;case 142:this.regX=this.fetch16(),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 144:e=this.dpadd(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 145:e=this.dpadd(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 146:e=this.dpadd(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 147:e=this.dpadd(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 148:e=this.dpadd(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 149:e=this.dpadd(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 150:e=this.dpadd(),this.regA=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 151:e=this.dpadd(),this.memoryWriteFunction(e,this.regA),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 152:e=this.dpadd(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 153:e=this.dpadd(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 154:e=this.dpadd(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 155:e=this.dpadd(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regX,this.ReadWord(e));break;case 157:e=this.dpadd(),this.PUSHW(this.regPC),this.regPC=e;break;case 158:e=this.dpadd(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 159:e=this.dpadd(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 160:e=this.PostByte(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 161:e=this.PostByte(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 162:e=this.PostByte(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 163:e=this.PostByte(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 164:e=this.PostByte(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 165:e=this.PostByte(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 166:e=this.PostByte(),this.regA=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 167:e=this.PostByte(),this.memoryWriteFunction(e,this.regA),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 168:e=this.PostByte(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 169:e=this.PostByte(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 170:e=this.PostByte(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 171:e=this.PostByte(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regX,this.ReadWord(e));break;case 173:e=this.PostByte(),this.PUSHW(this.regPC),this.regPC=e;break;case 174:e=this.PostByte(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 175:e=this.PostByte(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 176:e=this.fetch16(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(e));break;case 177:e=this.fetch16(),this.oCMP(this.regA,this.memoryReadFunction(e));break;case 178:e=this.fetch16(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(e));break;case 179:e=this.fetch16(),this.setD(this.oSUB16(this.getD(),this.ReadWord(e)));break;case 180:e=this.fetch16(),this.regA=this.oAND(this.regA,this.memoryReadFunction(e));break;case 181:e=this.fetch16(),this.oAND(this.regA,this.memoryReadFunction(e));break;case 182:e=this.fetch16(),this.regA=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 183:e=this.fetch16(),this.memoryWriteFunction(e,this.regA),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regA];break;case 184:e=this.fetch16(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(e));break;case 185:e=this.fetch16(),this.regA=this.oADC(this.regA,this.memoryReadFunction(e));break;case 186:e=this.fetch16(),this.regA=this.oOR(this.regA,this.memoryReadFunction(e));break;case 187:e=this.fetch16(),this.regA=this.oADD(this.regA,this.memoryReadFunction(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regX,this.ReadWord(e));break;case 189:e=this.fetch16(),this.PUSHW(this.regPC),this.regPC=e;break;case 190:e=this.fetch16(),this.regX=this.ReadWord(e),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 191:e=this.fetch16(),this.WriteWord(e,this.regX),this.flagsNZ16(this.regX),this.regCC&=~r;break;case 192:this.regB=this.oSUB(this.regB,this.fetch());break;case 193:this.oCMP(this.regB,this.fetch());break;case 194:this.regB=this.oSBC(this.regB,this.fetch());break;case 195:this.setD(this.oADD16(this.getD(),this.fetch16()));break;case 196:this.regB=this.oAND(this.regB,this.fetch());break;case 197:this.oAND(this.regB,this.fetch());break;case 198:this.regB=this.fetch(),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 200:this.regB=this.oEOR(this.regB,this.fetch());break;case 201:this.regB=this.oADC(this.regB,this.fetch());break;case 202:this.regB=this.oOR(this.regB,this.fetch());break;case 203:this.regB=this.oADD(this.regB,this.fetch());break;case 204:e=this.fetch16(),this.setD(e),this.flagsNZ16(e),this.regCC&=~r;break;case 206:this.regU=this.fetch16(),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 208:e=this.dpadd(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 209:e=this.dpadd(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 210:e=this.dpadd(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 211:e=this.dpadd(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 212:e=this.dpadd(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 213:e=this.dpadd(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 214:e=this.dpadd(),this.regB=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 215:e=this.dpadd(),this.memoryWriteFunction(e,this.regB),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 216:e=this.dpadd(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 217:e=this.dpadd(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 218:e=this.dpadd(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 219:e=this.dpadd(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 220:e=this.dpadd(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=~r;break;case 221:e=this.dpadd(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=~r;break;case 222:e=this.dpadd(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 223:e=this.dpadd(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 224:e=this.PostByte(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 225:e=this.PostByte(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 226:e=this.PostByte(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 227:e=this.PostByte(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 228:e=this.PostByte(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 229:e=this.PostByte(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 230:e=this.PostByte(),this.regB=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 231:e=this.PostByte(),this.memoryWriteFunction(e,this.regB),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 232:e=this.PostByte(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 233:e=this.PostByte(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 234:e=this.PostByte(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 235:e=this.PostByte(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 236:e=this.PostByte(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=~r;break;case 237:e=this.PostByte(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=~r;break;case 238:e=this.PostByte(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 239:e=this.PostByte(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 240:e=this.fetch16(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(e));break;case 241:e=this.fetch16(),this.oCMP(this.regB,this.memoryReadFunction(e));break;case 242:e=this.fetch16(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(e));break;case 243:e=this.fetch16(),this.setD(this.oADD16(this.getD(),this.ReadWord(e)));break;case 244:e=this.fetch16(),this.regB=this.oAND(this.regB,this.memoryReadFunction(e));break;case 245:e=this.fetch16(),this.oAND(this.regB,this.memoryReadFunction(e));break;case 246:e=this.fetch16(),this.regB=this.memoryReadFunction(e),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 247:e=this.fetch16(),this.memoryWriteFunction(e,this.regB),this.regCC&=~(h|a|r),this.regCC|=f[255&this.regB];break;case 248:e=this.fetch16(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(e));break;case 249:e=this.fetch16(),this.regB=this.oADC(this.regB,this.memoryReadFunction(e));break;case 250:e=this.fetch16(),this.regB=this.oOR(this.regB,this.memoryReadFunction(e));break;case 251:e=this.fetch16(),this.regB=this.oADD(this.regB,this.memoryReadFunction(e));break;case 252:e=this.fetch16(),s=this.ReadWord(e),this.setD(s),this.flagsNZ16(s),this.regCC&=~r;break;case 253:e=this.fetch16(),this.WriteWord(e,this.getD()),this.flagsNZ16(this.getD()),this.regCC&=~r;break;case 254:e=this.fetch16(),this.regU=this.ReadWord(e),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 255:e=this.fetch16(),this.WriteWord(e,this.regU),this.flagsNZ16(this.regU),this.regCC&=~r;break;case 16:switch(u=this.fetch(),this.tickCount+=R[u],u){case 33:e=this.signed16(this.fetch16());break;case 34:e=this.signed16(this.fetch16()),this.regCC&(i|h)||(this.regPC+=e,this.tickCount++);break;case 35:e=this.signed16(this.fetch16()),this.regCC&(i|h)&&(this.regPC+=e,this.tickCount++);break;case 36:e=this.signed16(this.fetch16()),this.regCC&i||(this.regPC+=e,this.tickCount++);break;case 37:e=this.signed16(this.fetch16()),this.regCC&i&&(this.regPC+=e,this.tickCount++);break;case 38:e=this.signed16(this.fetch16()),this.regCC&h||(this.regPC+=e,this.tickCount++);break;case 39:e=this.signed16(this.fetch16()),this.regCC&h&&(this.regPC+=e,this.tickCount++);break;case 40:e=this.signed16(this.fetch16()),this.regCC&r||(this.regPC+=e,this.tickCount++);break;case 41:e=this.signed16(this.fetch16()),this.regCC&r&&(this.regPC+=e,this.tickCount++);break;case 42:e=this.signed16(this.fetch16()),this.regCC&a||(this.regPC+=e,this.tickCount++);break;case 43:e=this.signed16(this.fetch16()),this.regCC&a&&(this.regPC+=e,this.tickCount++);break;case 44:e=this.signed16(this.fetch16()),this.regCC&a^(this.regCC&r)<<2||(this.regPC+=e,this.tickCount++);break;case 45:e=this.signed16(this.fetch16()),this.regCC&a^(this.regCC&r)<<2&&(this.regPC+=e,this.tickCount++);break;case 46:e=this.signed16(this.fetch16()),this.regCC&a^(this.regCC&r)<<2||this.regCC&h||(this.regPC+=e,this.tickCount++);break;case 47:e=this.signed16(this.fetch16()),(this.regCC&a^(this.regCC&r)<<2||this.regCC&h)&&(this.regPC+=e,this.tickCount++);break;case 63:this.regCC|=g,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regPC=this.ReadWord(P);break;case 131:this.oCMP16(this.getD(),this.fetch16());break;case 140:this.oCMP16(this.regY,this.fetch16());break;case 142:this.regY=this.fetch16(),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 147:e=this.dpadd(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regY,this.ReadWord(e));break;case 158:e=this.dpadd(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 159:e=this.dpadd(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 163:e=this.PostByte(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regY,this.ReadWord(e));break;case 174:e=this.PostByte(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 175:e=this.PostByte(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 179:e=this.fetch16(),this.oCMP16(this.getD(),this.ReadWord(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regY,this.ReadWord(e));break;case 190:e=this.fetch16(),this.regY=this.ReadWord(e),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 191:e=this.fetch16(),this.WriteWord(e,this.regY),this.flagsNZ16(this.regY),this.regCC&=~r;break;case 206:this.regS=this.fetch16(),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 222:e=this.dpadd(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 223:e=this.dpadd(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 238:e=this.PostByte(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 239:e=this.PostByte(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 254:e=this.fetch16(),this.regS=this.ReadWord(e),this.flagsNZ16(this.regS),this.regCC&=~r;break;case 255:e=this.fetch16(),this.WriteWord(e,this.regS),this.flagsNZ16(this.regS),this.regCC&=~r;break;default:throw new Error("CPU_OPCODE_INVALID_PAGE1_"+u)}break;case 17:switch(u=this.fetch(),this.tickCount+=R[u],u){case 63:this.regCC|=g,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regPC=this.ReadWord(S);break;case 131:this.oCMP16(this.regU,this.fetch16());break;case 140:this.oCMP16(this.regS,this.fetch16());break;case 147:e=this.dpadd(),this.oCMP16(this.regU,this.ReadWord(e));break;case 156:e=this.dpadd(),this.oCMP16(this.regS,this.ReadWord(e));break;case 163:e=this.PostByte(),this.oCMP16(this.regU,this.ReadWord(e));break;case 172:e=this.PostByte(),this.oCMP16(this.regS,this.ReadWord(e));break;case 179:e=this.fetch16(),this.oCMP16(this.regU,this.ReadWord(e));break;case 188:e=this.fetch16(),this.oCMP16(this.regS,this.ReadWord(e));break;default:throw new Error("CPU_OPCODE_INVALID_PAGE2_"+u)}break;default:throw new Error("CPU_OPCODE_INVALID_"+u)}return this.regA&=255,this.regB&=255,this.regCC&=255,this.regDP&=255,this.regX&=65535,this.regY&=65535,this.regU&=65535,this.regS&=65535,this.regPC&=65535,this.tickCount-t}reset(){this.regDP=0,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.regCC|=o|c,this.regPC=this.ReadWord(u),this.tickCount=0}_executeNmi(){this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=g,this.PUSHB(this.regCC),this.regCC|=o|c,this.regPC=this.ReadWord(m),this.tickCount+=19}_executeFirq(){this.regCC&=~g,this.PUSHW(this.regPC),this.PUSHB(this.regCC),this.regCC|=o|c,this.regPC=this.ReadWord(d),this.tickCount+=10}_executeIrq(){this.regCC|=g,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=o,this.regPC=this.ReadWord(C),this.tickCount+=19}steps(t=1){const e=this.tickCount;for(;t>0;){const e=this.step();e<1&&console.log("WARNING: invalid step detected",e),t-=e}return this.tickCount-e}getState(){return{regPC:this.regPC,regS:this.regS,regU:this.regU,regA:this.regA,regB:this.regB,regX:this.regX,regY:this.regY,regDP:this.regDP,regCC:this.regCC,missedIRQ:this.missedIRQ,missedFIRQ:this.missedFIRQ,irqCount:this.irqCount,firqCount:this.firqCount,nmiCount:this.nmiCount,tickCount:this.tickCount}}setState(t){["regPC","regS","regU","regA","regB","regX","regY","regDP","regCC","missedIRQ","missedFIRQ","irqCount","firqCount","nmiCount","tickCount"].forEach(e=>{void 0!==t[e]&&(this[e]=t[e])})}irq(){0==(this.regCC&o)?(this.irqCount++,this._executeIrq()):this.missedIRQ++}clearIrqMasking(){this.regCC&=~o}firq(){0==(this.regCC&c)?(this.firqCount++,this._executeFirq()):this.missedFIRQ++}clearFirqMasking(){this.regCC&=~c}nmi(){this.nmiCount++,this._executeNmi()}set(t,e){switch(t.toUpperCase()){case"PC":this.regPC=e;break;case"A":this.regA=e;break;case"B":this.regB=e;break;case"X":this.regX=e;break;case"Y":this.regY=e;break;case"SP":this.regS=e;break;case"U":this.regU=e;break;case"FLAGS":this.regCC=e;break;default:console.log("INVALID REGISTER",t)}}flagsToString(){const t="EFHINZVC";for(var e="",s=0;s<8;s++){e+=0===(this.regCC&128>>s)?t[s].toLowerCase():t[s]}return e}}},function(t,e,s){"use strict";t.exports={getInstance:function(){return new r}};const i=512;class r{constructor(){this.count=0,this.oldState={videoRam:[],dmdShadedBuffer:[],lampState:[],solenoidState:[],inputState:[]},this.videoRam=[]}getVideoRamDiff(t){let e=!1;for(let s=0;s<16;s++){const h=t.slice(s*i,(s+1)*i);(!this.oldState.videoRam[s]||!r.arraysEqual(h,this.oldState.videoRam[s]))&&(e=!0,this.videoRam[s]=h,this.oldState.videoRam[s]=Uint8Array.from(h))}return e}static arraysEqual(t,e){if(t===e)return!0;if(null===t||null===e||t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}getChangedState(t){this.count++;const e=!r.arraysEqual(t.dmd.dmdShadedBuffer,this.oldState.dmdShadedBuffer),s=!r.arraysEqual(t.wpc.lampState,this.oldState.lampState),i=!r.arraysEqual(t.wpc.solenoidState,this.oldState.solenoidState),h=!r.arraysEqual(t.wpc.inputState,this.oldState.inputState);e&&(this.oldState.dmdShadedBuffer=Uint8Array.from(t.dmd.dmdShadedBuffer)),s&&(this.oldState.lampState=Uint8Array.from(t.wpc.lampState)),i&&(this.oldState.solenoidState=Uint8Array.from(t.wpc.solenoidState)),h&&(this.oldState.inputState=Uint8Array.from(t.wpc.inputState));const a=this.getVideoRamDiff(t.dmd.videoRam);return{ram:this.count%4==0?t.ram:void 0,sound:t.sound,wpc:{diagnosticLed:t.wpc.diagnosticLed,lampState:s?t.wpc.lampState:void 0,solenoidState:i?t.wpc.solenoidState:void 0,generalIlluminationState:t.wpc.generalIlluminationState,inputState:h?t.wpc.inputState:void 0,diagnosticLedToggleCount:t.wpc.diagnosticLedToggleCount,midnightModeEnabled:t.wpc.midnightModeEnabled,irqEnabled:t.wpc.irqEnabled,activeRomBank:t.wpc.activeRomBank,time:t.wpc.time},dmd:{scanline:t.dmd.scanline,dmdPageMapping:t.dmd.dmdPageMapping,activepage:t.dmd.activepage,videoRam:a?this.videoRam:void 0,dmdShadedBuffer:e?t.dmd.dmdShadedBuffer:void 0,videoOutputBuffer:t.dmd.videoOutputBuffer}}}}}]);