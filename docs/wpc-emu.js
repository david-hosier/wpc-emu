var WpcEmu=function(t){function e(i){if(s[i])return s[i].exports;var a=s[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var s={};return e.m=t,e.c=s,e.d=function(t,s,i){e.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:i})},e.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=18)}([function(t){"use strict";t.exports={CALL_IRQ_AFTER_TICKS:2049,CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS:512,CALL_ZEROCLEAR_AFTER_TICKS:16667}},function(t){"use strict";t.exports={findMsbBit:function(t){const e=[1,2,4,8,16,32,64,128].indexOf(t);return-1<e?e+1:0},setMsbBit:function(t=0){return[1,2,4,8,16,32,64,128][t]}}},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.count=0,this.oldState={videoRam:"",dmdShadedBuffer:"",lampState:"",solenoidState:"",inputState:""}}getChangedState(t){this.count++;const e=t.dmd.dmdShadedBuffer.toString()!==this.oldState.dmdShadedBuffer,s=t.dmd.videoRam.toString()!==this.oldState.videoRam,i=t.wpc.lampState.toString()!==this.oldState.lampState,a=t.wpc.solenoidState.toString()!==this.oldState.solenoidState,r=t.wpc.inputState.toString()!==this.oldState.inputState;return e&&(this.oldState.dmdShadedBuffer=t.dmd.dmdShadedBuffer.toString()),s&&(this.oldState.videoRam=t.dmd.videoRam.toString()),i&&(this.oldState.lampState=t.wpc.lampState.toString()),a&&(this.oldState.solenoidState=t.wpc.lampState.toString()),r&&(this.oldState.inputState=t.wpc.inputState.toString()),{romFileName:t.romFileName,ram:0==this.count%4?t.ram:void 0,wpc:{diagnosticLed:t.wpc.diagnosticLed,lampState:i?t.wpc.lampState:void 0,solenoidState:a?t.wpc.solenoidState:void 0,generalIlluminationState:t.wpc.generalIlluminationState,inputState:r?t.wpc.inputState:void 0,diagnosticLedToggleCount:t.wpc.diagnosticLedToggleCount,irqEnabled:t.wpc.irqEnabled,activeRomBank:t.wpc.activeRomBank},dmd:{scanline:t.dmd.scanline,lowpage:t.dmd.lowpage,highpage:t.dmd.highpage,activepage:t.dmd.activepage,videoRam:s?t.dmd.videoRam:void 0,dmdShadedBuffer:e?t.dmd.dmdShadedBuffer:void 0}}}}}}},function(t,e,s){"use strict";const i=s(1);t.exports={getInstance:function(t,e){return new class{constructor(t,e){this.dmdPageSize=t,this.videoBuffer=e}updateVideoBuffer(t){this.videoBuffer=Uint8Array.from(t)}getShadedOutputVideoFrame(){const t=this.dmdPageSize,e=2*this.dmdPageSize,s=new Uint8Array(8*this.dmdPageSize).fill(0);for(var a=0,r=0,o=0;o<32;o++)for(var h=0;h<16;h++){for(var c=0;8>c;c++){const o=i.setMsbBit(c),h=(0<(this.videoBuffer[0+r]&o)?1:0)+(0<(this.videoBuffer[t+r]&o)?1:0)+(0<(this.videoBuffer[e+r]&o)?1:0);s[a++]=h}r++}return s}}(t,e)}}},function(t,e,s){"use strict";const i=s(3),a={WPC_DMD_HIGH_PAGE:16316,WPC_DMD_SCANLINE:16317,WPC_DMD_LOW_PAGE:16318,WPC_DMD_ACTIVE_PAGE:16319},r=14848,o=15360,h=512,c=16,n=3,_=[];Object.keys(a).forEach(t=>{_[a[t]]=t}),t.exports={getInstance:function(t){return new class{constructor(t){this.interruptCallback=t.interruptCallback,this.ram=t.ram,this.videoRam=new Uint8Array(16*h).fill(0),this.lowPage=0,this.highPage=1,this.scanline=0,this.activePage=0,this.nextActivePage=void 0,this.videoOutputPointer=0,this.videoOutputBuffer=new Uint8Array(n*h).fill(0),this.outputDmdDisplay=i.getInstance(h,this.videoOutputBuffer)}getUiState(){return{scanline:this.scanline,lowpage:this.lowPage,highpage:this.highPage,activepage:this.activePage,videoRam:this.videoRam,dmdShadedBuffer:this.outputDmdDisplay.getShadedOutputVideoFrame()}}copyScanline(){const t=this.activePage*h+this.scanline*c,e=this.videoOutputPointer*h+this.scanline*c;for(var s=0;s<c;s++)this.videoOutputBuffer[e+s]=this.videoRam[t+s];this.scanline=31&this.scanline+1,0===this.scanline&&(this.videoOutputPointer=(this.videoOutputPointer+1)%n,this.outputDmdDisplay.updateVideoBuffer(this.videoOutputBuffer),Number.isInteger(this.nextActivePage)&&(this.activePage=this.nextActivePage,this.nextActivePage=void 0)),!0===this.requestFIRQ&&31&this.scanline===this.ram[a.WPC_DMD_SCANLINE]&&(this.interruptCallback.firqFromDmd(),this.requestFIRQ=!1)}_getLowPageOffset(t){return this.lowPage*h+(t-14336)}_getHighPageOffset(t){return this.highPage*h+(t-r)}write(t,e){var s;if(t<r)return s=this._getLowPageOffset(t),void(this.videoRam[s]=e);if(t<o)return s=this._getHighPageOffset(t),void(this.videoRam[s]=e);switch(this.ram[t]=e,t){case a.WPC_DMD_SCANLINE:this.requestFIRQ=!0;break;case a.WPC_DMD_ACTIVE_PAGE:this.nextActivePage=15&e;break;case a.WPC_DMD_LOW_PAGE:this.lowPage=15&e;break;case a.WPC_DMD_HIGH_PAGE:this.highPage=15&e;break;default:console.log("DMD W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){var e;return t<r?(e=this._getLowPageOffset(t),this.videoRam[e]):t<o?(e=this._getHighPageOffset(t),this.videoRam[e]):t===a.WPC_DMD_SCANLINE?this.scanline:(console.log("DMD R_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t])}}(t)}}},function(t){var e=this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);s.prototype=e.prototype,t.prototype=new s};!function(){"use strict";var s,i=Math.min,a=Math.pow;(function(t){t.FM_PGBITS=9,t.FM_RATIOBITS=7,t.FM_LFOBITS=8,t.FM_TLBITS=7,t.FM_TLENTS=1<<t.FM_TLBITS,t.FM_LFOENTS=1<<t.FM_LFOBITS,t.FM_CLENTS=8192,t.FM_OPSINBITS=10,t.FM_OPSINENTS=1<<t.FM_OPSINBITS,t.FM_EG_BOTTOM=955,t.IS2EC_SHIFT=20+t.FM_PGBITS-13})(s||(s={})),function(t){var e=Math.sin,s=Math.PI;!function(t){t[t.typeN=0]="typeN",t[t.typeM=1]="typeM"}(t.OpType||(t.OpType={})),t.OpType,t.pmtable,t.amtable,t.tablemade=!1;var r=function(){function r(){this.chip_=null,this.out_=0,this.out2_=0,this.in2_=0,this.dp_=0,this.detune_=0,this.detune2_=0,this.multiple_=0,this.pg_count_=0,this.pg_diff_=0,this.pg_diff_lfo_=0,this.bn_=0,this.eg_level_=0,this.eg_level_on_next_phase_=0,this.eg_count_=0,this.eg_count_diff_=0,this.eg_out_=0,this.tl_out_=0,this.eg_rate_=0,this.eg_curve_count_=0,this.key_scale_rate_=0,this.eg_phase_=r.EGPhase.next,this.ms_=0,this.tl_=0,this.tl_latch_=0,this.ar_=0,this.dr_=0,this.sr_=0,this.sl_=0,this.rr_=0,this.ks_=0,this.keyon_=!1,this.amon_=!1,this.param_changed_=!1,this.mute_=!1,this.dbgopout_=0,this.dbgpgout_=0,r.tablehasmade||this.MakeTable(),this.ar_=this.dr_=this.sr_=this.rr_=this.key_scale_rate_=0,this.ams_=t.amtable[0][0],this.mute_=!1,this.keyon_=!1,this.tl_out_=0,this.multiple_=0,this.detune_=0,this.detune2_=0,this.ms_=0}return r.prototype.SetChip=function(t){this.chip_=t},r.prototype.Reset=function(){this.tl_=this.tl_latch_=127,this.ShiftPhase(r.EGPhase.off),this.eg_count_=0,this.eg_curve_count_=0,this.pg_count_=0,this.out_=this.out2_=0,this.param_changed_=!0},r.prototype.MakeTable=function(){var i,o=Math.floor,h=0;for(i=0;256>i;i++){var c=o(a(2,13-i/256));c=-4&c+2,r.cltable[h++]=c,r.cltable[h++]=-c}for(;h<t.FM_CLENTS;)r.cltable[h]=0|r.cltable[h-512]/2,h++;for(i=0;i<t.FM_OPSINENTS/2;i++){var n=(2*i+1)*s/t.FM_OPSINENTS,_=o(-256*Math.log(e(n))/Math.LN2+.5)+1;r.sinetable[i]=2*_,r.sinetable[t.FM_OPSINENTS/2+i]=2*_+1}t.MakeLFOTable(),r.tablehasmade=!0},r.prototype.SetDPBN=function(t,e){this.dp_=t,this.bn_=e,this.param_changed_=!0},r.prototype.Prepare=function(){if(this.param_changed_){switch(this.param_changed_=!1,this.pg_diff_=(this.dp_+r.dttable[this.detune_+this.bn_])*this.chip_.GetMulValue(this.detune2_,this.multiple_),this.pg_diff_lfo_=this.pg_diff_>>11,this.key_scale_rate_=this.bn_>>3-this.ks_,this.tl_out_=this.mute_?1023:8*this.tl_,this.eg_phase_){case r.EGPhase.attack:this.SetEGRate(this.ar_?i(63,this.ar_+this.key_scale_rate_):0);break;case r.EGPhase.decay:this.SetEGRate(this.dr_?i(63,this.dr_+this.key_scale_rate_):0),this.eg_level_on_next_phase_=8*this.sl_;break;case r.EGPhase.sustain:this.SetEGRate(this.sr_?i(63,this.sr_+this.key_scale_rate_):0);break;case r.EGPhase.release:this.SetEGRate(i(63,this.rr_+this.key_scale_rate_))}this.ams_=t.amtable[this.type_][this.amon_?3&this.ms_>>4:0],this.EGUpdate(),this.dbgopout_=0}},r.prototype.ShiftPhase=function(e){switch(e){case r.EGPhase.attack:if(62>this.ar_+this.key_scale_rate_){this.SetEGRate(this.ar_?i(63,this.ar_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.attack;break}case r.EGPhase.decay:if(this.sl_){this.eg_level_=0,this.eg_level_on_next_phase_=8*this.sl_,this.SetEGRate(this.dr_?i(63,this.dr_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.decay;break}case r.EGPhase.sustain:this.eg_level_=8*this.sl_,this.eg_level_on_next_phase_=1024,this.SetEGRate(this.sr_?i(63,this.sr_+this.key_scale_rate_):0),this.eg_phase_=r.EGPhase.sustain;break;case r.EGPhase.release:if(this.eg_phase_===r.EGPhase.attack||this.eg_level_<t.FM_EG_BOTTOM){this.eg_level_on_next_phase_=1024,this.SetEGRate(i(63,this.rr_+this.key_scale_rate_)),this.eg_phase_=r.EGPhase.release;break}case r.EGPhase.off:default:this.eg_level_=t.FM_EG_BOTTOM,this.eg_level_on_next_phase_=t.FM_EG_BOTTOM,this.EGUpdate(),this.SetEGRate(0),this.eg_phase_=r.EGPhase.off}},r.prototype.SetFNum=function(t){this.dp_=(2047&t)<<(7&t>>11),this.bn_=r.notetable[127&t>>7],this.param_changed_=!0},r.prototype.LogToLin=function(e){return e<t.FM_CLENTS?r.cltable[e]:0},r.prototype.EGUpdate=function(){this.eg_out_=i(this.tl_out_+this.eg_level_,1023)<<3},r.prototype.SetEGRate=function(t){this.eg_rate_=t,this.eg_count_diff_=r.decaytable2[t>>2]*this.chip_.GetRatio()},r.prototype.EGCalc=function(){if(this.eg_count_=6141<<t.FM_RATIOBITS,this.eg_phase_===r.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),0>=this.eg_level_&&this.ShiftPhase(r.EGPhase.decay)),this.EGUpdate()}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1),this.EGUpdate();this.eg_curve_count_++},r.prototype.EGStep=function(){this.eg_count_-=this.eg_count_diff_,0>=this.eg_count_&&this.EGCalc()},r.prototype.PGCalc=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_,this.dbgpgout_=t,t},r.prototype.PGCalcL=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.GetPMV()>>5),this.dbgpgout_=t,t},r.prototype.Calc=function(e){this.EGStep(),this.out2_=this.out_;var s=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=e>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+r.sinetable[s&t.FM_OPSINENTS-1]),this.dbgopout_=this.out_,this.out_},r.prototype.CalcL=function(e){this.EGStep();var s=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=e>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+r.sinetable[s&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},r.prototype.CalcN=function(t){this.EGStep();var e=Math.max(0,1023-(this.tl_out_+this.eg_level_))<<1;return t=(1&t)-1,this.out_=e+t^t,this.dbgopout_=this.out_,this.out_},r.prototype.CalcFB=function(e){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var i=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return 31>e&&(i+=s<<1+t.IS2EC_SHIFT>>e>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+r.sinetable[i&t.FM_OPSINENTS-1]),this.dbgopout_=this.out2_,this.out2_},r.prototype.CalcFBL=function(e){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var i=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return 31>e&&(i+=s<<1+t.IS2EC_SHIFT>>e>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+r.sinetable[i&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},r.prototype.ResetFB=function(){this.out_=this.out2_=0},r.prototype.KeyOn=function(){this.keyon_||(this.keyon_=!0,(this.eg_phase_===r.EGPhase.off||this.eg_phase_===r.EGPhase.release)&&(this.ShiftPhase(r.EGPhase.attack),this.EGUpdate(),this.in2_=this.out_=this.out2_=0,this.pg_count_=0))},r.prototype.KeyOff=function(){this.keyon_&&(this.keyon_=!1,this.ShiftPhase(r.EGPhase.release))},r.prototype.IsOn=function(){return this.eg_phase_-r.EGPhase.off},r.prototype.SetDT=function(t){this.detune_=32*t,this.param_changed_=!0},r.prototype.SetDT2=function(t){this.detune2_=3&t,this.param_changed_=!0},r.prototype.SetMULTI=function(t){this.multiple_=t,this.param_changed_=!0},r.prototype.SetTL=function(t){this.tl_=t,this.param_changed_=!0},r.prototype.SetAR=function(t){this.ar_=t,this.param_changed_=!0},r.prototype.SetDR=function(t){this.dr_=t,this.param_changed_=!0},r.prototype.SetSR=function(t){this.sr_=t,this.param_changed_=!0},r.prototype.SetSL=function(t){this.sl_=t,this.param_changed_=!0},r.prototype.SetRR=function(t){this.rr_=t,this.param_changed_=!0},r.prototype.SetKS=function(t){this.ks_=t,this.param_changed_=!0},r.prototype.SetAMON=function(t){this.amon_=t,this.param_changed_=!0},r.prototype.Mute=function(t){this.mute_=t,this.param_changed_=!0},r.prototype.SetMS=function(t){this.ms_=t,this.param_changed_=!0},r.prototype.Out=function(){return this.out_},r.notetable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,30,31,31,31,31,31,31,31],r.dttable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,16,16,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,32,32,32,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,34,38,40,44,44,44,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,-2,-2,-2,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-16,-16,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-32,-32,-32,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-34,-38,-40,-44,-44,-44,-44],r.decaytable1=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0],[1,1,1,0,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1],[2,1,1,1,2,1,1,1],[2,1,2,1,2,1,2,1],[2,2,2,1,2,2,2,1],[2,2,2,2,2,2,2,2],[4,2,2,2,4,2,2,2],[4,2,4,2,4,2,4,2],[4,4,4,2,4,4,4,2],[4,4,4,4,4,4,4,4],[8,4,4,4,8,4,4,4],[8,4,8,4,8,4,8,4],[8,8,8,4,8,8,8,4],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16]],r.decaytable2=[1,2,4,8,16,32,64,128,256,512,1024,2047,2047,2047,2047,2047],r.attacktable=[[-1,-1,-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1,-1,-1],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,-1,4,4,4,-1],[4,4,4,-1,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,4,4,4,4,4,4,4],[3,4,4,4,3,4,4,4],[3,4,3,4,3,4,3,4],[3,3,3,4,3,3,3,4],[3,3,3,3,3,3,3,3],[2,3,3,3,2,3,3,3],[2,3,2,3,2,3,2,3],[2,2,2,3,2,2,2,3],[2,2,2,2,2,2,2,2],[1,2,2,2,1,2,2,2],[1,2,1,2,1,2,1,2],[1,1,1,2,1,1,1,2],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],r.tablehasmade=!1,r.sinetable=Array(1024),r.cltable=Array(t.FM_CLENTS),r.EGPhase={next:0,attack:1,decay:2,sustain:3,release:4,off:5},r}();t.Operator=r;var o=function(){function e(){this.op=[new r,new r,new r,new r],this.tablehasmade=!1,this.fb=0,this.buf=[,,,,],this.inop=[,,,],this.outop=[,,,],this.algo_=0,this.chip_=null,this.tablehasmade||this.MakeTable(),this.SetAlgorithm(0),this.pms=t.pmtable[0][0]}return e.prototype.MakeTable=function(){for(var t=0;64>t;t++)e.kftable[t]=0|65536*a(2,t/768)},e.prototype.SetChip=function(t){this.chip_=t;for(var e=0;4>e;e++)this.op[e].SetChip(t)},e.prototype.Reset=function(){for(var t=0;4>t;t++)this.op[t].Reset()},e.prototype.Prepare=function(){for(var e=0;4>e;e++)this.op[e].Prepare();return this.pms=t.pmtable[this.op[0].type_][7&this.op[0].ms_],(this.op[0].IsOn()|this.op[1].IsOn()|this.op[2].IsOn()|this.op[3].IsOn()?1:0)|(this.op[0].ms_&(this.op[0].amon_||this.op[1].amon_||this.op[2].amon_||this.op[3].amon_?55:7)?2:0)},e.prototype.SetFNum=function(t){for(var e=0;4>e;e++)this.op[e].SetFNum(t)},e.prototype.SetKCKF=function(t,s){var i=[5197,5506,5833,6180,6180,6547,6937,7349,7349,7786,8249,8740,8740,9259,9810,10394][15&t],a=(i=(i+2)/4*4)*e.kftable[63&s];a>>=19,a<<=19,a>>=19-(7&t>>4);var r=31&t>>2;this.op[0].SetDPBN(a,r),this.op[1].SetDPBN(a,r),this.op[2].SetDPBN(a,r),this.op[3].SetDPBN(a,r)},e.prototype.KeyControl=function(t){1&t?this.op[0].KeyOn():this.op[0].KeyOff(),2&t?this.op[1].KeyOn():this.op[1].KeyOff(),4&t?this.op[2].KeyOn():this.op[2].KeyOff(),8&t?this.op[3].KeyOn():this.op[3].KeyOff()},e.prototype.SetAlgorithm=function(t){var e=[[0,1,1,2,2,3],[1,0,0,1,1,2],[1,1,1,0,0,2],[0,1,2,1,1,2],[0,1,2,2,2,1],[0,1,0,1,0,1],[0,1,2,1,2,1],[1,0,1,0,1,0]];this.inop[0]=e[t][0],this.outop[0]=e[t][1],this.inop[1]=e[t][2],this.outop[1]=e[t][3],this.inop[2]=e[t][4],this.outop[2]=e[t][5],this.op[0].ResetFB(),this.algo_=t},e.prototype.Calc=function(){var t;switch(this.algo_){case 0:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 1:this.op[2].Calc(this.op[0].Out()+this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 2:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 3:this.op[2].Calc(0),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 4:this.op[2].Calc(0),t=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 5:t=this.op[2].Calc(this.op[0].Out()),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[0].Out()),this.op[0].CalcFB(this.fb);break;case 6:t=this.op[2].Calc(0),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(0),this.op[0].CalcFB(this.fb);break;case 7:t=this.op[2].Calc(0),t+=this.op[1].Calc(0),t+=this.op[3].Calc(0),t+=this.op[0].CalcFB(this.fb)}return t},e.prototype.CalcL=function(){var t;switch(this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.algo_){case 0:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 1:this.op[2].CalcL(this.op[0].Out()+this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 2:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 3:this.op[2].CalcL(0),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 4:this.op[2].CalcL(0),t=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 5:t=this.op[2].CalcL(this.op[0].Out()),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[0].Out()),this.op[0].CalcFBL(this.fb);break;case 6:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(0),this.op[0].CalcFBL(this.fb);break;case 7:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(0),t+=this.op[3].CalcL(0),t+=this.op[0].CalcFBL(this.fb)}return t},e.prototype.CalcN=function(t){this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFB(this.fb),this.buf[this.outop[0]]+=this.op[1].Calc(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].Calc(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.CalcLN=function(t){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFBL(this.fb),this.buf[this.outop[0]]+=this.op[1].CalcL(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].CalcL(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.SetType=function(t){for(var e=0;4>e;e++)this.op[e].type_=t},e.prototype.SetFB=function(t){this.fb=e.fbtable[t]},e.prototype.SetMS=function(t){for(var e=0;4>e;e++)this.op[e].SetMS(t)},e.prototype.Mute=function(t){for(var e=0;4>e;e++)this.op[e].Mute(t)},e.fbtable=[31,7,6,5,4,3,2,1],e.kftable=Array(64),e.muted=0,e}();t.Channel4=o;var h=function(){function e(){this.ratio_=0,this.aml_=0,this.pml_=0,this.pmv_=0}return e.prototype.SetRatio=function(t){t=Math.round(t),this.ratio_!==t&&(this.ratio_=t,this.MakeTable())},e.prototype.SetAML=function(e){this.aml_=e&t.FM_LFOENTS-1},e.prototype.SetPML=function(e){this.pml_=e&t.FM_LFOENTS-1},e.prototype.SetPMV=function(t){this.pmv_=t},e.prototype.GetMulValue=function(t,e){return this.multable_[t][e]},e.prototype.GetAML=function(){return this.aml_},e.prototype.GetPML=function(){return this.pml_},e.prototype.GetPMV=function(){return this.pmv_},e.prototype.GetRatio=function(){return this.ratio_},e.prototype.MakeTable=function(){var e,s,i=[1,1.414,1.581,1.732];for(this.multable_=[,,,,],e=0;4>e;e++){var a=i[e]*this.ratio_/(1<<2+t.FM_RATIOBITS-t.FM_PGBITS);for(this.multable_[e]=Array(16),s=0;16>s;s++){var r=s?2*s:1;this.multable_[e][s]=0|r*a}}},e}();t.Chip=h,t.MakeLFOTable=function(){if(!t.tablemade){t.tablemade=!0;var i,r=[[0,1/360,2/360,3/360,4/360,6/360,12/360,24/360],[0,1/480,2/480,4/480,10/480,20/480,80/480,140/480]],o=[[31,6,4,3],[31,2,1,0]];t.pmtable=[,,],t.amtable=[,,];for(var h=0;2>h;h++){for(t.pmtable[h]=Array(8),i=0;8>i;i++){var c=r[h][i];t.pmtable[h][i]=Array(t.FM_LFOENTS);for(var n=0;n<t.FM_LFOENTS;n++){a(2,c*(2*n-t.FM_LFOENTS+1)/(t.FM_LFOENTS-1));var _=.6*c*e(2*n*s/t.FM_LFOENTS)+1;t.pmtable[h][i][n]=0|65536*(_-1)}}for(t.amtable[h]=[,,,,],i=0;4>i;i++)for(t.amtable[h][i]=Array(t.FM_LFOENTS),n=0;n<t.FM_LFOENTS;n++)t.amtable[h][i][n]=2*(4*n>>o[h][i])<<2}}}}(s||(s={})),function(t){var e=function(){function t(){this.OPM_LFOENTS=512,this.regtc=0,this.regta=[,,],this.timera=0,this.timera_count=0,this.timerb=0,this.timerb_count=0,this.timer_step=0}return t.prototype.Reset=function(){this.timera_count=0,this.timerb_count=0},t.prototype.SetTimerControl=function(t){var e=this.regtc^t;this.regtc=t,16&t&&this.ResetStatus(1),32&t&&this.ResetStatus(2),1&e&&(this.timera_count=1&t?this.timera:0),2&e&&(this.timerb_count=2&t?this.timerb:0)},t.prototype.SetTimerA=function(t,e){var s;this.regta[1&t]=e,s=(this.regta[0]<<2)+(3&this.regta[1]),this.timera=(1024-s)*this.timer_step},t.prototype.SetTimerB=function(t){this.timerb=(256-t)*this.timer_step},t.prototype.Count=function(t){var e=!1;if(this.timera_count&&(this.timera_count-=t<<16,0>=this.timera_count)){for(e=!0,this.TimerA();0>=this.timera_count;)this.timera_count+=this.timera;4&this.regtc&&this.SetStatus(1)}if(this.timerb_count&&(this.timerb_count-=t<<12,0>=this.timerb_count)){for(e=!0;0>=this.timerb_count;)this.timerb_count+=this.timerb;8&this.regtc&&this.SetStatus(2)}return e},t.prototype.GetNextEvent=function(){var t=(this.timera_count+65535>>16)-1,e=(this.timerb_count+4095>>12)-1;return(t<e?t:e)+1},t.prototype.SetTimerBase=function(t){this.timer_step=0|65536e6/t},t.prototype.SetStatus=function(){},t.prototype.ResetStatus=function(){},t.prototype.TimerA=function(){},t}();t.Timer=e}(s||(s={})),function(t){var s=function(s){function r(){s.call(this),this.fmvolume=0,this.clock=0,this.rate=0,this.pcmrate=0,this.pmd=0,this.amd=0,this.lfocount=0,this.lfodcount=0,this.lfo_count_=0,this.lfo_count_diff_=0,this.lfo_step_=0,this.lfo_count_prev_=0,this.lfowaveform=0,this.rateratio=0,this.noise=0,this.noisecount=0,this.noisedelta=0,this.interpolation=!1,this.lfofreq=0,this.status=0,this.reg01=0,this.kc=Array(8),this.kf=Array(8),this.pan=Array(8),this.ch=[new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4],this.chip=new t.Chip,this.lfo_count_=0,this.lfo_count_prev_=-1,this.BuildLFOTable();for(var e=0;8>e;e++)this.ch[e].SetChip(this.chip),this.ch[e].SetType(1)}return e(r,s),r.prototype.Init=function(t,e){return!!this.SetRate(t,e)&&(this.Reset(),this.SetVolume(0),this.SetChannelMask(0),!0)},r.prototype.SetRate=function(t,e){return this.clock=t,this.pcmrate=e,this.rate=e,this.RebuildTimeTable(),!0},r.prototype.SetChannelMask=function(t){for(var e=0;8>e;e++)this.ch[e].Mute(!!(t&1<<e))},r.prototype.Reset=function(){var t;for(t=0;256>t;t++)this.SetReg(t,0);for(this.SetReg(25,128),s.prototype.Reset.call(this),this.status=0,this.noise=12345,this.noisecount=0,t=0;8>t;t++)this.ch[t].Reset()},r.prototype.RebuildTimeTable=function(){var e=this.clock/64;this.rateratio=((e<<t.FM_RATIOBITS)+this.rate/2)/this.rate,this.SetTimerBase(e),this.chip.SetRatio(this.rateratio)},r.prototype.SetVolume=function(t){t=i(t,20),this.fmvolume=-192<t?0|16384*a(10,t/40):0},r.prototype.SetStatus=function(t){this.status&t||(this.status|=t,this.Intr(!0))},r.prototype.ResetStatus=function(t){this.status&t&&(this.status&=~t,!this.status&&this.Intr(!1))},r.prototype.SetReg=function(e,s){if(!(256<=e)){var i=7&e;switch(255&e){case 1:2&s&&(this.lfo_count_=0,this.lfo_count_prev_=-1),this.reg01=s;break;case 8:128&this.regtc?(i=7&s,!(8&s)&&this.ch[i].op[0].KeyOff(),!(16&s)&&this.ch[i].op[1].KeyOff(),!(32&s)&&this.ch[i].op[2].KeyOff(),!(64&s)&&this.ch[i].op[3].KeyOff()):this.ch[7&s].KeyControl(s>>3);break;case 16:case 17:this.SetTimerA(e,s);break;case 18:this.SetTimerB(s);break;case 20:this.SetTimerControl(s);break;case 24:this.lfofreq=s,this.lfo_count_diff_=this.rateratio*(16+(15&this.lfofreq)<<12-t.FM_RATIOBITS)/(1<<15-(this.lfofreq>>4));break;case 25:0==(128&s)?this.amd=127&s:this.pmd=127&s;break;case 27:this.lfowaveform=3&s;break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:this.ch[i].SetFB(7&s>>3),this.ch[i].SetAlgorithm(7&s),this.pan[i]=3&s>>6;break;case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this.kc[i]=s,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:this.kf[i]=s>>2,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.ch[i].SetMS(s<<4|s>>4);break;case 15:this.noisedelta=s,this.noisecount=0;break;default:64<=e&&this.SetParameter(e,s)}}},r.prototype.SetParameter=function(t,e){var s=[0,2,1,3][3&t>>3],i=this.ch[7&t].op[s];switch(7&t>>5){case 2:i.SetDT(7&e>>4),i.SetMULTI(15&e);break;case 3:i.SetTL(127&e);break;case 4:i.SetKS(3&e>>6),i.SetAR(2*(31&e));break;case 5:i.SetDR(2*(31&e)),i.SetAMON(0!=(128&e));break;case 6:i.SetSR(2*(31&e)),i.SetDT2(3&e>>6);break;case 7:i.SetSL([0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,124][15&e>>4]),i.SetRR(4*(15&e)+2)}},r.prototype.BuildLFOTable=function(){this.amtable=[,,,,],this.pmtable=[,,,,];for(var t,e=0;4>e;e++){t=0,this.amtable[e]=Array(this.OPM_LFOENTS),this.pmtable[e]=Array(this.OPM_LFOENTS);for(var s=0;s<this.OPM_LFOENTS;s++){var i,a;0===e?(a=(511&s+256)/2-128,i=255-s/2):1===e?(i=256>s?255:0,a=256>s?127:-128):2===e?(a=256>(a=511&s+128)?a-128:383-a,i=256>s?255-s:s-256):3===e&&(3&s||(t=255&(0|32768*Math.random())/17),i=t,a=t-128),this.amtable[e][s]=0|i,this.pmtable[e][s]=0|-a-1}}},r.prototype.LFO=function(){var t;3===this.lfowaveform?-131072&(this.lfo_count_^this.lfo_count_prev_)&&(t=255&(0|32768*Math.random())/17,this.chip.SetPML((t-128)*this.pmd/128+128),this.chip.SetAML(t*this.amd/128)):(t=510&this.lfo_count_>>15,this.chip.SetPML(this.pmtable[this.lfowaveform][t]*this.pmd/128+128),this.chip.SetAML(this.amtable[this.lfowaveform][t]*this.amd/128)),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_)},r.prototype.Noise=function(){if(this.noisecount+=2*this.rateratio,this.noisecount>=32<<t.FM_RATIOBITS){var e=32-(31&this.noisedelta);1==e&&(e=2),this.noisecount-=e<<t.FM_RATIOBITS,31==(31&this.noisedelta)&&(this.noisecount-=t.FM_RATIOBITS),this.noise=this.noise>>1^(1&this.noise?33800:0)}return this.noise},r.prototype.MixSub=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].Calc()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].Calc()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].Calc()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].Calc()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].Calc()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].Calc()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].Calc()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcN(this.Noise()):e[this.pan[7]]+=this.ch[7].Calc())},r.prototype.MixSubL=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].CalcL()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].CalcL()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].CalcL()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].CalcL()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].CalcL()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].CalcL()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].CalcL()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcLN(this.Noise()):e[this.pan[7]]+=this.ch[7].CalcL())},r.prototype.Mix=function(t,e,s){for(var i=0,a=1/this.attenuation,r=this.volume/100,o=0;8>o;o++)i=i<<2|this.ch[o].Prepare();2&this.reg01&&(i&=21845);var h=[,,,,];for(o=0;o<s;o++)h[1]=h[2]=h[3]=0,this.LFO(),43690&i?this.MixSubL(i,h):this.MixSub(i,h),t[o]=(h[1]+h[3])*a*r,e[o]=(h[2]+h[3])*a*r},r.prototype.label="YM2151",r.prototype.version=258,r.prototype.attenuation=49152,r.prototype.volume=100,r.prototype.mixStereo=function(t,e,s){for(var i=0,a=1/this.attenuation,r=this.volume/100,o=0;8>o;o++)i=i<<2|this.ch[o].Prepare();2&this.reg01&&(i&=21845);var h=[,,,,],c=0|s;for(o=0;o<e;o++)h[1]=h[2]=h[3]=0,this.LFO(),43690&i?this.MixSubL(i,h):this.MixSub(i,h),t[c++]+=(h[1]+h[3])*a*r,t[c++]+=(h[2]+h[3])*a*r},r.prototype.Intr=function(){},r.prototype.toggle=function(t,e){this.ch[t].muted=!e},r}(t.Timer);t.OPM=s}(s||(s={})),t.exports={get label(){return"YM2151"},get channels(){return["Ch 1","Ch 2","Ch 3","Ch 4","Ch 5","Ch 6","Ch 7","Ch 8"]},create:function(t,e){var i=new s.OPM;i.Init(t,e),i.SetReg(20,42);for(var a=0;8>a;++a)i.SetReg(56+a,0);return i.SetReg(15,0),i}}}()},function(t,e,s){"use strict";const i=s(5);t.exports={getInstance:function(){return new class{constructor(){this.ym2151=i.create(3579545,11e3,1)}start(){this.resetChip()}writeControlStatus(){}writeSoundData(){}readSoundData(){return 0}resetChip(){this.ym2151.Reset()}getUiState(){}}}}},function(t,e,s){"use strict";const i=s(6),a={WPC_PARALLEL_STROBE_PORT:16322,WPC_TICKET_DISPENSE:16326,WPC_SOUND_CONTROL_STATUS:16349,WPC_SOUND_DATA:16348},r=[];Object.keys(a).forEach(t=>{r[a[t]]=t}),t.exports={getInstance:function(t){return new class{constructor(t){this.ram=t.ram,this.interruptCallback=t.interruptCallback,this.soundboard=i.getInstance()}write(t,e){switch(this.ram[t]=e,t){case a.WPC_PARALLEL_STROBE_PORT:case a.WPC_TICKET_DISPENSE:break;case a.WPC_SOUND_CONTROL_STATUS:this.soundboard.writeControlStatus(e);break;case a.WPC_SOUND_DATA:this.soundboard.writeSoundData(e)}}read(t){return t===a.WPC_SOUND_CONTROL_STATUS?(this.interruptCallback.firq(),128):t===a.WPC_SOUND_DATA?this.soundboard.readSoundData():this.ram[t]}}(t)}}},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.generalIlluminationState=new Uint8Array(8).fill(0),this.lastValue=-1}update(t){if(t!==this.lastValue){this.lastValue=t;for(var e=0;8>e;e++)this.generalIlluminationState[e]=t&1<<e?255:0}}}}}},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.solenoidState=new Uint8Array(s).fill(0),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateSolenoids(t,e){for(var s=0;8>s;s++)e&1<<s&&(this.solenoidState[t+s]=255)}executeCycle(t){if(this.ticks+=t,this.ticks>=e){this.ticks-=e;for(var i=0;i<s;i++)this.solenoidState[i]>>>=1}}setActive(t,e){if(!(1>e))switch(t){case 16352:return this._updateSolenoids(24,e);case 16353:return this._updateSolenoids(0,e);case 16354:return this._updateSolenoids(16,e);case 16355:return this._updateSolenoids(8,e);default:throw new Error("SOLENOD_MATRIX_INVALID_OFFSET_"+t)}}}}};const e=266672,s=64},function(t){"use strict";t.exports={getInstance:function(){return new class{constructor(){this.lampState=new Uint8Array(e).fill(0),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateLampState(){if(0!==this.activeColumn)for(var t=0;8>t;t++)if(this.activeRow&1<<t)for(var e=0;8>e;e++)this.activeColumn&1<<e&&(this.lampState[e<<3|t]|=128)}executeCycle(t){if(this.ticks+=t,this.ticks>=s){this.ticks-=s;for(var i=0;i<e;i++)this.lampState[i]>>>=1}}setActiveRow(t){this.activeRow=t,this._updateLampState()}setActiveColumn(t){this.activeColumn=t,this._updateLampState()}}}};const e=64,s=33334},function(t,e,s){"use strict";const i=s(1);t.exports={getInstance:function(){return new class{constructor(){this.cabinetKeyState=a,this.cabinetKeyAutoreleaseTs=0,this.switchState=new Uint8Array(8).fill(a),this.setInputKey(24),this.activeColumn=0}setActiveColumn(t){this.activeColumn=i.findMsbBit(t)}setCabinetKey(t){console.log("SET CABINET_KEY",t),this.switchState[r]=t,this.cabinetKeyAutoreleaseTs=Date.now()}getCabinetKey(){const t=Date.now()-this.cabinetKeyAutoreleaseTs>100;return t&&(this.switchState[r]=a),this.switchState[r]}setInputKey(t=0){if(!Number.isInteger(t)||11>t||88<t)return void console.log("INVALID INPUT_KEY",t);const e=t-1,s=parseInt(e/10,10),a=parseInt(e%10,10);this.switchState[s]^=i.setMsbBit(a),this.switchState[2]|=8}getActiveRow(){return this.switchState[this.activeColumn]}clearInputKeys(){this.cabinetKeyState=a,this.switchState.fill(a)}}}};const a=0,r=0},function(t,e,s){"use strict";const i=s(0),a=s(11),r=s(10),o=s(9),h=s(8),c={WPC_SOLENOID_GEN_OUTPUT:16352,WPC_SOLENOID_HIGHPOWER_OUTPUT:16353,WPC_SOLENOID_FLASH1_OUTPUT:16354,WPC_SOLENOID_LOWPOWER_OUTPUT:16355,WPC_LAMP_ROW_OUTPUT:16356,WPC_LAMP_COL_STROBE:16357,WPC_GI_TRIAC:16358,WPC_SW_JUMPER_INPUT:16359,WPC_SWITCH_CABINET_INPUT:16360,WPC_SWITCH_ROW_SELECT:16361,WPC_SWITCH_COL_SELECT:16362,WPC_EXTBOARD1:16363,WPC_EXTBOARD2:16364,WPC_EXTBOARD3:16365,WPC_EXTBOARD4:16366,WPC_EXTBOARD5:16367,WPC_LEDS:16370,WPC_RAM_BANK:16371,WPC_SHIFTADDRH:16372,WPC_SHIFTADDRL:16373,WPC_SHIFTBIT:16374,WPC_SHIFTBIT2:16375,WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:16376,WPC_ROM_LOCK:16377,WPC_CLK_HOURS_DAYS:16378,WPC_CLK_MINS:16379,WPC_ROM_BANK:16380,WPC_RAM_LOCK:16381,WPC_RAM_LOCKSIZE:16382,WPC_ZEROCROSS_IRQ_CLEAR:16383},n=[];Object.keys(c).forEach(t=>{n[c[t]]=t});const _=[0,7,15,0,31,0,0,0,63],u=62,p=63;t.exports={getInstance:function(t,e){return new class{constructor(t,e){this.interruptCallback=e.interruptCallback,this.pageMask=_[t],this.ram=e.ram,this.periodicIRQTimerEnabled=void 0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._irqSourceDmd=!1,this.ticksZeroCross=0,this.inputSwitchMatrix=a.getInstance(),this.outputLampMatrix=r.getInstance(),this.outputSolenoidMatrix=o.getInstance(),this.outputGeneralIllumination=h.getInstance()}getUiState(){const t=this.ram[c.WPC_LEDS];return{diagnosticLed:t,lampState:this.outputLampMatrix.lampState,solenoidState:this.outputSolenoidMatrix.solenoidState,generalIlluminationState:this.outputGeneralIllumination.generalIlluminationState,inputState:this.inputSwitchMatrix.switchState,diagnosticLedToggleCount:this.diagnosticLedToggleCount,irqEnabled:this.periodicIRQTimerEnabled,activeRomBank:this.romBank}}setZeroCrossFlag(){this.zeroCrossFlag=1}setCabinetInput(t){this.inputSwitchMatrix.setCabinetKey(255&t)}setInput(t){this.inputSwitchMatrix.setInputKey(255&t)}irqSourceDmd(t){this._irqSourceDmd=!0===t}executeCycle(t){this.ticksZeroCross+=t,this.ticksZeroCross>=i.CALL_ZEROCLEAR_AFTER_TICKS&&(this.ticksZeroCross-=i.CALL_ZEROCLEAR_AFTER_TICKS,this.setZeroCrossFlag()),this.outputLampMatrix.executeCycle(t),this.outputSolenoidMatrix.executeCycle(t)}write(t,e){switch(this.ram[t]=e,t){case c.WPC_RAM_BANK:case c.WPC_RAM_LOCK:case c.WPC_RAM_LOCKSIZE:case c.WPC_CLK_HOURS_DAYS:case c.WPC_CLK_MINS:case c.WPC_SHIFTADDRH:case c.WPC_SHIFTADDRL:case c.WPC_SHIFTBIT:case c.WPC_SHIFTBIT2:case c.WPC_ROM_LOCK:case c.WPC_EXTBOARD1:case c.WPC_EXTBOARD2:case c.WPC_EXTBOARD3:case c.WPC_EXTBOARD4:case c.WPC_EXTBOARD5:break;case c.WPC_SWITCH_COL_SELECT:this.inputSwitchMatrix.setActiveColumn(e);break;case c.WPC_GI_TRIAC:this.outputGeneralIllumination.update(e);break;case c.WPC_LAMP_ROW_OUTPUT:this.outputLampMatrix.setActiveRow(e);break;case c.WPC_LAMP_COL_STROBE:this.outputLampMatrix.setActiveColumn(e);break;case c.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:return;case c.WPC_SOLENOID_GEN_OUTPUT:case c.WPC_SOLENOID_HIGHPOWER_OUTPUT:case c.WPC_SOLENOID_FLASH1_OUTPUT:case c.WPC_SOLENOID_LOWPOWER_OUTPUT:this.outputSolenoidMatrix.setActive(t,e);break;case c.WPC_LEDS:e!==this.oldDiagnostigLedState&&(this.diagnosticLedToggleCount++,this.oldDiagnostigLedState=e);break;case c.WPC_ROM_BANK:if(e===u||e===p)return void(this.romBank=e);this.romBank=e&this.pageMask;break;case c.WPC_ZEROCROSS_IRQ_CLEAR:break;default:console.log("W_NOT_IMPLEMENTED","0x"+t.toString(16),e)}}read(t){let e;return t===c.WPC_RAM_LOCK||t===c.WPC_RAM_LOCKSIZE||t===c.WPC_LEDS||t===c.WPC_ROM_LOCK||t===c.WPC_EXTBOARD1||t===c.WPC_EXTBOARD2||t===c.WPC_EXTBOARD3||t===c.WPC_EXTBOARD4||t===c.WPC_EXTBOARD5?this.ram[t]:t===c.WPC_SWITCH_CABINET_INPUT?this.inputSwitchMatrix.getCabinetKey():t===c.WPC_ROM_BANK?this.ram[t]&this.pageMask:t===c.WPC_SWITCH_ROW_SELECT?this.inputSwitchMatrix.getActiveRow():t===c.WPC_SHIFTADDRH?e=this.ram[c.WPC_SHIFTADDRH]+(this.ram[c.WPC_SHIFTADDRL]+(this.ram[c.WPC_SHIFTBIT]>>>3)>>>8):t===c.WPC_SHIFTADDRL?e=255&this.ram[c.WPC_SHIFTADDRL]+(this.ram[c.WPC_SHIFTBIT]>>>3):t===c.WPC_SHIFTBIT||t===c.WPC_SHIFTBIT2?1<<(7&this.ram[t]):t===c.WPC_CLK_HOURS_DAYS?(e=new Date).getHours():t===c.WPC_CLK_MINS?(e=new Date).getMinutes():t===c.WPC_SW_JUMPER_INPUT?0:t===c.WPC_ZEROCROSS_IRQ_CLEAR?(e=this.zeroCrossFlag<<7|127&this.ram[t],this.zeroCrossFlag=0,e):t===c.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR?!0===this._irqSourceDmd?0:128:(console.log("R_NOT_IMPLEMENTED","0x"+t.toString(16),this.ram[t]),this.ram[t])}}(t,e)},SYSTEM_ROM_BANK_NUMBER1:u,SYSTEM_ROM_BANK_NUMBER2:p,OP:c}},function(t){"use strict";function e(t,e){return{offset:t,subsystem:e}}const s="wpcio",i="externalio";t.exports={getAddress:function(t){if(t<8192)throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16));if(t<14336)return e(t,i);if(t<16320)return e(t,"dmd");if(t<16352)return e(t,i);if(t<16384)return e(t,s);throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},SUBSYSTEM_WPCIO:s,SUBSYSTEM_EXTERNALIO:i,SUBSYSTEM_DMD:"dmd"}},function(t){"use strict";function e(t,e){return{offset:t,subsystem:e}}const s="hardware",i="bank",a="system";t.exports={getAddress:function(t){if(0>t)throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16));if(t<8192)return e(t,"ram");if(t<16384)return e(t,s);if(t<32768)return e(t-16384,i);if(t<65536)return e(t-32768,a);throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+t.toString(16))},MEMORY_ADDR_RAM:8192,MEMORY_ADDR_HARDWARE:16384,SUBSYSTEM_RAM:"ram",SUBSYSTEM_HARDWARE:s,SUBSYSTEM_BANKSWITCHED:i,SUBSYSTEM_SYSTEMROM:a}},function(t,e,s){"use strict";const i=s(14),a=s(13),r=s(0),o=s(12),h=s(7),c=s(4),n=s(2);t.exports={getInstance:function(t,e){return new class{constructor(t,e){this.ram=new Uint8Array(i.MEMORY_ADDR_HARDWARE).fill(0),this.romSizeMBit=t.romSizeMBit,this.systemRom=t.systemRom,this.romFileName=t.fileName,this.gameRom=t.gameRom,this.interruptCallback=e,this.ui=n.getInstance();const s={interruptCallback:e,ram:this.ram};this.boardWpc=o.getInstance(this.romSizeMBit,s),this.boardExternalIo=h.getInstance(s),this.boardDmd=c.getInstance(s),this.ticksUpdateDmd=0,!0===t.skipWmcRomCheck&&(console.log("skipWmcRomCheck TRUE"),this.systemRom[32748]=0,this.systemRom[32749]=255)}getUiState(){return this.ui.getChangedState({romFileName:this.romFileName,ram:this.ram.slice(0,i.MEMORY_ADDR_RAM),wpc:this.boardWpc.getUiState(),dmd:this.boardDmd.getUiState()})}isPeriodicIrqEnabled(){return this.boardWpc.periodicIRQTimerEnabled}setCabinetInput(t){this.boardWpc.setCabinetInput(t)}setInput(t){this.boardWpc.setInput(t)}irqSourceDmd(t){this.boardWpc.irqSourceDmd(t)}executeCycle(t){this.ticksUpdateDmd+=t,this.ticksUpdateDmd>=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS&&(this.ticksUpdateDmd-=r.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS,this.boardDmd.copyScanline()),this.boardWpc.executeCycle(t)}read8(t){if(!isNaN(t)){const e=i.getAddress(t);switch(e.subsystem){case i.SUBSYSTEM_RAM:return this.ram[e.offset];case i.SUBSYSTEM_HARDWARE:return this._hardwareRead(e.offset);case i.SUBSYSTEM_BANKSWITCHED:return this._bankswitchedRead(e.offset);case i.SUBSYSTEM_SYSTEMROM:return this.systemRom[e.offset];default:throw new Error("INVALID_READ_SUBSYSTEM")}}}write8(t,e){if(!isNaN(t)&&void 0!==e){e&=255;const s=i.getAddress(t);switch(s.subsystem){case i.SUBSYSTEM_RAM:this.ram[s.offset]=e;break;case i.SUBSYSTEM_HARDWARE:this._hardwareWrite(t,e);break;case i.SUBSYSTEM_BANKSWITCHED:break;case i.SUBSYSTEM_SYSTEMROM:this.systemRom[s.offset]=e;break;default:throw new Error("INVALID_WRITE_SUBSYSTEM_0x"+s.offset.toString(16))}}}_bankswitchedRead(t){const e=this.boardWpc.romBank;return e===o.SYSTEM_ROM_BANK_NUMBER1||e===o.SYSTEM_ROM_BANK_NUMBER2?this.systemRom[t]:this.gameRom[t+16384*e]}_hardwareWrite(t,e){const s=a.getAddress(t);switch(s.subsystem){case a.SUBSYSTEM_DMD:this.boardDmd.write(t,e);break;case a.SUBSYSTEM_EXTERNALIO:this.boardExternalIo.write(t,e);break;case a.SUBSYSTEM_WPCIO:this.boardWpc.write(t,e);break;default:throw new Error("INVALID_HW_WRITE")}}_hardwareRead(t){const e=a.getAddress(t);switch(e.subsystem){case a.SUBSYSTEM_DMD:return this.boardDmd.read(t);case a.SUBSYSTEM_EXTERNALIO:return this.boardExternalIo.read(t);case a.SUBSYSTEM_WPCIO:return this.boardWpc.read(t);default:throw new Error("INVALID_HW_READ")}}}(t,e)}}},function(t){"use strict";t.exports=function(){function t(){p=0,E=!1,T=!1,g=!1,C=!1,M=0,R=0,u=l|f,_=j(b),O=0}function e(){w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u|=S),u|=l|f,_=j(m),O+=19}function s(){w(_),N(u&=~S),u|=l|f,_=j(d),O+=10}function i(){w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u|=S),u|=l,_=j(k),O+=19}var a,r,o,h,c,n,_,u,p;const l=16,f=64,S=128,b=65534,d=65526,k=65528,m=65532;var C,g,T,E,P,I,O=0,M=0,R=0;const L=[6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,0,0,2,4,0,0,5,9,0,2,3,0,3,2,8,6,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,5,5,5,5,0,5,3,6,9,11,0,19,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,7,0,0,7,7,0,7,7,7,7,7,0,7,7,4,7,2,2,2,4,2,2,2,0,2,2,2,2,4,7,3,0,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,5,5,5,7,5,5,5,5,5,5,5,5,7,8,6,6,2,2,2,4,2,2,2,0,2,2,2,2,3,0,3,0,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,7,5,5,5,5,5,5,5,5,6,6,6,6],v=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,5,0,4,0,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,8,0,0,0,0,0,0,0,0,8,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],A=[4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var y=function(t,e,s){u|=(128&(t^e^s^s>>1))>>6},D=function(t,e,s){u|=(32768&(t^e^s^s>>1))>>14},B=function(){return 256*a+r},F=function(t){a=255&t>>8,r=255&t},N=function(t){P(--n,255&t)},w=function(t){P(--n,255&t),P(--n,255&t>>8)},W=function(t){P(--c,255&t)},G=function(t){P(--c,255&t),P(--c,255&t>>8)},U=function(){return I(n++)},x=function(){return 256*I(n++)+I(n++)},K=function(){return I(c++)},H=function(){return 256*I(c++)+I(c++)},Y=function(t){switch(15&t){case 0:return B();case 1:return o;case 2:return h;case 3:return c;case 4:return n;case 5:return _;case 8:return a;case 9:return r;case 10:return u;case 11:return p;default:return null}},q=function(t,e){switch(15&t){case 0:return void F(e);case 1:return void(o=e);case 2:return void(h=e);case 3:return void(c=e);case 4:return void(n=e);case 5:return void(_=e);case 8:return void(a=e);case 9:return void(r=e);case 10:return void(u=e);case 11:return void(p=e)}},V=function(t,e){var s=136&t;(128==s||8==s)&&(s=0),e?(s=Y(t>>4),q(t>>4,Y(t)),q(t,s)):q(t,Y(t>>4))},Q=function(t){return 127<t?t-256:t},X=function(t){return 32767<t?t-65536:t},Z=function(){var t=I(_++);return _&=65535,t},z=function(){var t=I(_++);_&=65535;var e=I(_++);return _&=65535,256*t+e},j=function(t){var e=I(t++);t&=65535;var s=I(t++);return t&=65535,256*e+s},J=function(t,e){P(t++,255&e>>8),P(t&=65535,255&e)},$=function(){var t,e=Z();switch(96&e){case 0:t=o;break;case 32:t=h;break;case 64:t=c;break;case 96:t=n}var s,i=null,u=null;if(128&e){switch(15&e){case 0:u=t,i=t+1,O+=2;break;case 1:u=t,i=t+2,O+=3;break;case 2:u=i=t-1,O+=2;break;case 3:u=i=t-2,O+=3;break;case 4:u=t;break;case 5:u=t+Q(r),O+=1;break;case 6:u=t+Q(a),O+=1;break;case 7:u=0;break;case 8:u=t+Q(Z()),O+=1;break;case 9:u=t+X(z()),O+=4;break;case 10:u=0;break;case 11:O+=4,u=t+B();break;case 12:s=Q(Z()),u=_+s,O+=1;break;case 13:s=X(z()),u=_+s,O+=5;break;case 14:u=0;break;case 15:O+=5,u=z()}u&=65535,16&e&&(u=256*I(u)+I(65535&u+1),O+=3)}else{var p=31&e;15<p&&(p-=32),u=t+p,O+=1}if(null!==i)switch(96&e){case 0:o=i;break;case 32:h=i;break;case 64:c=i;break;case 96:n=i}return 65535&u},tt=function(t){u&=-13,0===t&&(u|=4),32768&t&&(u|=8)},et=function(t){return t++,u&=-15,u|=A[t&=255],(0===t||128==t)&&(u|=2),t},st=function(t){return t--,u&=-15,u|=A[t&=255],(127===t||255==t)&&(u|=2),t},it=function(t,e){var s=t-e;return u&=-16,u|=A[255&s],256&s&&(u|=1),y(t,e,s),255&s},at=function(t,e){var s=t-e;return u&=-16,0==(65535&s)&&(u|=4),32768&s&&(u|=8),65536&s&&(u|=1),D(t,e,s),65535&s},rt=function(t,e){var s=t+e;return u&=-48,u|=A[255&s],256&s&&(u|=1),y(t,e,s),16&(s^t^e)&&(u|=32),255&s},ot=function(t,e){var s=t+e;return u&=-16,0==(65535&s)&&(u|=4),32768&s&&(u|=8),65536&s&&(u|=1),D(t,e,s),65535&s},ht=function(t,e){var s=t+e+(1&u);return u&=-48,u|=A[255&s],256&s&&(u|=1),y(t,e,s),16&(s^t^e)&&(u|=32),255&s},ct=function(t,e){var s=t-e-(1&u);return u&=-16,u|=A[255&s],256&s&&(u|=1),y(t,e,s),255&s},nt=function(t,e){var s=t-e;return u&=-16,u|=A[255&s],256&s&&(u|=1),void y(t,e,s)},_t=function(t,e){var s=t-e;return u&=-16,0==(65535&s)&&(u|=4),32768&s&&(u|=8),65536&s&&(u|=1),void D(t,e,s)},ut=function(t){return u&=-16,128==t&&(u|=2),0==(t=1+(255&~t))&&(u|=4),128&t&&(u|=9),t},pt=function(t){return u&=-14,1&t&&(u|=1),0==(t>>=1)&&(u|=4),255&t},lt=function(t){return u&=-14,1&t&&(u|=1),u|=A[t=128&t|t>>1],t},ft=function(t){var e=t;return u&=-16,128&t&&(u|=1),u|=A[t<<=1],128&(t^e)&&(u|=2),t},St=function(t){var e=t,s=1&u;return u&=-16,128&t&&(u|=1),u|=A[t=t<<1|s],128&(t^e)&&(u|=2),t},bt=function(t){var e=1&u;return u&=-14,1&t&&(u|=1),u|=A[t=t>>1|e<<7],t},dt=function(t,e){return u&=-15,u|=A[t^=e],t},kt=function(t,e){return u&=-15,u|=A[t|=e],t},mt=function(t,e){return u&=-15,u|=A[t&=e],t},Ct=function(t){return u&=-15,u|=A[t^=255],u|=1,t},gt=function(){return 256*p+Z()},Tt=function(){var t=O;if(C?(E=!1,C=!1,e()):g&&0==(u&f)?(E=!1,g=!1,s()):T&&0==(u&l)&&(E=!1,T=!1,i()),E)return console.log("waitOnInterrupt"),O++,0;var b=null,d=null,k=Z();switch(O+=L[k],k){case 0:b=gt(),P(b,ut(I(b)));break;case 3:b=gt(),P(b,Ct(I(b)));break;case 4:b=gt(),P(b,pt(I(b)));break;case 6:b=gt(),P(b,bt(I(b)));break;case 7:b=gt(),P(b,lt(I(b)));break;case 8:b=gt(),P(b,ft(I(b)));break;case 9:b=gt(),P(b,St(I(b)));break;case 10:b=gt(),P(b,st(I(b)));break;case 12:b=gt(),P(b,et(I(b)));break;case 13:b=gt(),d=I(b),u&=-15,u|=A[d];break;case 14:b=gt(),_=b;break;case 15:b=gt(),P(b,0),u&=-12,u|=4;break;case 18:break;case 19:console.log("SYNC"),E=!0;break;case 22:b=X(z()),_+=b;break;case 23:b=X(z()),w(_),_+=b;break;case 25:var m=0,M=240&a,R=15&a;(9<R||32&u)&&(m|=6),128<M&&9<R&&(m|=96),(144<M||1&u)&&(m|=96),u&=-16,256&(b=m+a)&&(u|=1),u|=A[a=255&b];break;case 26:u|=Z();break;case 28:u&=Z();break;case 29:a=128&r?255:0,tt(B()),u&=-3;break;case 30:d=Z(),V(d,!0);break;case 31:d=Z(),V(d,!1);break;case 32:b=Q(Z()),_+=b;break;case 33:b=Q(Z());break;case 34:b=Q(Z()),5&u||(_+=b);break;case 35:b=Q(Z()),5&u&&(_+=b);break;case 36:b=Q(Z()),1&u||(_+=b);break;case 37:b=Q(Z()),1&u&&(_+=b);break;case 38:b=Q(Z()),4&u||(_+=b);break;case 39:b=Q(Z()),4&u&&(_+=b);break;case 40:b=Q(Z()),2&u||(_+=b);break;case 41:b=Q(Z()),2&u&&(_+=b);break;case 42:b=Q(Z()),8&u||(_+=b);break;case 43:b=Q(Z()),8&u&&(_+=b);break;case 44:b=Q(Z()),8&u^(2&u)<<2||(_+=b);break;case 45:b=Q(Z()),8&u^(2&u)<<2&&(_+=b);break;case 46:b=Q(Z()),8&u^(2&u)<<2||4&u||(_+=b);break;case 47:b=Q(Z()),(8&u^(2&u)<<2||4&u)&&(_+=b);break;case 48:0===(o=$())?u|=4:u&=-5;break;case 49:0===(h=$())?u|=4:u&=-5;break;case 50:n=$();break;case 51:c=$();break;case 52:!function(t){var e=0;128&t&&(w(_),e+=2),64&t&&(w(c),e+=2),32&t&&(w(h),e+=2),16&t&&(w(o),e+=2),8&t&&(N(p),e++),4&t&&(N(r),e++),2&t&&(N(a),e++),1&t&&(N(u),e++),O+=e}(Z());break;case 53:!function(t){var e=0;1&t&&(u=U(),e++),2&t&&(a=U(),e++),4&t&&(r=U(),e++),8&t&&(p=U(),e++),16&t&&(o=x(),e+=2),32&t&&(h=x(),e+=2),64&t&&(c=x(),e+=2),128&t&&(_=x(),e+=2),O+=e}(Z());break;case 54:!function(t){var e=0;128&t&&(G(_),e+=2),64&t&&(G(n),e+=2),32&t&&(G(h),e+=2),16&t&&(G(o),e+=2),8&t&&(W(p),e++),4&t&&(W(r),e++),2&t&&(W(a),e++),1&t&&(W(u),e++),O+=e}(Z());break;case 55:!function(t){var e=0;1&t&&(u=K(),e++),2&t&&(a=K(),e++),4&t&&(r=K(),e++),8&t&&(p=K(),e++),16&t&&(o=H(),e+=2),32&t&&(h=H(),e+=2),64&t&&(n=H(),e+=2),128&t&&(_=H(),e+=2),O+=e}(Z());break;case 57:_=x();break;case 58:o+=r;break;case 59:(u=U())&S&&(O+=9,a=U(),r=U(),p=U(),o=x(),h=x(),c=x()),_=x();break;case 60:console.log("CWAI might be broken!"),u&=Z(),u|=S,w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u),E=!0;break;case 61:0==(b=a*r)?u|=4:u&=-5,128&b?u|=1:u&=-2,F(b);break;case 63:u|=S,w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u),u|=l|f,_=j(65530);break;case 64:a=ut(a);break;case 67:a=Ct(a);break;case 68:a=pt(a);break;case 70:a=bt(a);break;case 71:a=lt(a);break;case 72:a=ft(a);break;case 73:a=St(a);break;case 74:a=st(a);break;case 76:a=et(a);break;case 77:u&=-15,u|=A[a];break;case 79:a=0,u&=-12,u|=4;break;case 80:r=ut(r);break;case 83:r=Ct(r);break;case 84:r=pt(r);break;case 86:r=bt(r);break;case 87:r=lt(r);break;case 88:r=ft(r);break;case 89:r=St(r);break;case 90:r=st(r);break;case 92:r=et(r);break;case 93:u&=-15,u|=A[r];break;case 95:r=0,u&=-12,u|=4;break;case 96:b=$(),P(b,ut(I(b)));break;case 99:b=$(),P(b,Ct(I(b)));break;case 100:b=$(),P(b,pt(I(b)));break;case 102:b=$(),P(b,bt(I(b)));break;case 103:b=$(),P(b,lt(I(b)));break;case 104:b=$(),P(b,ft(I(b)));break;case 105:b=$(),P(b,St(I(b)));break;case 106:b=$(),P(b,st(I(b)));break;case 108:b=$(),P(b,et(I(b)));break;case 109:b=$(),d=I(b),u&=-15,u|=A[d];break;case 110:b=$(),_=b;break;case 111:b=$(),P(b,0),u&=-12,u|=4;break;case 112:b=z(),P(b,ut(I(b)));break;case 115:b=z(),P(b,Ct(I(b)));break;case 116:b=z(),P(b,pt(I(b)));break;case 118:b=z(),P(b,bt(I(b)));break;case 119:b=z(),P(b,lt(I(b)));break;case 120:b=z(),P(b,ft(I(b)));break;case 121:b=z(),P(b,St(I(b)));break;case 122:b=z(),P(b,st(I(b)));break;case 124:b=z(),P(b,et(I(b)));break;case 125:b=z(),d=I(b),u&=-15,u|=A[d];break;case 126:b=z(),_=b;break;case 127:b=z(),P(b,0),u&=-12,u|=4;break;case 128:a=it(a,Z());break;case 129:nt(a,Z());break;case 130:a=ct(a,Z());break;case 131:F(at(B(),z()));break;case 132:a=mt(a,Z());break;case 133:mt(a,Z());break;case 134:a=Z(),u&=-15,u|=A[a];break;case 136:a=dt(a,Z());break;case 137:a=ht(a,Z());break;case 138:a=kt(a,Z());break;case 139:a=rt(a,Z());break;case 140:_t(o,z());break;case 141:b=Q(Z()),w(_),_+=b;break;case 142:o=z(),tt(o),u&=-3;break;case 144:b=gt(),a=it(a,I(b));break;case 145:b=gt(),nt(a,I(b));break;case 146:b=gt(),a=ct(a,I(b));break;case 147:b=gt(),F(at(B(),j(b)));break;case 148:b=gt(),a=mt(a,I(b));break;case 149:b=gt(),mt(a,I(b));break;case 150:b=gt(),a=I(b),u&=-15,u|=A[a];break;case 151:b=gt(),P(b,a),u&=-15,u|=A[a];break;case 152:b=gt(),a=dt(a,I(b));break;case 153:b=gt(),a=ht(a,I(b));break;case 154:b=gt(),a=kt(a,I(b));break;case 155:b=gt(),a=rt(a,I(b));break;case 156:b=gt(),_t(o,j(b));break;case 157:b=gt(),w(_),_=b;break;case 158:b=gt(),o=j(b),tt(o),u&=-3;break;case 159:b=gt(),J(b,o),tt(o),u&=-3;break;case 160:b=$(),a=it(a,I(b));break;case 161:b=$(),nt(a,I(b));break;case 162:b=$(),a=ct(a,I(b));break;case 163:b=$(),F(at(B(),j(b)));break;case 164:b=$(),a=mt(a,I(b));break;case 165:b=$(),mt(a,I(b));break;case 166:b=$(),a=I(b),u&=-15,u|=A[a];break;case 167:b=$(),P(b,a),u&=-15,u|=A[a];break;case 168:b=$(),a=dt(a,I(b));break;case 169:b=$(),a=ht(a,I(b));break;case 170:b=$(),a=kt(a,I(b));break;case 171:b=$(),a=rt(a,I(b));break;case 172:b=$(),_t(o,j(b));break;case 173:b=$(),w(_),_=b;break;case 174:b=$(),o=j(b),tt(o),u&=-3;break;case 175:b=$(),J(b,o),tt(o),u&=-3;break;case 176:b=z(),a=it(a,I(b));break;case 177:b=z(),nt(a,I(b));break;case 178:b=z(),a=ct(a,I(b));break;case 179:b=z(),F(at(B(),j(b)));break;case 180:b=z(),a=mt(a,I(b));break;case 181:b=z(),mt(a,I(b));break;case 182:b=z(),a=I(b),u&=-15,u|=A[a];break;case 183:b=z(),P(b,a),u&=-15,u|=A[a];break;case 184:b=z(),a=dt(a,I(b));break;case 185:b=z(),a=ht(a,I(b));break;case 186:b=z(),a=kt(a,I(b));break;case 187:b=z(),a=rt(a,I(b));break;case 188:b=z(),_t(o,j(b));break;case 189:b=z(),w(_),_=b;break;case 190:b=z(),o=j(b),tt(o),u&=-3;break;case 191:b=z(),J(b,o),tt(o),u&=-3;break;case 192:r=it(r,Z());break;case 193:nt(r,Z());break;case 194:r=ct(r,Z());break;case 195:F(ot(B(),z()));break;case 196:r=mt(r,Z());break;case 197:mt(r,Z());break;case 198:r=Z(),u&=-15,u|=A[r];break;case 200:r=dt(r,Z());break;case 201:r=ht(r,Z());break;case 202:r=kt(r,Z());break;case 203:r=rt(r,Z());break;case 204:b=z(),F(b),tt(b),u&=-3;break;case 206:c=z(),tt(c),u&=-3;break;case 208:b=gt(),r=it(r,I(b));break;case 209:b=gt(),nt(r,I(b));break;case 210:b=gt(),r=ct(r,I(b));break;case 211:b=gt(),F(ot(B(),j(b)));break;case 212:b=gt(),r=mt(r,I(b));break;case 213:b=gt(),mt(r,I(b));break;case 214:b=gt(),r=I(b),u&=-15,u|=A[r];break;case 215:b=gt(),P(b,r),u&=-15,u|=A[r];break;case 216:b=gt(),r=dt(r,I(b));break;case 217:b=gt(),r=ht(r,I(b));break;case 218:b=gt(),r=kt(r,I(b));break;case 219:b=gt(),r=rt(r,I(b));break;case 220:b=gt(),d=j(b),F(d),tt(d),u&=-3;break;case 221:b=gt(),J(b,B()),u&=-3;break;case 222:b=gt(),c=j(b),tt(o),u&=-3;break;case 223:b=gt(),J(b,c),tt(c),u&=-3;break;case 224:b=$(),r=it(r,I(b));break;case 225:b=$(),nt(r,I(b));break;case 226:b=$(),r=ct(r,I(b));break;case 227:b=$(),F(ot(B(),j(b)));break;case 228:b=$(),r=mt(r,I(b));break;case 229:b=$(),mt(r,I(b));break;case 230:b=$(),r=I(b),u&=-15,u|=A[r];break;case 231:b=$(),P(b,r),u&=-15,u|=A[r];break;case 232:b=$(),r=dt(r,I(b));break;case 233:b=$(),r=ht(r,I(b));break;case 234:b=$(),r=kt(r,I(b));break;case 235:b=$(),r=rt(r,I(b));break;case 236:b=$(),d=j(b),F(d),tt(d),u&=-3;break;case 237:b=$(),J(b,B()),u&=-3;break;case 238:b=$(),c=j(b),tt(c),u&=-3;break;case 239:b=$(),J(b,c),tt(c),u&=-3;break;case 240:b=z(),r=it(r,I(b));break;case 241:b=z(),nt(r,I(b));break;case 242:b=z(),r=ct(r,I(b));break;case 243:b=z(),F(ot(B(),j(b)));break;case 244:b=z(),r=mt(r,I(b));break;case 245:b=z(),mt(r,I(b));break;case 246:b=z(),r=I(b),u&=-15,u|=A[r];break;case 247:b=z(),P(b,r),u&=-15,u|=A[r];break;case 248:b=z(),r=dt(r,I(b));break;case 249:b=z(),r=ht(r,I(b));break;case 250:b=z(),r=kt(r,I(b));break;case 251:b=z(),r=rt(r,I(b));break;case 252:b=z(),d=j(b),F(d),tt(d),u&=-3;break;case 253:b=z(),J(b,B()),u&=-3;break;case 254:b=z(),c=j(b),tt(c),u&=-3;break;case 255:b=z(),J(b,c),tt(c),u&=-3;break;case 16:k=Z(),O+=v[k],33===k?b=X(z()):34===k?(b=X(z()),5&u||(_+=b)):35===k?(b=X(z()),5&u&&(_+=b)):36===k?(b=X(z()),1&u||(_+=b)):37===k?(b=X(z()),1&u&&(_+=b)):38===k?(b=X(z()),4&u||(_+=b)):39===k?(b=X(z()),4&u&&(_+=b)):40===k?(b=X(z()),2&u||(_+=b)):41===k?(b=X(z()),2&u&&(_+=b)):42===k?(b=X(z()),8&u||(_+=b)):43===k?(b=X(z()),8&u&&(_+=b)):44===k?(b=X(z()),8&u^(2&u)<<2||(_+=b)):45===k?(b=X(z()),8&u^(2&u)<<2&&(_+=b)):46===k?(b=X(z()),8&u^(2&u)<<2||4&u||(_+=b)):47===k?(b=X(z()),(8&u^(2&u)<<2||4&u)&&(_+=b)):63===k?(u|=S,w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u),u|=l|f,_=j(65524)):131===k?_t(B(),z()):140===k?_t(h,z()):142===k?(h=z(),tt(h),u&=-3):147===k?(b=gt(),_t(B(),j(b))):156===k?(b=gt(),_t(h,j(b))):158===k?(b=gt(),h=j(b),tt(h),u&=-3):159===k?(b=gt(),J(b,h),tt(h),u&=-3):163===k?(b=$(),_t(B(),j(b))):172===k?(b=$(),_t(h,j(b))):174===k?(b=$(),h=j(b),tt(h),u&=-3):175===k?(b=$(),J(b,h),tt(h),u&=-3):179===k?(b=z(),_t(B(),j(b))):188===k?(b=z(),_t(h,j(b))):190===k?(b=z(),h=j(b),tt(h),u&=-3):191===k?(b=z(),J(b,h),tt(h),u&=-3):206===k?(n=z(),tt(n),u&=-3):222===k?(b=gt(),n=j(b),tt(n),u&=-3):223===k?(b=gt(),J(b,n),tt(n),u&=-3):238===k?(b=$(),n=j(b),tt(n),u&=-3):239===k?(b=$(),J(b,n),tt(n),u&=-3):254===k?(b=z(),n=j(b),tt(n),u&=-3):255===k?(b=z(),J(b,n),tt(n),u&=-3):console.log("CPU_OPCODE_IIKS_AA");break;case 17:k=Z(),O+=v[k],63===k?(u|=S,w(_),w(c),w(h),w(o),N(p),N(r),N(a),N(u),u|=l|f,_=j(65522)):131===k?_t(c,z()):140===k?_t(n,z()):147===k?(b=gt(),_t(c,j(b))):156===k?(b=gt(),_t(n,j(b))):163===k?(b=$(),_t(c,j(b))):172===k?(b=$(),_t(n,j(b))):179===k?(b=z(),_t(c,j(b))):188===k?(b=z(),_t(n,j(b))):console.log("CPU_OPCODE_IIKS_BB")}return a&=255,r&=255,u&=255,p&=255,o&=65535,h&=65535,c&=65535,n&=65535,_&=65535,O-t};return{step:Tt,steps:function(t=1){const e=O;for(;0<t;)t-=Tt();return O-e},T:function(){return O},ticks:function(){return O},reset:t,init:function(e,s){O=0,P=e,I=s,t()},status:function(){return{pc:_,sp:n,u:c,a:a,b:r,x:o,y:h,dp:p,flags:u,waitOnInterrupt:E,irqPendingNMI:C,irqPendingFIRQ:g,irqPendingIRQ:T,missedIRQ:M,missedFIRQ:R}},irq:function(){T&&M++,T=!0},firq:function(){g&&R++,g=!0},nmi:function(){C=!0},set:function(t,e){switch(t.toUpperCase()){case"PC":_=e;break;case"A":a=e;break;case"B":r=e;break;case"X":o=e;break;case"Y":h=e;break;case"SP":n=e;break;case"U":c=e;break;case"FLAGS":u=e}},flagsToString:function(){for(var t="",e="EFHINZVC",s=0;8>s;s++)t+=0==(u&128>>s)?e[s].toLowerCase():e[s];return t}}}()},function(t){"use strict";const e=[1,2,4,8];t.exports={parse:function(t,s){return new Promise((i,a)=>{if(!t)return a(new Error("EMPTY_ROM"));const r=t.length/131072,o=!Number.isInteger(r),h=!e.includes(r);if(o||h)return a(new Error("INVALID_ROM_SIZE"));i({romSizeMBit:r,systemRom:t.subarray(t.length-32768,t.length),gameRom:t.subarray(0,t.length-32768),fileName:s.fileName,skipWmcRomCheck:s.skipWmcRomCheck,switchesEnabled:s.switchesEnabled})})}}},function(t,e,s){"use strict";const i=s(17),a=s(16),r=s(15),o=s(0);t.exports={initVMwithRom:function(t,e){return i.parse(t,e).then(t=>new class{constructor(t){const e={irq:a.irq,firq:()=>{this.asic.irqSourceDmd(!1),a.firq()},firqFromDmd:()=>{this.asic.irqSourceDmd(!0),a.firq()},clearIrqFlag:()=>{},clearFirqFlag:()=>{},reset:a.reset};this.asic=r.getInstance(t,e),this.startTime=0,this.ticksIrq=0,this.ticksZeroCross=0,this.ticksUpdateDmd=0}start(){const t=this.asic.read8.bind(this.asic),e=this.asic.write8.bind(this.asic);this.fastForwardOps=0,a.init(e,t),this.startTime=Date.now()}getUiState(){const t=a.T(),e=a.status(),s=Date.now()-this.startTime;return{asic:this.asic.getUiState(),ticks:t,opsMs:parseInt(t/s,10),missedIrqCall:e.missedIRQ,missedFirqCall:e.missedFIRQ}}executeCycle(t=500,e=4){let s=0;for(;s<t;){const t=a.steps(e);s+=t,this.ticksIrq+=t,this.ticksIrq>=o.CALL_IRQ_AFTER_TICKS&&(this.ticksIrq-=o.CALL_IRQ_AFTER_TICKS,a.irq()),this.asic.executeCycle(t)}return s}setCabinetInput(t){this.asic.setCabinetInput(t)}setInput(t){this.asic.setInput(t)}irq(){a.irq()}firq(){a.firq()}reset(){a.reset(),a.steps(2e6),a.irq()}}(t))}}}]);