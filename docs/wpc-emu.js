var WpcEmu=function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=3)}([function(module,exports,__webpack_require__){"use strict";module.exports={CALL_IRQ_AFTER_TICKS:2049,CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS:512,CALL_ZEROCLEAR_AFTER_TICKS:16667,CALL_UPDATELAMP_AFTER_TICKS:33334,CALL_UPDATESOLENOID_AFTER_TICKS:266672}},function(module,exports,__webpack_require__){"use strict";module.exports={findMsbBit:function(uint8Value){const index=[1,2,4,8,16,32,64,128].indexOf(uint8Value);return index>-1?index+1:0},setMsbBit:function(uint8Value=0){return[1,2,4,8,16,32,64,128][uint8Value]}}},function(module,exports,__webpack_require__){"use strict";const F_CARRY=1,F_OVERFLOW=2,F_ZERO=4,F_NEGATIVE=8,F_IRQMASK=16,F_HALFCARRY=32,F_FIRQMASK=64,F_ENTIRE=128,vecRESET=65534,vecFIRQ=65526,vecIRQ=65528,vecNMI=65532,vecSWI=65530,vecSWI2=65524,vecSWI3=65522,cycles=[6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,0,0,2,4,0,0,5,9,0,2,3,0,3,2,8,6,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,5,5,5,5,0,5,3,6,9,11,0,19,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,2,0,0,2,2,0,2,2,2,2,2,0,2,2,0,2,6,0,0,6,6,0,6,6,6,6,6,0,6,6,3,6,7,0,0,7,7,0,7,7,7,7,7,0,7,7,4,7,2,2,2,4,2,2,2,0,2,2,2,2,4,7,3,0,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,4,4,4,6,4,4,4,4,4,4,4,4,6,7,5,5,5,5,5,7,5,5,5,5,5,5,5,5,7,8,6,6,2,2,2,4,2,2,2,0,2,2,2,2,3,0,3,0,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,4,4,4,6,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,7,5,5,5,5,5,5,5,5,6,6,6,6],cycles2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,5,0,4,0,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,7,0,0,0,0,0,0,0,0,7,0,6,6,0,0,0,8,0,0,0,0,0,0,0,0,8,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],flagsNZ=[4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];module.exports={getInstance:function(memoryWriteFunction,memoryReadFunction,name){return new Cpu6809(memoryWriteFunction,memoryReadFunction,name)}};class Cpu6809{constructor(memoryWriteFunction,memoryReadFunction,name){this.name=name,this.memoryWriteFunction=memoryWriteFunction,this.memoryReadFunction=memoryReadFunction,this.tickCount=0,this.missedIRQ=0,this.missedFIRQ=0,this.irqPendingNMI=!1,this.irqPendingFIRQ=!1,this.irqPendingIRQ=!1,this.irqCount=0,this.firqCount=0,this.nmiCount=0,this.regA=0,this.regB=0,this.regX=0,this.regY=0,this.regU=0,this.regS=0,this.regCC=0,this.regPC=0,this.regDP=0}setV8(a,b,r){this.regCC|=(128&(a^b^r^r>>1))>>6}setV16(a,b,r){this.regCC|=(32768&(a^b^r^r>>1))>>14}getD(){return(this.regA<<8)+this.regB}setD(v){this.regA=v>>8&255,this.regB=255&v}PUSHB(b){this.memoryWriteFunction(--this.regS,255&b)}PUSHW(b){this.memoryWriteFunction(--this.regS,255&b),this.memoryWriteFunction(--this.regS,b>>8&255)}PUSHBU(b){this.memoryWriteFunction(--this.regU,255&b)}PUSHWU(b){this.memoryWriteFunction(--this.regU,255&b),this.memoryWriteFunction(--this.regU,b>>8&255)}PULLB(){return this.memoryReadFunction(this.regS++)}PULLW(){return(this.memoryReadFunction(this.regS++)<<8)+this.memoryReadFunction(this.regS++)}PULLBU(){return this.memoryReadFunction(this.regU++)}PULLWU(){return(this.memoryReadFunction(this.regU++)<<8)+this.memoryReadFunction(this.regU++)}PSHS(ucTemp){var i=0;128&ucTemp&&(this.PUSHW(this.regPC),i+=2),64&ucTemp&&(this.PUSHW(this.regU),i+=2),32&ucTemp&&(this.PUSHW(this.regY),i+=2),16&ucTemp&&(this.PUSHW(this.regX),i+=2),8&ucTemp&&(this.PUSHB(this.regDP),i++),4&ucTemp&&(this.PUSHB(this.regB),i++),2&ucTemp&&(this.PUSHB(this.regA),i++),1&ucTemp&&(this.PUSHB(this.regCC),i++),this.tickCount+=i}PSHU(ucTemp){var i=0;128&ucTemp&&(this.PUSHWU(this.regPC),i+=2),64&ucTemp&&(this.PUSHWU(this.regS),i+=2),32&ucTemp&&(this.PUSHWU(this.regY),i+=2),16&ucTemp&&(this.PUSHWU(this.regX),i+=2),8&ucTemp&&(this.PUSHBU(this.regDP),i++),4&ucTemp&&(this.PUSHBU(this.regB),i++),2&ucTemp&&(this.PUSHBU(this.regA),i++),1&ucTemp&&(this.PUSHBU(this.regCC),i++),this.tickCount+=i}PULS(ucTemp){var i=0;1&ucTemp&&(this.regCC=this.PULLB(),i++),2&ucTemp&&(this.regA=this.PULLB(),i++),4&ucTemp&&(this.regB=this.PULLB(),i++),8&ucTemp&&(this.regDP=this.PULLB(),i++),16&ucTemp&&(this.regX=this.PULLW(),i+=2),32&ucTemp&&(this.regY=this.PULLW(),i+=2),64&ucTemp&&(this.regU=this.PULLW(),i+=2),128&ucTemp&&(this.regPC=this.PULLW(),i+=2),this.tickCount+=i}PULU(ucTemp){var i=0;1&ucTemp&&(this.regCC=this.PULLBU(),i++),2&ucTemp&&(this.regA=this.PULLBU(),i++),4&ucTemp&&(this.regB=this.PULLBU(),i++),8&ucTemp&&(this.regDP=this.PULLBU(),i++),16&ucTemp&&(this.regX=this.PULLWU(),i+=2),32&ucTemp&&(this.regY=this.PULLWU(),i+=2),64&ucTemp&&(this.regS=this.PULLWU(),i+=2),128&ucTemp&&(this.regPC=this.PULLWU(),i+=2),this.tickCount+=i}getPBR(ucPostByte){switch(15&ucPostByte){case 0:return this.getD();case 1:return this.regX;case 2:return this.regY;case 3:return this.regU;case 4:return this.regS;case 5:return this.regPC;case 8:return this.regA;case 9:return this.regB;case 10:return this.regCC;case 11:return this.regDP;default:throw new Error("getPBR_INVALID"+ucPostByte)}}setPBR(ucPostByte,v){switch(15&ucPostByte){case 0:return void this.setD(v);case 1:return void(this.regX=v);case 2:return void(this.regY=v);case 3:return void(this.regU=v);case 4:return void(this.regS=v);case 5:return void(this.regPC=v);case 8:return void(this.regA=v);case 9:return void(this.regB=v);case 10:return void(this.regCC=v);case 11:return void(this.regDP=v);default:throw new Error("setPBR_INVALID"+ucPostByte)}}TFREXG(ucPostByte,bExchange){var ucTemp=136&ucPostByte;128!==ucTemp&&8!==ucTemp||(console.log("**** TFREXG problem!"),ucTemp=0),ucTemp=this.getPBR(ucPostByte>>4),bExchange&&this.setPBR(ucPostByte>>4,this.getPBR(ucPostByte)),this.setPBR(ucPostByte,ucTemp)}signed(x){return x>127?x-256:x}signed16(x){return x>32767?x-65536:x}fetch(){const v=this.memoryReadFunction(this.regPC++);return this.regPC&=65535,v}fetch16(){const v1=this.memoryReadFunction(this.regPC++);this.regPC&=65535;const v2=this.memoryReadFunction(this.regPC++);return this.regPC&=65535,(v1<<8)+v2}ReadWord(addr){const v1=this.memoryReadFunction(addr++);addr&=65535;const v2=this.memoryReadFunction(addr++);return addr&=65535,(v1<<8)+v2}WriteWord(addr,v){this.memoryWriteFunction(addr++,v>>8&255),addr&=65535,this.memoryWriteFunction(addr,255&v)}PostByte(){const pb=this.fetch();var preg;switch(96&pb){case 0:preg=this.regX;break;case 32:preg=this.regY;break;case 64:preg=this.regU;break;case 96:preg=this.regS;break;default:throw new Error("INVALID_ADDRESS_PB")}var sTemp,xchg=null,addr=null;if(128&pb){switch(15&pb){case 0:addr=preg,xchg=preg+1,this.tickCount+=2;break;case 1:addr=preg,xchg=preg+2,this.tickCount+=3;break;case 2:addr=xchg=preg-1,this.tickCount+=2;break;case 3:addr=xchg=preg-2,this.tickCount+=3;break;case 4:addr=preg;break;case 5:addr=preg+this.signed(this.regB),this.tickCount+=1;break;case 6:addr=preg+this.signed(this.regA),this.tickCount+=1;break;case 7:throw new Error("INVALID_ADDRESS_MODE_0x07");case 8:addr=preg+this.signed(this.fetch()),this.tickCount+=1;break;case 9:addr=preg+this.signed16(this.fetch16()),this.tickCount+=4;break;case 10:throw new Error("INVALID_ADDRESS_MODE_0x0A");case 11:this.tickCount+=4,addr=preg+this.getD();break;case 12:sTemp=this.signed(this.fetch()),addr=this.regPC+sTemp,this.tickCount+=1;break;case 13:sTemp=this.signed16(this.fetch16()),addr=this.regPC+sTemp,this.tickCount+=5;break;case 14:throw new Error("INVALID_ADDRESS_MODE_0x0E");case 15:this.tickCount+=5,addr=this.fetch16()}addr&=65535,16&pb&&(addr=this.ReadWord(addr),this.tickCount+=3)}else{var sByte=31&pb;sByte>15&&(sByte-=32),addr=preg+sByte,this.tickCount+=1}if(null!==xchg)switch(96&pb){case 0:this.regX=xchg;break;case 32:this.regY=xchg;break;case 64:this.regU=xchg;break;case 96:this.regS=xchg;break;default:throw new Error("PB_INVALID_XCHG_VALUE_"+pb)}return 65535&addr}flagsNZ16(word){this.regCC&=~(F_ZERO|F_NEGATIVE),0===word&&(this.regCC|=F_ZERO),32768&word&&(this.regCC|=F_NEGATIVE)}oINC(b){return b++,b&=255,this.regCC&=~(F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[b],0!==b&&128!==b||(this.regCC|=F_OVERFLOW),b}oDEC(b){return b--,b&=255,this.regCC&=~(F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[b],127!==b&&255!==b||(this.regCC|=F_OVERFLOW),b}oSUB(b,v){var temp=b-v;return this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[255&temp],256&temp&&(this.regCC|=F_CARRY),this.setV8(b,v,temp),255&temp}oSUB16(b,v){var temp=b-v;return this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),0==(65535&temp)&&(this.regCC|=F_ZERO),32768&temp&&(this.regCC|=F_NEGATIVE),65536&temp&&(this.regCC|=F_CARRY),this.setV16(b,v,temp),65535&temp}oADD(b,v){var temp=b+v;return this.regCC&=~(F_HALFCARRY|F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[255&temp],256&temp&&(this.regCC|=F_CARRY),this.setV8(b,v,temp),16&(temp^b^v)&&(this.regCC|=F_HALFCARRY),255&temp}oADD16(b,v){var temp=b+v;return this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),0==(65535&temp)&&(this.regCC|=F_ZERO),32768&temp&&(this.regCC|=F_NEGATIVE),65536&temp&&(this.regCC|=F_CARRY),this.setV16(b,v,temp),65535&temp}oADC(b,v){var temp=b+v+(this.regCC&F_CARRY);return this.regCC&=~(F_HALFCARRY|F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[255&temp],256&temp&&(this.regCC|=F_CARRY),this.setV8(b,v,temp),16&(temp^b^v)&&(this.regCC|=F_HALFCARRY),255&temp}oSBC(b,v){var temp=b-v-(this.regCC&F_CARRY);return this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[255&temp],256&temp&&(this.regCC|=F_CARRY),this.setV8(b,v,temp),255&temp}oCMP(b,v){var temp=b-v;this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),this.regCC|=flagsNZ[255&temp],256&temp&&(this.regCC|=F_CARRY),this.setV8(b,v,temp)}oCMP16(b,v){var temp=b-v;this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),0==(65535&temp)&&(this.regCC|=F_ZERO),32768&temp&&(this.regCC|=F_NEGATIVE),65536&temp&&(this.regCC|=F_CARRY),this.setV16(b,v,temp)}oNEG(b){return this.regCC&=~(F_CARRY|F_ZERO|F_OVERFLOW|F_NEGATIVE),128===b&&(this.regCC|=F_OVERFLOW),b*=-1,0===(b&=255)&&(this.regCC|=F_ZERO),128&b&&(this.regCC|=F_NEGATIVE|F_CARRY),b}oLSR(b){return this.regCC&=~(F_ZERO|F_CARRY|F_NEGATIVE),1&b&&(this.regCC|=F_CARRY),0===(b>>=1)&&(this.regCC|=F_ZERO),255&b}oASR(b){return this.regCC&=~(F_ZERO|F_CARRY|F_NEGATIVE),1&b&&(this.regCC|=F_CARRY),b=128&b|b>>1,this.regCC|=flagsNZ[b],b}oASL(b){var temp=b;return this.regCC&=~(F_ZERO|F_CARRY|F_NEGATIVE|F_OVERFLOW),128&b&&(this.regCC|=F_CARRY),b<<=1,b&=255,this.regCC|=flagsNZ[b],128&(b^temp)&&(this.regCC|=F_OVERFLOW),b}oROL(b){var temp=b,oldc=this.regCC&F_CARRY;return this.regCC&=~(F_ZERO|F_CARRY|F_NEGATIVE|F_OVERFLOW),128&b&&(this.regCC|=F_CARRY),b=b<<1|oldc,b&=255,this.regCC|=flagsNZ[b],128&(b^temp)&&(this.regCC|=F_OVERFLOW),b}oROR(b){var oldc=this.regCC&F_CARRY;return this.regCC&=~(F_ZERO|F_CARRY|F_NEGATIVE),1&b&&(this.regCC|=F_CARRY),b=b>>1|oldc<<7,b&=255,this.regCC|=flagsNZ[b],b}oEOR(b,v){return this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),b^=v,this.regCC|=flagsNZ[b],b}oOR(b,v){return this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),b|=v,this.regCC|=flagsNZ[b],b}oAND(b,v){return this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),b&=v,this.regCC|=flagsNZ[b],b}oCOM(b){return this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),b^=255,this.regCC|=flagsNZ[b],this.regCC|=F_CARRY,b}dpadd(){return(this.regDP<<8)+this.fetch()}step(){const oldTickCount=this.tickCount;this.irqPendingNMI?(this.irqPendingNMI=!1,this.nmiCount++,this._executeNmi()):this.irqPendingFIRQ&&0==(this.regCC&F_FIRQMASK)?(this.irqPendingFIRQ=!1,this.firqCount++,this._executeFirq()):this.irqPendingIRQ&&0==(this.regCC&F_IRQMASK)&&(this.irqPendingIRQ=!1,this.irqCount++,this._executeIrq());var addr=null,pb=null,opcode=this.fetch();switch(this.tickCount+=cycles[opcode],opcode){case 0:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oNEG(this.memoryReadFunction(addr)));break;case 3:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oCOM(this.memoryReadFunction(addr)));break;case 4:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oLSR(this.memoryReadFunction(addr)));break;case 6:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oROR(this.memoryReadFunction(addr)));break;case 7:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oASR(this.memoryReadFunction(addr)));break;case 8:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oASL(this.memoryReadFunction(addr)));break;case 9:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oROL(this.memoryReadFunction(addr)));break;case 10:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oDEC(this.memoryReadFunction(addr)));break;case 12:addr=this.dpadd(),this.memoryWriteFunction(addr,this.oINC(this.memoryReadFunction(addr)));break;case 13:addr=this.dpadd(),pb=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[pb];break;case 14:addr=this.dpadd(),this.regPC=addr;break;case 15:addr=this.dpadd(),this.memoryWriteFunction(addr,0),this.regCC&=~(F_CARRY|F_NEGATIVE|F_OVERFLOW),this.regCC|=F_ZERO;break;case 18:break;case 19:console.log("SYNC");break;case 22:addr=this.signed16(this.fetch16()),this.regPC+=addr;break;case 23:addr=this.signed16(this.fetch16()),this.PUSHW(this.regPC),this.regPC+=addr;break;case 25:var cf=0,nhi=240&this.regA,nlo=15&this.regA;(nlo>9||32&this.regCC)&&(cf|=6),nhi>128&&nlo>9&&(cf|=96),(nhi>144||1&this.regCC)&&(cf|=96),addr=cf+this.regA,this.regCC&=~(F_CARRY|F_NEGATIVE|F_ZERO|F_OVERFLOW),256&addr&&(this.regCC|=F_CARRY),this.regA=255&addr,this.regCC|=flagsNZ[this.regA];break;case 26:this.regCC|=this.fetch();break;case 28:this.regCC&=this.fetch();break;case 29:this.regA=128&this.regB?255:0,this.flagsNZ16(this.getD()),this.regCC&=~F_OVERFLOW;break;case 30:pb=this.fetch(),this.TFREXG(pb,!0);break;case 31:pb=this.fetch(),this.TFREXG(pb,!1);break;case 32:addr=this.signed(this.fetch()),this.regPC+=addr;break;case 33:addr=this.signed(this.fetch());break;case 34:addr=this.signed(this.fetch()),this.regCC&(F_CARRY|F_ZERO)||(this.regPC+=addr);break;case 35:addr=this.signed(this.fetch()),this.regCC&(F_CARRY|F_ZERO)&&(this.regPC+=addr);break;case 36:addr=this.signed(this.fetch()),this.regCC&F_CARRY||(this.regPC+=addr);break;case 37:addr=this.signed(this.fetch()),this.regCC&F_CARRY&&(this.regPC+=addr);break;case 38:addr=this.signed(this.fetch()),this.regCC&F_ZERO||(this.regPC+=addr);break;case 39:addr=this.signed(this.fetch()),this.regCC&F_ZERO&&(this.regPC+=addr);break;case 40:addr=this.signed(this.fetch()),this.regCC&F_OVERFLOW||(this.regPC+=addr);break;case 41:addr=this.signed(this.fetch()),this.regCC&F_OVERFLOW&&(this.regPC+=addr);break;case 42:addr=this.signed(this.fetch()),this.regCC&F_NEGATIVE||(this.regPC+=addr);break;case 43:addr=this.signed(this.fetch()),this.regCC&F_NEGATIVE&&(this.regPC+=addr);break;case 44:addr=this.signed(this.fetch()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||(this.regPC+=addr);break;case 45:addr=this.signed(this.fetch()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2&&(this.regPC+=addr);break;case 46:addr=this.signed(this.fetch()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||this.regCC&F_ZERO||(this.regPC+=addr);break;case 47:addr=this.signed(this.fetch()),(this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||this.regCC&F_ZERO)&&(this.regPC+=addr);break;case 48:this.regX=this.PostByte(),0===this.regX?this.regCC|=F_ZERO:this.regCC&=~F_ZERO;break;case 49:this.regY=this.PostByte(),0===this.regY?this.regCC|=F_ZERO:this.regCC&=~F_ZERO;break;case 50:this.regS=this.PostByte();break;case 51:this.regU=this.PostByte();break;case 52:this.PSHS(this.fetch());break;case 53:this.PULS(this.fetch());break;case 54:this.PSHU(this.fetch());break;case 55:this.PULU(this.fetch());break;case 57:this.regPC=this.PULLW();break;case 58:this.regX+=this.regB;break;case 59:this.regCC=this.PULLB(),this.regCC&F_ENTIRE&&(this.tickCount+=9,this.regA=this.PULLB(),this.regB=this.PULLB(),this.regDP=this.PULLB(),this.regX=this.PULLW(),this.regY=this.PULLW(),this.regU=this.PULLW()),this.regPC=this.PULLW();break;case 60:console.log("CWAI might be broken!"),this.regCC&=this.fetch();break;case 61:0===(addr=this.regA*this.regB)?this.regCC|=F_ZERO:this.regCC&=~F_ZERO,128&addr?this.regCC|=F_CARRY:this.regCC&=~F_CARRY,this.setD(addr);break;case 63:console.log("swi"),this.regCC|=F_ENTIRE,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecSWI);break;case 64:this.regA=this.oNEG(this.regA);break;case 67:this.regA=this.oCOM(this.regA);break;case 68:this.regA=this.oLSR(this.regA);break;case 70:this.regA=this.oROR(this.regA);break;case 71:this.regA=this.oASR(this.regA);break;case 72:this.regA=this.oASL(this.regA);break;case 73:this.regA=this.oROL(this.regA);break;case 74:this.regA=this.oDEC(this.regA);break;case 76:this.regA=this.oINC(this.regA);break;case 77:this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 79:this.regA=0,this.regCC&=~(F_NEGATIVE|F_OVERFLOW|F_CARRY),this.regCC|=F_ZERO;break;case 80:this.regB=this.oNEG(this.regB);break;case 83:this.regB=this.oCOM(this.regB);break;case 84:this.regB=this.oLSR(this.regB);break;case 86:this.regB=this.oROR(this.regB);break;case 87:this.regB=this.oASR(this.regB);break;case 88:this.regB=this.oASL(this.regB);break;case 89:this.regB=this.oROL(this.regB);break;case 90:this.regB=this.oDEC(this.regB);break;case 92:this.regB=this.oINC(this.regB);break;case 93:this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 95:this.regB=0,this.regCC&=~(F_NEGATIVE|F_OVERFLOW|F_CARRY),this.regCC|=F_ZERO;break;case 96:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oNEG(this.memoryReadFunction(addr)));break;case 99:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oCOM(this.memoryReadFunction(addr)));break;case 100:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oLSR(this.memoryReadFunction(addr)));break;case 102:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oROR(this.memoryReadFunction(addr)));break;case 103:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oASR(this.memoryReadFunction(addr)));break;case 104:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oASL(this.memoryReadFunction(addr)));break;case 105:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oROL(this.memoryReadFunction(addr)));break;case 106:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oDEC(this.memoryReadFunction(addr)));break;case 108:addr=this.PostByte(),this.memoryWriteFunction(addr,this.oINC(this.memoryReadFunction(addr)));break;case 109:addr=this.PostByte(),pb=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[pb];break;case 110:addr=this.PostByte(),this.regPC=addr;break;case 111:addr=this.PostByte(),this.memoryWriteFunction(addr,0),this.regCC&=~(F_CARRY|F_NEGATIVE|F_OVERFLOW),this.regCC|=F_ZERO;break;case 112:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oNEG(this.memoryReadFunction(addr)));break;case 115:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oCOM(this.memoryReadFunction(addr)));break;case 116:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oLSR(this.memoryReadFunction(addr)));break;case 118:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oROR(this.memoryReadFunction(addr)));break;case 119:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oASR(this.memoryReadFunction(addr)));break;case 120:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oASL(this.memoryReadFunction(addr)));break;case 121:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oROL(this.memoryReadFunction(addr)));break;case 122:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oDEC(this.memoryReadFunction(addr)));break;case 124:addr=this.fetch16(),this.memoryWriteFunction(addr,this.oINC(this.memoryReadFunction(addr)));break;case 125:addr=this.fetch16(),pb=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[pb];break;case 126:addr=this.fetch16(),this.regPC=addr;break;case 127:addr=this.fetch16(),this.memoryWriteFunction(addr,0),this.regCC&=~(F_CARRY|F_NEGATIVE|F_OVERFLOW),this.regCC|=F_ZERO;break;case 128:this.regA=this.oSUB(this.regA,this.fetch());break;case 129:this.oCMP(this.regA,this.fetch());break;case 130:this.regA=this.oSBC(this.regA,this.fetch());break;case 131:this.setD(this.oSUB16(this.getD(),this.fetch16()));break;case 132:this.regA=this.oAND(this.regA,this.fetch());break;case 133:this.oAND(this.regA,this.fetch());break;case 134:this.regA=this.fetch(),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 136:this.regA=this.oEOR(this.regA,this.fetch());break;case 137:this.regA=this.oADC(this.regA,this.fetch());break;case 138:this.regA=this.oOR(this.regA,this.fetch());break;case 139:this.regA=this.oADD(this.regA,this.fetch());break;case 140:this.oCMP16(this.regX,this.fetch16());break;case 141:addr=this.signed(this.fetch()),this.PUSHW(this.regPC),this.regPC+=addr;break;case 142:this.regX=this.fetch16(),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 144:addr=this.dpadd(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(addr));break;case 145:addr=this.dpadd(),this.oCMP(this.regA,this.memoryReadFunction(addr));break;case 146:addr=this.dpadd(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(addr));break;case 147:addr=this.dpadd(),this.setD(this.oSUB16(this.getD(),this.ReadWord(addr)));break;case 148:addr=this.dpadd(),this.regA=this.oAND(this.regA,this.memoryReadFunction(addr));break;case 149:addr=this.dpadd(),this.oAND(this.regA,this.memoryReadFunction(addr));break;case 150:addr=this.dpadd(),this.regA=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 151:addr=this.dpadd(),this.memoryWriteFunction(addr,this.regA),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 152:addr=this.dpadd(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(addr));break;case 153:addr=this.dpadd(),this.regA=this.oADC(this.regA,this.memoryReadFunction(addr));break;case 154:addr=this.dpadd(),this.regA=this.oOR(this.regA,this.memoryReadFunction(addr));break;case 155:addr=this.dpadd(),this.regA=this.oADD(this.regA,this.memoryReadFunction(addr));break;case 156:addr=this.dpadd(),this.oCMP16(this.regX,this.ReadWord(addr));break;case 157:addr=this.dpadd(),this.PUSHW(this.regPC),this.regPC=addr;break;case 158:addr=this.dpadd(),this.regX=this.ReadWord(addr),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 159:addr=this.dpadd(),this.WriteWord(addr,this.regX),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 160:addr=this.PostByte(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(addr));break;case 161:addr=this.PostByte(),this.oCMP(this.regA,this.memoryReadFunction(addr));break;case 162:addr=this.PostByte(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(addr));break;case 163:addr=this.PostByte(),this.setD(this.oSUB16(this.getD(),this.ReadWord(addr)));break;case 164:addr=this.PostByte(),this.regA=this.oAND(this.regA,this.memoryReadFunction(addr));break;case 165:addr=this.PostByte(),this.oAND(this.regA,this.memoryReadFunction(addr));break;case 166:addr=this.PostByte(),this.regA=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 167:addr=this.PostByte(),this.memoryWriteFunction(addr,this.regA),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 168:addr=this.PostByte(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(addr));break;case 169:addr=this.PostByte(),this.regA=this.oADC(this.regA,this.memoryReadFunction(addr));break;case 170:addr=this.PostByte(),this.regA=this.oOR(this.regA,this.memoryReadFunction(addr));break;case 171:addr=this.PostByte(),this.regA=this.oADD(this.regA,this.memoryReadFunction(addr));break;case 172:addr=this.PostByte(),this.oCMP16(this.regX,this.ReadWord(addr));break;case 173:addr=this.PostByte(),this.PUSHW(this.regPC),this.regPC=addr;break;case 174:addr=this.PostByte(),this.regX=this.ReadWord(addr),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 175:addr=this.PostByte(),this.WriteWord(addr,this.regX),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 176:addr=this.fetch16(),this.regA=this.oSUB(this.regA,this.memoryReadFunction(addr));break;case 177:addr=this.fetch16(),this.oCMP(this.regA,this.memoryReadFunction(addr));break;case 178:addr=this.fetch16(),this.regA=this.oSBC(this.regA,this.memoryReadFunction(addr));break;case 179:addr=this.fetch16(),this.setD(this.oSUB16(this.getD(),this.ReadWord(addr)));break;case 180:addr=this.fetch16(),this.regA=this.oAND(this.regA,this.memoryReadFunction(addr));break;case 181:addr=this.fetch16(),this.oAND(this.regA,this.memoryReadFunction(addr));break;case 182:addr=this.fetch16(),this.regA=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 183:addr=this.fetch16(),this.memoryWriteFunction(addr,this.regA),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regA];break;case 184:addr=this.fetch16(),this.regA=this.oEOR(this.regA,this.memoryReadFunction(addr));break;case 185:addr=this.fetch16(),this.regA=this.oADC(this.regA,this.memoryReadFunction(addr));break;case 186:addr=this.fetch16(),this.regA=this.oOR(this.regA,this.memoryReadFunction(addr));break;case 187:addr=this.fetch16(),this.regA=this.oADD(this.regA,this.memoryReadFunction(addr));break;case 188:addr=this.fetch16(),this.oCMP16(this.regX,this.ReadWord(addr));break;case 189:addr=this.fetch16(),this.PUSHW(this.regPC),this.regPC=addr;break;case 190:addr=this.fetch16(),this.regX=this.ReadWord(addr),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 191:addr=this.fetch16(),this.WriteWord(addr,this.regX),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 192:this.regB=this.oSUB(this.regB,this.fetch());break;case 193:this.oCMP(this.regB,this.fetch());break;case 194:this.regB=this.oSBC(this.regB,this.fetch());break;case 195:this.setD(this.oADD16(this.getD(),this.fetch16()));break;case 196:this.regB=this.oAND(this.regB,this.fetch());break;case 197:this.oAND(this.regB,this.fetch());break;case 198:this.regB=this.fetch(),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 200:this.regB=this.oEOR(this.regB,this.fetch());break;case 201:this.regB=this.oADC(this.regB,this.fetch());break;case 202:this.regB=this.oOR(this.regB,this.fetch());break;case 203:this.regB=this.oADD(this.regB,this.fetch());break;case 204:addr=this.fetch16(),this.setD(addr),this.flagsNZ16(addr),this.regCC&=~F_OVERFLOW;break;case 206:this.regU=this.fetch16(),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 208:addr=this.dpadd(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(addr));break;case 209:addr=this.dpadd(),this.oCMP(this.regB,this.memoryReadFunction(addr));break;case 210:addr=this.dpadd(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(addr));break;case 211:addr=this.dpadd(),this.setD(this.oADD16(this.getD(),this.ReadWord(addr)));break;case 212:addr=this.dpadd(),this.regB=this.oAND(this.regB,this.memoryReadFunction(addr));break;case 213:addr=this.dpadd(),this.oAND(this.regB,this.memoryReadFunction(addr));break;case 214:addr=this.dpadd(),this.regB=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 215:addr=this.dpadd(),this.memoryWriteFunction(addr,this.regB),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 216:addr=this.dpadd(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(addr));break;case 217:addr=this.dpadd(),this.regB=this.oADC(this.regB,this.memoryReadFunction(addr));break;case 218:addr=this.dpadd(),this.regB=this.oOR(this.regB,this.memoryReadFunction(addr));break;case 219:addr=this.dpadd(),this.regB=this.oADD(this.regB,this.memoryReadFunction(addr));break;case 220:addr=this.dpadd(),pb=this.ReadWord(addr),this.setD(pb),this.flagsNZ16(pb),this.regCC&=~F_OVERFLOW;break;case 221:addr=this.dpadd(),this.WriteWord(addr,this.getD()),this.regCC&=~F_OVERFLOW;break;case 222:addr=this.dpadd(),this.regU=this.ReadWord(addr),this.flagsNZ16(this.regX),this.regCC&=~F_OVERFLOW;break;case 223:addr=this.dpadd(),this.WriteWord(addr,this.regU),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 224:addr=this.PostByte(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(addr));break;case 225:addr=this.PostByte(),this.oCMP(this.regB,this.memoryReadFunction(addr));break;case 226:addr=this.PostByte(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(addr));break;case 227:addr=this.PostByte(),this.setD(this.oADD16(this.getD(),this.ReadWord(addr)));break;case 228:addr=this.PostByte(),this.regB=this.oAND(this.regB,this.memoryReadFunction(addr));break;case 229:addr=this.PostByte(),this.oAND(this.regB,this.memoryReadFunction(addr));break;case 230:addr=this.PostByte(),this.regB=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 231:addr=this.PostByte(),this.memoryWriteFunction(addr,this.regB),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 232:addr=this.PostByte(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(addr));break;case 233:addr=this.PostByte(),this.regB=this.oADC(this.regB,this.memoryReadFunction(addr));break;case 234:addr=this.PostByte(),this.regB=this.oOR(this.regB,this.memoryReadFunction(addr));break;case 235:addr=this.PostByte(),this.regB=this.oADD(this.regB,this.memoryReadFunction(addr));break;case 236:addr=this.PostByte(),pb=this.ReadWord(addr),this.setD(pb),this.flagsNZ16(pb),this.regCC&=~F_OVERFLOW;break;case 237:addr=this.PostByte(),this.WriteWord(addr,this.getD()),this.regCC&=~F_OVERFLOW;break;case 238:addr=this.PostByte(),this.regU=this.ReadWord(addr),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 239:addr=this.PostByte(),this.WriteWord(addr,this.regU),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 240:addr=this.fetch16(),this.regB=this.oSUB(this.regB,this.memoryReadFunction(addr));break;case 241:addr=this.fetch16(),this.oCMP(this.regB,this.memoryReadFunction(addr));break;case 242:addr=this.fetch16(),this.regB=this.oSBC(this.regB,this.memoryReadFunction(addr));break;case 243:addr=this.fetch16(),this.setD(this.oADD16(this.getD(),this.ReadWord(addr)));break;case 244:addr=this.fetch16(),this.regB=this.oAND(this.regB,this.memoryReadFunction(addr));break;case 245:addr=this.fetch16(),this.oAND(this.regB,this.memoryReadFunction(addr));break;case 246:addr=this.fetch16(),this.regB=this.memoryReadFunction(addr),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 247:addr=this.fetch16(),this.memoryWriteFunction(addr,this.regB),this.regCC&=~(F_ZERO|F_NEGATIVE|F_OVERFLOW),this.regCC|=flagsNZ[this.regB];break;case 248:addr=this.fetch16(),this.regB=this.oEOR(this.regB,this.memoryReadFunction(addr));break;case 249:addr=this.fetch16(),this.regB=this.oADC(this.regB,this.memoryReadFunction(addr));break;case 250:addr=this.fetch16(),this.regB=this.oOR(this.regB,this.memoryReadFunction(addr));break;case 251:addr=this.fetch16(),this.regB=this.oADD(this.regB,this.memoryReadFunction(addr));break;case 252:addr=this.fetch16(),pb=this.ReadWord(addr),this.setD(pb),this.flagsNZ16(pb),this.regCC&=~F_OVERFLOW;break;case 253:addr=this.fetch16(),this.WriteWord(addr,this.getD()),this.regCC&=~F_OVERFLOW;break;case 254:addr=this.fetch16(),this.regU=this.ReadWord(addr),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 255:addr=this.fetch16(),this.WriteWord(addr,this.regU),this.flagsNZ16(this.regU),this.regCC&=~F_OVERFLOW;break;case 16:switch(opcode=this.fetch(),this.tickCount+=cycles2[opcode],opcode){case 33:addr=this.signed16(this.fetch16());break;case 34:addr=this.signed16(this.fetch16()),this.regCC&(F_CARRY|F_ZERO)||(this.regPC+=addr);break;case 35:addr=this.signed16(this.fetch16()),this.regCC&(F_CARRY|F_ZERO)&&(this.regPC+=addr);break;case 36:addr=this.signed16(this.fetch16()),this.regCC&F_CARRY||(this.regPC+=addr);break;case 37:addr=this.signed16(this.fetch16()),this.regCC&F_CARRY&&(this.regPC+=addr);break;case 38:addr=this.signed16(this.fetch16()),this.regCC&F_ZERO||(this.regPC+=addr);break;case 39:addr=this.signed16(this.fetch16()),this.regCC&F_ZERO&&(this.regPC+=addr);break;case 40:addr=this.signed16(this.fetch16()),this.regCC&F_OVERFLOW||(this.regPC+=addr);break;case 41:addr=this.signed16(this.fetch16()),this.regCC&F_OVERFLOW&&(this.regPC+=addr);break;case 42:addr=this.signed16(this.fetch16()),this.regCC&F_NEGATIVE||(this.regPC+=addr);break;case 43:addr=this.signed16(this.fetch16()),this.regCC&F_NEGATIVE&&(this.regPC+=addr);break;case 44:addr=this.signed16(this.fetch16()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||(this.regPC+=addr);break;case 45:addr=this.signed16(this.fetch16()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2&&(this.regPC+=addr);break;case 46:addr=this.signed16(this.fetch16()),this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||this.regCC&F_ZERO||(this.regPC+=addr);break;case 47:addr=this.signed16(this.fetch16()),(this.regCC&F_NEGATIVE^(this.regCC&F_OVERFLOW)<<2||this.regCC&F_ZERO)&&(this.regPC+=addr);break;case 63:this.regCC|=F_ENTIRE,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecSWI2);break;case 131:this.oCMP16(this.getD(),this.fetch16());break;case 140:this.oCMP16(this.regY,this.fetch16());break;case 142:this.regY=this.fetch16(),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 147:addr=this.dpadd(),this.oCMP16(this.getD(),this.ReadWord(addr));break;case 156:addr=this.dpadd(),this.oCMP16(this.regY,this.ReadWord(addr));break;case 158:addr=this.dpadd(),this.regY=this.ReadWord(addr),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 159:addr=this.dpadd(),this.WriteWord(addr,this.regY),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 163:addr=this.PostByte(),this.oCMP16(this.getD(),this.ReadWord(addr));break;case 172:addr=this.PostByte(),this.oCMP16(this.regY,this.ReadWord(addr));break;case 174:addr=this.PostByte(),this.regY=this.ReadWord(addr),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 175:addr=this.PostByte(),this.WriteWord(addr,this.regY),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 179:addr=this.fetch16(),this.oCMP16(this.getD(),this.ReadWord(addr));break;case 188:addr=this.fetch16(),this.oCMP16(this.regY,this.ReadWord(addr));break;case 190:addr=this.fetch16(),this.regY=this.ReadWord(addr),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 191:addr=this.fetch16(),this.WriteWord(addr,this.regY),this.flagsNZ16(this.regY),this.regCC&=~F_OVERFLOW;break;case 206:this.regS=this.fetch16(),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 222:addr=this.dpadd(),this.regS=this.ReadWord(addr),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 223:addr=this.dpadd(),this.WriteWord(addr,this.regS),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 238:addr=this.PostByte(),this.regS=this.ReadWord(addr),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 239:addr=this.PostByte(),this.WriteWord(addr,this.regS),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 254:addr=this.fetch16(),this.regS=this.ReadWord(addr),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;case 255:addr=this.fetch16(),this.WriteWord(addr,this.regS),this.flagsNZ16(this.regS),this.regCC&=~F_OVERFLOW;break;default:throw new Error("CPU_OPCODE_INVALID_PAGE1_"+opcode)}break;case 17:switch(opcode=this.fetch(),this.tickCount+=cycles2[opcode],opcode){case 63:this.regCC|=F_ENTIRE,this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.PUSHB(this.regCC),this.regCC|=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecSWI3);break;case 131:this.oCMP16(this.regU,this.fetch16());break;case 140:this.oCMP16(this.regS,this.fetch16());break;case 147:addr=this.dpadd(),this.oCMP16(this.regU,this.ReadWord(addr));break;case 156:addr=this.dpadd(),this.oCMP16(this.regS,this.ReadWord(addr));break;case 163:addr=this.PostByte(),this.oCMP16(this.regU,this.ReadWord(addr));break;case 172:addr=this.PostByte(),this.oCMP16(this.regS,this.ReadWord(addr));break;case 179:addr=this.fetch16(),this.oCMP16(this.regU,this.ReadWord(addr));break;case 188:addr=this.fetch16(),this.oCMP16(this.regS,this.ReadWord(addr));break;default:throw new Error("CPU_OPCODE_INVALID_PAGE2_"+opcode)}}return this.regA&=255,this.regB&=255,this.regCC&=255,this.regDP&=255,this.regX&=65535,this.regY&=65535,this.regU&=65535,this.regS&=65535,this.regPC&=65535,this.tickCount-oldTickCount}reset(){this.regDP=0,this.irqPendingIRQ=!1,this.irqPendingFIRQ=!1,this.irqPendingNMI=!1,this.missedIRQ=0,this.missedFIRQ=0,this.irqCount=0,this.firqCount=0,this.regCC=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecRESET),this.tickCount=0}_executeNmi(){this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=F_ENTIRE,this.PUSHB(this.regCC),this.regCC|=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecNMI),this.tickCount+=19}_executeFirq(){this.PUSHW(this.regPC),this.regCC&=~F_ENTIRE,this.PUSHB(this.regCC),this.regCC|=F_IRQMASK|F_FIRQMASK,this.regPC=this.ReadWord(vecFIRQ),this.tickCount+=10}_executeIrq(){this.PUSHW(this.regPC),this.PUSHW(this.regU),this.PUSHW(this.regY),this.PUSHW(this.regX),this.PUSHB(this.regDP),this.PUSHB(this.regB),this.PUSHB(this.regA),this.regCC|=F_ENTIRE,this.PUSHB(this.regCC),this.regCC|=F_IRQMASK,this.regPC=this.ReadWord(vecIRQ),this.tickCount+=19}steps(ticks=1){const preTicks=this.tickCount;for(;ticks>0;)ticks-=this.step();return this.tickCount-preTicks}status(){return{pc:this.regPC,sp:this.regS,u:this.regU,a:this.regA,b:this.regB,x:this.regX,y:this.regY,dp:this.regDP,flags:this.regCC,irqPendingNMI:this.irqPendingNMI,irqPendingFIRQ:this.irqPendingFIRQ,irqPendingIRQ:this.irqPendingIRQ,missedIRQ:this.missedIRQ,missedFIRQ:this.missedFIRQ,irqCount:this.irqCount,firqCount:this.firqCount,nmiCount:this.nmiCount}}irq(){this.irqPendingIRQ&&this.missedIRQ++,this.irqPendingIRQ=!0}clearIrqMasking(){this.regCC&=~F_IRQMASK}firq(){this.irqPendingFIRQ&&this.missedFIRQ++,this.irqPendingFIRQ=!0}clearFirqMasking(){this.regCC&=~F_FIRQMASK}nmi(){this.irqPendingNMI=!0}set(reg,value){switch(reg.toUpperCase()){case"PC":this.reg=value;break;case"A":this.regA=value;break;case"B":this.regB=value;break;case"X":this.regX=value;break;case"Y":this.regY=value;break;case"SP":this.regS=value;break;case"U":this.regU=value;break;case"FLAGS":this.regCC=value}}flagsToString(){const fx="EFHINZVC";for(var f="",i=0;i<8;i++){f+=0===(this.regCC&128>>i)?fx[i].toLowerCase():fx[i]}return f}}},function(module,exports,__webpack_require__){"use strict";(function(process){const RomHelper=__webpack_require__(5),CpuBoard=__webpack_require__(7),Package=__webpack_require__(28);module.exports={initVMwithRom:function(romObject,metaData){return RomHelper.parse(romObject,metaData).then(romObject=>new Emulator(romObject))}};class Emulator{constructor(romObject){this.cpuBoard=CpuBoard.getInstance(romObject)}start(){this.startTime=Date.now(),this.cpuBoard.start()}getUiState(){const uiState=this.cpuBoard.getUiState(),runtime=Date.now()-this.startTime;return uiState.opsMs=parseInt(uiState.ticks/runtime,10),uiState.runtime=runtime,uiState}registerAudioConsumer(dacCallback){this.cpuBoard.registerDacCallback(dacCallback)}mixStereo(audioBuffer,sampleCount,offset){}executeCycle(ticksToRun=500,tickSteps=4){return this.cpuBoard.executeCycle(ticksToRun,tickSteps)}setCabinetInput(value){this.cpuBoard.setCabinetInput(value)}setInput(value){this.cpuBoard.setInput(value)}setFliptronicsInput(value){this.cpuBoard.setFliptronicsInput(value)}reset(){this.startTime=Date.now(),this.cpuBoard.reset()}version(){return Package.version}}process.on("uncaughtException",err=>{console.error("UNCAUGHT_EXCEPTION",{error:err.message})}),process.on("unhandledRejection",error=>{console.error("UNHANDLED_REJECTION",{msg:error.message,stack:error.stack})})}).call(this,__webpack_require__(4))},function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},function(module,exports,__webpack_require__){"use strict";const gameId=__webpack_require__(6),WPC_ROM_SIZE_1MBIT=131072,WPC_VALID_ROM_SIZES_IN_MBIT=[1,2,4,8],SYSTEM_ROM_SIZE_BYTES=32768,SOUNDBOARD_SYSTEM_ROM_SIZE=16384,SOUNDBOARD_CONCATINATED_ROM_SIZE=1572864;function getSoundBoardSystemRom(uInt8Roms){const u18Rom=uInt8Roms.u18;if(u18Rom)return u18Rom.subarray(u18Rom.length-SOUNDBOARD_SYSTEM_ROM_SIZE,u18Rom.length)}module.exports={parse:function(uInt8Roms,metaData={}){return new Promise((resolve,reject)=>{if("object"!=typeof uInt8Roms)return reject(new Error("INVALID_ROM_DATA"));const u06=uInt8Roms.u06,romSizeMBit=u06.length/WPC_ROM_SIZE_1MBIT,hasNotAlignedSize=!Number.isInteger(romSizeMBit),hasInvalidSize=!WPC_VALID_ROM_SIZES_IN_MBIT.includes(romSizeMBit);if(hasNotAlignedSize||hasInvalidSize)return reject(new Error("INVALID_ROM_SIZE"));const concatinatedSoundRom=function(uInt8Roms){if(!uInt8Roms.u18||!uInt8Roms.u15||!uInt8Roms.u14)return void console.log("missing sound roms");const soundRom=new Uint8Array(SOUNDBOARD_CONCATINATED_ROM_SIZE);if(console.log("u18 rom size: %s bytes",uInt8Roms.u18.length),uInt8Roms.u18.length>524288)throw new Error("U18_ROM_SIZE_EXCEEDED");if(soundRom.set(uInt8Roms.u18,0),uInt8Roms.u15){if(console.log("u15 rom size: %s bytes",uInt8Roms.u15.length),uInt8Roms.u15.length>524288)throw new Error("U15_ROM_SIZE_EXCEEDED");soundRom.set(uInt8Roms.u15,524288)}if(uInt8Roms.u14){if(console.log("u14 rom size: %s bytes",uInt8Roms.u14.length),uInt8Roms.u14.length>524288)throw new Error("U14_ROM_SIZE_EXCEEDED");soundRom.set(uInt8Roms.u14,1048576)}const systemRom=getSoundBoardSystemRom(uInt8Roms);return soundRom.set(systemRom,507904),soundRom}(uInt8Roms),soundSystemRom=getSoundBoardSystemRom(uInt8Roms),systemRom=function(u06Rom){return u06Rom.subarray(u06Rom.length-SYSTEM_ROM_SIZE_BYTES,u06Rom.length)}(u06),gameRom=function(u06Rom){return u06Rom.subarray(0,u06Rom.length-SYSTEM_ROM_SIZE_BYTES)}(u06),gameIdMemoryLocation=gameId.search(gameRom,systemRom),hasFeatures=Array.isArray(metaData.features),romData={romSizeMBit,systemRom,gameRom,soundSystemRom,concatinatedSoundRom,gameIdMemoryLocation,fileName:metaData.fileName||"Unknown",skipWmcRomCheck:!0===metaData.skipWmcRomCheck,hasSecurityPic:hasFeatures&&metaData.features.includes("securityPic")};resolve(romData)})}}},function(module,exports,__webpack_require__){"use strict";const MAGIC_SEQUENCE_LENGTH=7,PREFIX_MAGIC_1=236,PREFIX_MAGIC_2=159,POSTFIX_MAGIC_1=131,POSTFIX_MAGIC_2=18,POSTFIX_MAGIC_3=52;module.exports={search:function(gameRom,systemRom){let foundGameIdLink=0;for(let x=0;x<gameRom.length-MAGIC_SEQUENCE_LENGTH;x++){const prefixMatches=gameRom[x]===PREFIX_MAGIC_1&&gameRom[x+1]===PREFIX_MAGIC_2;if(prefixMatches){const suffixMatches=gameRom[x+4]===POSTFIX_MAGIC_1&&gameRom[x+5]===POSTFIX_MAGIC_2&&gameRom[x+6]===POSTFIX_MAGIC_3;if(suffixMatches&&2==++foundGameIdLink){let gameIdMemoryPosition=(gameRom[x+2]<<8)+gameRom[x+3];const gameIdMemoryLocation=(systemRom[gameIdMemoryPosition-=32768]<<8)+systemRom[gameIdMemoryPosition+1];return console.log("GAMEID_FOUND",gameIdMemoryLocation),gameIdMemoryLocation}}}}}},function(module,exports,__webpack_require__){"use strict";const memoryMapper=__webpack_require__(8),hardwareMapper=__webpack_require__(9),timing=__webpack_require__(0),Asic=__webpack_require__(10),SoundBoard=__webpack_require__(18),ExternalIo=__webpack_require__(22),MemoryPatch=__webpack_require__(23),MemoryPatchGameId=__webpack_require__(24),DmdBoard=__webpack_require__(25),UiFacade=__webpack_require__(27),Cpu6809=__webpack_require__(2),ROM_BANK_SIZE=16384;module.exports={getInstance:function(romObject){return new WpcCpuBoard(romObject)}};class WpcCpuBoard{constructor(romObject){this.ram=new Uint8Array(memoryMapper.MEMORY_ADDR_HARDWARE),this.romSizeMBit=romObject.romSizeMBit,this.systemRom=romObject.systemRom,this.romFileName=romObject.fileName,this.gameRom=romObject.gameRom,this.memoryPatch=MemoryPatch.getInstance(),romObject.gameIdMemoryLocation&&MemoryPatchGameId.run(this.memoryPatch,romObject.gameIdMemoryLocation);const readMemory=this._read8.bind(this),writeMemory=this._write8.bind(this);this.cpu=Cpu6809.getInstance(writeMemory,readMemory,"cpuboard"),this.uiFacade=UiFacade.getInstance();const initObject={interruptCallback:{irq:this.cpu.irq,firq:()=>{this.asic.firqSourceDmd(!1),this.cpu.firq()},firqFromDmd:()=>{this.asic.firqSourceDmd(!0),this.cpu.firq()},clearIrqFlag:()=>{this.cpu.clearIrqMasking()},clearFirqFlag:()=>{this.cpu.clearFirqMasking()},reset:this.cpu.reset},romSizeMBit:this.romSizeMBit,romObject,ram:this.ram};this.asic=Asic.getInstance(initObject),this.soundBoard=SoundBoard.getInstance(initObject),this.dmdBoard=DmdBoard.getInstance(initObject),this.externalIo=ExternalIo.getInstance(),this.startTime=0,this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0,!0===romObject.skipWmcRomCheck&&this._disableWpcRomCheck()}reset(){console.log("RESET_CPU_BOARD"),this.startTime=0,this.ticksIrq=0,this.ticksUpdateDmd=0,this.protectedMemoryWriteAttempts=0,this.cpu.reset(),this.asic.reset(),this.dmdBoard.reset(),this.soundBoard.reset()}getUiState(){const asic=this.uiFacade.getChangedState({ram:this.ram.slice(0,memoryMapper.MEMORY_ADDR_RAM),wpc:this.asic.getUiState(),dmd:this.dmdBoard.getUiState()});asic.sound=this.soundBoard.getUiState();const ticks=this.cpu.tickCount,cpuStatus=this.cpu.status();return{asic,romFileName:this.romFileName,ticks,missedIrqCall:cpuStatus.missedIRQ,missedFirqCall:cpuStatus.missedFIRQ,irqCount:cpuStatus.irqCount,firqCount:cpuStatus.firqCount,nmiCount:cpuStatus.nmiCount,protectedMemoryWriteAttempts:this.protectedMemoryWriteAttempts}}setCabinetInput(value){this.asic.setCabinetInput(value)}setInput(value){this.asic.setInput(value)}setFliptronicsInput(value){this.asic.setFliptronicsInput(value)}registerDacCallback(dacCallback){this.soundBoard.registerDacCallback(dacCallback)}start(){console.log("RESET_SYSTEM"),this.reset()}mixStereo(audioBuffer,sampleCount,offset){this.soundBoard.mixStereo(audioBuffer,sampleCount,offset)}executeCycle(ticksToRun,tickSteps){let ticksExecuted=0;for(;ticksExecuted<ticksToRun;){const singleTicks=this.cpu.steps(tickSteps);ticksExecuted+=singleTicks,this.ticksIrq+=singleTicks,this.ticksIrq>=timing.CALL_IRQ_AFTER_TICKS&&(this.ticksIrq-=timing.CALL_IRQ_AFTER_TICKS,this.cpu.irq()),this.ticksUpdateDmd+=singleTicks,this.ticksUpdateDmd>=timing.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS&&(this.ticksUpdateDmd-=timing.CALL_WPC_UPDATE_DISPLAY_AFTER_TICKS,this.dmdBoard.copyScanline()),this.asic.executeCycle(singleTicks)}return this.soundBoard.executeCycle(ticksToRun,tickSteps),ticksExecuted}_disableWpcRomCheck(){this.systemRom[32748]=0,this.systemRom[32749]=255}_read8(offset){if(isNaN(offset))throw new TypeError("ASIC_MEMORY_READ_BUG_DETECTED!");const memoryPatch=this.memoryPatch.hasPatch(offset);if(memoryPatch)return memoryPatch.value;const address=memoryMapper.getAddress(offset);switch(address.subsystem){case memoryMapper.SUBSYSTEM_RAM:return this.ram[address.offset];case memoryMapper.SUBSYSTEM_HARDWARE:return this._hardwareRead(address.offset);case memoryMapper.SUBSYSTEM_BANKSWITCHED:return this._bankswitchedRead(address.offset);case memoryMapper.SUBSYSTEM_SYSTEMROM:return this.systemRom[address.offset];default:throw new Error("INVALID_READ_SUBSYSTEM")}}_write8(offset,value){if(isNaN(offset))throw new TypeError("ASIC_MEMORY_WRITE_BUG_DETECTED!");if(void 0===value)return;value&=255;const address=memoryMapper.getAddress(offset);switch(address.subsystem){case memoryMapper.SUBSYSTEM_RAM:this.asic.isMemoryProtectionEnabled()||(offset&this.asic.memoryProtectionMask)!==this.asic.memoryProtectionMask?this.ram[address.offset]=value:this.protectedMemoryWriteAttempts++;break;case memoryMapper.SUBSYSTEM_HARDWARE:this._hardwareWrite(offset,value);break;default:console.log("CPU_WRITE8_FAIL",JSON.stringify(address),offset,value)}}_bankswitchedRead(offset){const activeBank=this.asic.romBank;if(activeBank===Asic.SYSTEM_ROM_BANK_NUMBER1||activeBank===Asic.SYSTEM_ROM_BANK_NUMBER2)return this.systemRom[offset];const pageOffset=offset+activeBank*ROM_BANK_SIZE;return this.gameRom[pageOffset]}_hardwareWrite(offset,value){const address=hardwareMapper.getAddress(offset);switch(address.subsystem){case hardwareMapper.SUBSYSTEM_DMD:this.dmdBoard.write(offset,value);break;case hardwareMapper.SUBSYSTEM_EXTERNAL_IO:this.externalIo.write(offset,value);break;case hardwareMapper.SUBSYSTEM_SOUND:this.soundBoard.writeInterface(offset,value);break;case hardwareMapper.SUBSYSTEM_WPCIO:this.asic.write(offset,value);break;case hardwareMapper.SUBSYSTEM_EXPANSION:console.log("EXPANSION_WRITE_NOT_IMPL",{offset,value});break;default:throw console.log(JSON.stringify(address)),new Error("CPUBOARD_INVALID_HW_WRITE")}}_hardwareRead(offset){const address=hardwareMapper.getAddress(offset);switch(address.subsystem){case hardwareMapper.SUBSYSTEM_DMD:return this.dmdBoard.read(offset);case hardwareMapper.SUBSYSTEM_EXTERNAL_IO:return this.externalIo.read(offset);case hardwareMapper.SUBSYSTEM_SOUND:return this.soundBoard.readInterface(offset);case hardwareMapper.SUBSYSTEM_WPCIO:return this.asic.read(offset);case hardwareMapper.SUBSYSTEM_EXPANSION:return 0;default:throw console.log(JSON.stringify(address)),new Error("INVALID_HW_READ")}}}},function(module,exports,__webpack_require__){"use strict";const MEMORY_ADDR_RAM=8192,MEMORY_ADDR_RAM2_START=15360,MEMORY_ADDR_RAM2_END=16303,MEMORY_ADDR_HARDWARE=16384,MEMORY_ADDR_BANKSWITCHED_ROM=32768,MEMORY_ADDR_SYSTEMROM=65536,SUBSYSTEM_RAM="ram",SUBSYSTEM_HARDWARE="hardware",SUBSYSTEM_BANKSWITCHED="bank",SUBSYSTEM_SYSTEMROM="system";function buildReturnModel(offset,subsystem){return{offset,subsystem}}module.exports={getAddress:function(offset){if(void 0===offset)throw new Error("MEMORY_GET_ADDRESS_UNDEFINED");if((offset&=65535)>=MEMORY_ADDR_RAM2_START&&offset<=MEMORY_ADDR_RAM2_END||offset<MEMORY_ADDR_RAM)return buildReturnModel(offset,SUBSYSTEM_RAM);if(offset<MEMORY_ADDR_HARDWARE)return buildReturnModel(offset,SUBSYSTEM_HARDWARE);if(offset<MEMORY_ADDR_BANKSWITCHED_ROM)return buildReturnModel(offset-16384,SUBSYSTEM_BANKSWITCHED);if(offset<MEMORY_ADDR_SYSTEMROM)return buildReturnModel(offset-32768,SUBSYSTEM_SYSTEMROM);throw new Error("MEMORY_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+offset.toString(16))},MEMORY_ADDR_RAM,MEMORY_ADDR_HARDWARE,SUBSYSTEM_RAM,SUBSYSTEM_HARDWARE,SUBSYSTEM_BANKSWITCHED,SUBSYSTEM_SYSTEMROM}},function(module,exports,__webpack_require__){"use strict";const MEMORY_ADDR_LOW_UNSUPPORTED=8192,MEMORY_ADDR_EXPANSION=14336,MEMORY_ADDR_DMD=16320,MEMORY_ADDR_EXTERNAL_IO=16348,MEMORY_ADDR_SOUND=16352,MEMORY_ADDR_FLIPTRONICS_FLIPPER_PORT_A=16340,MEMORY_ADDR_WPC_IO=16384,SUBSYSTEM_WPCIO="wpcio",SUBSYSTEM_SOUND="sound",SUBSYSTEM_EXTERNAL_IO="externalIo",SUBSYSTEM_DMD="dmd",SUBSYSTEM_EXPANSION="expansion";function buildReturnModel(offset,subsystem){return{offset,subsystem}}module.exports={getAddress:function(offset){if(void 0===offset)throw new Error("HW_GET_ADDRESS_UNDEFINED");if((offset&=65535)<MEMORY_ADDR_LOW_UNSUPPORTED)throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+offset.toString(16));if(offset<MEMORY_ADDR_EXPANSION)return buildReturnModel(offset,SUBSYSTEM_EXPANSION);if(offset<MEMORY_ADDR_DMD)return buildReturnModel(offset,SUBSYSTEM_DMD);if(offset===MEMORY_ADDR_FLIPTRONICS_FLIPPER_PORT_A)return buildReturnModel(offset,SUBSYSTEM_WPCIO);if(offset<MEMORY_ADDR_EXTERNAL_IO)return buildReturnModel(offset,SUBSYSTEM_EXTERNAL_IO);if(offset<MEMORY_ADDR_SOUND)return buildReturnModel(offset,SUBSYSTEM_SOUND);if(offset<MEMORY_ADDR_WPC_IO)return buildReturnModel(offset,SUBSYSTEM_WPCIO);throw new Error("HW_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+offset.toString(16))},SUBSYSTEM_WPCIO,SUBSYSTEM_SOUND,SUBSYSTEM_EXTERNAL_IO,SUBSYSTEM_DMD,SUBSYSTEM_EXPANSION}},function(module,exports,__webpack_require__){"use strict";const timing=__webpack_require__(0),dipswitchCountry=__webpack_require__(11),inputSwitchMatrix=__webpack_require__(12),outputLampMatrix=__webpack_require__(13),outputSolenoidMatrix=__webpack_require__(14),outputGeneralIllumination=__webpack_require__(15),memoryProtection=__webpack_require__(16),securityPic=__webpack_require__(17),OP={WPC_FLIPTRONICS_FLIPPER_PORT_A:16340,WPC_SOLENOID_GEN_OUTPUT:16352,WPC_SOLENOID_HIGHPOWER_OUTPUT:16353,WPC_SOLENOID_FLASH1_OUTPUT:16354,WPC_SOLENOID_LOWPOWER_OUTPUT:16355,WPC_LAMP_ROW_OUTPUT:16356,WPC_LAMP_COL_STROBE:16357,WPC_GI_TRIAC:16358,WPC_SW_JUMPER_INPUT:16359,WPC_SWITCH_CABINET_INPUT:16360,WPC_SWITCH_ROW_SELECT:16361,WPC_SWITCH_COL_SELECT:16362,WPC_PICREAD:16361,WPC_PICWRITE:16362,WPC_EXTBOARD1:16363,WPC_EXTBOARD2:16364,WPC_EXTBOARD3:16365,WPC_EXTBOARD4:16366,WPC_EXTBOARD5:16367,WPC_LEDS:16370,WPC_RAM_BANK:16371,WPC_SHIFTADDRH:16372,WPC_SHIFTADDRL:16373,WPC_SHIFTBIT:16374,WPC_SHIFTBIT2:16375,WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:16376,WPC_ROM_LOCK:16377,WPC_CLK_HOURS_DAYS:16378,WPC_CLK_MINS:16379,WPC_ROM_BANK:16380,WPC_RAM_LOCK:16381,WPC_RAM_LOCKSIZE:16382,WPC_ZEROCROSS_IRQ_CLEAR:16383},REVERSEOP=[];Object.keys(OP).forEach(key=>{REVERSEOP[OP[key]]=key});const PAGESIZE_MAP=[0,7,15,0,31,0,0,0,63],SYSTEM_ROM_BANK_NUMBER1=62,SYSTEM_ROM_BANK_NUMBER2=63,JUMPER_SETTINGS=dipswitchCountry.USA,WPC_PROTECTED_MEMORY_UNLOCK_VALUE=180;module.exports={getInstance:function(initObject){return new CpuBoardAsic(initObject)},SYSTEM_ROM_BANK_NUMBER1,SYSTEM_ROM_BANK_NUMBER2,OP};class CpuBoardAsic{constructor(initObject){this.interruptCallback=initObject.interruptCallback,this.pageMask=PAGESIZE_MAP[initObject.romSizeMBit],this.ram=initObject.ram,this.hardwareHasSecurityPic=initObject.romObject&&initObject.romObject.hasSecurityPic,this.inputSwitchMatrix=inputSwitchMatrix.getInstance(),this.outputLampMatrix=outputLampMatrix.getInstance(timing.CALL_UPDATELAMP_AFTER_TICKS),this.outputSolenoidMatrix=outputSolenoidMatrix.getInstance(timing.CALL_UPDATESOLENOID_AFTER_TICKS),this.outputGeneralIllumination=outputGeneralIllumination.getInstance(),this.securityPic=securityPic.getInstance()}reset(){console.log("RESET_ASIC"),this.periodicIRQTimerEnabled=!0,this.romBank=0,this.diagnosticLedToggleCount=0,this.oldDiagnostigLedState=0,this._firqSourceDmd=!1,this.ticksZeroCross=0,this.hardwareHasSecurityPic&&this.securityPic.reset()}getUiState(){return{diagnosticLed:this.ram[OP.WPC_LEDS],lampState:this.outputLampMatrix.lampState,solenoidState:this.outputSolenoidMatrix.solenoidState,generalIlluminationState:this.outputGeneralIllumination.generalIlluminationState,inputState:this.inputSwitchMatrix.switchState,diagnosticLedToggleCount:this.diagnosticLedToggleCount,irqEnabled:this.periodicIRQTimerEnabled,activeRomBank:this.romBank}}setZeroCrossFlag(){this.zeroCrossFlag=1}setCabinetInput(value){this.inputSwitchMatrix.setCabinetKey(255&value)}setInput(value){this.inputSwitchMatrix.setInputKey(255&value)}setFliptronicsInput(value){this.inputSwitchMatrix.setFliptronicsInput(value)}firqSourceDmd(fromDmd){this._firqSourceDmd=!0===fromDmd}executeCycle(ticksExecuted){this.ticksZeroCross+=ticksExecuted,this.ticksZeroCross>=timing.CALL_ZEROCLEAR_AFTER_TICKS&&(this.ticksZeroCross-=timing.CALL_ZEROCLEAR_AFTER_TICKS,this.setZeroCrossFlag()),this.outputLampMatrix.executeCycle(ticksExecuted),this.outputSolenoidMatrix.executeCycle(ticksExecuted)}isMemoryProtectionEnabled(){return this.ram[OP.WPC_RAM_LOCK]===WPC_PROTECTED_MEMORY_UNLOCK_VALUE}write(offset,value){switch(this.ram[offset]=value,offset){case OP.WPC_RAM_LOCK:case OP.WPC_RAM_BANK:case OP.WPC_CLK_HOURS_DAYS:case OP.WPC_CLK_MINS:case OP.WPC_SHIFTADDRH:case OP.WPC_SHIFTADDRL:case OP.WPC_SHIFTBIT:case OP.WPC_SHIFTBIT2:case OP.WPC_ROM_LOCK:case OP.WPC_EXTBOARD1:case OP.WPC_EXTBOARD2:case OP.WPC_EXTBOARD3:case OP.WPC_EXTBOARD4:case OP.WPC_EXTBOARD5:case OP.WPC_FLIPTRONICS_FLIPPER_PORT_A:break;case OP.WPC_RAM_LOCKSIZE:this.isMemoryProtectionEnabled()&&(this.memoryProtectionMask=memoryProtection.getMemoryProtectionMask(value));break;case OP.WPC_SWITCH_COL_SELECT:if(this.hardwareHasSecurityPic)return this.securityPic.write(value);this.inputSwitchMatrix.setActiveColumn(value);break;case OP.WPC_GI_TRIAC:this.outputGeneralIllumination.update(value);break;case OP.WPC_LAMP_ROW_OUTPUT:this.outputLampMatrix.setActiveRow(value);break;case OP.WPC_LAMP_COL_STROBE:this.outputLampMatrix.setActiveColumn(value);break;case OP.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:break;case OP.WPC_SOLENOID_GEN_OUTPUT:case OP.WPC_SOLENOID_HIGHPOWER_OUTPUT:case OP.WPC_SOLENOID_FLASH1_OUTPUT:case OP.WPC_SOLENOID_LOWPOWER_OUTPUT:this.outputSolenoidMatrix.setActive(offset,value);break;case OP.WPC_LEDS:value!==this.oldDiagnostigLedState&&(this.diagnosticLedToggleCount++,this.oldDiagnostigLedState=value);break;case OP.WPC_ROM_BANK:if(value===SYSTEM_ROM_BANK_NUMBER1||value===SYSTEM_ROM_BANK_NUMBER2)return void(this.romBank=value);this.romBank=value&this.pageMask;break;case OP.WPC_ZEROCROSS_IRQ_CLEAR:{128&value&&this.interruptCallback.clearIrqFlag();const timerEnabled=(16&value)>0;timerEnabled!==this.periodicIRQTimerEnabled&&(this.periodicIRQTimerEnabled=timerEnabled);break}default:console.log("W_NOT_IMPLEMENTED","0x"+offset.toString(16),value)}}read(offset){let temp;switch(offset){case OP.WPC_LEDS:case OP.WPC_ROM_LOCK:case OP.WPC_EXTBOARD1:case OP.WPC_EXTBOARD2:case OP.WPC_EXTBOARD3:case OP.WPC_EXTBOARD4:case OP.WPC_EXTBOARD5:return this.ram[offset];case OP.WPC_FLIPTRONICS_FLIPPER_PORT_A:return this.inputSwitchMatrix.getFliptronicsKeys();case OP.WPC_RAM_LOCK:case OP.WPC_RAM_LOCKSIZE:return this.ram[offset];case OP.WPC_SWITCH_CABINET_INPUT:return this.inputSwitchMatrix.getCabinetKey();case OP.WPC_ROM_BANK:return this.ram[offset]&this.pageMask;case OP.WPC_SWITCH_ROW_SELECT:return this.hardwareHasSecurityPic?this.securityPic.read(col=>this.inputSwitchMatrix.getRow(col)):this.inputSwitchMatrix.getActiveRow();case OP.WPC_SHIFTADDRH:return temp=this.ram[OP.WPC_SHIFTADDRH]+(this.ram[OP.WPC_SHIFTADDRL]+(this.ram[OP.WPC_SHIFTBIT]>>>3)>>>8)&255;case OP.WPC_SHIFTADDRL:return temp=this.ram[OP.WPC_SHIFTADDRL]+(this.ram[OP.WPC_SHIFTBIT]>>>3)&255;case OP.WPC_SHIFTBIT:case OP.WPC_SHIFTBIT2:return 1<<(7&this.ram[offset]);case OP.WPC_CLK_HOURS_DAYS:return(temp=new Date).getHours();case OP.WPC_CLK_MINS:return(temp=new Date).getMinutes();case OP.WPC_SW_JUMPER_INPUT:return JUMPER_SETTINGS;case OP.WPC_ZEROCROSS_IRQ_CLEAR:return temp=this.zeroCrossFlag<<7|127&this.ram[offset],this.zeroCrossFlag=0,temp;case OP.WPC_PERIPHERAL_TIMER_FIRQ_CLEAR:return!0===this._firqSourceDmd?0:128;default:return console.log("R_NOT_IMPLEMENTED","0x"+offset.toString(16),this.ram[offset]),this.ram[offset]}}}},function(module,exports,__webpack_require__){"use strict";module.exports={FRENCH:48,GERMAN:112,EUROPE:208,USA:0}},function(module,exports,__webpack_require__){"use strict";const bitmagic=__webpack_require__(1);module.exports={getInstance:function(){return new InputSwitchMatrix}};const INPUT_ALWAYS_CLOSED=24,CABINET_KEY_RELEASE_TIME_MS=100,MATRIX_COLUMN_SIZE=10,ALL_SWITCHES_OFF=0,CABINET_COLUMN=0,FLIPTRONICS_COLUMN=9;class InputSwitchMatrix{constructor(){this.cabinetKeyState=ALL_SWITCHES_OFF,this.cabinetKeyAutoreleaseTs=0,this.switchState=new Uint8Array(MATRIX_COLUMN_SIZE).fill(ALL_SWITCHES_OFF),this.setInputKey(INPUT_ALWAYS_CLOSED),this.activeColumn=0}setActiveColumn(columnBitmask){this.activeColumn=bitmagic.findMsbBit(columnBitmask)}setCabinetKey(keyValue){console.log("SET CABINET_KEY",keyValue),this.switchState[CABINET_COLUMN]=keyValue,this.cabinetKeyAutoreleaseTs=Date.now()}getCabinetKey(){return Date.now()-this.cabinetKeyAutoreleaseTs>CABINET_KEY_RELEASE_TIME_MS&&(this.switchState[CABINET_COLUMN]=ALL_SWITCHES_OFF),this.switchState[CABINET_COLUMN]}setFliptronicsInput(value){if(!("string"==typeof value&&2===value.length)||"F"!==value[0])return void console.log("INVALID_FLIPTRONICS_INPUT_VALUE_"+value);const column=value[1]-1;console.log("setFliptronicsInput",value),this.switchState[FLIPTRONICS_COLUMN]^=bitmagic.setMsbBit(column)}setInputKey(keyValue=0){if(!Number.isInteger(keyValue)||keyValue<11||keyValue>95)return void console.log("INVALID INPUT_KEY",keyValue);const normalizedKeyValue=keyValue-1,row=parseInt(normalizedKeyValue/10,10),column=parseInt(normalizedKeyValue%10,10);this.switchState[row]^=bitmagic.setMsbBit(column),this.switchState[2]|=8}getActiveRow(){return this.switchState[this.activeColumn]}getRow(number){return this.switchState[number]}getFliptronicsKeys(){return this.switchState[FLIPTRONICS_COLUMN]}clearInputKeys(){this.cabinetKeyState=ALL_SWITCHES_OFF,this.switchState.fill(ALL_SWITCHES_OFF)}}},function(module,exports,__webpack_require__){"use strict";module.exports={getInstance:function(updateLampTicks){return new OutputLampMatrix(updateLampTicks)}};const MATRIX_COLUMN_SIZE=64,ALL_LAMPS_OFF=0;class OutputLampMatrix{constructor(updateAfterTicks){this.updateAfterTicks=updateAfterTicks,this.lampState=new Uint8Array(MATRIX_COLUMN_SIZE).fill(ALL_LAMPS_OFF),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateLampState(){if(0!==this.activeColumn)for(let i=0;i<8;i++)if(this.activeRow&1<<i)for(let j=0;j<8;j++)this.activeColumn&1<<j&&(this.lampState[j<<3|i]|=128)}executeCycle(ticks){this.ticks+=ticks,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.lampState=this.lampState.map(state=>state>>>1))}setActiveRow(activeRow){this.activeRow=activeRow,this._updateLampState()}setActiveColumn(activeColumn){this.activeColumn=activeColumn,this._updateLampState()}}},function(module,exports,__webpack_require__){"use strict";module.exports={getInstance:function(updateAfterTicks){return new OutputSolenoidMatrix(updateAfterTicks)}};const MATRIX_COLUMN_SIZE=64,ALL_SOLENOID_OFF=0,WPC_SOLENOID_GEN_OUTPUT=16352,WPC_SOLENOID_HIGHPOWER_OUTPUT=16353,WPC_SOLENOID_FLASH1_OUTPUT=16354,WPC_SOLENOID_LOWPOWER_OUTPUT=16355;class OutputSolenoidMatrix{constructor(updateAfterTicks){this.updateAfterTicks=updateAfterTicks,this.solenoidState=new Uint8Array(MATRIX_COLUMN_SIZE).fill(ALL_SOLENOID_OFF),this.activeRow=0,this.activeColumn=0,this.ticks=0}_updateSolenoidsPacked(offset,value){for(var i=0;i<8;i++)value&1<<i&&(this.solenoidState[offset+i]=255)}executeCycle(ticks){this.ticks+=ticks,this.ticks>=this.updateAfterTicks&&(this.ticks-=this.updateAfterTicks,this.solenoidState=this.solenoidState.map(state=>state>>>1))}setActive(sourceAddress,value){if(value<0||value>255)throw new Error("SOLENOID_MATRIX_INVALID_VALUE_"+value);switch(sourceAddress){case WPC_SOLENOID_GEN_OUTPUT:return this._updateSolenoidsPacked(24,value);case WPC_SOLENOID_HIGHPOWER_OUTPUT:return this._updateSolenoidsPacked(0,value);case WPC_SOLENOID_FLASH1_OUTPUT:return this._updateSolenoidsPacked(16,value);case WPC_SOLENOID_LOWPOWER_OUTPUT:return this._updateSolenoidsPacked(8,value);default:throw new Error("SOLENOID_MATRIX_INVALID_OFFSET_"+sourceAddress.toString(16))}}}},function(module,exports,__webpack_require__){"use strict";module.exports={getInstance:function(){return new OutputSolenoidMatrix}};const MATRIX_COLUMN_SIZE=8,ALL_LAMPS_OFF=0;class OutputSolenoidMatrix{constructor(){this.generalIlluminationState=new Uint8Array(MATRIX_COLUMN_SIZE).fill(ALL_LAMPS_OFF),this.lastValue=-1}update(value){if(value!==this.lastValue){this.lastValue=value;for(var i=0;i<8;i++)this.generalIlluminationState[i]=value&1<<i?255:0}}}},function(module,exports,__webpack_require__){"use strict";const SWAP_NIBBLE=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15];module.exports={getMemoryProtectionMask:function(value){return 65535&SWAP_NIBBLE[15&value]+(240&value)+16<<8}}},function(module,exports,__webpack_require__){"use strict";const SECURITY_CHIP_SERIAL_NUMBER=[0,0,0,1,2,3,4,5,6,1,2,3,4,5,1,2,3],PIC_SERIAL_SIZE=16,WPC_PIC_RESET=0,WPC_PIC_COUNTER=13,WPC_PIC_UNLOCK=32,INIITAL_BYTE=255;module.exports={getInstance:function(machineNumber){return new SecurityPIC(machineNumber)}};class SecurityPIC{constructor(machineNumber=559){this.machineNumber=machineNumber,this.gameSerialNumber=new Uint8Array(SECURITY_CHIP_SERIAL_NUMBER),this.picSerialNumber=new Uint8Array(PIC_SERIAL_SIZE);const machineNumberString=""+machineNumber;this.gameSerialNumber[0]=parseInt(machineNumberString[0],10),this.gameSerialNumber[1]=parseInt(machineNumberString[1],10),this.gameSerialNumber[2]=parseInt(machineNumberString[2],10),this.picSerialNumber[10]=0,this.picSerialNumber[2]=0;let tmp=100*this.gameSerialNumber[1]+10*this.gameSerialNumber[7]+this.gameSerialNumber[4]+5*this.picSerialNumber[10];tmp=7117*tmp+127984,this.picSerialNumber[1]=tmp>>16&255,this.picSerialNumber[11]=tmp>>8&255,this.picSerialNumber[9]=255&tmp,tmp=4223*(tmp=1e4*this.gameSerialNumber[2]+1e3*this.gameSerialNumber[15]+100*this.gameSerialNumber[0]+10*this.gameSerialNumber[8]+this.gameSerialNumber[6]+2*this.picSerialNumber[10]+this.picSerialNumber[2])+7463513,this.picSerialNumber[7]=tmp>>24&255,this.picSerialNumber[12]=tmp>>16&255,this.picSerialNumber[0]=tmp>>8&255,this.picSerialNumber[8]=255&tmp,tmp=581*(tmp=1e3*this.gameSerialNumber[16]+100*this.gameSerialNumber[3]+10*this.gameSerialNumber[5]+this.gameSerialNumber[14]+this.picSerialNumber[2])+15732,this.picSerialNumber[3]=tmp>>16&255,this.picSerialNumber[14]=tmp>>8&255,this.picSerialNumber[6]=255&tmp,tmp=99999-(tmp=1e4*this.gameSerialNumber[13]+1e3*this.gameSerialNumber[12]+100*this.gameSerialNumber[11]+10*this.gameSerialNumber[10]+this.gameSerialNumber[9]),this.picSerialNumber[15]=tmp>>8&255,this.picSerialNumber[4]=255&tmp}reset(){this.lastByteWrite=INIITAL_BYTE,this.unlockMode=0,this.unlockCode=0,this.writesUntilUnlockNeeded=32,console.log("RESET SECURITY PIC")}read(getRowFunction){switch(this.lastByteWrite){case WPC_PIC_RESET:case WPC_PIC_UNLOCK:return 0;case WPC_PIC_COUNTER:return this.writesUntilUnlockNeeded=this.writesUntilUnlockNeeded-1&31,this.writesUntilUnlockNeeded;case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:if(this.unlockMode>0)return console.log("Column read in unlock mode"),0;const col=this.lastByteWrite-22;return col<0||col>=8?(console.log("Invalid column %d",col),0):getRowFunction(col+1);case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:const offset=this.lastByteWrite-112;return offset<0||offset>this.gameSerialNumber.length?(console.log("invalid OFFSET!!!",offset),0):this.picSerialNumber[offset];default:return console.log("Invalid PIC address read"),0}}write(data){if(this.lastByteWrite!==INIITAL_BYTE||data===WPC_PIC_RESET){if(this.lastByteWrite=data,this.unlockMode>0)return this.unlockCode=this.unlockCode<<8|data,void(++this.unlockMode>3&&(this.unlockMode=0));data===WPC_PIC_UNLOCK&&(this.unlockMode=1,this.unlockCode=0)}}}},function(module,exports,__webpack_require__){"use strict";const Cpu6809=__webpack_require__(2),YM2151=__webpack_require__(19),soundMapper=__webpack_require__(20),OP=(__webpack_require__(21),{WPC_ROMBANK_W:8192,WPC_DAC_WRITE:10240,HC55516_CLOCK_SET_WRITE:11264,WPC_LATCH_READ:12288,HC55516_DIGIT_CLOCK_CLEAR_WRITE:13312,WPC_VOLUME_WRITE:14336,WPC_LATCH_WRITE:15360,WPC_SOUND_CONTROL_STATUS:16349,WPC_SOUND_DATA:16348}),REVERSEOP=[];Object.keys(OP).forEach(key=>{REVERSEOP[OP[key]]=key});const YM2151_CLOCK_HZ=3579545,YM2151_SAMPLERATE=44100,NO_SOUND_DATA_READY=255,MEMORY_SIZE=8192;module.exports={getInstance:function(romObject){return new SoundBoard(romObject)}};class SoundBoard{constructor(initObject){this.interruptCallback=initObject.interruptCallback,this.ram=new Uint8Array(MEMORY_SIZE).fill(0);const readMemory=this._cpuRead8.bind(this),writeMemory=this._cpuWrite8.bind(this);this.cpu=Cpu6809.getInstance(writeMemory,readMemory,"soundboard"),this.ym2151=YM2151.create(YM2151_CLOCK_HZ,YM2151_SAMPLERATE),this.ym2151.TimerA=(()=>{}),this.ym2151.Intr=(booleanSetIrq=>{!0===booleanSetIrq?this.cpu.firq():this.cpu.clearFirqMasking()}),this.dacCallback=(()=>{}),this.systemROM=initObject.romObject.soundSystemRom,this.concatinatedSoundRom=initObject.romObject.concatinatedSoundRom,this.systemROM&&this.concatinatedSoundRom||(this.noRomAvailable=!0)}reset(){console.log("RESET_SOUNDBOARD"),this.volume=0,this.ym2151Register0=0,this.soundData=NO_SOUND_DATA_READY,this.firqHackTicks=0,this.romBankOffset=0,this.ym2151.Reset(),this.cpu.reset()}getUiState(){const cpuStatus=this.cpu.status();return{ram:this.ram,volume:this.volume,ticks:this.cpu.tickCount,missedIrqCall:cpuStatus.missedIRQ,missedFirqCall:cpuStatus.missedFIRQ,irqCount:cpuStatus.irqCount,firqCount:cpuStatus.firqCount,nmiCount:cpuStatus.nmiCount}}executeCycle(ticksToRun=500,tickSteps=4){if(this.noRomAvailable)return;let ticksExecuted=0;for(;ticksExecuted<ticksToRun;){ticksExecuted+=this.cpu.steps(tickSteps)}return ticksExecuted}_getBankRomOffset(value){let bankBase=15&value;switch(224&~value){case 128:bankBase|=0;break;case 64:bankBase|=16;break;case 32:bankBase|=32;break;default:console.log("UNKNOWN_SOUND_ROM_BANK_"+value+" -> "+bankBase)}return bankBase<<15}_cpuRead8(offset){if(this.noRomAvailable)return 0;if(isNaN(offset))throw new TypeError("SOUND_MEMORY_READ_BUG_DETECTED!");const address=soundMapper.getAddress(offset);switch(address.subsystem){case soundMapper.SUBSYSTEM_RAM:return this.ram[address.offset];case soundMapper.SUBSYSTEM_HARDWARE:return this._hardwareRead(address.offset);case soundMapper.SUBSYSTEM_BANKSWITCHED:const readOffset=address.offset+this.romBankOffset;return this.concatinatedSoundRom[readOffset];case soundMapper.SUBSYSTEM_ROM:return this.systemROM[address.offset];default:throw console.log("wpcemu:boards:sound-board: CPU_READ8_FAIL",JSON.stringify(address),offset),new Error("SND_INVALID_READ_SUBSYSTEM")}}_cpuWrite8(offset,value){if(this.noRomAvailable)return;if(isNaN(offset))throw new TypeError("SOUND_MEMORY_WRITE_BUG_DETECTED!");if(void 0===value)throw new TypeError("MEMORY WRITE VALUE BUG DETECTED!");value&=255;const address=soundMapper.getAddress(offset);switch(address.subsystem){case soundMapper.SUBSYSTEM_RAM:this.ram[address.offset]=value;break;case soundMapper.SUBSYSTEM_HARDWARE:this._hardwareWrite(address.offset,value)}}mixStereo(audioBuffer,sampleCount,offset){this.ym2151.mixStereo(audioBuffer,sampleCount,offset)}registerDacCallback(dacCallback){this.dacCallback=dacCallback}writeInterface(offset,value){switch(this.ram[offset]=value,offset){case OP.WPC_SOUND_CONTROL_STATUS:console.log("RESET_SOUND_CPU"),this.reset();break;case OP.WPC_SOUND_DATA:console.log("write sound data",value),this._hardwareWrite(OP.WPC_LATCH_WRITE,value);break;default:console.log("SND_W_NOT_IMPLEMENTED","0x"+offset.toString(16),value)}}readInterface(offset){switch(offset){case OP.WPC_SOUND_CONTROL_STATUS:return this._hardwareRead(soundMapper.ADDRESS_YM2151_REGISTER);case OP.WPC_SOUND_DATA:return this._hardwareRead(OP.WPC_LATCH_READ);default:return console.log("wpcemu:boards:sound-board R_NOT_IMPLEMENTED","0x"+offset.toString(16)),0}}_hardwareWrite(offset,value){switch(offset){case OP.WPC_ROMBANK_W:[111,127].includes(value)&&console.log("SYSTEM ROM BANK REQUESTED!!!!");const newRomBank=this._getBankRomOffset(value);newRomBank!==this.romBankOffset&&(this.romBankOffset=newRomBank);break;case soundMapper.ADDRESS_YM2151_REGISTER:this.ym2151Register0=value;break;case soundMapper.ADDRESS_YM2151_DATA:this.ym2151.SetReg(this.ym2151Register0,value);break;case OP.WPC_DAC_WRITE:const analogValue=value;this.dacCallback(analogValue);break;case OP.HC55516_CLOCK_SET_WRITE:case OP.HC55516_DIGIT_CLOCK_CLEAR_WRITE:break;case OP.WPC_VOLUME_WRITE:1&value&&(this.volume>0&&2&value?this.volume-=1:this.volume<255&&0==(2&value)&&(this.volume+=1));break;case OP.WPC_LATCH_WRITE:this.soundData=value,this.cpu.irq(),this.interruptCallback.firq();break;default:console.log("SND_INVALID_HW_WRITE","0x"+offset.toString(16),value)}}_hardwareRead(offset){switch(offset){case soundMapper.ADDRESS_YM2151_DATA:return this.ym2151.status;case soundMapper.ADDRESS_YM2151_REGISTER:return this.ym2151Register0;case OP.WPC_LATCH_READ:return this.cpu.clearIrqMasking(),this.soundData;default:throw console.log("SND_INVALID_HW_READ","0x"+offset.toString(16)),new Error("SND_INVALID_READ_SUBSYSTEM_0x"+offset.toString(16))}}}},function(module,exports,__webpack_require__){"use strict";var FM,t,__extends=this.__extends||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);function s(){this.constructor=t}s.prototype=e.prototype,t.prototype=new s};(t=FM||(FM={})).FM_PGBITS=9,t.FM_RATIOBITS=7,t.FM_LFOBITS=8,t.FM_TLBITS=7,t.FM_TLENTS=1<<t.FM_TLBITS,t.FM_LFOENTS=1<<t.FM_LFOBITS,t.FM_CLENTS=8192,t.FM_OPSINBITS=10,t.FM_OPSINENTS=1<<t.FM_OPSINBITS,t.FM_EG_BOTTOM=955,t.IS2EC_SHIFT=20+t.FM_PGBITS-13,function(t){!function(t){t[t.typeN=0]="typeN",t[t.typeM=1]="typeM"}(t.OpType||(t.OpType={})),t.OpType,t.pmtable,t.amtable,t.tablemade=!1;var i=function(){function e(){this.chip_=null,this.out_=0,this.out2_=0,this.in2_=0,this.dp_=0,this.detune_=0,this.detune2_=0,this.multiple_=0,this.pg_count_=0,this.pg_diff_=0,this.pg_diff_lfo_=0,this.bn_=0,this.eg_level_=0,this.eg_level_on_next_phase_=0,this.eg_count_=0,this.eg_count_diff_=0,this.eg_out_=0,this.tl_out_=0,this.eg_rate_=0,this.eg_curve_count_=0,this.key_scale_rate_=0,this.eg_phase_=e.EGPhase.next,this.ms_=0,this.tl_=0,this.tl_latch_=0,this.ar_=0,this.dr_=0,this.sr_=0,this.sl_=0,this.rr_=0,this.ks_=0,this.keyon_=!1,this.amon_=!1,this.param_changed_=!1,this.mute_=!1,this.dbgopout_=0,this.dbgpgout_=0,e.tablehasmade||this.MakeTable(),this.ar_=this.dr_=this.sr_=this.rr_=this.key_scale_rate_=0,this.ams_=t.amtable[0][0],this.mute_=!1,this.keyon_=!1,this.tl_out_=0,this.multiple_=0,this.detune_=0,this.detune2_=0,this.ms_=0}return e.prototype.SetChip=function(t){this.chip_=t},e.prototype.Reset=function(){this.tl_=this.tl_latch_=127,this.ShiftPhase(e.EGPhase.off),this.eg_count_=0,this.eg_curve_count_=0,this.pg_count_=0,this.out_=this.out2_=0,this.param_changed_=!0},e.prototype.MakeTable=function(){var s,i=0;for(s=0;s<256;s++){var a=Math.floor(Math.pow(2,13-s/256));a=a+2&-4,e.cltable[i++]=a,e.cltable[i++]=-a}for(;i<t.FM_CLENTS;)e.cltable[i]=e.cltable[i-512]/2|0,i++;for(s=0;s<t.FM_OPSINENTS/2;s++){var h=(2*s+1)*Math.PI/t.FM_OPSINENTS,o=-256*Math.log(Math.sin(h))/Math.LN2,n=Math.floor(o+.5)+1;e.sinetable[s]=2*n,e.sinetable[t.FM_OPSINENTS/2+s]=2*n+1}t.MakeLFOTable(),e.tablehasmade=!0},e.prototype.SetDPBN=function(t,e){this.dp_=t,this.bn_=e,this.param_changed_=!0},e.prototype.Prepare=function(){if(this.param_changed_){switch(this.param_changed_=!1,this.pg_diff_=(this.dp_+e.dttable[this.detune_+this.bn_])*this.chip_.GetMulValue(this.detune2_,this.multiple_),this.pg_diff_lfo_=this.pg_diff_>>11,this.key_scale_rate_=this.bn_>>3-this.ks_,this.tl_out_=this.mute_?1023:8*this.tl_,this.eg_phase_){case e.EGPhase.attack:this.SetEGRate(this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0);break;case e.EGPhase.decay:this.SetEGRate(this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_level_on_next_phase_=8*this.sl_;break;case e.EGPhase.sustain:this.SetEGRate(this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0);break;case e.EGPhase.release:this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_))}this.ams_=t.amtable[this.type_][this.amon_?this.ms_>>4&3:0],this.EGUpdate(),this.dbgopout_=0}},e.prototype.ShiftPhase=function(i){switch(i){case e.EGPhase.attack:if(this.ar_+this.key_scale_rate_<62){this.SetEGRate(this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0),this.eg_phase_=e.EGPhase.attack;break}case e.EGPhase.decay:if(this.sl_){this.eg_level_=0,this.eg_level_on_next_phase_=8*this.sl_,this.SetEGRate(this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_phase_=e.EGPhase.decay;break}case e.EGPhase.sustain:this.eg_level_=8*this.sl_,this.eg_level_on_next_phase_=1024,this.SetEGRate(this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0),this.eg_phase_=e.EGPhase.sustain;break;case e.EGPhase.release:if(this.eg_phase_===e.EGPhase.attack||this.eg_level_<t.FM_EG_BOTTOM){this.eg_level_on_next_phase_=1024,this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_)),this.eg_phase_=e.EGPhase.release;break}case e.EGPhase.off:default:this.eg_level_=t.FM_EG_BOTTOM,this.eg_level_on_next_phase_=t.FM_EG_BOTTOM,this.EGUpdate(),this.SetEGRate(0),this.eg_phase_=e.EGPhase.off}},e.prototype.SetFNum=function(t){this.dp_=(2047&t)<<(t>>11&7),this.bn_=e.notetable[t>>7&127],this.param_changed_=!0},e.prototype.LogToLin=function(i){return i<t.FM_CLENTS?e.cltable[i]:0},e.prototype.EGUpdate=function(){this.eg_out_=Math.min(this.tl_out_+this.eg_level_,1023)<<3},e.prototype.SetEGRate=function(t){this.eg_rate_=t,this.eg_count_diff_=e.decaytable2[t>>2]*this.chip_.GetRatio()},e.prototype.EGCalc=function(){if(this.eg_count_=6141<<t.FM_RATIOBITS,this.eg_phase_===e.EGPhase.attack){var i=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];i>=0&&(this.eg_level_-=1+(this.eg_level_>>i),this.eg_level_<=0&&this.ShiftPhase(e.EGPhase.decay)),this.EGUpdate()}else this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1),this.EGUpdate();this.eg_curve_count_++},e.prototype.EGStep=function(){this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0&&this.EGCalc()},e.prototype.PGCalc=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_,this.dbgpgout_=t,t},e.prototype.PGCalcL=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.GetPMV()>>5),this.dbgpgout_=t,t},e.prototype.Calc=function(i){this.EGStep(),this.out2_=this.out_;var s=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=i>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+e.sinetable[s&t.FM_OPSINENTS-1]),this.dbgopout_=this.out_,this.out_},e.prototype.CalcL=function(i){this.EGStep();var s=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return s+=i>>20+t.FM_PGBITS-t.FM_OPSINBITS-(2+t.IS2EC_SHIFT),this.out_=this.LogToLin(this.eg_out_+e.sinetable[s&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},e.prototype.CalcN=function(t){this.EGStep();var e=Math.max(0,1023-(this.tl_out_+this.eg_level_))<<1;return t=(1&t)-1,this.out_=e+t^t,this.dbgopout_=this.out_,this.out_},e.prototype.CalcFB=function(i){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var a=this.PGCalc()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return i<31&&(a+=s<<1+t.IS2EC_SHIFT>>i>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+e.sinetable[a&t.FM_OPSINENTS-1]),this.dbgopout_=this.out2_,this.out2_},e.prototype.CalcFBL=function(i){this.EGStep();var s=this.out_+this.out2_;this.out2_=this.out_;var a=this.PGCalcL()>>20+t.FM_PGBITS-t.FM_OPSINBITS;return i<31&&(a+=s<<1+t.IS2EC_SHIFT>>i>>20+t.FM_PGBITS-t.FM_OPSINBITS),this.out_=this.LogToLin(this.eg_out_+e.sinetable[a&t.FM_OPSINENTS-1]+this.ams_[this.chip_.GetAML()]),this.dbgopout_=this.out_,this.out_},e.prototype.ResetFB=function(){this.out_=this.out2_=0},e.prototype.KeyOn=function(){this.keyon_||(this.keyon_=!0,this.eg_phase_!==e.EGPhase.off&&this.eg_phase_!==e.EGPhase.release||(this.ShiftPhase(e.EGPhase.attack),this.EGUpdate(),this.in2_=this.out_=this.out2_=0,this.pg_count_=0))},e.prototype.KeyOff=function(){this.keyon_&&(this.keyon_=!1,this.ShiftPhase(e.EGPhase.release))},e.prototype.IsOn=function(){return this.eg_phase_-e.EGPhase.off},e.prototype.SetDT=function(t){this.detune_=32*t,this.param_changed_=!0},e.prototype.SetDT2=function(t){this.detune2_=3&t,this.param_changed_=!0},e.prototype.SetMULTI=function(t){this.multiple_=t,this.param_changed_=!0},e.prototype.SetTL=function(t){this.tl_=t,this.param_changed_=!0},e.prototype.SetAR=function(t){this.ar_=t,this.param_changed_=!0},e.prototype.SetDR=function(t){this.dr_=t,this.param_changed_=!0},e.prototype.SetSR=function(t){this.sr_=t,this.param_changed_=!0},e.prototype.SetSL=function(t){this.sl_=t,this.param_changed_=!0},e.prototype.SetRR=function(t){this.rr_=t,this.param_changed_=!0},e.prototype.SetKS=function(t){this.ks_=t,this.param_changed_=!0},e.prototype.SetAMON=function(t){this.amon_=t,this.param_changed_=!0},e.prototype.Mute=function(t){this.mute_=t,this.param_changed_=!0},e.prototype.SetMS=function(t){this.ms_=t,this.param_changed_=!0},e.prototype.Out=function(){return this.out_},e.notetable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,30,31,31,31,31,31,31,31],e.dttable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,16,16,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,32,32,32,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,34,38,40,44,44,44,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,-2,-2,-2,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-16,-16,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-32,-32,-32,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-34,-38,-40,-44,-44,-44,-44],e.decaytable1=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0],[1,1,1,0,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1],[2,1,1,1,2,1,1,1],[2,1,2,1,2,1,2,1],[2,2,2,1,2,2,2,1],[2,2,2,2,2,2,2,2],[4,2,2,2,4,2,2,2],[4,2,4,2,4,2,4,2],[4,4,4,2,4,4,4,2],[4,4,4,4,4,4,4,4],[8,4,4,4,8,4,4,4],[8,4,8,4,8,4,8,4],[8,8,8,4,8,8,8,4],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16]],e.decaytable2=[1,2,4,8,16,32,64,128,256,512,1024,2047,2047,2047,2047,2047],e.attacktable=[[-1,-1,-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1,-1,-1],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,-1,4,4,4,-1],[4,4,4,-1,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,4,4,4,4,4,4,4],[3,4,4,4,3,4,4,4],[3,4,3,4,3,4,3,4],[3,3,3,4,3,3,3,4],[3,3,3,3,3,3,3,3],[2,3,3,3,2,3,3,3],[2,3,2,3,2,3,2,3],[2,2,2,3,2,2,2,3],[2,2,2,2,2,2,2,2],[1,2,2,2,1,2,2,2],[1,2,1,2,1,2,1,2],[1,1,1,2,1,1,1,2],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],e.tablehasmade=!1,e.sinetable=new Array(1024),e.cltable=new Array(t.FM_CLENTS),e.EGPhase={next:0,attack:1,decay:2,sustain:3,release:4,off:5},e}();t.Operator=i;var s=function(){function e(){this.op=[new i,new i,new i,new i],this.tablehasmade=!1,this.fb=0,this.buf=new Array(4),this.inop=new Array(3),this.outop=new Array(3),this.algo_=0,this.chip_=null,this.tablehasmade||this.MakeTable(),this.SetAlgorithm(0),this.pms=t.pmtable[0][0]}return e.prototype.MakeTable=function(){for(var t=0;t<64;t++)e.kftable[t]=65536*Math.pow(2,t/768)|0},e.prototype.SetChip=function(t){this.chip_=t;for(var e=0;e<4;e++)this.op[e].SetChip(t)},e.prototype.Reset=function(){for(var t=0;t<4;t++)this.op[t].Reset()},e.prototype.Prepare=function(){for(var e=0;e<4;e++)this.op[e].Prepare();return this.pms=t.pmtable[this.op[0].type_][7&this.op[0].ms_],(this.op[0].IsOn()|this.op[1].IsOn()|this.op[2].IsOn()|this.op[3].IsOn()?1:0)|(this.op[0].ms_&(this.op[0].amon_||this.op[1].amon_||this.op[2].amon_||this.op[3].amon_?55:7)?2:0)},e.prototype.SetFNum=function(t){for(var e=0;e<4;e++)this.op[e].SetFNum(t)},e.prototype.SetKCKF=function(t,i){var a=19-(t>>4&7),h=[5197,5506,5833,6180,6180,6547,6937,7349,7349,7786,8249,8740,8740,9259,9810,10394][15&t],o=(h=(h+2)/4*4)*e.kftable[63&i];o>>=19,o<<=19,o>>=a;var n=t>>2&31;this.op[0].SetDPBN(o,n),this.op[1].SetDPBN(o,n),this.op[2].SetDPBN(o,n),this.op[3].SetDPBN(o,n)},e.prototype.KeyControl=function(t){1&t?this.op[0].KeyOn():this.op[0].KeyOff(),2&t?this.op[1].KeyOn():this.op[1].KeyOff(),4&t?this.op[2].KeyOn():this.op[2].KeyOff(),8&t?this.op[3].KeyOn():this.op[3].KeyOff()},e.prototype.SetAlgorithm=function(t){var e=[[0,1,1,2,2,3],[1,0,0,1,1,2],[1,1,1,0,0,2],[0,1,2,1,1,2],[0,1,2,2,2,1],[0,1,0,1,0,1],[0,1,2,1,2,1],[1,0,1,0,1,0]];this.inop[0]=e[t][0],this.outop[0]=e[t][1],this.inop[1]=e[t][2],this.outop[1]=e[t][3],this.inop[2]=e[t][4],this.outop[2]=e[t][5],this.op[0].ResetFB(),this.algo_=t},e.prototype.Calc=function(){var t;switch(this.algo_){case 0:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 1:this.op[2].Calc(this.op[0].Out()+this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 2:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 3:this.op[2].Calc(0),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 4:this.op[2].Calc(0),t=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 5:t=this.op[2].Calc(this.op[0].Out()),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[0].Out()),this.op[0].CalcFB(this.fb);break;case 6:t=this.op[2].Calc(0),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(0),this.op[0].CalcFB(this.fb);break;case 7:t=this.op[2].Calc(0),t+=this.op[1].Calc(0),t+=this.op[3].Calc(0),t+=this.op[0].CalcFB(this.fb)}return t},e.prototype.CalcL=function(){var t;switch(this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.algo_){case 0:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 1:this.op[2].CalcL(this.op[0].Out()+this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 2:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 3:this.op[2].CalcL(0),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 4:this.op[2].CalcL(0),t=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 5:t=this.op[2].CalcL(this.op[0].Out()),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[0].Out()),this.op[0].CalcFBL(this.fb);break;case 6:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(0),this.op[0].CalcFBL(this.fb);break;case 7:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(0),t+=this.op[3].CalcL(0),t+=this.op[0].CalcFBL(this.fb)}return t},e.prototype.CalcN=function(t){this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFB(this.fb),this.buf[this.outop[0]]+=this.op[1].Calc(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].Calc(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.CalcLN=function(t){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].out_,this.op[0].CalcFBL(this.fb),this.buf[this.outop[0]]+=this.op[1].CalcL(this.buf[this.inop[0]]),this.buf[this.outop[1]]+=this.op[2].CalcL(this.buf[this.inop[1]]);var e=this.op[3].out_;return this.op[3].CalcN(t),this.buf[this.outop[2]]+e},e.prototype.SetType=function(t){for(var e=0;e<4;e++)this.op[e].type_=t},e.prototype.SetFB=function(t){this.fb=e.fbtable[t]},e.prototype.SetMS=function(t){for(var e=0;e<4;e++)this.op[e].SetMS(t)},e.prototype.Mute=function(t){for(var e=0;e<4;e++)this.op[e].Mute(t)},e.fbtable=[31,7,6,5,4,3,2,1],e.kftable=new Array(64),e.muted=0,e}();t.Channel4=s;var a=function(){function e(){this.ratio_=0,this.aml_=0,this.pml_=0,this.pmv_=0}return e.prototype.SetRatio=function(t){t=Math.round(t),this.ratio_!==t&&(this.ratio_=t,this.MakeTable())},e.prototype.SetAML=function(e){this.aml_=e&t.FM_LFOENTS-1},e.prototype.SetPML=function(e){this.pml_=e&t.FM_LFOENTS-1},e.prototype.SetPMV=function(t){this.pmv_=t},e.prototype.GetMulValue=function(t,e){return this.multable_[t][e]},e.prototype.GetAML=function(){return this.aml_},e.prototype.GetPML=function(){return this.pml_},e.prototype.GetPMV=function(){return this.pmv_},e.prototype.GetRatio=function(){return this.ratio_},e.prototype.MakeTable=function(){var e,i,s=[1,1.414,1.581,1.732];for(this.multable_=new Array(4),e=0;e<4;e++){var a=s[e]*this.ratio_/(1<<2+t.FM_RATIOBITS-t.FM_PGBITS);for(this.multable_[e]=new Array(16),i=0;i<16;i++){var h=i?2*i:1;this.multable_[e][i]=h*a|0}}},e}();t.Chip=a,t.MakeLFOTable=function(){if(!t.tablemade){var e;t.tablemade=!0;var i=[[0,1/360,2/360,3/360,4/360,6/360,12/360,24/360],[0,1/480,2/480,4/480,10/480,20/480,80/480,140/480]],s=[[31,6,4,3],[31,2,1,0]];t.pmtable=new Array(2),t.amtable=new Array(2);for(var a=0;a<2;a++){for(t.pmtable[a]=new Array(8),e=0;e<8;e++){var h=i[a][e];t.pmtable[a][e]=new Array(t.FM_LFOENTS);for(var o=0;o<t.FM_LFOENTS;o++){Math.pow(2,h*(2*o-t.FM_LFOENTS+1)/(t.FM_LFOENTS-1));var r=.6*h*Math.sin(2*o*Math.PI/t.FM_LFOENTS)+1;t.pmtable[a][e][o]=65536*(r-1)|0}}for(t.amtable[a]=new Array(4),e=0;e<4;e++)for(t.amtable[a][e]=new Array(t.FM_LFOENTS),o=0;o<t.FM_LFOENTS;o++)t.amtable[a][e][o]=2*(4*o>>s[a][e])<<2}}}}(FM||(FM={})),function(t){var e=function(){function t(){this.OPM_LFOENTS=512,this.regtc=0,this.regta=new Array(2),this.timera=0,this.timera_count=0,this.timerb=0,this.timerb_count=0,this.timer_step=0}return t.prototype.Reset=function(){this.timera_count=0,this.timerb_count=0},t.prototype.SetTimerControl=function(t){var e=this.regtc^t;this.regtc=t,16&t&&this.ResetStatus(1),32&t&&this.ResetStatus(2),1&e&&(this.timera_count=1&t?this.timera:0),2&e&&(this.timerb_count=2&t?this.timerb:0)},t.prototype.SetTimerA=function(t,e){var i;this.regta[1&t]=e,i=(this.regta[0]<<2)+(3&this.regta[1]),this.timera=(1024-i)*this.timer_step},t.prototype.SetTimerB=function(t){this.timerb=(256-t)*this.timer_step},t.prototype.Count=function(t){var e=!1;if(this.timera_count&&(this.timera_count-=t<<16,this.timera_count<=0)){for(e=!0,this.TimerA();this.timera_count<=0;)this.timera_count+=this.timera;4&this.regtc&&this.SetStatus(1)}if(this.timerb_count&&(this.timerb_count-=t<<12,this.timerb_count<=0)){for(e=!0;this.timerb_count<=0;)this.timerb_count+=this.timerb;8&this.regtc&&this.SetStatus(2)}return e},t.prototype.GetNextEvent=function(){var t=(this.timera_count+65535>>16)-1,e=(this.timerb_count+4095>>12)-1;return(t<e?t:e)+1},t.prototype.SetTimerBase=function(t){this.timer_step=65536e6/t|0,console.log("YM2151: SetTimerBase",{param:t,stepsize:this.timer_step})},t.prototype.SetStatus=function(t){console.log("t.prototype.SetStatus not impl",t)},t.prototype.ResetStatus=function(t){console.log("t.prototype.ResetStatus not impl",t)},t.prototype.TimerA=function(){console.log("t.prototype.TimerA not impl",t)},t}();t.Timer=e}(FM||(FM={})),function(t){var e=function(e){function i(){e.call(this),this.fmvolume=0,this.clock=0,this.rate=0,this.pcmrate=0,this.pmd=0,this.amd=0,this.lfocount=0,this.lfodcount=0,this.lfo_count_=0,this.lfo_count_diff_=0,this.lfo_step_=0,this.lfo_count_prev_=0,this.lfowaveform=0,this.rateratio=0,this.noise=0,this.noisecount=0,this.noisedelta=0,this.interpolation=!1,this.lfofreq=0,this.status=0,this.reg01=0,this.kc=new Array(8),this.kf=new Array(8),this.pan=new Array(8),this.ch=[new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4,new t.Channel4],this.chip=new t.Chip,this.lfo_count_=0,this.lfo_count_prev_=-1,this.BuildLFOTable();for(var i=0;i<8;i++)this.ch[i].SetChip(this.chip),this.ch[i].SetType(1)}return __extends(i,e),i.prototype.Init=function(clockrate,sampleRate){return this.SetRate(clockrate,sampleRate)?(this.Reset(),this.SetVolume(0),this.SetChannelMask(0),!0):(console.log("init:setRate failed!"),!1)},i.prototype.SetRate=function(clockrate,sampleRate){return this.clock=clockrate,this.pcmrate=sampleRate,this.rate=sampleRate,this.RebuildTimeTable(),!0},i.prototype.SetChannelMask=function(t){for(var e=0;e<8;e++)this.ch[e].Mute(!!(t&1<<e))},i.prototype.Reset=function(){var t;for(console.log("YM2151: Reset",{clock:this.clock}),t=0;t<256;t++)this.SetReg(t,0);for(this.SetReg(25,128),e.prototype.Reset.call(this),this.status=0,this.noise=12345,this.noisecount=0,t=0;t<8;t++)this.ch[t].Reset()},i.prototype.RebuildTimeTable=function(){var e=this.clock/64;this.rateratio=((e<<t.FM_RATIOBITS)+this.rate/2)/this.rate,this.SetTimerBase(e),console.log("YM2151: RebuildTimeTable",{clock:this.clock,rateratio:this.rateratio}),this.chip.SetRatio(this.rateratio)},i.prototype.SetVolume=function(t){t=Math.min(t,20),this.fmvolume=t>-192?16384*Math.pow(10,t/40)|0:0},i.prototype.SetStatus=function(t){this.status&t||(this.status|=t,this.Intr(!0))},i.prototype.ResetStatus=function(t){this.status&t&&(this.status&=~t,this.status||this.Intr(!1))},i.prototype.SetReg=function(e,i){if(!(e>=256)){var s=7&e;switch(255&e){case 1:2&i&&(this.lfo_count_=0,this.lfo_count_prev_=-1),this.reg01=i;break;case 8:128&this.regtc?(s=7&i,8&i||this.ch[s].op[0].KeyOff(),16&i||this.ch[s].op[1].KeyOff(),32&i||this.ch[s].op[2].KeyOff(),64&i||this.ch[s].op[3].KeyOff()):this.ch[7&i].KeyControl(i>>3);break;case 15:this.noisedelta=i,this.noisecount=0;break;case 16:case 17:this.SetTimerA(e,i);break;case 18:this.SetTimerB(i);break;case 20:this.SetTimerControl(i);break;case 24:this.lfofreq=i,this.lfo_count_diff_=this.rateratio*(16+(15&this.lfofreq)<<12-t.FM_RATIOBITS)/(1<<15-(this.lfofreq>>4));break;case 25:0!=(128&i)?this.pmd=127&i:this.amd=127&i;break;case 27:this.lfowaveform=3&i;break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:this.ch[s].SetFB(i>>3&7),this.ch[s].SetAlgorithm(7&i),this.pan[s]=i>>6&3;break;case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this.kc[s]=i,this.ch[s].SetKCKF(this.kc[s],this.kf[s]);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:this.kf[s]=i>>2,this.ch[s].SetKCKF(this.kc[s],this.kf[s]);break;case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.ch[s].SetMS(i<<4|i>>4);break;default:e>=64&&this.SetParameter(e,i)}}},i.prototype.SetParameter=function(t,e){var a=[0,2,1,3][t>>3&3],h=this.ch[7&t].op[a];switch(t>>5&7){case 2:h.SetDT(e>>4&7),h.SetMULTI(15&e);break;case 3:h.SetTL(127&e);break;case 4:h.SetKS(e>>6&3),h.SetAR(2*(31&e));break;case 5:h.SetDR(2*(31&e)),h.SetAMON(0!=(128&e));break;case 6:h.SetSR(2*(31&e)),h.SetDT2(e>>6&3);break;case 7:h.SetSL([0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,124][e>>4&15]),h.SetRR(4*(15&e)+2)}},i.prototype.BuildLFOTable=function(){this.amtable=new Array(4),this.pmtable=new Array(4);for(var t=0;t<4;t++){var e=0;this.amtable[t]=new Array(this.OPM_LFOENTS),this.pmtable[t]=new Array(this.OPM_LFOENTS);for(var i=0;i<this.OPM_LFOENTS;i++){var s,a;switch(t){case 0:a=(i+256&511)/2-128,s=255-i/2;break;case 1:s=i<256?255:0,a=i<256?127:-128;break;case 2:a=(a=i+128&511)<256?a-128:383-a,s=i<256?255-i:i-256;break;case 3:3&i||(e=(32768*Math.random()|0)/17&255),s=e,a=e-128}this.amtable[t][i]=0|s,this.pmtable[t][i]=-a-1|0}}},i.prototype.LFO=function(){var t;3!==this.lfowaveform?(t=this.lfo_count_>>15&510,this.chip.SetPML(this.pmtable[this.lfowaveform][t]*this.pmd/128+128),this.chip.SetAML(this.amtable[this.lfowaveform][t]*this.amd/128)):-131072&(this.lfo_count_^this.lfo_count_prev_)&&(t=(32768*Math.random()|0)/17&255,this.chip.SetPML((t-128)*this.pmd/128+128),this.chip.SetAML(t*this.amd/128)),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_)},i.prototype.Noise=function(){if(this.noisecount+=2*this.rateratio,this.noisecount>=32<<t.FM_RATIOBITS){var e=32-(31&this.noisedelta);1===e&&(e=2),this.noisecount=this.noisecount-(e<<t.FM_RATIOBITS),31==(31&this.noisedelta)&&(this.noisecount-=t.FM_RATIOBITS),this.noise=this.noise>>1^(1&this.noise?33800:0)}return this.noise},i.prototype.MixSub=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].Calc()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].Calc()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].Calc()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].Calc()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].Calc()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].Calc()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].Calc()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcN(this.Noise()):e[this.pan[7]]+=this.ch[7].Calc())},i.prototype.MixSubL=function(t,e){this.ch[0].muted||(e[this.pan[0]]=this.ch[0].CalcL()),this.ch[1].muted||(e[this.pan[1]]+=this.ch[1].CalcL()),this.ch[2].muted||(e[this.pan[2]]+=this.ch[2].CalcL()),this.ch[3].muted||(e[this.pan[3]]+=this.ch[3].CalcL()),this.ch[4].muted||(e[this.pan[4]]+=this.ch[4].CalcL()),this.ch[5].muted||(e[this.pan[5]]+=this.ch[5].CalcL()),this.ch[6].muted||(e[this.pan[6]]+=this.ch[6].CalcL()),this.ch[7].muted||(128&this.noisedelta?e[this.pan[7]]+=this.ch[7].CalcLN(this.Noise()):e[this.pan[7]]+=this.ch[7].CalcL())},i.prototype.Mix=function(t,e,i){for(var s=0,_sc=1/this.attenuation,_v=this.volume/100,a=0;a<8;a++)s=s<<2|this.ch[a].Prepare();2&this.reg01&&(s&=21845);var h=new Array(4);for(a=0;a<i;a++)h[1]=h[2]=h[3]=0,this.LFO(),43690&s?this.MixSubL(s,h):this.MixSub(s,h),t[a]=(h[1]+h[3])*_sc*_v,e[a]=(h[2]+h[3])*_sc*_v},i.prototype.label="YM2151",i.prototype.version=258,i.prototype.attenuation=49152,i.prototype.volume=100,i.prototype.mixStereo=function(audioBuffer,sample_count,offset){for(var s=0,_sc=1/this.attenuation,_v=this.volume/100,a=0;a<8;a++)s=s<<2|this.ch[a].Prepare();2&this.reg01&&(s&=21845);var h=new Array(4),n=0|offset;for(a=0;a<sample_count;a++)h[1]=h[2]=h[3]=0,this.LFO(),43690&s?this.MixSubL(s,h):this.MixSub(s,h),audioBuffer[n++]+=(h[1]+h[3])*_sc*_v,audioBuffer[n++]+=(h[2]+h[3])*_sc*_v},i.prototype.Intr=function(t){console.log("i.prototype.Intr not implemented")},i.prototype.toggle=function(ch,m){this.ch[ch].muted=!m},i}(t.Timer);t.OPM=e}(FM||(FM={})),module.exports={get label(){return"YM2151"},get channels(){return["Ch 1","Ch 2","Ch 3","Ch 4","Ch 5","Ch 6","Ch 7","Ch 8"]},create:function(clockRateHz,sampleRateHz){const ret=new FM.OPM;ret.Init(clockRateHz,sampleRateHz),ret.SetReg(20,42);for(var q=0;q<8;++q)ret.SetReg(56+q,0);return ret.SetReg(15,0),ret}}},function(module,exports,__webpack_require__){"use strict";const MEMORY_ADDR_RAM=8192,MEMORY_ADDR_HARDWARE=16384,MEMORY_ADDR_BANKSWITCHED=49152,MEMORY_ADDR_ROM=65536,SUBSYSTEM_RAM="ram",SUBSYSTEM_HARDWARE="hardware",SUBSYSTEM_BANKSWITCHED="bank",SUBSYSTEM_ROM="rom",ADDRESS_YM2151_REGISTER=9216,ADDRESS_YM2151_DATA=9217,ADDRESS_YM2151_END=10239;function buildReturnModel(offset,subsystem){return{offset,subsystem}}module.exports={getAddress:function(offset){if(void 0===offset)throw new Error("SND_GET_ADDRESS_UNDEFINED");if((offset&=65535)<MEMORY_ADDR_RAM)return buildReturnModel(offset,SUBSYSTEM_RAM);if(offset<MEMORY_ADDR_HARDWARE){if(offset<ADDRESS_YM2151_REGISTER||offset>ADDRESS_YM2151_END)return buildReturnModel(offset,SUBSYSTEM_HARDWARE);const yn2151Offset=offset%2==1?ADDRESS_YM2151_DATA:ADDRESS_YM2151_REGISTER;return buildReturnModel(yn2151Offset,SUBSYSTEM_HARDWARE)}if(offset<MEMORY_ADDR_BANKSWITCHED)return buildReturnModel(offset-16384,SUBSYSTEM_BANKSWITCHED);if(offset<MEMORY_ADDR_ROM)return buildReturnModel(offset-49152,SUBSYSTEM_ROM);throw new Error("SND_GET_ADDRESS_INVALID_MEMORY_REGION_0x"+offset.toString(16))},SUBSYSTEM_RAM,SUBSYSTEM_HARDWARE,SUBSYSTEM_BANKSWITCHED,SUBSYSTEM_ROM,ADDRESS_YM2151_REGISTER,ADDRESS_YM2151_DATA}},function(module,exports,__webpack_require__){"use strict";module.exports={getRegisterName:function(register){if(NOT_USED_REGISTER.includes(register))return"NOT_USED";const isSpecificRegister=YM2151_REGISTER[register];if(isSpecificRegister)return isSpecificRegister;if(isInRange(register,40,47))return"KEY CODE";if(isInRange(register,48,55))return"KEY FRACTION";if(isInRange(register,56,63))return"PHASE & AMPLITUDE MODULATION SENSITIVITY";if(isInRange(register,64,95))return"DETUNE & PHASE MULTIPLY";if(isInRange(register,96,127))return"TOTAL LEVEL";if(isInRange(register,128,159))return"EG ATTACK";if(isInRange(register,160,191))return"EG DECAY 1";if(isInRange(register,192,223))return"EG DECAY 2";if(isInRange(register,224,255))return"EG DECAY LEVEL, RELEASE RATE";return"WTF?"}};const NOT_USED_REGISTER=[0,2,3,4,5,6,7,9,10,11,12,13,14,16,26,28,29,30,31,33,34,35,36,37,38,39],YM2151_REGISTER=[];function isInRange(register,minValue,maxValue){return register>=minValue&&register<=maxValue}YM2151_REGISTER[1]="TEST & LFO RESET",YM2151_REGISTER[8]="KEY ON",YM2151_REGISTER[15]="NOISE ENABLE, NOISE FREQUENCY",YM2151_REGISTER[17]="CLOCK A1",YM2151_REGISTER[18]="CLOCK A2",YM2151_REGISTER[19]="CLOCK B",YM2151_REGISTER[20]="CLOCK FUNCTIONS",YM2151_REGISTER[24]="LOW FREQUENCY",YM2151_REGISTER[25]="PHASE AND AMPLITUDE MODULATION",YM2151_REGISTER[27]="CONTROL OUTPUT & WAVE FORM SELECT",YM2151_REGISTER[32]="CHANNEL CONTROL"},function(module,exports,__webpack_require__){"use strict";const EXTERNALIO_MEMORY_SIZE=32,OP={WPC_PARALLEL_STATUS_PORT:16320,WPC_PARALLEL_DATA_PORT:16321,WPC_PARALLEL_STROBE_PORT:16322,WPC_SERIAL_DATA_OUTPUT:16323,WPC_SERIAL_CONTROL_OUTPUT:16324,WPC_SERIAL_BAUD_SELECT:16325,WPC_TICKET_DISPENSE:16326,WPC_FLIPTRONICS_FLIPPER_PORT_B:16341},REVERSEOP=[];Object.keys(OP).forEach(key=>{REVERSEOP[OP[key]]=key});const TICKET_DISPENSE_NOT_AVAILABLE=255;module.exports={getInstance:function(){return new ExternalIo}};class ExternalIo{constructor(){this.ram=new Uint8Array(EXTERNALIO_MEMORY_SIZE).fill(0)}write(offset,value){const _offset=offset-16320;switch(this.ram[_offset]=value,offset){case OP.WPC_PARALLEL_STATUS_PORT:case OP.WPC_PARALLEL_DATA_PORT:case OP.WPC_PARALLEL_STROBE_PORT:case OP.WPC_SERIAL_DATA_OUTPUT:case OP.WPC_SERIAL_CONTROL_OUTPUT:case OP.WPC_SERIAL_BAUD_SELECT:case OP.WPC_TICKET_DISPENSE:case OP.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO W_NOT_IMPLEMENTED","0x"+offset.toString(16),value)}}read(offset){const _offset=offset-16320;switch(offset){case OP.WPC_TICKET_DISPENSE:return TICKET_DISPENSE_NOT_AVAILABLE;case OP.WPC_PARALLEL_STATUS_PORT:case OP.WPC_PARALLEL_DATA_PORT:case OP.WPC_PARALLEL_STROBE_PORT:case OP.WPC_SERIAL_DATA_OUTPUT:case OP.WPC_SERIAL_CONTROL_OUTPUT:case OP.WPC_SERIAL_BAUD_SELECT:case OP.WPC_FLIPTRONICS_FLIPPER_PORT_B:break;default:console.log("IO R_NOT_IMPLEMENTED","0x"+offset.toString(16))}return this.ram[_offset]}}},function(module,exports,__webpack_require__){"use strict";module.exports={getInstance:function(gameIdMemoryPosition){return new MemoryPatch}};class MemoryPatch{constructor(){this.patch=[]}addPatch(memoryOffset,value){this.patch.push({memoryOffset,value})}hasPatch(memoryOffset){return this.patch.find(patchEntry=>patchEntry.memoryOffset===memoryOffset)}}},function(module,exports,__webpack_require__){"use strict";module.exports={run:function(memoryPatch,gameIdMemoryPosition){return memoryPatch.addPatch(gameIdMemoryPosition,MEDIEVALMADNESS_GAMEID_LO),memoryPatch.addPatch(gameIdMemoryPosition+1,MEDIEVALMADNESS_GAMEID_HI),memoryPatch}};const MEDIEVALMADNESS_GAMEID_LO=20,MEDIEVALMADNESS_GAMEID_HI=99},function(module,exports,__webpack_require__){"use strict";const outputDmdDisplay=__webpack_require__(26),OP={FREEWPC_DEBUG_CONTROL_PORT:15713,WPC_SERIAL_CONTROL_PORT:15974,WPC_DMD_HIGH_PAGE:16316,WPC_DMD_SCANLINE:16317,WPC_DMD_LOW_PAGE:16318,WPC_DMD_ACTIVE_PAGE:16319},DMD_START_PAGE_1_ADDRESS=14336,DMD_START_PAGE_2_ADDRESS=14848,DMD_END_PAGE_2_ADDRESS=15360,DMD_PAGE_SIZE=512,DMD_SCANLINE_SIZE_IN_BYTES=16,DMD_NR_OF_PAGES=16,DMD_SHADING_FRAMES=3,REVERSEOP=[];Object.keys(OP).forEach(key=>{REVERSEOP[OP[key]]=key}),module.exports={getInstance:function(initObject){return new DMD(initObject)}};class DMD{constructor(initObject){this.interruptCallback=initObject.interruptCallback,this.ram=initObject.ram,this.videoOutputBuffer=new Uint8Array(DMD_SHADING_FRAMES*DMD_PAGE_SIZE).fill(0),this.outputDmdDisplay=outputDmdDisplay.getInstance(DMD_PAGE_SIZE,this.videoOutputBuffer),this.videoRam=new Uint8Array(DMD_PAGE_SIZE*DMD_NR_OF_PAGES).fill(0)}reset(){console.log("RESET_DMD_BOARD"),this.videoRam.fill(0),this.videoOutputBuffer.fill(0),this.lowPage=0,this.highPage=1,this.scanline=0,this.activePage=0,this.nextActivePage=void 0,this.videoOutputPointer=0,this.requestFIRQ=!1}getUiState(){return{scanline:this.scanline,lowpage:this.lowPage,highpage:this.highPage,activepage:this.activePage,videoRam:this.videoRam,dmdShadedBuffer:this.outputDmdDisplay.getShadedOutputVideoFrame()}}copyScanline(){const sourceAddress=this.activePage*DMD_PAGE_SIZE+this.scanline*DMD_SCANLINE_SIZE_IN_BYTES,destinationAddress=this.videoOutputPointer*DMD_PAGE_SIZE+this.scanline*DMD_SCANLINE_SIZE_IN_BYTES;for(let i=0;i<DMD_SCANLINE_SIZE_IN_BYTES;i++)this.videoOutputBuffer[destinationAddress+i]=this.videoRam[sourceAddress+i];this.scanline=this.scanline+1&31,0===this.scanline&&(this.videoOutputPointer=(this.videoOutputPointer+1)%DMD_SHADING_FRAMES,this.outputDmdDisplay.updateVideoBuffer(this.videoOutputBuffer),Number.isInteger(this.nextActivePage)&&(this.activePage=this.nextActivePage,this.nextActivePage=void 0)),!0===this.requestFIRQ&&this.scanline===this.ram[OP.WPC_DMD_SCANLINE]&31&&(this.interruptCallback.firqFromDmd(),this.requestFIRQ=!1)}_getLowPageOffset(offset){const deltaLow=offset-DMD_START_PAGE_1_ADDRESS;return this.lowPage*DMD_PAGE_SIZE+deltaLow}_getHighPageOffset(offset){const deltaHigh=offset-DMD_START_PAGE_2_ADDRESS;return this.highPage*DMD_PAGE_SIZE+deltaHigh}write(offset,value){var _ofs;if(offset<DMD_START_PAGE_2_ADDRESS)return _ofs=this._getLowPageOffset(offset),void(this.videoRam[_ofs]=value);if(offset<DMD_END_PAGE_2_ADDRESS)return _ofs=this._getHighPageOffset(offset),void(this.videoRam[_ofs]=value);switch(this.ram[offset]=value,offset){case OP.WPC_DMD_SCANLINE:this.requestFIRQ=!0;break;case OP.WPC_DMD_ACTIVE_PAGE:this.nextActivePage=15&value;break;case OP.WPC_DMD_LOW_PAGE:this.lowPage=15&value;break;case OP.WPC_DMD_HIGH_PAGE:this.highPage=15&value;break;default:console.log("DMD W_NOT_IMPLEMENTED","0x"+offset.toString(16),value)}}read(offset){var _ofs;if(offset<DMD_START_PAGE_2_ADDRESS)return _ofs=this._getLowPageOffset(offset),this.videoRam[_ofs];if(offset<DMD_END_PAGE_2_ADDRESS)return _ofs=this._getHighPageOffset(offset),this.videoRam[_ofs];switch(offset){case OP.WPC_DMD_SCANLINE:return this.scanline;case OP.FREEWPC_DEBUG_CONTROL_PORT:case OP.WPC_SERIAL_CONTROL_PORT:return 0;default:return console.log("DMD R_NOT_IMPLEMENTED","0x"+offset.toString(16),this.ram[offset]),this.ram[offset]}}}},function(module,exports,__webpack_require__){"use strict";const bitmagic=__webpack_require__(1),DMD_WINDOW_HEIGHT=32,DMD_WINDOW_WIDTH_IN_BYTES=16;module.exports={getInstance:function(dmdPageSize,videoBuffer){return new OutputDmdDisplay(dmdPageSize,videoBuffer)}};class OutputDmdDisplay{constructor(dmdPageSize,videoBuffer){this.dmdPageSize=dmdPageSize,this.videoBuffer=videoBuffer}updateVideoBuffer(videoBuffer){this.videoBuffer=Uint8Array.from(videoBuffer)}getShadedOutputVideoFrame(){const BUFFER1=this.dmdPageSize,BUFFER2=2*this.dmdPageSize,videoBufferShaded=new Uint8Array(8*this.dmdPageSize).fill(0);for(var outputOffset=0,inputOffset=0,scanline=0;scanline<DMD_WINDOW_HEIGHT;scanline++)for(var eightPixelsOffset=0;eightPixelsOffset<DMD_WINDOW_WIDTH_IN_BYTES;eightPixelsOffset++){for(var i=0;i<8;i++){const bitMask=bitmagic.setMsbBit(i),intensity=((this.videoBuffer[0+inputOffset]&bitMask)>0?1:0)+((this.videoBuffer[BUFFER1+inputOffset]&bitMask)>0?1:0)+((this.videoBuffer[BUFFER2+inputOffset]&bitMask)>0?1:0);videoBufferShaded[outputOffset++]=intensity}inputOffset++}return videoBufferShaded}}},function(module,exports,__webpack_require__){"use strict";module.exports={getInstance:function(){return new UiState}};const DMD_PAGE_SIZE=512;class UiState{constructor(){this.count=0,this.oldState={videoRam:[],dmdShadedBuffer:[],lampState:[],solenoidState:[],inputState:[]},this.videoRam=[]}getVideoRamDiff(videoMemory){let changedFrames=!1;for(let i=0;i<16;i++){const tempDmdFrame=videoMemory.slice(i*DMD_PAGE_SIZE,(i+1)*DMD_PAGE_SIZE);(!this.oldState.videoRam[i]||!UiState.arraysEqual(tempDmdFrame,this.oldState.videoRam[i]))&&(changedFrames=!0,this.videoRam[i]=tempDmdFrame,this.oldState.videoRam[i]=Uint8Array.from(tempDmdFrame))}return changedFrames}static arraysEqual(a,b){if(a===b)return!0;if(null===a||null===b||a.length!==b.length)return!1;for(let i=0;i<a.length;++i)if(a[i]!==b[i])return!1;return!0}getChangedState(state){this.count++;const dmdShadedBufferChanged=!UiState.arraysEqual(state.dmd.dmdShadedBuffer,this.oldState.dmdShadedBuffer),lampStateChanged=!UiState.arraysEqual(state.wpc.lampState,this.oldState.lampState),solenoidStateChanged=!UiState.arraysEqual(state.wpc.solenoidState,this.oldState.solenoidState),inputStateChanged=!UiState.arraysEqual(state.wpc.inputState,this.oldState.inputState);dmdShadedBufferChanged&&(this.oldState.dmdShadedBuffer=Uint8Array.from(state.dmd.dmdShadedBuffer)),lampStateChanged&&(this.oldState.lampState=Uint8Array.from(state.wpc.lampState)),solenoidStateChanged&&(this.oldState.solenoidState=Uint8Array.from(state.wpc.solenoidState)),inputStateChanged&&(this.oldState.inputState=Uint8Array.from(state.wpc.inputState));const videoRamChanged=this.getVideoRamDiff(state.dmd.videoRam);return{ram:this.count%4==0?state.ram:void 0,wpc:{diagnosticLed:state.wpc.diagnosticLed,lampState:lampStateChanged?state.wpc.lampState:void 0,solenoidState:solenoidStateChanged?state.wpc.solenoidState:void 0,generalIlluminationState:state.wpc.generalIlluminationState,inputState:inputStateChanged?state.wpc.inputState:void 0,diagnosticLedToggleCount:state.wpc.diagnosticLedToggleCount,irqEnabled:state.wpc.irqEnabled,activeRomBank:state.wpc.activeRomBank},dmd:{scanline:state.dmd.scanline,lowpage:state.dmd.lowpage,highpage:state.dmd.highpage,activepage:state.dmd.activepage,videoRam:videoRamChanged?this.videoRam:void 0,dmdShadedBuffer:dmdShadedBufferChanged?state.dmd.dmdShadedBuffer:void 0}}}}},function(module){module.exports={name:"wpc-emu",version:"0.6.8",description:"WPC pinball machine emu",main:"index.js",engines:{node:">=10.0.0"},author:"Michael Vogt",license:"ISC",devDependencies:{ava:"^0.25.0","http-server":"^0.11.1","remove-debug-loader":"^0.2.6","terser-webpack-plugin":"^1.1.0",webpack:"^4.20.2","webpack-cli":"^3.1.2",xo:"^0.23.0"},dependencies:{debug:"^3.1.0"},xo:{envs:["node","browser"],space:!0,rules:{"comma-dangle":0,"arrow-parens":0,"no-var":0,"comma-spacing":0,"capitalized-comments":0,"promise/prefer-await-to-then":0,"ava/prefer-async-await":0,"no-use-before-define":0,"spaced-comment":0,"object-curly-spacing":0,"array-bracket-spacing":0,"padded-blocks":0,"no-mixed-operators":0,"unicorn/import-index":0,"new-cap":0,"prefer-destructuring":0,"no-use-extend-native/no-use-extend-native":0},ignores:["client","docs","lib/boards/up/ym2151.js","lib/boards/up/mc6809.js"]},scripts:{build:"webpack --mode development",watch:"webpack --mode development --watch","build:production":"webpack --mode production","build:test":"rm -f dist/* && webpack && cp assets/* dist && DEBUG=* node index.js",start:"DEBUG=* node index.js","start:fileserv":"http-server ./rom --cors",debug:"node --inspect index.js",xo:"xo",test:"ava --verbose test/lib/**","test:debug":"DEBUG='wpc*' ava --verbose test/lib/**","test:integration":"ava --verbose test/integration/*.test.js","test:runner":"node test/headless-runner.js","test:soundboard":"env DEBUG='*' node test/integration/soundboard.js",benchmark:"node test/integration/benchmark.js > /dev/null","benchmark:t2":"CYCLES=20000000 ROMFILE=./rom/t2_l8.rom node test/integration/benchmark.js > /dev/null",release:"npm run build:production && cd client && npm run build:production && cd .. && cp -f ./dist/* ./docs"}}}]);